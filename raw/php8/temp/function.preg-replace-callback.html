<div id="function.preg-replace-callback" class="refentry"> <div class="refnamediv">  <h1 class="refname">preg_replace_callback</h1>  <p class="verinfo">(PHP 4 &gt;= 4.0.5, PHP 5, PHP 7, PHP 8)</p><p class="refpurpose"><span class="refname">preg_replace_callback</span> &mdash; <span class="dc-title">执行一个正则表达式搜索并且使用一个回调进行替换</span></p> </div> <br></br><div style="BORDER-TOP: gray 1px dashed; OVERFLOW: hidden; HEIGHT: 1px"></div><div class="refsect1 description" id="refsect1-function.preg-replace-callback-description">  <h3 class="title">说明</h3>  <div class="methodsynopsis dc-description">   <span class="methodname" style="color:#CC7832"><strong>preg_replace_callback</strong></span>(<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="methodparam"><span class="type" style="color:#EAB766"><span class="type" style="color:#EAB766">string</span>|<span class="type" style="color:#EAB766">array</span></span> <span class="parameter" style="color:#3A95FF">$pattern</span></span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="methodparam"><span class="type" style="color:#EAB766"><a href="https://www.php.net/manual/zh/language.types.callable.php" class="type callable" style="color:#EAB766">callable</a></span> <span class="parameter" style="color:#3A95FF">$callback</span></span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="methodparam"><span class="type" style="color:#EAB766"><span class="type" style="color:#EAB766">string</span>|<span class="type" style="color:#EAB766">array</span></span> <span class="parameter" style="color:#3A95FF">$subject</span></span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="methodparam"><span class="type" style="color:#EAB766">int</span> <span class="parameter" style="color:#3A95FF">$limit</span><span class="initializer"> = -1</span></span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="methodparam"><span class="type" style="color:#EAB766">int</span> <span class="parameter" style="color:#3A95FF">&$count</span><span class="initializer"> = <strong><span>null</span></strong></span></span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="methodparam"><span class="type" style="color:#EAB766">int</span> <span class="parameter" style="color:#3A95FF">$flags</span><span class="initializer"> = 0</span></span><br>): <span class="type" style="color:#EAB766"><span class="type" style="color:#EAB766">string</span>|<span class="type" style="color:#EAB766">array</span>|<span class="type" style="color:#EAB766">null</span></span></div>  <p class="para rdfs-comment">  这个函数的行为除了可以指定一个  <span class="parameter" style="color:#3A95FF">callback</span> 替代  <span class="parameter" style="color:#3A95FF">replacement</span>  进行替换字符串的计算，其他方面等同于  <span class="function">{@link preg_replace()}</span>。  </p> </div> <br></br><div style="BORDER-TOP: gray 1px dashed; OVERFLOW: hidden; HEIGHT: 1px"></div><div class="refsect1 parameters" id="refsect1-function.preg-replace-callback-parameters">  <h3 class="title">参数</h3>  <span>   <dl>         <dt><span class="parameter" style="color:#3A95FF">pattern</span></dt>     <dd>      <p class="para">      要搜索的模式，可以是字符串或一个字符串数组。      </p>     </dd>             <dt><span class="parameter" style="color:#3A95FF">callback</span></dt>     <dd>      <p class="para">      一个回调函数，在每次需要替换时调用，调用时函数得到的参数是从 <span class="parameter" style="color:#3A95FF">subject</span>      中匹配到的结果。回调函数返回真正参与替换的字符串。这是该回调函数的签名：      </p>      <p class="para">       <div class="methodsynopsis dc-description">        <span class="methodname" style="color:#CC7832"><span class="replaceable">handler</span></span>(<span class="methodparam"><span class="type" style="color:#EAB766">array</span> <span class="parameter" style="color:#3A95FF">$matches</span></span>): <span class="type" style="color:#EAB766">string</span></div>      </p>      <p class="para">        经常会需要 <span class="parameter" style="color:#3A95FF">callback</span> 函数而仅用于        <span class="function"><strong style="color:#CC7832">preg_replace_callback()</strong></span> 一个地方的调用。在这种情况下，你可以使用        <a href="https://www.php.net/manual/zh/functions.anonymous.php" class="link">匿名函数</a> 来定义一个匿名函数作为        <span class="function"><strong style="color:#CC7832">preg_replace_callback()</strong></span>        调用时的回调。 这样做你可以保留所有调用信息在同一个位置并且不会因为一个不在任何其他地方使用的回调函数名称而污染函数名称空间。      </p>      <p class="para">       <div class="example" id="">        <p><strong>示例 #1 <span class="function"><strong style="color:#CC7832">preg_replace_callback()</strong></span> 和        匿名函数</strong></p>        <div class="example-contents"><div class="phpcode" style="border-color:gray;background:#232525"><span><span style="color: #000000"><span style="color: #9876AA">&lt;?php<br /></span><span style="color: #FF8000">// 一个unix样式的命令行过滤器，用于将段落开始部分的大写字母转换为小写。 <br /></span><span style="color: #9876AA">$fp </span><span style="color: #007700">= </span><span style="color: #9876AA">fopen</span><span style="color: #007700">(</span><span style="color: #DD0000">"php://stdin"</span><span style="color: #007700">, </span><span style="color: #DD0000">"r"</span><span style="color: #007700">) or die(</span><span style="color: #DD0000">"can't read stdin"</span><span style="color: #007700">);<br />while (!</span><span style="color: #9876AA">feof</span><span style="color: #007700">(</span><span style="color: #9876AA">$fp</span><span style="color: #007700">)) {<br />    </span><span style="color: #9876AA">$line </span><span style="color: #007700">= </span><span style="color: #9876AA">fgets</span><span style="color: #007700">(</span><span style="color: #9876AA">$fp</span><span style="color: #007700">);<br />    </span><span style="color: #9876AA">$line </span><span style="color: #007700">= </span><span style="color: #9876AA">preg_replace_callback</span><span style="color: #007700">(<br />        </span><span style="color: #DD0000">'|&lt;p&gt;\s*\w|'</span><span style="color: #007700">,<br />        function (</span><span style="color: #9876AA">$matches</span><span style="color: #007700">) {<br />            return </span><span style="color: #9876AA">strtolower</span><span style="color: #007700">(</span><span style="color: #9876AA">$matches</span><span style="color: #007700">[</span><span style="color: #9876AA">0</span><span style="color: #007700">]);<br />        },<br />        </span><span style="color: #9876AA">$line<br />    </span><span style="color: #007700">);<br />    echo </span><span style="color: #9876AA">$line</span><span style="color: #007700">;<br />}<br /></span><span style="color: #9876AA">fclose</span><span style="color: #007700">(</span><span style="color: #9876AA">$fp</span><span style="color: #007700">);<br /></span><span style="color: #9876AA">?&gt;</span></span></span></div>        </div>       </div>      </p>     </dd>             <dt><span class="parameter" style="color:#3A95FF">subject</span></dt>     <dd>      <p class="para">       要搜索替换的目标字符串或字符串数组。      </p>     </dd>             <dt><span class="parameter" style="color:#3A95FF">limit</span></dt>     <dd>      <p class="para">      对于每个模式用于每个 <span class="parameter" style="color:#3A95FF">subject</span> 字符串的最大可替换次数。      默认是 <span>-1</span>（无限制）。      </p>     </dd>             <dt><span class="parameter" style="color:#3A95FF">count</span></dt>     <dd>      <p class="para">       如果指定，这个变量将被填充为替换执行的次数。      </p>     </dd>             <dt><span class="parameter" style="color:#3A95FF">flags</span></dt>     <dd>      <p class="para">       <span class="parameter" style="color:#3A95FF">flags</span> 可以是 <strong><span>PREG_OFFSET_CAPTURE</span></strong>       和 <strong><span>PREG_UNMATCHED_AS_NULL</span></strong> 标志的组合， 这会影响匹配到的结果的格式。       相关详情请参阅 <span class="function">{@link preg_match()}</span> 中的描述。      </p>     </dd>       </dl>  </span> </div> <br></br><div style="BORDER-TOP: gray 1px dashed; OVERFLOW: hidden; HEIGHT: 1px"></div><div class="refsect1 returnvalues" id="refsect1-function.preg-replace-callback-returnvalues">  <h3 class="title">返回值</h3>  <p class="para">    如果 <span class="parameter" style="color:#3A95FF">subject</span> 是一个数组，    <span class="function"><strong style="color:#CC7832">preg_replace_callback()</strong></span> 返回一个数组，其他情况返回字符串。错误发生时返回 <strong><span>null</span></strong>。  </p>  <p class="para">  如果查找到了匹配，返回替换后的目标字符串（或字符串数组），其他情况  <span class="parameter" style="color:#3A95FF">subject</span> 将会无变化返回。  </p> </div> <br></br><div style="BORDER-TOP: gray 1px dashed; OVERFLOW: hidden; HEIGHT: 1px"></div><div class="refsect1 errors" id="refsect1-function.preg-replace-callback-errors">  <h3 class="title">错误／异常</h3>  <p class="para">如果传递的正则表达式无法正常解析，会发出 <strong><span>E_WARNING</span></strong>。 </p> </div> <br></br><div style="BORDER-TOP: gray 1px dashed; OVERFLOW: hidden; HEIGHT: 1px"></div><div class="refsect1 changelog" id="refsect1-function.preg-replace-callback-changelog">  <h3 class="title">更新日志</h3>  <span>   <table class="doctable informaltable">         <thead>      <tr>       <th>版本</th>       <th>说明</th>      </tr>     </thead>     <tbody class="tbody">      <tr>       <td>7.4.0</td>       <td>        新增 <span class="parameter" style="color:#3A95FF">flags</span> 参数。       </td>      </tr>     </tbody>       </table>  </span> </div> <br></br><div style="BORDER-TOP: gray 1px dashed; OVERFLOW: hidden; HEIGHT: 1px"></div><div class="refsect1 examples" id="refsect1-function.preg-replace-callback-examples">  <h3 class="title">示例</h3>  <span>   <div class="example" id="">    <p><strong>示例 #2 <span class="function"><strong style="color:#CC7832">preg_replace_callback()</strong></span>示例</strong></p>    <div class="example-contents"><div class="phpcode" style="border-color:gray;background:#232525"><span><span style="color: #000000"><span style="color: #9876AA">&lt;?php<br /></span><span style="color: #FF8000">// 将文本中的年份增加一年.<br /></span><span style="color: #9876AA">$text </span><span style="color: #007700">= </span><span style="color: #DD0000">"April fools day is 04/01/2002\n"</span><span style="color: #007700">;<br /></span><span style="color: #9876AA">$text</span><span style="color: #007700">.= </span><span style="color: #DD0000">"Last christmas was 12/24/2001\n"</span><span style="color: #007700">;<br /></span><span style="color: #FF8000">// 回调函数<br /></span><span style="color: #007700">function </span><span style="color: #9876AA">next_year</span><span style="color: #007700">(</span><span style="color: #9876AA">$matches</span><span style="color: #007700">)<br />{<br />  </span><span style="color: #FF8000">// 通常: $matches[0]是完成的匹配<br />  // $matches[1]是第一个捕获子组的匹配<br />  // 以此类推<br />  </span><span style="color: #007700">return </span><span style="color: #9876AA">$matches</span><span style="color: #007700">[</span><span style="color: #9876AA">1</span><span style="color: #007700">].(</span><span style="color: #9876AA">$matches</span><span style="color: #007700">[</span><span style="color: #9876AA">2</span><span style="color: #007700">]+</span><span style="color: #9876AA">1</span><span style="color: #007700">);<br />}<br />echo </span><span style="color: #9876AA">preg_replace_callback</span><span style="color: #007700">(<br />            </span><span style="color: #DD0000">"|(\d{2}/\d{2}/)(\d{4})|"</span><span style="color: #007700">,<br />            </span><span style="color: #DD0000">"next_year"</span><span style="color: #007700">,<br />            </span><span style="color: #9876AA">$text</span><span style="color: #007700">);<br /><br /></span><span style="color: #9876AA">?&gt;</span></span></span></div>    </div>    <div class="example-contents"><p>以上示例会输出：</p></div>    <div class="example-contents screen" style="color:AFB1B3;background:black;padding-left:5px;"><div class="cdata"><span>April fools day is 04/01/2003<br>Last christmas was 12/24/2002<br></span></div>    </div>   </div>  </span>  <p class="para">   <div class="example" id="">    <p><strong>示例 #3 <span class="function"><strong style="color:#CC7832">preg_replace_callback()</strong></span> 使用递归构造处理 BB 码的封装</strong></p>    <div class="example-contents"><div class="phpcode" style="border-color:gray;background:#232525"><span><span style="color: #000000"><span style="color: #9876AA">&lt;?php<br />$input </span><span style="color: #007700">= </span><span style="color: #DD0000">"plain [indent] deep [indent] deeper [/indent] deep [/indent] plain"</span><span style="color: #007700">;<br /><br />function </span><span style="color: #9876AA">parseTagsRecursive</span><span style="color: #007700">(</span><span style="color: #9876AA">$input</span><span style="color: #007700">)<br />{<br />     </span><span style="color: #FF8000">// 译注: 对此正则表达式分段分析<br />     * 首尾两个#是正则分隔符<br />     * \[indent] 匹配一个原文的[indent]<br />     * ((?:[^[]|\[(?!/?indent])|(?R))+)分析:<br />     *   (?:[^[]|\[(?!/?indent])分析:<br />     *  首先它是一个非捕获子组<br />     *   两个可选路径, 一个是非[字符, 另一个是[字符但后面紧跟着不是/indent或indent.<br />     *   (?R) 正则表达式递归<br />     *     \[/indent] 匹配结束的[/indent]<br />     * /<br /><br />    $regex = '#\[indent]((?:[^[]|\[(?!/?indent])|(?R))+)\[/indent]#';<br /><br />    if (is_array($input)) {<br />        $input = '&lt;div style="margin-left: 10px"&gt;'.$input[1].'&lt;/div&gt;';<br />    }<br /><br />    return preg_replace_callback($regex, 'parseTagsRecursive', $input);<br />}<br /><br />$output = parseTagsRecursive($input);<br /><br />echo $output;<br />?&gt;</span></span></span></div>    </div>   </div>  </p> </div> <br></br><div style="BORDER-TOP: gray 1px dashed; OVERFLOW: hidden; HEIGHT: 1px"></div><div class="refsect1 seealso" id="refsect1-function.preg-replace-callback-seealso">  <h3 class="title">参见</h3>  <span>   <ul class="simplelist">    <li class="member"><a href="https://www.php.net/manual/zh/pcre.pattern.php" class="link">PCRE 模式</a></li>    <li class="member"><span class="function">{@link preg_replace_callback_array()} - Perform a regular expression search and replace using callbacks</span></li>    <li class="member"><span class="function">{@link preg_quote()} - 转义正则表达式字符</span></li>    <li class="member"><span class="function">{@link preg_replace()} - 执行一个正则表达式的搜索和替换</span></li>    <li class="member"><span class="function">{@link preg_last_error()} - 返回最后一个PCRE正则执行产生的错误代码</span></li>    <li class="member"><a href="https://www.php.net/manual/zh/functions.anonymous.php" class="link">匿名函数</a></li>   </ul>  </span> </div></div>