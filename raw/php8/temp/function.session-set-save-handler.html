<div id="function.session-set-save-handler" class="refentry"> <div class="refnamediv">  <h1 class="refname">session_set_save_handler</h1>  <p class="verinfo">(PHP 4, PHP 5, PHP 7, PHP 8)</p><p class="refpurpose"><span class="refname">session_set_save_handler</span> &mdash; <span class="dc-title">设置用户自定义会话存储函数</span></p> </div> <br></br><div style="BORDER-TOP: gray 1px dashed; OVERFLOW: hidden; HEIGHT: 1px"></div><div class="refsect1 description" id="refsect1-function.session-set-save-handler-description">  <h3 class="title">说明</h3>  <div class="methodsynopsis dc-description">   <span class="methodname" style="color:#CC7832"><strong>session_set_save_handler</strong></span>(<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="methodparam"><span class="type" style="color:#EAB766"><a href="https://www.php.net/manual/zh/language.types.callable.php" class="type callable" style="color:#EAB766">callable</a></span> <span class="parameter" style="color:#3A95FF">$open</span></span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="methodparam"><span class="type" style="color:#EAB766"><a href="https://www.php.net/manual/zh/language.types.callable.php" class="type callable" style="color:#EAB766">callable</a></span> <span class="parameter" style="color:#3A95FF">$close</span></span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="methodparam"><span class="type" style="color:#EAB766"><a href="https://www.php.net/manual/zh/language.types.callable.php" class="type callable" style="color:#EAB766">callable</a></span> <span class="parameter" style="color:#3A95FF">$read</span></span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="methodparam"><span class="type" style="color:#EAB766"><a href="https://www.php.net/manual/zh/language.types.callable.php" class="type callable" style="color:#EAB766">callable</a></span> <span class="parameter" style="color:#3A95FF">$write</span></span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="methodparam"><span class="type" style="color:#EAB766"><a href="https://www.php.net/manual/zh/language.types.callable.php" class="type callable" style="color:#EAB766">callable</a></span> <span class="parameter" style="color:#3A95FF">$destroy</span></span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="methodparam"><span class="type" style="color:#EAB766"><a href="https://www.php.net/manual/zh/language.types.callable.php" class="type callable" style="color:#EAB766">callable</a></span> <span class="parameter" style="color:#3A95FF">$gc</span></span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="methodparam"><span class="type" style="color:#EAB766"><a href="https://www.php.net/manual/zh/language.types.callable.php" class="type callable" style="color:#EAB766">callable</a></span> <span class="parameter" style="color:#3A95FF">$create_sid</span><span class="initializer"> = ?</span></span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="methodparam"><span class="type" style="color:#EAB766"><a href="https://www.php.net/manual/zh/language.types.callable.php" class="type callable" style="color:#EAB766">callable</a></span> <span class="parameter" style="color:#3A95FF">$validate_sid</span><span class="initializer"> = ?</span></span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="methodparam"><span class="type" style="color:#EAB766"><a href="https://www.php.net/manual/zh/language.types.callable.php" class="type callable" style="color:#EAB766">callable</a></span> <span class="parameter" style="color:#3A95FF">$update_timestamp</span><span class="initializer"> = ?</span></span><br>): <span class="type" style="color:#EAB766">bool</span></div>  <p class="para rdfs-comment">   可以使用下面的方式来注册自定义会话存储函数：  </p>  <div class="methodsynopsis dc-description"><span class="methodname" style="color:#CC7832"><strong>session_set_save_handler</strong></span>(<span class="methodparam"><span class="type" style="color:#EAB766">object</span> <span class="parameter" style="color:#3A95FF">$sessionhandler</span></span>, <span class="methodparam"><span class="type" style="color:#EAB766">bool</span> <span class="parameter" style="color:#3A95FF">$register_shutdown</span><span class="initializer"> = <strong><span>true</span></strong></span></span>): <span class="type" style="color:#EAB766">bool</span></div>  <p class="para rdfs-comment">   <span class="function"><strong style="color:#CC7832">session_set_save_handler()</strong></span> 设置用户自定义   会话存储函数。   如果想使用 PHP 内置的会话存储机制之外的方式，   可以使用本函数。   例如，可以自定义会话存储函数来将会话数据存储到数据库。  </p> </div> <br></br><div style="BORDER-TOP: gray 1px dashed; OVERFLOW: hidden; HEIGHT: 1px"></div><div class="refsect1 parameters" id="refsect1-function.session-set-save-handler-parameters">  <h3 class="title">参数</h3>  <span>   本函数有 2 种原型：   <dl>         <dt><span class="parameter" style="color:#3A95FF">sessionhandler</span></dt>     <dd>      <p class="para">       实现了       <span class="interfacename"><a href="https://www.php.net/manual/zh/class.sessionhandlerinterface.php" class="interfacename">SessionHandlerInterface</a></span>，       <span class="interfacename"><a href="https://www.php.net/manual/zh/class.sessionidinterface.php" class="interfacename">SessionIdInterface</a></span>（可选） 和/或       <span class="interfacename"><a href="https://www.php.net/manual/zh/class.sessionupdatetimestamphandlerinterface.php" class="interfacename">SessionUpdateTimestampHandlerInterface</a></span>       接口的对象，       例如 <span class="classname"><a href="https://www.php.net/manual/zh/class.sessionhandler.php" class="classname">SessionHandler</a></span>。      </p>     </dd>             <dt><span class="parameter" style="color:#3A95FF">register_shutdown</span></dt>     <dd>      <p class="para">       将函数 <span class="function">{@link session_write_close()}</span> 注册为       <span class="function">{@link register_shutdown_function()}</span> 函数。      </p>     </dd>       </dl>   或者   <dl>         <dt><span class="parameter" style="color:#3A95FF">open(string $savePath, string $sessionName)</span></dt>     <dd>      <p class="para">       实现了以下签名的 callable 回调：       <div class="methodsynopsis dc-description"><span class="methodname" style="color:#CC7832"><span class="replaceable">open</span></span>(<span class="methodparam"><span class="type" style="color:#EAB766">string</span> <span class="parameter" style="color:#3A95FF">$savePath</span></span>, <span class="methodparam"><span class="type" style="color:#EAB766">string</span> <span class="parameter" style="color:#3A95FF">$sessionName</span></span>): <span class="type" style="color:#EAB766">bool</span></div>      </p>      <p class="para">       open 回调函数类似于类的构造函数，       在会话打开的时候会被调用。       这是自动开始会话或者通过调用 <span class="function">{@link session_start()}</span> 手动开始会话       之后第一个被调用的回调函数。       此回调函数操作成功返回 <strong><span>true</span></strong>，反之返回 <strong><span>false</span></strong>。      </p>     </dd>             <dt><span class="parameter" style="color:#3A95FF">close</span></dt>     <dd>      <p class="para">       close 回调函数类似于类的析构函数。       在 write 回调函数调用之后调用。       当调用 <span class="function">{@link session_write_close()}</span> 函数之后，也会调用 close 回调函数。       此回调函数操作成功返回 <strong><span>true</span></strong>，反之返回 <strong><span>false</span></strong>。      </p>     </dd>             <dt><span class="parameter" style="color:#3A95FF">read</span></dt>     <dd>      <p class="para">       实现了以下签名的 callable 回调：       <div class="methodsynopsis dc-description"><span class="methodname" style="color:#CC7832"><span class="replaceable">read</span></span>(<span class="methodparam"><span class="type" style="color:#EAB766">string</span> <span class="parameter" style="color:#3A95FF">$sessionId</span></span>): <span class="type" style="color:#EAB766">string</span></div>      </p>      <p class="para">       如果会话中有数据，read 回调函数必须返回将会话数据编码（序列化）后的字符串。       如果会话中没有数据，read 回调函数返回空字符串。      </p>      <p class="para">       在自动开始会话或者通过调用       <span class="function">{@link session_start()}</span> 函数手动开始会话之后，PHP 内部调用 read 回调函数来获取会话数据。       在调用 read 之前，PHP 会调用 open 回调函数。      </p>      <p class="para">       read 回调返回的序列化之后的字符串格式必须与 <span class="parameter" style="color:#3A95FF">write</span> 回调函数保存数据时的格式完全一致。       PHP 会自动反序列化返回的字符串并填充 <var class="varname"><a href="https://www.php.net/manual/zh/reserved.variables.session.php" class="classname">$_SESSION</a></var> 超级全局变量。       虽然数据看起来和 <span class="function">{@link serialize()}</span> 函数很相似，       但是需要提醒的是，它们是不同的。       请参考： <a href="https://www.php.net/manual/zh/session.configuration.php#ini.session.serialize-handler" class="link">session.serialize_handler</a>。      </p>     </dd>             <dt><span class="parameter" style="color:#3A95FF">write</span></dt>     <dd>      <p class="para">       实现了以下签名的 callable 回调：       <div class="methodsynopsis dc-description"><span class="methodname" style="color:#CC7832"><span class="replaceable">write</span></span>(<span class="methodparam"><span class="type" style="color:#EAB766">string</span> <span class="parameter" style="color:#3A95FF">$sessionId</span></span>, <span class="methodparam"><span class="type" style="color:#EAB766">string</span> <span class="parameter" style="color:#3A95FF">$data</span></span>): <span class="type" style="color:#EAB766">bool</span></div>      </p>      <p class="para">       在会话保存数据时会调用 <span class="parameter" style="color:#3A95FF">write</span> 回调函数。       此回调函数接收当前会话 ID 以及 <var class="varname"><a href="https://www.php.net/manual/zh/reserved.variables.session.php" class="classname">$_SESSION</a></var> 中数据序列化之后的字符串作为参数。       序列化会话数据的过程由 PHP 根据 <a href="https://www.php.net/manual/zh/session.configuration.php#ini.session.serialize-handler" class="link">session.serialize_handler</a> 设定值来完成。      </p>      <p class="para">       序列化后的数据将和会话 ID 关联在一起进行保存。       当调用 <span class="parameter" style="color:#3A95FF">read</span> 回调函数获取数据时，所返回的数据必须要和       传入 <span class="parameter" style="color:#3A95FF">write</span> 回调函数的数据完全保持一致。      </p>      <p class="para">       PHP 会在脚本执行完毕或调用 <span class="function">{@link session_write_close()}</span> 函数之后调用此回调函数。       注意，在调用完此回调函数之后，PHP 内部会调用 <span class="parameter" style="color:#3A95FF">close</span> 回调函数。       <blockquote class="note" style="border:1px gray solid"><p><strong class="note" style="border:1px gray solid">注意</strong>:         <p class="para">         PHP 会在输出流写入完毕并且关闭之后         才调用 write 回调函数，         所以在 write 回调函数中的调试信息不会输出到浏览器中。         如果需要在 write 回调函数中使用调试输出，         建议将调试输出写入到文件。        </p>       </p></blockquote>      </p>     </dd>             <dt><span class="parameter" style="color:#3A95FF">destroy</span></dt>     <dd>      <p class="para">       实现了以下签名的 callable 回调：       <div class="methodsynopsis dc-description">        <span class="methodname" style="color:#CC7832"><span class="replaceable">destroy</span></span>(<span class="methodparam"><span class="type" style="color:#EAB766">string</span> <span class="parameter" style="color:#3A95FF">$sessionId</span></span>): <span class="type" style="color:#EAB766">bool</span></div>      </p>      <p class="para">       当调用 <span class="function">{@link session_destroy()}</span> 函数，       或者调用  <span class="function">{@link session_regenerate_id()}</span> 函数并且设置 destroy 参数为 <strong><span>true</span></strong> 时，       会调用此回调函数。此回调函数操作成功返回 <strong><span>true</span></strong>，反之返回 <strong><span>false</span></strong>。      </p>     </dd>             <dt><span class="parameter" style="color:#3A95FF">gc</span></dt>     <dd>      <p class="para">       实现了以下签名的 callable 回调：       <div class="methodsynopsis dc-description"><span class="methodname" style="color:#CC7832"><span class="replaceable">gc</span></span>(<span class="methodparam"><span class="type" style="color:#EAB766">int</span> <span class="parameter" style="color:#3A95FF">$lifetime</span></span>): <span class="type" style="color:#EAB766">bool</span></div>      </p>      <p class="para">       为了清理会话中的旧数据，PHP 会不时的调用垃圾收集回调函数。       调用周期由 <a href="https://www.php.net/manual/zh/session.configuration.php#ini.session.gc-probability" class="link">session.gc_probability</a>        和 <a href="https://www.php.net/manual/zh/session.configuration.php#ini.session.gc-divisor" class="link">session.gc_divisor</a> 参数控制。       传入到此回调函数的 lifetime 参数由 <a href="https://www.php.net/manual/zh/session.configuration.php#ini.session.gc-maxlifetime" class="link">session.gc_maxlifetime</a> 设置。       此回调函数操作成功返回 <strong><span>true</span></strong>，反之返回 <strong><span>false</span></strong>。      </p>     </dd>                <dt><span class="parameter" style="color:#3A95FF">create_sid</span></dt>     <dd>      <p class="para">       实现了以下签名的 callable 回调：       <div class="methodsynopsis dc-description"><span class="methodname" style="color:#CC7832"><span class="replaceable">create_sid</span></span>(): <span class="type" style="color:#EAB766">string</span></div>      </p>      <p class="para">       需要新的会话 ID 时，执行此回调函数。       它被调用时不会传入参数，其返回值应该是一个字符串格式的、有效的 session ID。      </p>     </dd>             <dt><span class="parameter" style="color:#3A95FF">validate_sid</span></dt>     <dd>      <p class="para">       实现了以下签名的 callable 回调：       <div class="methodsynopsis dc-description"><span class="methodname" style="color:#CC7832"><span class="replaceable">validate_sid</span></span>(<span class="methodparam"><span class="type" style="color:#EAB766">string</span> <span class="parameter" style="color:#3A95FF">$key</span></span>): <span class="type" style="color:#EAB766">bool</span></div>      </p>      <p class="para">       开启 <a href="https://www.php.net/manual/zh/session.configuration.php#ini.session.use-strict-mode" class="link">session.use_strict_mode</a> 后，       当启动一个 session 时，提供了 session ID 后会执行此回调。       参数 <span class="parameter" style="color:#3A95FF">key</span> 是待验证的 session ID。       如果该 ID 的 session 已经存在，则为有效 session ID。       成功时返回值应当为 <strong><span>true</span></strong>，失败时为 <strong><span>false</span></strong>。      </p>     </dd>             <dt><span class="parameter" style="color:#3A95FF">update_timestamp</span></dt>     <dd>      <p class="para">       实现了以下签名的 callable 回调：       <div class="methodsynopsis dc-description"><span class="methodname" style="color:#CC7832"><span class="replaceable">update_timestamp</span></span>(<span class="methodparam"><span class="type" style="color:#EAB766">string</span> <span class="parameter" style="color:#3A95FF">$key</span></span>, <span class="methodparam"><span class="type" style="color:#EAB766">string</span> <span class="parameter" style="color:#3A95FF">$val</span></span>): <span class="type" style="color:#EAB766">bool</span></div>      </p>      <p class="para">       更新 session 时执行此回调。       参数 <span class="parameter" style="color:#3A95FF">key</span> 是 session ID；参数 <span class="parameter" style="color:#3A95FF">val</span> 是 session 的数据。       成功时返回值应当为 <strong><span>true</span></strong>，失败时为 <strong><span>false</span></strong>。      </p>     </dd>       </dl>  </span> </div> <br></br><div style="BORDER-TOP: gray 1px dashed; OVERFLOW: hidden; HEIGHT: 1px"></div><div class="refsect1 returnvalues" id="refsect1-function.session-set-save-handler-returnvalues">  <h3 class="title">返回值</h3>  <p class="para">   成功时返回 <strong><span>true</span></strong>， 或者在失败时返回 <strong><span>false</span></strong>。  </p> </div> <br></br><div style="BORDER-TOP: gray 1px dashed; OVERFLOW: hidden; HEIGHT: 1px"></div><div class="refsect1 examples" id="refsect1-function.session-set-save-handler-examples">  <h3 class="title">示例</h3>  <span>   <div class="example" id="">    <p><strong>示例 #1      自定义会话处理程序：完整代码请参见 <span class="classname"><a href="https://www.php.net/manual/zh/class.sessionhandlerinterface.php" class="classname">SessionHandlerInterface</a></span>。    </strong></p>    <div class="example-contents"><p>     这里仅列出了调用方式，完整代码请参见 <span class="classname"><a href="https://www.php.net/manual/zh/class.sessionhandlerinterface.php" class="classname">SessionHandlerInterface</a></span>。    </p></div>    <div class="example-contents"><p>     这里使用了 <span class="function"><strong style="color:#CC7832">session_set_save_handler()</strong></span> 函数的 OOP 原型     并且使用第二个参数来注册 shutdown 函数。     当将对象注册为会话保存处理程序时，建议使用这种方式。    </p></div>    <div class="example-contents"><div class="phpcode" style="border-color:gray;background:#232525"><span><span style="color: #000000"><span style="color: #9876AA">&lt;?php<br /></span><span style="color: #007700">class </span><span style="color: #9876AA">MySessionHandler </span><span style="color: #007700">implements </span><span style="color: #9876AA">SessionHandlerInterface<br /></span><span style="color: #007700">{<br />    </span><span style="color: #FF8000">// 在这里实现接口<br /></span><span style="color: #007700">}<br /><br /></span><span style="color: #9876AA">$handler </span><span style="color: #007700">= new </span><span style="color: #9876AA">MySessionHandler</span><span style="color: #007700">();<br /></span><span style="color: #9876AA">session_set_save_handler</span><span style="color: #007700">(</span><span style="color: #9876AA">$handler</span><span style="color: #007700">, </span><span style="color: #9876AA">true</span><span style="color: #007700">);<br /></span><span style="color: #9876AA">session_start</span><span style="color: #007700">();<br /><br /></span><span style="color: #FF8000">// 现在可以使用 $_SESSION 保存以及获取数据了</span></span></span></div>    </div>   </div>  </span> </div> <br></br><div style="BORDER-TOP: gray 1px dashed; OVERFLOW: hidden; HEIGHT: 1px"></div><div class="refsect1 notes" id="refsect1-function.session-set-save-handler-notes">  <h3 class="title">注释</h3>  <div class="warning"><strong class="warning">警告</strong>   <p class="para">    在对象销毁之后才会调用    <span class="parameter" style="color:#3A95FF">write</span> 和 <span class="parameter" style="color:#3A95FF">close</span> 回调函数，    所以，在这两个回调函数中不可以使用对象，也不可以抛出异常。    如果在函数中抛出异常，PHP 既不会捕获它，也不会跟踪它，    这样会导致程序异常终止。    但是对象析构函数可以使用会话。   </p>   <p class="para">    可以在析构函数中调用  <span class="function">{@link session_write_close()}</span>      函数来解决这个问题。    但是注册 shutdown 回调函数才是更加可靠的做法。   </p>  </div>  <div class="warning"><strong class="warning">警告</strong>   <p class="para">    如果会话在脚本结束后关闭，对于某些 SAPI 而言，当前工作目录可能已经被改变。    可以调用 <span class="function">{@link session_write_close()}</span>     函数在脚本执行结束之前关闭会话。   </p>  </div> </div> <br></br><div style="BORDER-TOP: gray 1px dashed; OVERFLOW: hidden; HEIGHT: 1px"></div><div class="refsect1 seealso" id="refsect1-function.session-set-save-handler-seealso">  <h3 class="title">参见</h3>  <span>   <ul class="simplelist">    <li class="member">     <a href="https://www.php.net/manual/zh/session.configuration.php#ini.session.save-handler" class="link">session.save_handler</a>     配置指示    </li>    <li class="member">     <a href="https://www.php.net/manual/zh/session.configuration.php#ini.session.serialize-handler" class="link">session.serialize_handler</a>     配置指示    </li>    <li class="member"><span class="function">{@link register_shutdown_function()} - 注册在关闭时执行的函数</span></li>    <li class="member"><span class="function">{@link session_register_shutdown()} - 关闭会话</span></li>    <li class="member">     完整的实现请参考      <a href="https://www.php.net/manual/zh/https://github.com/php/php-src/blob/master/ext/session/tests/save_handler.inc" class="link external">&raquo;&nbsp;save_handler.inc</a>。    </li>   </ul>  </span> </div></div>