<div id="ev.examples" class="chapter"> <h1>示例</h1> <div class="example" id="">  <p><strong>示例 #1 Simple timers</strong></p>  <div class="example-contents"><div class="phpcode" style="border-color:gray;background:#232525"><span><span style="color: #000000"><span style="color: #9876AA">&lt;?php<br /></span><span style="color: #FF8000">// Create and start timer firing after 2 seconds<br /></span><span style="color: #9876AA">$w1 </span><span style="color: #007700">= new </span><span style="color: #9876AA">EvTimer</span><span style="color: #007700">(</span><span style="color: #9876AA">2</span><span style="color: #007700">, </span><span style="color: #9876AA">0</span><span style="color: #007700">, function () {<br />    echo </span><span style="color: #DD0000">"2 seconds elapsed\n"</span><span style="color: #007700">;<br />});<br /><br /></span><span style="color: #FF8000">// Create and launch timer firing after 2 seconds repeating each second<br />// until we manually stop it<br /></span><span style="color: #9876AA">$w2 </span><span style="color: #007700">= new </span><span style="color: #9876AA">EvTimer</span><span style="color: #007700">(</span><span style="color: #9876AA">2</span><span style="color: #007700">, </span><span style="color: #9876AA">1</span><span style="color: #007700">, function (</span><span style="color: #9876AA">$w</span><span style="color: #007700">) {<br />    echo </span><span style="color: #DD0000">"is called every second, is launched after 2 seconds\n"</span><span style="color: #007700">;<br />    echo </span><span style="color: #DD0000">"iteration = "</span><span style="color: #007700">, </span><span style="color: #9876AA">Ev</span><span style="color: #007700">::</span><span style="color: #9876AA">iteration</span><span style="color: #007700">(), </span><span style="color: #9876AA">PHP_EOL</span><span style="color: #007700">;<br /><br />    </span><span style="color: #FF8000">// Stop the watcher after 5 iterations<br />    </span><span style="color: #9876AA">Ev</span><span style="color: #007700">::</span><span style="color: #9876AA">iteration</span><span style="color: #007700">() == </span><span style="color: #9876AA">5 </span><span style="color: #007700">and </span><span style="color: #9876AA">$w</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">stop</span><span style="color: #007700">();<br />    </span><span style="color: #FF8000">// Stop the watcher if further calls cause more than 10 iterations<br />    </span><span style="color: #9876AA">Ev</span><span style="color: #007700">::</span><span style="color: #9876AA">iteration</span><span style="color: #007700">() &gt;= </span><span style="color: #9876AA">10 </span><span style="color: #007700">and </span><span style="color: #9876AA">$w</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">stop</span><span style="color: #007700">();<br />});<br /><br /></span><span style="color: #FF8000">// Create stopped timer. It will be inactive until we start it ourselves<br /></span><span style="color: #9876AA">$w_stopped </span><span style="color: #007700">= </span><span style="color: #9876AA">EvTimer</span><span style="color: #007700">::</span><span style="color: #9876AA">createStopped</span><span style="color: #007700">(</span><span style="color: #9876AA">10</span><span style="color: #007700">, </span><span style="color: #9876AA">5</span><span style="color: #007700">, function(</span><span style="color: #9876AA">$w</span><span style="color: #007700">) {<br />    echo </span><span style="color: #DD0000">"Callback of a timer created as stopped\n"</span><span style="color: #007700">;<br /><br />    </span><span style="color: #FF8000">// Stop the watcher after 2 iterations<br />    </span><span style="color: #9876AA">Ev</span><span style="color: #007700">::</span><span style="color: #9876AA">iteration</span><span style="color: #007700">() &gt;= </span><span style="color: #9876AA">2 </span><span style="color: #007700">and </span><span style="color: #9876AA">$w</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">stop</span><span style="color: #007700">();<br />});<br /><br /></span><span style="color: #FF8000">// Loop until Ev::stop() is called or all of watchers stop<br /></span><span style="color: #9876AA">Ev</span><span style="color: #007700">::</span><span style="color: #9876AA">run</span><span style="color: #007700">();<br /><br /></span><span style="color: #FF8000">// Start and look if it works<br /></span><span style="color: #9876AA">$w_stopped</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">start</span><span style="color: #007700">();<br />echo </span><span style="color: #DD0000">"Run single iteration\n"</span><span style="color: #007700">;<br /></span><span style="color: #9876AA">Ev</span><span style="color: #007700">::</span><span style="color: #9876AA">run</span><span style="color: #007700">(</span><span style="color: #9876AA">Ev</span><span style="color: #007700">::</span><span style="color: #9876AA">RUN_ONCE</span><span style="color: #007700">);<br /><br />echo </span><span style="color: #DD0000">"Restart the second watcher and try to handle the same events, but don't block\n"</span><span style="color: #007700">;<br /></span><span style="color: #9876AA">$w2</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">again</span><span style="color: #007700">();<br /></span><span style="color: #9876AA">Ev</span><span style="color: #007700">::</span><span style="color: #9876AA">run</span><span style="color: #007700">(</span><span style="color: #9876AA">Ev</span><span style="color: #007700">::</span><span style="color: #9876AA">RUN_NOWAIT</span><span style="color: #007700">);<br /><br /></span><span style="color: #9876AA">$w </span><span style="color: #007700">= new </span><span style="color: #9876AA">EvTimer</span><span style="color: #007700">(</span><span style="color: #9876AA">10</span><span style="color: #007700">, </span><span style="color: #9876AA">0</span><span style="color: #007700">, function() {});<br />echo </span><span style="color: #DD0000">"Running a blocking loop\n"</span><span style="color: #007700">;<br /></span><span style="color: #9876AA">Ev</span><span style="color: #007700">::</span><span style="color: #9876AA">run</span><span style="color: #007700">();<br />echo </span><span style="color: #DD0000">"END\n"</span><span style="color: #007700">;<br /></span><span style="color: #9876AA">?&gt;</span></span></span></div>  </div>  <div class="example-contents"><p>以上示例的输出类似于：</p></div>  <div class="example-contents screen" style="color:AFB1B3;background:black;padding-left:5px;"><div class="cdata"><span>2 seconds elapsed<br>is called every second, is launched after 2 seconds<br>iteration = 1<br>is called every second, is launched after 2 seconds<br>iteration = 2<br>is called every second, is launched after 2 seconds<br>iteration = 3<br>is called every second, is launched after 2 seconds<br>iteration = 4<br>is called every second, is launched after 2 seconds<br>iteration = 5<br>Run single iteration<br>Callback of a timer created as stopped<br>Restart the second watcher and try to handle the same events, but don&#039;t block<br>Running a blocking loop<br>is called every second, is launched after 2 seconds<br>iteration = 8<br>is called every second, is launched after 2 seconds<br>iteration = 9<br>is called every second, is launched after 2 seconds<br>iteration = 10<br>END<br></span></div>  </div> </div> <div class="example" id="">  <p><strong>示例 #2 Periodic timer. Tick each 10.5 seconds</strong></p>  <div class="example-contents"><div class="phpcode" style="border-color:gray;background:#232525"><span><span style="color: #000000"><span style="color: #9876AA">&lt;?php<br />$w </span><span style="color: #007700">= new </span><span style="color: #9876AA">EvPeriodic</span><span style="color: #007700">(</span><span style="color: #9876AA">0.</span><span style="color: #007700">, </span><span style="color: #9876AA">10.5</span><span style="color: #007700">, </span><span style="color: #9876AA">NULL</span><span style="color: #007700">, function (</span><span style="color: #9876AA">$w</span><span style="color: #007700">, </span><span style="color: #9876AA">$revents</span><span style="color: #007700">) {<br />    echo </span><span style="color: #9876AA">time</span><span style="color: #007700">(), </span><span style="color: #9876AA">PHP_EOL</span><span style="color: #007700">;<br />});<br /><br /></span><span style="color: #9876AA">Ev</span><span style="color: #007700">::</span><span style="color: #9876AA">run</span><span style="color: #007700">();<br /></span><span style="color: #9876AA">?&gt;</span></span></span></div>  </div> </div> <div class="example" id="">  <p><strong>示例 #3 Periodic timer. Use reschedule callback</strong></p>  <div class="example-contents"><div class="phpcode" style="border-color:gray;background:#232525"><span><span style="color: #000000"><span style="color: #9876AA">&lt;?php<br /></span><span style="color: #FF8000">// Tick each 10.5 seconds<br /><br /></span><span style="color: #007700">function </span><span style="color: #9876AA">reschedule_cb </span><span style="color: #007700">(</span><span style="color: #9876AA">$watcher</span><span style="color: #007700">, </span><span style="color: #9876AA">$now</span><span style="color: #007700">) {<br />    return </span><span style="color: #9876AA">$now </span><span style="color: #007700">+ (</span><span style="color: #9876AA">10.5</span><span style="color: #007700">. - </span><span style="color: #9876AA">fmod</span><span style="color: #007700">(</span><span style="color: #9876AA">$now</span><span style="color: #007700">, </span><span style="color: #9876AA">10.5</span><span style="color: #007700">));<br />}<br /><br /></span><span style="color: #9876AA">$w </span><span style="color: #007700">= new </span><span style="color: #9876AA">EvPeriodic</span><span style="color: #007700">(</span><span style="color: #9876AA">0.</span><span style="color: #007700">, </span><span style="color: #9876AA">0.</span><span style="color: #007700">, </span><span style="color: #DD0000">"reschedule_cb"</span><span style="color: #007700">, function (</span><span style="color: #9876AA">$w</span><span style="color: #007700">, </span><span style="color: #9876AA">$revents</span><span style="color: #007700">) {<br />    echo </span><span style="color: #9876AA">time</span><span style="color: #007700">(), </span><span style="color: #9876AA">PHP_EOL</span><span style="color: #007700">;<br />});<br /><br /></span><span style="color: #9876AA">Ev</span><span style="color: #007700">::</span><span style="color: #9876AA">run</span><span style="color: #007700">();<br /></span><span style="color: #9876AA">?&gt;</span></span></span></div>  </div> </div> <div class="example" id="">  <p><strong>示例 #4 Periodic timer. Tick every 10.5 seconds starting at now</strong></p>  <div class="example-contents"><div class="phpcode" style="border-color:gray;background:#232525"><span><span style="color: #000000"><span style="color: #9876AA">&lt;?php<br /></span><span style="color: #FF8000">// Tick every 10.5 seconds starting at now<br /></span><span style="color: #9876AA">$w </span><span style="color: #007700">= new </span><span style="color: #9876AA">EvPeriodic</span><span style="color: #007700">(</span><span style="color: #9876AA">fmod</span><span style="color: #007700">(</span><span style="color: #9876AA">Ev</span><span style="color: #007700">::</span><span style="color: #9876AA">now</span><span style="color: #007700">(), </span><span style="color: #9876AA">10.5</span><span style="color: #007700">), </span><span style="color: #9876AA">10.5</span><span style="color: #007700">, </span><span style="color: #9876AA">NULL</span><span style="color: #007700">, function (</span><span style="color: #9876AA">$w</span><span style="color: #007700">, </span><span style="color: #9876AA">$revents</span><span style="color: #007700">) {<br />    echo </span><span style="color: #9876AA">time</span><span style="color: #007700">(), </span><span style="color: #9876AA">PHP_EOL</span><span style="color: #007700">;<br />});<br /><br /></span><span style="color: #9876AA">Ev</span><span style="color: #007700">::</span><span style="color: #9876AA">run</span><span style="color: #007700">();<br /></span><span style="color: #9876AA">?&gt;</span></span></span></div>  </div> </div> <div class="example" id="">  <p><strong>示例 #5 Wait until STDIN is readable</strong></p>  <div class="example-contents"><div class="phpcode" style="border-color:gray;background:#232525"><span><span style="color: #000000"><span style="color: #9876AA">&lt;?php<br /></span><span style="color: #FF8000">// Wait until STDIN is readable<br /></span><span style="color: #9876AA">$w </span><span style="color: #007700">= new </span><span style="color: #9876AA">EvIo</span><span style="color: #007700">(</span><span style="color: #9876AA">STDIN</span><span style="color: #007700">, </span><span style="color: #9876AA">Ev</span><span style="color: #007700">::</span><span style="color: #9876AA">READ</span><span style="color: #007700">, function (</span><span style="color: #9876AA">$watcher</span><span style="color: #007700">, </span><span style="color: #9876AA">$revents</span><span style="color: #007700">) {<br />    echo </span><span style="color: #DD0000">"STDIN is readable\n"</span><span style="color: #007700">;<br />});<br /><br /></span><span style="color: #9876AA">Ev</span><span style="color: #007700">::</span><span style="color: #9876AA">run</span><span style="color: #007700">(</span><span style="color: #9876AA">Ev</span><span style="color: #007700">::</span><span style="color: #9876AA">RUN_ONCE</span><span style="color: #007700">);<br /></span><span style="color: #9876AA">?&gt;</span></span></span></div>  </div> </div> <div class="example" id="">  <p><strong>示例 #6 Use some async I/O to access a socket</strong></p>  <div class="example-contents"><div class="phpcode" style="border-color:gray;background:#232525"><span><span style="color: #000000"><span style="color: #9876AA">&lt;?php<br /></span><span style="color: #FF8000">// Use some async I/O to access a socket <br /><br />// `sockets' extension still logs warnings<br />// for EINPROGRESS, EAGAIN/EWOULDBLOCK etc.<br /></span><span style="color: #9876AA">error_reporting</span><span style="color: #007700">(</span><span style="color: #9876AA">E_ERROR</span><span style="color: #007700">);<br /><br /></span><span style="color: #9876AA">$e_nonblocking </span><span style="color: #007700">= array (</span><span style="color: #FF8000">//EAGAIN or EWOULDBLOCK</span><span style="color: #9876AA">11</span><span style="color: #007700">, </span><span style="color: #FF8000">//EINPROGRESS</span><span style="color: #9876AA">115</span><span style="color: #007700">);<br /><br /></span><span style="color: #FF8000">// Get the port for the WWW service<br /></span><span style="color: #9876AA">$service_port </span><span style="color: #007700">= </span><span style="color: #9876AA">getservbyname</span><span style="color: #007700">(</span><span style="color: #DD0000">'www'</span><span style="color: #007700">, </span><span style="color: #DD0000">'tcp'</span><span style="color: #007700">);<br /><br /></span><span style="color: #FF8000">// Get the IP address for the target host<br /></span><span style="color: #9876AA">$address </span><span style="color: #007700">= </span><span style="color: #9876AA">gethostbyname</span><span style="color: #007700">(</span><span style="color: #DD0000">'google.co.uk'</span><span style="color: #007700">);<br /><br /></span><span style="color: #FF8000">// Create a TCP/IP socket<br /></span><span style="color: #9876AA">$socket </span><span style="color: #007700">= </span><span style="color: #9876AA">socket_create</span><span style="color: #007700">(</span><span style="color: #9876AA">AF_INET</span><span style="color: #007700">, </span><span style="color: #9876AA">SOCK_STREAM</span><span style="color: #007700">, </span><span style="color: #9876AA">SOL_TCP</span><span style="color: #007700">);<br />if (</span><span style="color: #9876AA">$socket </span><span style="color: #007700">=== </span><span style="color: #9876AA">FALSE</span><span style="color: #007700">) {<br />    echo </span><span style="color: #DD0000">"socket_create() failed: reason: "<br />        </span><span style="color: #007700">.</span><span style="color: #9876AA">socket_strerror</span><span style="color: #007700">(</span><span style="color: #9876AA">socket_last_error</span><span style="color: #007700">()) . </span><span style="color: #DD0000">"\n"</span><span style="color: #007700">;<br />}<br /><br /></span><span style="color: #FF8000">// Set O_NONBLOCK flag<br /></span><span style="color: #9876AA">socket_set_nonblock</span><span style="color: #007700">(</span><span style="color: #9876AA">$socket</span><span style="color: #007700">);<br /><br /></span><span style="color: #FF8000">// Abort on timeout<br /></span><span style="color: #9876AA">$timeout_watcher </span><span style="color: #007700">= new </span><span style="color: #9876AA">EvTimer</span><span style="color: #007700">(</span><span style="color: #9876AA">10.0</span><span style="color: #007700">, </span><span style="color: #9876AA">0.</span><span style="color: #007700">, function () use (</span><span style="color: #9876AA">$socket</span><span style="color: #007700">) {<br />    </span><span style="color: #9876AA">socket_close</span><span style="color: #007700">(</span><span style="color: #9876AA">$socket</span><span style="color: #007700">);<br />    </span><span style="color: #9876AA">Ev</span><span style="color: #007700">::</span><span style="color: #9876AA">stop</span><span style="color: #007700">(</span><span style="color: #9876AA">Ev</span><span style="color: #007700">::</span><span style="color: #9876AA">BREAK_ALL</span><span style="color: #007700">);<br />});<br /><br /></span><span style="color: #FF8000">// Make HEAD request when the socket is writable<br /></span><span style="color: #9876AA">$write_watcher </span><span style="color: #007700">= new </span><span style="color: #9876AA">EvIo</span><span style="color: #007700">(</span><span style="color: #9876AA">$socket</span><span style="color: #007700">, </span><span style="color: #9876AA">Ev</span><span style="color: #007700">::</span><span style="color: #9876AA">WRITE</span><span style="color: #007700">, function (</span><span style="color: #9876AA">$w</span><span style="color: #007700">)<br />    use (</span><span style="color: #9876AA">$socket</span><span style="color: #007700">, </span><span style="color: #9876AA">$timeout_watcher</span><span style="color: #007700">, </span><span style="color: #9876AA">$e_nonblocking</span><span style="color: #007700">)<br />{<br />    </span><span style="color: #FF8000">// Stop timeout watcher<br />    </span><span style="color: #9876AA">$timeout_watcher</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">stop</span><span style="color: #007700">();<br />    </span><span style="color: #FF8000">// Stop write watcher<br />    </span><span style="color: #9876AA">$w</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">stop</span><span style="color: #007700">();<br /><br />    </span><span style="color: #9876AA">$in </span><span style="color: #007700">= </span><span style="color: #DD0000">"HEAD / HTTP/1.1\r\n"</span><span style="color: #007700">;<br />    </span><span style="color: #9876AA">$in </span><span style="color: #007700">.= </span><span style="color: #DD0000">"Host: google.co.uk\r\n"</span><span style="color: #007700">;<br />    </span><span style="color: #9876AA">$in </span><span style="color: #007700">.= </span><span style="color: #DD0000">"Connection: Close\r\n\r\n"</span><span style="color: #007700">;<br /><br />    if (!</span><span style="color: #9876AA">socket_write</span><span style="color: #007700">(</span><span style="color: #9876AA">$socket</span><span style="color: #007700">, </span><span style="color: #9876AA">$in</span><span style="color: #007700">, </span><span style="color: #9876AA">strlen</span><span style="color: #007700">(</span><span style="color: #9876AA">$in</span><span style="color: #007700">))) {<br />        </span><span style="color: #9876AA">trigger_error</span><span style="color: #007700">(</span><span style="color: #DD0000">"Failed writing </span><span style="color: #9876AA">$in</span><span style="color: #DD0000"> to socket"</span><span style="color: #007700">, </span><span style="color: #9876AA">E_USER_ERROR</span><span style="color: #007700">);<br />    }<br /><br />    </span><span style="color: #9876AA">$read_watcher </span><span style="color: #007700">= new </span><span style="color: #9876AA">EvIo</span><span style="color: #007700">(</span><span style="color: #9876AA">$socket</span><span style="color: #007700">, </span><span style="color: #9876AA">Ev</span><span style="color: #007700">::</span><span style="color: #9876AA">READ</span><span style="color: #007700">, function (</span><span style="color: #9876AA">$w</span><span style="color: #007700">, </span><span style="color: #9876AA">$re</span><span style="color: #007700">)<br />        use (</span><span style="color: #9876AA">$socket</span><span style="color: #007700">, </span><span style="color: #9876AA">$e_nonblocking</span><span style="color: #007700">)<br />    {<br />        </span><span style="color: #FF8000">// Socket is readable. recv() 20 bytes using non-blocking mode<br />        </span><span style="color: #9876AA">$ret </span><span style="color: #007700">= </span><span style="color: #9876AA">socket_recv</span><span style="color: #007700">(</span><span style="color: #9876AA">$socket</span><span style="color: #007700">, </span><span style="color: #9876AA">$out</span><span style="color: #007700">, </span><span style="color: #9876AA">20</span><span style="color: #007700">, </span><span style="color: #9876AA">MSG_DONTWAIT</span><span style="color: #007700">);<br /><br />        if (</span><span style="color: #9876AA">$ret</span><span style="color: #007700">) {<br />            echo </span><span style="color: #9876AA">$out</span><span style="color: #007700">;<br />        } elseif (</span><span style="color: #9876AA">$ret </span><span style="color: #007700">=== </span><span style="color: #9876AA">0</span><span style="color: #007700">) {<br />            </span><span style="color: #FF8000">// All read<br />            </span><span style="color: #9876AA">$w</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">stop</span><span style="color: #007700">();<br />            </span><span style="color: #9876AA">socket_close</span><span style="color: #007700">(</span><span style="color: #9876AA">$socket</span><span style="color: #007700">);<br />            return;<br />        }<br /><br />        </span><span style="color: #FF8000">// Caught EINPROGRESS, EAGAIN, or EWOULDBLOCK<br />        </span><span style="color: #007700">if (</span><span style="color: #9876AA">in_array</span><span style="color: #007700">(</span><span style="color: #9876AA">socket_last_error</span><span style="color: #007700">(), </span><span style="color: #9876AA">$e_nonblocking</span><span style="color: #007700">)) {<br />            return;<br />        }<br /><br />        </span><span style="color: #9876AA">$w</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">stop</span><span style="color: #007700">();<br />        </span><span style="color: #9876AA">socket_close</span><span style="color: #007700">(</span><span style="color: #9876AA">$socket</span><span style="color: #007700">);<br />    });<br /><br />    </span><span style="color: #9876AA">Ev</span><span style="color: #007700">::</span><span style="color: #9876AA">run</span><span style="color: #007700">();<br />});<br /><br /></span><span style="color: #9876AA">$result </span><span style="color: #007700">= </span><span style="color: #9876AA">socket_connect</span><span style="color: #007700">(</span><span style="color: #9876AA">$socket</span><span style="color: #007700">, </span><span style="color: #9876AA">$address</span><span style="color: #007700">, </span><span style="color: #9876AA">$service_port</span><span style="color: #007700">);<br /><br /></span><span style="color: #9876AA">Ev</span><span style="color: #007700">::</span><span style="color: #9876AA">run</span><span style="color: #007700">();<br /></span><span style="color: #9876AA">?&gt;</span></span></span></div>  </div>  <div class="example-contents"><p>以上示例的输出类似于：</p></div>  <div class="example-contents screen" style="color:AFB1B3;background:black;padding-left:5px;"><div class="cdata"><span>HTTP/1.1 301 Moved Permanently<br>Location: http://www.google.co.uk/<br>Content-Type: text/html; charset=UTF-8<br>Date: Sun, 23 Dec 2012 16:08:27 GMT<br>Expires: Tue, 22 Jan 2013 16:08:27 GMT<br>Cache-Control: public, max-age=2592000<br>Server: gws<br>Content-Length: 221<br>X-XSS-Protection: 1; mode=block<br>X-Frame-Options: SAMEORIGIN<br>Connection: close<br><br><br></span></div>  </div> </div> <div class="example" id="">  <p><strong>示例 #7 Embedding one loop into another</strong></p>  <div class="example-contents"><div class="phpcode" style="border-color:gray;background:#232525"><span><span style="color: #000000"><span style="color: #9876AA">&lt;?php<br /></span><span style="color: #FF8000">//<br />* Try to get an embeddable event loop and embed it into the default event loop.<br />* If it is impossible, use the default<br />* loop. The default loop is stored in $loop_hi, while the embeddable loop is<br />* stored in $loop_lo(which is $loop_hi in the case no embeddable loop can be<br />* used).<br />*<br />* Sample translated to PHP<br />* http://pod.tst.eu/http://cvs.schmorp.de/libev/ev.pod#Examples_CONTENT-9<br /><br /></span><span style="color: #9876AA">$loop_hi </span><span style="color: #007700">= </span><span style="color: #9876AA">EvLoop</span><span style="color: #007700">::</span><span style="color: #9876AA">defaultLoop</span><span style="color: #007700">();<br /></span><span style="color: #9876AA">$loop_lo </span><span style="color: #007700">= </span><span style="color: #9876AA">NULL</span><span style="color: #007700">;<br /></span><span style="color: #9876AA">$embed   </span><span style="color: #007700">= </span><span style="color: #9876AA">NULL</span><span style="color: #007700">;<br /><br /></span><span style="color: #FF8000">//<br />* See if there is a chance of getting one that works<br />* (flags' value of 0 means autodetection)<br /><br /></span><span style="color: #9876AA">$loop_lo </span><span style="color: #007700">= </span><span style="color: #9876AA">Ev</span><span style="color: #007700">::</span><span style="color: #9876AA">embeddableBackends</span><span style="color: #007700">() &amp; </span><span style="color: #9876AA">Ev</span><span style="color: #007700">::</span><span style="color: #9876AA">recommendedBackends</span><span style="color: #007700">()<br />    ? new </span><span style="color: #9876AA">EvLoop</span><span style="color: #007700">(</span><span style="color: #9876AA">Ev</span><span style="color: #007700">::</span><span style="color: #9876AA">embeddableBackends</span><span style="color: #007700">() &amp; </span><span style="color: #9876AA">Ev</span><span style="color: #007700">::</span><span style="color: #9876AA">recommendedBackends</span><span style="color: #007700">())<br />    : </span><span style="color: #9876AA">0</span><span style="color: #007700">;<br /><br />if (</span><span style="color: #9876AA">$loop_lo</span><span style="color: #007700">) {<br />    </span><span style="color: #9876AA">$embed </span><span style="color: #007700">= new </span><span style="color: #9876AA">EvEmbed</span><span style="color: #007700">(</span><span style="color: #9876AA">$loop_lo</span><span style="color: #007700">, function () {});<br />} else {<br />    </span><span style="color: #9876AA">$loop_lo </span><span style="color: #007700">= </span><span style="color: #9876AA">$loop_hi</span><span style="color: #007700">;<br />}<br /></span><span style="color: #9876AA">?&gt;</span></span></span></div>  </div> </div> <div class="example" id="">  <p><strong>示例 #8 Embedding loop created with kqueue backend into the default loop</strong></p>  <div class="example-contents"><div class="phpcode" style="border-color:gray;background:#232525"><span><span style="color: #000000"><span style="color: #9876AA">&lt;?php<br /></span><span style="color: #FF8000">//<br />* Check if kqueue is available but not recommended and create a kqueue backend<br />* for use with sockets (which usually work with any kqueue implementation).<br />* Store the kqueue/socket-only event loop in loop_socket. (One might optionally<br />* use EVFLAG_NOENV, too)<br />*<br />* Example borrowed from<br />* http://pod.tst.eu/http://cvs.schmorp.de/libev/ev.pod#Examples_CONTENT-9<br /><br /></span><span style="color: #9876AA">$loop        </span><span style="color: #007700">= </span><span style="color: #9876AA">EvLoop</span><span style="color: #007700">::</span><span style="color: #9876AA">defaultLoop</span><span style="color: #007700">();<br /></span><span style="color: #9876AA">$socket_loop </span><span style="color: #007700">= </span><span style="color: #9876AA">NULL</span><span style="color: #007700">;<br /></span><span style="color: #9876AA">$embed       </span><span style="color: #007700">= </span><span style="color: #9876AA">NULL</span><span style="color: #007700">;<br /><br />if (</span><span style="color: #9876AA">Ev</span><span style="color: #007700">::</span><span style="color: #9876AA">supportedBackends</span><span style="color: #007700">() &amp; ~</span><span style="color: #9876AA">Ev</span><span style="color: #007700">::</span><span style="color: #9876AA">recommendedBackends</span><span style="color: #007700">() &amp; </span><span style="color: #9876AA">Ev</span><span style="color: #007700">::</span><span style="color: #9876AA">BACKEND_KQUEUE</span><span style="color: #007700">) {<br />    if ((</span><span style="color: #9876AA">$socket_loop </span><span style="color: #007700">= new </span><span style="color: #9876AA">EvLoop</span><span style="color: #007700">(</span><span style="color: #9876AA">Ev</span><span style="color: #007700">::</span><span style="color: #9876AA">BACKEND_KQUEUE</span><span style="color: #007700">))) {<br />        </span><span style="color: #9876AA">$embed </span><span style="color: #007700">= new </span><span style="color: #9876AA">EvEmbed</span><span style="color: #007700">(</span><span style="color: #9876AA">$loop</span><span style="color: #007700">);<br />    }<br />}<br /><br />if (!</span><span style="color: #9876AA">$socket_loop</span><span style="color: #007700">) {<br />    </span><span style="color: #9876AA">$socket_loop </span><span style="color: #007700">= </span><span style="color: #9876AA">$loop</span><span style="color: #007700">;<br />}<br /><br /></span><span style="color: #FF8000">// Now use $socket_loop for all sockets, and $loop for anything else<br /></span><span style="color: #9876AA">?&gt;</span></span></span></div>  </div> </div> <div class="example" id="">  <p><strong>示例 #9 Handle SIGTERM signal</strong></p>  <div class="example-contents"><div class="phpcode" style="border-color:gray;background:#232525"><span><span style="color: #000000"><span style="color: #9876AA">&lt;?php<br />$w </span><span style="color: #007700">= new </span><span style="color: #9876AA">EvSignal</span><span style="color: #007700">(</span><span style="color: #9876AA">SIGTERM</span><span style="color: #007700">, function (</span><span style="color: #9876AA">$watcher</span><span style="color: #007700">) {<br />    echo </span><span style="color: #DD0000">"SIGTERM received\n"</span><span style="color: #007700">;<br />    </span><span style="color: #9876AA">$watcher</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">stop</span><span style="color: #007700">();<br />});<br /><br /></span><span style="color: #9876AA">Ev</span><span style="color: #007700">::</span><span style="color: #9876AA">run</span><span style="color: #007700">();<br /></span><span style="color: #9876AA">?&gt;</span></span></span></div>  </div> </div> <div class="example" id="">  <p><strong>示例 #10 Monitor changes of /var/log/messages</strong></p>  <div class="example-contents"><div class="phpcode" style="border-color:gray;background:#232525"><span><span style="color: #000000"><span style="color: #9876AA">&lt;?php<br /></span><span style="color: #FF8000">// Use 10 second update interval.<br /></span><span style="color: #9876AA">$w </span><span style="color: #007700">= new </span><span style="color: #9876AA">EvStat</span><span style="color: #007700">(</span><span style="color: #DD0000">"/var/log/messages"</span><span style="color: #007700">, </span><span style="color: #9876AA">8</span><span style="color: #007700">, function (</span><span style="color: #9876AA">$w</span><span style="color: #007700">) {<br />    echo </span><span style="color: #DD0000">"/var/log/messages changed\n"</span><span style="color: #007700">;<br /><br />    </span><span style="color: #9876AA">$attr </span><span style="color: #007700">= </span><span style="color: #9876AA">$w</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">attr</span><span style="color: #007700">();<br /><br />    if (</span><span style="color: #9876AA">$attr</span><span style="color: #007700">[</span><span style="color: #DD0000">'nlink'</span><span style="color: #007700">]) {<br />        </span><span style="color: #9876AA">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">"Current size: %ld\n"</span><span style="color: #007700">, </span><span style="color: #9876AA">$attr</span><span style="color: #007700">[</span><span style="color: #DD0000">'size'</span><span style="color: #007700">]);<br />        </span><span style="color: #9876AA">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">"Current atime: %ld\n"</span><span style="color: #007700">, </span><span style="color: #9876AA">$attr</span><span style="color: #007700">[</span><span style="color: #DD0000">'atime'</span><span style="color: #007700">]);<br />        </span><span style="color: #9876AA">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">"Current mtime: %ld\n"</span><span style="color: #007700">, </span><span style="color: #9876AA">$attr</span><span style="color: #007700">[</span><span style="color: #DD0000">'mtime'</span><span style="color: #007700">]);<br />    } else {<br />        </span><span style="color: #9876AA">fprintf</span><span style="color: #007700">(</span><span style="color: #9876AA">STDERR</span><span style="color: #007700">, </span><span style="color: #DD0000">"`messages` file is not there!"</span><span style="color: #007700">);<br />        </span><span style="color: #9876AA">$w</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">stop</span><span style="color: #007700">();<br />    }<br />});<br /><br /></span><span style="color: #9876AA">Ev</span><span style="color: #007700">::</span><span style="color: #9876AA">run</span><span style="color: #007700">();<br /></span><span style="color: #9876AA">?&gt;</span></span></span></div>  </div> </div> <div class="example" id="">  <p><strong>示例 #11 Monotor changes of /var/log/messages. Avoid missing updates by means of one second delay</strong></p>  <div class="example-contents"><div class="phpcode" style="border-color:gray;background:#232525"><span><span style="color: #000000"><span style="color: #9876AA">&lt;?php<br />$timer </span><span style="color: #007700">= </span><span style="color: #9876AA">EvTimer</span><span style="color: #007700">::</span><span style="color: #9876AA">createStopped</span><span style="color: #007700">(</span><span style="color: #9876AA">0.</span><span style="color: #007700">, </span><span style="color: #9876AA">1.02</span><span style="color: #007700">, function (</span><span style="color: #9876AA">$w</span><span style="color: #007700">) {<br />    </span><span style="color: #9876AA">$w</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">stop</span><span style="color: #007700">();<br /><br />    </span><span style="color: #9876AA">$stat </span><span style="color: #007700">= </span><span style="color: #9876AA">$w</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">data</span><span style="color: #007700">;<br /><br />    </span><span style="color: #FF8000">// 1 second after the most recent change of the file<br />    </span><span style="color: #9876AA">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">"Current size: %ld\n"</span><span style="color: #007700">, </span><span style="color: #9876AA">$stat</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">attr</span><span style="color: #007700">()[</span><span style="color: #DD0000">'size'</span><span style="color: #007700">]);<br />});<br /><br /></span><span style="color: #9876AA">$stat </span><span style="color: #007700">= new </span><span style="color: #9876AA">EvStat</span><span style="color: #007700">(</span><span style="color: #DD0000">"/var/log/messages"</span><span style="color: #007700">, </span><span style="color: #9876AA">0.</span><span style="color: #007700">, function () use (</span><span style="color: #9876AA">$timer</span><span style="color: #007700">) {<br />    </span><span style="color: #FF8000">// Reset timer watcher<br />    </span><span style="color: #9876AA">$timer</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">again</span><span style="color: #007700">();<br />});<br /><br /></span><span style="color: #9876AA">$timer</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">data </span><span style="color: #007700">= </span><span style="color: #9876AA">$stat</span><span style="color: #007700">;<br /><br /></span><span style="color: #9876AA">Ev</span><span style="color: #007700">::</span><span style="color: #9876AA">run</span><span style="color: #007700">();<br /></span><span style="color: #9876AA">?&gt;</span></span></span></div>  </div> </div> <div class="example" id="">  <p><strong>示例 #12 Process status changes</strong></p>  <div class="example-contents"><div class="phpcode" style="border-color:gray;background:#232525"><span><span style="color: #000000"><span style="color: #9876AA">&lt;?php<br />$pid </span><span style="color: #007700">= </span><span style="color: #9876AA">pcntl_fork</span><span style="color: #007700">();<br /><br />if (</span><span style="color: #9876AA">$pid </span><span style="color: #007700">== -</span><span style="color: #9876AA">1</span><span style="color: #007700">) {<br />    </span><span style="color: #9876AA">fprintf</span><span style="color: #007700">(</span><span style="color: #9876AA">STDERR</span><span style="color: #007700">, </span><span style="color: #DD0000">"pcntl_fork failed\n"</span><span style="color: #007700">);<br />} elseif (</span><span style="color: #9876AA">$pid</span><span style="color: #007700">) {<br />    </span><span style="color: #9876AA">$w </span><span style="color: #007700">= new </span><span style="color: #9876AA">EvChild</span><span style="color: #007700">(</span><span style="color: #9876AA">$pid</span><span style="color: #007700">, </span><span style="color: #9876AA">FALSE</span><span style="color: #007700">, function (</span><span style="color: #9876AA">$w</span><span style="color: #007700">, </span><span style="color: #9876AA">$revents</span><span style="color: #007700">) {<br />        </span><span style="color: #9876AA">$w</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">stop</span><span style="color: #007700">();<br /><br />        </span><span style="color: #9876AA">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">"Process %d exited with status %d\n"</span><span style="color: #007700">, </span><span style="color: #9876AA">$w</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">rpid</span><span style="color: #007700">, </span><span style="color: #9876AA">$w</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">rstatus</span><span style="color: #007700">);<br />    });<br /><br />    </span><span style="color: #9876AA">Ev</span><span style="color: #007700">::</span><span style="color: #9876AA">run</span><span style="color: #007700">();<br /><br />    </span><span style="color: #FF8000">// Protect against Zombies<br />    </span><span style="color: #9876AA">pcntl_wait</span><span style="color: #007700">(</span><span style="color: #9876AA">$status</span><span style="color: #007700">);<br />} else {<br />    </span><span style="color: #FF8000">//Forked child<br />    </span><span style="color: #007700">exit(</span><span style="color: #9876AA">2</span><span style="color: #007700">);<br />}<br /></span><span style="color: #9876AA">?&gt;</span></span></span></div>  </div> </div></div>