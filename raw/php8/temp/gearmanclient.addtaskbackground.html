<div id="gearmanclient.addtaskbackground" class="refentry"> <div class="refnamediv">  <h1 class="refname">GearmanClient::addTaskBackground</h1>  <p class="verinfo">(PECL gearman &gt;= 0.5.0)</p><p class="refpurpose"><span class="refname">GearmanClient::addTaskBackground</span> &mdash; <span class="dc-title">Add a background task to be run in parallel</span></p> </div> <br></br><div style="BORDER-TOP: gray 1px dashed; OVERFLOW: hidden; HEIGHT: 1px"></div><div class="refsect1 description" id="refsect1-gearmanclient.addtaskbackground-description">  <h3 class="title">说明</h3>  <div class="methodsynopsis dc-description">   <span class="modifier">public</span> <span class="methodname" style="color:#CC7832"><strong>GearmanClient::addTaskBackground</strong></span>(<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="methodparam"><span class="type" style="color:#EAB766">string</span> <span class="parameter" style="color:#3A95FF">$function_name</span></span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="methodparam"><span class="type" style="color:#EAB766"><span class="type" style="color:#EAB766">string</span>|<span class="type" style="color:#EAB766">int</span>|<span class="type" style="color:#EAB766">float</span></span> <span class="parameter" style="color:#3A95FF">$workload</span></span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="methodparam"><span class="type" style="color:#EAB766"><a href="https://www.php.net/manual/zh/language.types.declarations.php#language.types.declarations.mixed" class="type mixed" style="color:#EAB766">mixed</a></span> <span class="parameter" style="color:#3A95FF">$context</span><span class="initializer"> = <strong><span>null</span></strong></span></span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="methodparam"><span class="type" style="color:#EAB766">?</span><span class="type" style="color:#EAB766"><span class="type" style="color:#EAB766">string</span><span class="type" style="color:#EAB766"></span></span> <span class="parameter" style="color:#3A95FF">$unique_key</span><span class="initializer"> = <strong><span>null</span></strong></span></span><br>): <span class="type" style="color:#EAB766"><span class="type" style="color:#EAB766"><a href="https://www.php.net/manual/zh/class.gearmantask.php" class="type GearmanTask" style="color:#EAB766">GearmanTask</a></span>|<span class="type" style="color:#EAB766"><span class="type false" style="color:#EAB766">false</span></span></span></div>  <p class="para rdfs-comment">   Adds a background task to be run in parallel with other tasks.  Call this method for all the tasks   to be run in parallel, then call <span class="methodname" style="color:#CC7832">{@link GearmanClient::runTasks()}</span> to   perform the work.  </p> </div> <br></br><div style="BORDER-TOP: gray 1px dashed; OVERFLOW: hidden; HEIGHT: 1px"></div><div class="refsect1 parameters" id="refsect1-gearmanclient.addtaskbackground-parameters">  <h3 class="title">参数</h3>  <span>   <dl>         <dt><span class="parameter" style="color:#3A95FF">function_name</span></dt>     <dd>      <p class="para">       由程序自动执行的已注册函数。      </p>     </dd>             <dt><span class="parameter" style="color:#3A95FF">workload</span></dt>     <dd>      <p class="para">       被处理的序列化数据。      </p>     </dd>             <dt><span class="parameter" style="color:#3A95FF">context</span></dt>     <dd>      <p class="para">       与任务关联的应用程序上下文。      </p>     </dd>             <dt><span class="parameter" style="color:#3A95FF">unique_key</span></dt>     <dd>      <p class="para">       用于标识特定任务的唯一性 ID。      </p>     </dd>       </dl>  </span> </div> <br></br><div style="BORDER-TOP: gray 1px dashed; OVERFLOW: hidden; HEIGHT: 1px"></div><div class="refsect1 returnvalues" id="refsect1-gearmanclient.addtaskbackground-returnvalues">  <h3 class="title">返回值</h3>  <p class="para">   A <span class="classname"><a href="https://www.php.net/manual/zh/class.gearmantask.php" class="classname">GearmanTask</a></span> object or <strong><span>false</span></strong> if the task could not be added.  </p> </div> <br></br><div style="BORDER-TOP: gray 1px dashed; OVERFLOW: hidden; HEIGHT: 1px"></div><div class="refsect1 examples" id="refsect1-gearmanclient.addtaskbackground-examples">  <h3 class="title">示例</h3>  <span>   <div class="example" id="">    <p><strong>示例 #1 Two tasks, one background and one not</strong></p>    <div class="example-contents"><p>     This example illustrates the difference between running a background task     and a normal task.  The client adds two tasks to execute the same function,     but one is added with <span class="methodname" style="color:#CC7832"><strong>addTaskBackground()</strong></span>.  A callback is      set so that progress of the job can be tracked.  A simple worker with an     artificial delay reports on the job progress and the client picks this up     through the callback.  Two workers are run for this example.  Note that the     background task does not show in the client output.    </p></div>    <div class="example-contents"><div class="phpcode" style="border-color:gray;background:#232525"><span><span style="color: #000000"><span style="color: #9876AA">&lt;?php<br /><br /></span><span style="color: #FF8000"># The client script<br /><br /># create our gearman client<br /></span><span style="color: #9876AA">$gmc</span><span style="color: #007700">= new </span><span style="color: #9876AA">GearmanClient</span><span style="color: #007700">();<br /><br /></span><span style="color: #FF8000"># add the default job server<br /></span><span style="color: #9876AA">$gmc</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">addServer</span><span style="color: #007700">();<br /><br /></span><span style="color: #FF8000"># set a couple of callbacks so we can track progress<br /></span><span style="color: #9876AA">$gmc</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">setCompleteCallback</span><span style="color: #007700">(</span><span style="color: #DD0000">"reverse_complete"</span><span style="color: #007700">);<br /></span><span style="color: #9876AA">$gmc</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">setStatusCallback</span><span style="color: #007700">(</span><span style="color: #DD0000">"reverse_status"</span><span style="color: #007700">);<br /><br /></span><span style="color: #FF8000"># add a task for the "reverse" function<br /></span><span style="color: #9876AA">$task</span><span style="color: #007700">= </span><span style="color: #9876AA">$gmc</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">addTask</span><span style="color: #007700">(</span><span style="color: #DD0000">"reverse"</span><span style="color: #007700">, </span><span style="color: #DD0000">"Hello World!"</span><span style="color: #007700">, </span><span style="color: #9876AA">null</span><span style="color: #007700">, </span><span style="color: #DD0000">"1"</span><span style="color: #007700">);<br /><br /></span><span style="color: #FF8000"># add another task, but this one to run in the background<br /></span><span style="color: #9876AA">$task</span><span style="color: #007700">= </span><span style="color: #9876AA">$gmc</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">addTaskBackground</span><span style="color: #007700">(</span><span style="color: #DD0000">"reverse"</span><span style="color: #007700">, </span><span style="color: #DD0000">"!dlroW olleH"</span><span style="color: #007700">, </span><span style="color: #9876AA">null</span><span style="color: #007700">, </span><span style="color: #DD0000">"2"</span><span style="color: #007700">);<br /><br />if (! </span><span style="color: #9876AA">$gmc</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">runTasks</span><span style="color: #007700">())<br />{<br />    echo </span><span style="color: #DD0000">"ERROR " </span><span style="color: #007700">. </span><span style="color: #9876AA">$gmc</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">error</span><span style="color: #007700">() . </span><span style="color: #DD0000">"\n"</span><span style="color: #007700">;<br />    exit;<br />}<br /><br />echo </span><span style="color: #DD0000">"DONE\n"</span><span style="color: #007700">;<br /><br />function </span><span style="color: #9876AA">reverse_status</span><span style="color: #007700">(</span><span style="color: #9876AA">$task</span><span style="color: #007700">)<br />{<br />    echo </span><span style="color: #DD0000">"STATUS: " </span><span style="color: #007700">. </span><span style="color: #9876AA">$task</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">unique</span><span style="color: #007700">() . </span><span style="color: #DD0000">", " </span><span style="color: #007700">. </span><span style="color: #9876AA">$task</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">jobHandle</span><span style="color: #007700">() . </span><span style="color: #DD0000">" - " </span><span style="color: #007700">. </span><span style="color: #9876AA">$task</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">taskNumerator</span><span style="color: #007700">() . <br />         </span><span style="color: #DD0000">"/" </span><span style="color: #007700">. </span><span style="color: #9876AA">$task</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">taskDenominator</span><span style="color: #007700">() . </span><span style="color: #DD0000">"\n"</span><span style="color: #007700">;<br />}<br /><br />function </span><span style="color: #9876AA">reverse_complete</span><span style="color: #007700">(</span><span style="color: #9876AA">$task</span><span style="color: #007700">)<br />{<br />    echo </span><span style="color: #DD0000">"COMPLETE: " </span><span style="color: #007700">. </span><span style="color: #9876AA">$task</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">unique</span><span style="color: #007700">() . </span><span style="color: #DD0000">", " </span><span style="color: #007700">. </span><span style="color: #9876AA">$task</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">data</span><span style="color: #007700">() . </span><span style="color: #DD0000">"\n"</span><span style="color: #007700">;<br />}<br /><br /></span><span style="color: #9876AA">?&gt;</span></span></span></div>    </div>    <div class="example-contents"><div class="phpcode" style="border-color:gray;background:#232525"><span><span style="color: #000000"><span style="color: #9876AA">&lt;?php<br /><br /></span><span style="color: #FF8000"># The worker script<br /><br /></span><span style="color: #007700">echo </span><span style="color: #DD0000">"Starting\n"</span><span style="color: #007700">;<br /><br /></span><span style="color: #FF8000"># Create our worker object.<br /></span><span style="color: #9876AA">$gmworker</span><span style="color: #007700">= new </span><span style="color: #9876AA">GearmanWorker</span><span style="color: #007700">();<br /><br /></span><span style="color: #FF8000"># Add default server (localhost).<br /></span><span style="color: #9876AA">$gmworker</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">addServer</span><span style="color: #007700">();<br /><br /></span><span style="color: #FF8000"># Register function "reverse" with the server.<br /></span><span style="color: #9876AA">$gmworker</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">addFunction</span><span style="color: #007700">(</span><span style="color: #DD0000">"reverse"</span><span style="color: #007700">, </span><span style="color: #DD0000">"reverse_fn"</span><span style="color: #007700">);<br /><br />print </span><span style="color: #DD0000">"Waiting for job...\n"</span><span style="color: #007700">;<br />while(</span><span style="color: #9876AA">$gmworker</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">work</span><span style="color: #007700">())<br />{<br />  if (</span><span style="color: #9876AA">$gmworker</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">returnCode</span><span style="color: #007700">() != </span><span style="color: #9876AA">GEARMAN_SUCCESS</span><span style="color: #007700">)<br />  {<br />    echo </span><span style="color: #DD0000">"return_code: " </span><span style="color: #007700">. </span><span style="color: #9876AA">$gmworker</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">returnCode</span><span style="color: #007700">() . </span><span style="color: #DD0000">"\n"</span><span style="color: #007700">;<br />    break;<br />  }<br />}<br /><br />function </span><span style="color: #9876AA">reverse_fn</span><span style="color: #007700">(</span><span style="color: #9876AA">$job</span><span style="color: #007700">)<br />{<br />  echo </span><span style="color: #DD0000">"Received job: " </span><span style="color: #007700">. </span><span style="color: #9876AA">$job</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">handle</span><span style="color: #007700">() . </span><span style="color: #DD0000">"\n"</span><span style="color: #007700">;<br /><br />  </span><span style="color: #9876AA">$workload </span><span style="color: #007700">= </span><span style="color: #9876AA">$job</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">workload</span><span style="color: #007700">();<br />  </span><span style="color: #9876AA">$workload_size </span><span style="color: #007700">= </span><span style="color: #9876AA">$job</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">workloadSize</span><span style="color: #007700">();<br /><br />  echo </span><span style="color: #DD0000">"Workload: </span><span style="color: #9876AA">$workload</span><span style="color: #DD0000"> (</span><span style="color: #9876AA">$workload_size</span><span style="color: #DD0000">)\n"</span><span style="color: #007700">;<br /><br />  </span><span style="color: #FF8000"># This status loop is not needed, just showing how it works<br />  </span><span style="color: #007700">for (</span><span style="color: #9876AA">$x</span><span style="color: #007700">= </span><span style="color: #9876AA">0</span><span style="color: #007700">; </span><span style="color: #9876AA">$x </span><span style="color: #007700">&lt; </span><span style="color: #9876AA">$workload_size</span><span style="color: #007700">; </span><span style="color: #9876AA">$x</span><span style="color: #007700">++)<br />  {<br />    echo </span><span style="color: #DD0000">"Sending status: " </span><span style="color: #007700">. (</span><span style="color: #9876AA">$x </span><span style="color: #007700">+ </span><span style="color: #9876AA">1</span><span style="color: #007700">) . </span><span style="color: #DD0000">"/</span><span style="color: #9876AA">$workload_size</span><span style="color: #DD0000"> complete\n"</span><span style="color: #007700">;<br />    </span><span style="color: #9876AA">$job</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">sendStatus</span><span style="color: #007700">(</span><span style="color: #9876AA">$x</span><span style="color: #007700">+</span><span style="color: #9876AA">1</span><span style="color: #007700">, </span><span style="color: #9876AA">$workload_size</span><span style="color: #007700">);<br />    </span><span style="color: #9876AA">$job</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">sendData</span><span style="color: #007700">(</span><span style="color: #9876AA">substr</span><span style="color: #007700">(</span><span style="color: #9876AA">$workload</span><span style="color: #007700">, </span><span style="color: #9876AA">$x</span><span style="color: #007700">, </span><span style="color: #9876AA">1</span><span style="color: #007700">));<br />    </span><span style="color: #9876AA">sleep</span><span style="color: #007700">(</span><span style="color: #9876AA">1</span><span style="color: #007700">);<br />  }<br /><br />  </span><span style="color: #9876AA">$result</span><span style="color: #007700">= </span><span style="color: #9876AA">strrev</span><span style="color: #007700">(</span><span style="color: #9876AA">$workload</span><span style="color: #007700">);<br />  echo </span><span style="color: #DD0000">"Result: </span><span style="color: #9876AA">$result</span><span style="color: #DD0000">\n"</span><span style="color: #007700">;<br /><br />  </span><span style="color: #FF8000"># Return what we want to send back to the client.<br />  </span><span style="color: #007700">return </span><span style="color: #9876AA">$result</span><span style="color: #007700">;<br />}<br /><br /></span><span style="color: #9876AA">?&gt;</span></span></span></div>    </div>    <div class="example-contents"><p>     Worker output for two workers running:    </p></div>    <div class="example-contents screen" style="color:AFB1B3;background:black;padding-left:5px;"><div class="cdata"><span>Received job: H:foo.local:65<br>Workload: !dlroW olleH (12)<br>1/12 complete<br>Received job: H:foo.local:66<br>Workload: Hello World! (12)<br>Sending status: 1/12 complete<br>Sending status: 2/12 complete<br>Sending status: 2/12 complete<br>Sending status: 3/12 complete<br>Sending status: 3/12 complete<br>Sending status: 4/12 complete<br>Sending status: 4/12 complete<br>Sending status: 5/12 complete<br>Sending status: 5/12 complete<br>Sending status: 6/12 complete<br>Sending status: 6/12 complete<br>Sending status: 7/12 complete<br>Sending status: 7/12 complete<br>Sending status: 8/12 complete<br>Sending status: 8/12 complete<br>Sending status: 9/12 complete<br>Sending status: 9/12 complete<br>Sending status: 10/12 complete<br>Sending status: 10/12 complete<br>Sending status: 11/12 complete<br>Sending status: 11/12 complete<br>Sending status: 12/12 complete<br>Sending status: 12/12 complete<br>Result: !dlroW olleH<br>Result: Hello World!<br></span></div>    </div>    <div class="example-contents"><p>     Client output:    </p></div>    <div class="example-contents screen" style="color:AFB1B3;background:black;padding-left:5px;"><div class="cdata"><span>STATUS: 1, H:foo.local:66 - 1/12<br>STATUS: 1, H:foo.local:66 - 2/12<br>STATUS: 1, H:foo.local:66 - 3/12<br>STATUS: 1, H:foo.local:66 - 4/12<br>STATUS: 1, H:foo.local:66 - 5/12<br>STATUS: 1, H:foo.local:66 - 6/12<br>STATUS: 1, H:foo.local:66 - 7/12<br>STATUS: 1, H:foo.local:66 - 8/12<br>STATUS: 1, H:foo.local:66 - 9/12<br>STATUS: 1, H:foo.local:66 - 10/12<br>STATUS: 1, H:foo.local:66 - 11/12<br>STATUS: 1, H:foo.local:66 - 12/12<br>COMPLETE: 1, !dlroW olleH<br>DONE<br></span></div>    </div>   </div>  </span> </div> <br></br><div style="BORDER-TOP: gray 1px dashed; OVERFLOW: hidden; HEIGHT: 1px"></div><div class="refsect1 seealso" id="refsect1-gearmanclient.addtaskbackground-seealso">  <h3 class="title">参见</h3>  <span>   <ul class="simplelist">    <li class="member"><span class="methodname" style="color:#CC7832">{@link GearmanClient::addTask()} - Add a task to be run in parallel</span></li>    <li class="member"><span class="methodname" style="color:#CC7832">{@link GearmanClient::addTaskHigh()} - Add a high priority task to run in parallel</span></li>    <li class="member"><span class="methodname" style="color:#CC7832">{@link GearmanClient::addTaskLow()} - Add a low priority task to run in parallel</span></li>    <li class="member"><span class="methodname" style="color:#CC7832">{@link GearmanClient::addTaskHighBackground()} - Add a high priority background task to be run in parallel</span></li>    <li class="member"><span class="methodname" style="color:#CC7832">{@link GearmanClient::addTaskLowBackground()} - Add a low priority background task to be run in parallel</span></li>    <li class="member"><span class="methodname" style="color:#CC7832">{@link GearmanClient::runTasks()} - Run a list of tasks in parallel</span></li>   </ul>  </span> </div></div>