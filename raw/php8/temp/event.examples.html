<div id="event.examples" class="chapter"> <h1>示例</h1> <div class="example" id="">  <p><strong>示例 #1 Simple HTTP client</strong></p>  <div class="example-contents"><div class="phpcode" style="border-color:gray;background:#232525"><span><span style="color: #000000"><span style="color: #9876AA">&lt;?php<br /></span><span style="color: #FF8000">// Read callback<br /></span><span style="color: #007700">function </span><span style="color: #9876AA">readcb</span><span style="color: #007700">(</span><span style="color: #9876AA">$bev</span><span style="color: #007700">, </span><span style="color: #9876AA">$base</span><span style="color: #007700">) {<br />    </span><span style="color: #FF8000">//$input = $bev-&gt;input; //$bev-&gt;getInput();<br /><br />    //$pos = $input-&gt;search("TTP");<br />    </span><span style="color: #9876AA">$pos </span><span style="color: #007700">= </span><span style="color: #9876AA">$bev</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">input</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">search</span><span style="color: #007700">(</span><span style="color: #DD0000">"TTP"</span><span style="color: #007700">);<br /><br />    while ((</span><span style="color: #9876AA">$n </span><span style="color: #007700">= </span><span style="color: #9876AA">$bev</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">input</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">remove</span><span style="color: #007700">(</span><span style="color: #9876AA">$buf</span><span style="color: #007700">, </span><span style="color: #9876AA">1024</span><span style="color: #007700">)) &gt; </span><span style="color: #9876AA">0</span><span style="color: #007700">) {<br />        echo </span><span style="color: #9876AA">$buf</span><span style="color: #007700">;<br />    }<br />}<br /><br /></span><span style="color: #FF8000">// Event callback<br /></span><span style="color: #007700">function </span><span style="color: #9876AA">eventcb</span><span style="color: #007700">(</span><span style="color: #9876AA">$bev</span><span style="color: #007700">, </span><span style="color: #9876AA">$events</span><span style="color: #007700">, </span><span style="color: #9876AA">$base</span><span style="color: #007700">) {<br />    if (</span><span style="color: #9876AA">$events </span><span style="color: #007700">&amp; </span><span style="color: #9876AA">EventBufferEvent</span><span style="color: #007700">::</span><span style="color: #9876AA">CONNECTED</span><span style="color: #007700">) {<br />        echo </span><span style="color: #DD0000">"Connected.\n"</span><span style="color: #007700">;<br />    } elseif (</span><span style="color: #9876AA">$events </span><span style="color: #007700">&amp; (</span><span style="color: #9876AA">EventBufferEvent</span><span style="color: #007700">::</span><span style="color: #9876AA">ERROR </span><span style="color: #007700">| </span><span style="color: #9876AA">EventBufferEvent</span><span style="color: #007700">::</span><span style="color: #9876AA">EOF</span><span style="color: #007700">)) {<br />        if (</span><span style="color: #9876AA">$events </span><span style="color: #007700">&amp; </span><span style="color: #9876AA">EventBufferEvent</span><span style="color: #007700">::</span><span style="color: #9876AA">ERROR</span><span style="color: #007700">) {<br />            echo </span><span style="color: #DD0000">"DNS error: "</span><span style="color: #007700">, </span><span style="color: #9876AA">$bev</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">getDnsErrorString</span><span style="color: #007700">(), </span><span style="color: #9876AA">PHP_EOL</span><span style="color: #007700">;<br />        }<br /><br />        echo </span><span style="color: #DD0000">"Closing\n"</span><span style="color: #007700">;<br />        </span><span style="color: #9876AA">$base</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">exit</span><span style="color: #007700">();<br />        exit(</span><span style="color: #DD0000">"Done\n"</span><span style="color: #007700">);<br />    }<br />}<br /><br />if (</span><span style="color: #9876AA">$argc </span><span style="color: #007700">!= </span><span style="color: #9876AA">3</span><span style="color: #007700">) {<br />    echo &lt;&lt;&lt;EOS<br /></span><span style="color: #DD0000">Trivial HTTP 0.x client<br />Syntax: php </span><span style="color: #007700">{</span><span style="color: #9876AA">$argv</span><span style="color: #007700">[</span><span style="color: #9876AA">0</span><span style="color: #007700">]}</span><span style="color: #DD0000"> [hostname] [resource]<br />Example: php </span><span style="color: #007700">{</span><span style="color: #9876AA">$argv</span><span style="color: #007700">[</span><span style="color: #9876AA">0</span><span style="color: #007700">]}</span><span style="color: #DD0000"> www.google.com /<br /><br /></span><span style="color: #007700">EOS;<br />    exit();<br />}<br /><br /></span><span style="color: #9876AA">$base </span><span style="color: #007700">= new </span><span style="color: #9876AA">EventBase</span><span style="color: #007700">();<br /><br /></span><span style="color: #9876AA">$dns_base </span><span style="color: #007700">= new </span><span style="color: #9876AA">EventDnsBase</span><span style="color: #007700">(</span><span style="color: #9876AA">$base</span><span style="color: #007700">, </span><span style="color: #9876AA">TRUE</span><span style="color: #007700">); </span><span style="color: #FF8000">// We'll use async DNS resolving<br /></span><span style="color: #007700">if (!</span><span style="color: #9876AA">$dns_base</span><span style="color: #007700">) {<br />    exit(</span><span style="color: #DD0000">"Failed to init DNS Base\n"</span><span style="color: #007700">);<br />}<br /><br /></span><span style="color: #9876AA">$bev </span><span style="color: #007700">= new </span><span style="color: #9876AA">EventBufferEvent</span><span style="color: #007700">(</span><span style="color: #9876AA">$base</span><span style="color: #007700">, </span><span style="color: #FF8000">// use internal socket  </span><span style="color: #9876AA">NULL</span><span style="color: #007700">,<br />    </span><span style="color: #9876AA">EventBufferEvent</span><span style="color: #007700">::</span><span style="color: #9876AA">OPT_CLOSE_ON_FREE </span><span style="color: #007700">| </span><span style="color: #9876AA">EventBufferEvent</span><span style="color: #007700">::</span><span style="color: #9876AA">OPT_DEFER_CALLBACKS</span><span style="color: #007700">,<br />    </span><span style="color: #DD0000">"readcb"</span><span style="color: #007700">, </span><span style="color: #FF8000">// writecb  </span><span style="color: #9876AA">NULL</span><span style="color: #007700">, </span><span style="color: #DD0000">"eventcb"<br /></span><span style="color: #007700">);<br />if (!</span><span style="color: #9876AA">$bev</span><span style="color: #007700">) {<br />    exit(</span><span style="color: #DD0000">"Failed creating bufferevent socket\n"</span><span style="color: #007700">);<br />}<br /><br /></span><span style="color: #FF8000">//$bev-&gt;setCallbacks("readcb", // writecb  NULL, "eventcb", $base);<br /></span><span style="color: #9876AA">$bev</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">enable</span><span style="color: #007700">(</span><span style="color: #9876AA">Event</span><span style="color: #007700">::</span><span style="color: #9876AA">READ </span><span style="color: #007700">| </span><span style="color: #9876AA">Event</span><span style="color: #007700">::</span><span style="color: #9876AA">WRITE</span><span style="color: #007700">);<br /><br /></span><span style="color: #9876AA">$output </span><span style="color: #007700">= </span><span style="color: #9876AA">$bev</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">output</span><span style="color: #007700">; </span><span style="color: #FF8000">//$bev-&gt;getOutput();<br /></span><span style="color: #007700">if (!</span><span style="color: #9876AA">$output</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">add</span><span style="color: #007700">(<br />    </span><span style="color: #DD0000">"GET </span><span style="color: #007700">{</span><span style="color: #9876AA">$argv</span><span style="color: #007700">[</span><span style="color: #9876AA">2</span><span style="color: #007700">]}</span><span style="color: #DD0000"> HTTP/1.0\r\n"</span><span style="color: #007700">.<br />    </span><span style="color: #DD0000">"Host: </span><span style="color: #007700">{</span><span style="color: #9876AA">$argv</span><span style="color: #007700">[</span><span style="color: #9876AA">1</span><span style="color: #007700">]}</span><span style="color: #DD0000">\r\n"</span><span style="color: #007700">.<br />    </span><span style="color: #DD0000">"Connection: Close\r\n\r\n"<br /></span><span style="color: #007700">)) {<br />    exit(</span><span style="color: #DD0000">"Failed adding request to output buffer\n"</span><span style="color: #007700">);<br />}<br /><br />if (!</span><span style="color: #9876AA">$bev</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">connectHost</span><span style="color: #007700">(</span><span style="color: #9876AA">$dns_base</span><span style="color: #007700">, </span><span style="color: #9876AA">$argv</span><span style="color: #007700">[</span><span style="color: #9876AA">1</span><span style="color: #007700">], </span><span style="color: #9876AA">80</span><span style="color: #007700">, </span><span style="color: #9876AA">EventUtil</span><span style="color: #007700">::</span><span style="color: #9876AA">AF_UNSPEC</span><span style="color: #007700">)) {<br />    exit(</span><span style="color: #DD0000">"Can't connect to host </span><span style="color: #007700">{</span><span style="color: #9876AA">$argv</span><span style="color: #007700">[</span><span style="color: #9876AA">1</span><span style="color: #007700">]}</span><span style="color: #DD0000">\n"</span><span style="color: #007700">);<br />}<br /><br /></span><span style="color: #9876AA">$base</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">dispatch</span><span style="color: #007700">();<br /></span><span style="color: #9876AA">?&gt;</span></span></span></div>  </div>  <div class="example-contents"><p>以上示例的输出类似于：</p></div>  <div class="example-contents screen" style="color:AFB1B3;background:black;padding-left:5px;"><div class="cdata"><span>Connected.<br>HTTP/1.1 301 Moved Permanently<br>Date: Fri, 01 Mar 2013 18:47:48 GMT<br>Location: http://www.google.co.uk/<br>Content-Type: text/html; charset=UTF-8<br>Cache-Control: public, max-age=2592000<br>Server: gws<br>Content-Length: 221<br>X-XSS-Protection: 1; mode=block<br>X-Frame-Options: SAMEORIGIN<br>Age: 133438<br>Expires: Sat, 30 Mar 2013 05:39:28 GMT<br>Connection: close<br><br>&lt;HTML&gt;&lt;HEAD&gt;&lt;meta http-equiv=&quot;content-type&quot; content=&quot;text/html;charset=utf-8&quot;&gt;<br>&lt;TITLE&gt;301 Moved&lt;/TITLE&gt;&lt;/HEAD&gt;&lt;BODY&gt;<br>&lt;H1&gt;301 Moved&lt;/H1&gt;<br>The document has moved<br>&lt;A HREF=&quot;http://www.google.co.uk/&quot;&gt;here&lt;/A&gt;.<br>&lt;/BODY&gt;&lt;/HTML&gt;<br>Closing<br>Done<br></span></div>  </div> </div> <div class="example" id="">  <p><strong>示例 #2 HTTP client using asynchronous DNS resolver</strong></p>  <div class="example-contents"><div class="phpcode" style="border-color:gray;background:#232525"><span><span style="color: #000000"><span style="color: #9876AA">&lt;?php<br /></span><span style="color: #FF8000">//<br /> * 1. Connect to 127.0.0.1 at port 80<br /> * by means of EventBufferEvent::connect().<br /> *<br /> * 2. Request /index.cphp via HTTP/1.0<br /> * using the output buffer.<br /> *<br /> * 3. Asyncronously read the response and print it to stdout.<br /> <br /><br />// Read callback<br /></span><span style="color: #007700">function </span><span style="color: #9876AA">readcb</span><span style="color: #007700">(</span><span style="color: #9876AA">$bev</span><span style="color: #007700">, </span><span style="color: #9876AA">$base</span><span style="color: #007700">) {<br />    </span><span style="color: #9876AA">$input </span><span style="color: #007700">= </span><span style="color: #9876AA">$bev</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">getInput</span><span style="color: #007700">();<br /><br />    while ((</span><span style="color: #9876AA">$n </span><span style="color: #007700">= </span><span style="color: #9876AA">$input</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">remove</span><span style="color: #007700">(</span><span style="color: #9876AA">$buf</span><span style="color: #007700">, </span><span style="color: #9876AA">1024</span><span style="color: #007700">)) &gt; </span><span style="color: #9876AA">0</span><span style="color: #007700">) {<br />        echo </span><span style="color: #9876AA">$buf</span><span style="color: #007700">;<br />    }<br />}<br /><br /></span><span style="color: #FF8000">// Event callback<br /></span><span style="color: #007700">function </span><span style="color: #9876AA">eventcb</span><span style="color: #007700">(</span><span style="color: #9876AA">$bev</span><span style="color: #007700">, </span><span style="color: #9876AA">$events</span><span style="color: #007700">, </span><span style="color: #9876AA">$base</span><span style="color: #007700">) {<br />    if (</span><span style="color: #9876AA">$events </span><span style="color: #007700">&amp; </span><span style="color: #9876AA">EventBufferEvent</span><span style="color: #007700">::</span><span style="color: #9876AA">CONNECTED</span><span style="color: #007700">) {<br />        echo </span><span style="color: #DD0000">"Connected.\n"</span><span style="color: #007700">;<br />    } elseif (</span><span style="color: #9876AA">$events </span><span style="color: #007700">&amp; (</span><span style="color: #9876AA">EventBufferEvent</span><span style="color: #007700">::</span><span style="color: #9876AA">ERROR </span><span style="color: #007700">| </span><span style="color: #9876AA">EventBufferEvent</span><span style="color: #007700">::</span><span style="color: #9876AA">EOF</span><span style="color: #007700">)) {<br />        if (</span><span style="color: #9876AA">$events </span><span style="color: #007700">&amp; </span><span style="color: #9876AA">EventBufferEvent</span><span style="color: #007700">::</span><span style="color: #9876AA">ERROR</span><span style="color: #007700">) {<br />            echo </span><span style="color: #DD0000">"DNS error: "</span><span style="color: #007700">, </span><span style="color: #9876AA">$bev</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">getDnsErrorString</span><span style="color: #007700">(), </span><span style="color: #9876AA">PHP_EOL</span><span style="color: #007700">;<br />        }<br /><br />        echo </span><span style="color: #DD0000">"Closing\n"</span><span style="color: #007700">;<br />        </span><span style="color: #9876AA">$base</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">exit</span><span style="color: #007700">();<br />        exit(</span><span style="color: #DD0000">"Done\n"</span><span style="color: #007700">);<br />    }<br />}<br /><br /></span><span style="color: #9876AA">$base </span><span style="color: #007700">= new </span><span style="color: #9876AA">EventBase</span><span style="color: #007700">();<br /><br />echo </span><span style="color: #DD0000">"step 1\n"</span><span style="color: #007700">;<br /></span><span style="color: #9876AA">$bev </span><span style="color: #007700">= new </span><span style="color: #9876AA">EventBufferEvent</span><span style="color: #007700">(</span><span style="color: #9876AA">$base</span><span style="color: #007700">, </span><span style="color: #FF8000">// use internal socket  </span><span style="color: #9876AA">NULL</span><span style="color: #007700">,<br />    </span><span style="color: #9876AA">EventBufferEvent</span><span style="color: #007700">::</span><span style="color: #9876AA">OPT_CLOSE_ON_FREE </span><span style="color: #007700">| </span><span style="color: #9876AA">EventBufferEvent</span><span style="color: #007700">::</span><span style="color: #9876AA">OPT_DEFER_CALLBACKS</span><span style="color: #007700">);<br />if (!</span><span style="color: #9876AA">$bev</span><span style="color: #007700">) {<br />    exit(</span><span style="color: #DD0000">"Failed creating bufferevent socket\n"</span><span style="color: #007700">);<br />}<br /><br />echo </span><span style="color: #DD0000">"step 2\n"</span><span style="color: #007700">;<br /></span><span style="color: #9876AA">$bev</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">setCallbacks</span><span style="color: #007700">(</span><span style="color: #DD0000">"readcb"</span><span style="color: #007700">, </span><span style="color: #FF8000">// writecb  </span><span style="color: #9876AA">NULL</span><span style="color: #007700">, </span><span style="color: #DD0000">"eventcb"</span><span style="color: #007700">, </span><span style="color: #9876AA">$base</span><span style="color: #007700">);<br /></span><span style="color: #9876AA">$bev</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">enable</span><span style="color: #007700">(</span><span style="color: #9876AA">Event</span><span style="color: #007700">::</span><span style="color: #9876AA">READ </span><span style="color: #007700">| </span><span style="color: #9876AA">Event</span><span style="color: #007700">::</span><span style="color: #9876AA">WRITE</span><span style="color: #007700">);<br /><br />echo </span><span style="color: #DD0000">"step 3\n"</span><span style="color: #007700">;<br /></span><span style="color: #FF8000">// Send request<br /></span><span style="color: #9876AA">$output </span><span style="color: #007700">= </span><span style="color: #9876AA">$bev</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">getOutput</span><span style="color: #007700">();<br />if (!</span><span style="color: #9876AA">$output</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">add</span><span style="color: #007700">(<br />    </span><span style="color: #DD0000">"GET /index.cphp HTTP/1.0\r\n"</span><span style="color: #007700">.<br />    </span><span style="color: #DD0000">"Connection: Close\r\n\r\n"<br /></span><span style="color: #007700">)) {<br />    exit(</span><span style="color: #DD0000">"Failed adding request to output buffer\n"</span><span style="color: #007700">);<br />}<br /><br /></span><span style="color: #FF8000">// Connect to the host syncronously.<br />We know the IP, and don't need to resolve DNS. <br /></span><span style="color: #007700">if (!</span><span style="color: #9876AA">$bev</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">connect</span><span style="color: #007700">(</span><span style="color: #DD0000">"127.0.0.1:80"</span><span style="color: #007700">)) {<br />    exit(</span><span style="color: #DD0000">"Can't connect to host\n"</span><span style="color: #007700">);<br />}<br /><br /></span><span style="color: #FF8000">// Dispatch pending events<br /></span><span style="color: #9876AA">$base</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">dispatch</span><span style="color: #007700">();<br /></span><span style="color: #9876AA">?&gt;</span></span></span></div>  </div> </div> <div class="example" id="">  <p><strong>示例 #3 Echo server</strong></p>  <div class="example-contents"><div class="phpcode" style="border-color:gray;background:#232525"><span><span style="color: #000000"><span style="color: #9876AA">&lt;?php<br /></span><span style="color: #FF8000">//<br /> * Simple echo server based on libevent's connection listener.<br /> *<br /> * Usage:<br /> * 1) In one terminal window run:<br /> *<br /> * $ php listener.php 9881<br /> *<br /> * 2) In another terminal window open up connection, e.g.:<br /> *<br /> * $ nc 127.0.0.1 9881<br /> *<br /> * 3) start typing. The server should repeat the input.<br /> <br /><br /></span><span style="color: #007700">class </span><span style="color: #9876AA">MyListenerConnection </span><span style="color: #007700">{<br />    private </span><span style="color: #9876AA">$bev</span><span style="color: #007700">, </span><span style="color: #9876AA">$base</span><span style="color: #007700">;<br /><br />    public function </span><span style="color: #9876AA">__destruct</span><span style="color: #007700">() {<br />        </span><span style="color: #9876AA">$this</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">bev</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">free</span><span style="color: #007700">();<br />    }<br /><br />    public function </span><span style="color: #9876AA">__construct</span><span style="color: #007700">(</span><span style="color: #9876AA">$base</span><span style="color: #007700">, </span><span style="color: #9876AA">$fd</span><span style="color: #007700">) {<br />        </span><span style="color: #9876AA">$this</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">base </span><span style="color: #007700">= </span><span style="color: #9876AA">$base</span><span style="color: #007700">;<br /><br />        </span><span style="color: #9876AA">$this</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">bev </span><span style="color: #007700">= new </span><span style="color: #9876AA">EventBufferEvent</span><span style="color: #007700">(</span><span style="color: #9876AA">$base</span><span style="color: #007700">, </span><span style="color: #9876AA">$fd</span><span style="color: #007700">, </span><span style="color: #9876AA">EventBufferEvent</span><span style="color: #007700">::</span><span style="color: #9876AA">OPT_CLOSE_ON_FREE</span><span style="color: #007700">);<br /><br />        </span><span style="color: #9876AA">$this</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">bev</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">setCallbacks</span><span style="color: #007700">(array(</span><span style="color: #9876AA">$this</span><span style="color: #007700">, </span><span style="color: #DD0000">"echoReadCallback"</span><span style="color: #007700">), </span><span style="color: #9876AA">NULL</span><span style="color: #007700">,<br />            array(</span><span style="color: #9876AA">$this</span><span style="color: #007700">, </span><span style="color: #DD0000">"echoEventCallback"</span><span style="color: #007700">), </span><span style="color: #9876AA">NULL</span><span style="color: #007700">);<br /><br />        if (!</span><span style="color: #9876AA">$this</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">bev</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">enable</span><span style="color: #007700">(</span><span style="color: #9876AA">Event</span><span style="color: #007700">::</span><span style="color: #9876AA">READ</span><span style="color: #007700">)) {<br />            echo </span><span style="color: #DD0000">"Failed to enable READ\n"</span><span style="color: #007700">;<br />            return;<br />        }<br />    }<br /><br />    public function </span><span style="color: #9876AA">echoReadCallback</span><span style="color: #007700">(</span><span style="color: #9876AA">$bev</span><span style="color: #007700">, </span><span style="color: #9876AA">$ctx</span><span style="color: #007700">) {<br />        </span><span style="color: #FF8000">// Copy all the data from the input buffer to the output buffer<br /><br />        // Variant #1<br />        </span><span style="color: #9876AA">$bev</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">output</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">addBuffer</span><span style="color: #007700">(</span><span style="color: #9876AA">$bev</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">input</span><span style="color: #007700">);<br /><br />        </span><span style="color: #FF8000">// Variant #2 <br />        //<br />        $input    = $bev-&gt;getInput();<br />        $output = $bev-&gt;getOutput();<br />        $output-&gt;addBuffer($input);<br />        <br />    </span><span style="color: #007700">}<br /><br />    public function </span><span style="color: #9876AA">echoEventCallback</span><span style="color: #007700">(</span><span style="color: #9876AA">$bev</span><span style="color: #007700">, </span><span style="color: #9876AA">$events</span><span style="color: #007700">, </span><span style="color: #9876AA">$ctx</span><span style="color: #007700">) {<br />        if (</span><span style="color: #9876AA">$events </span><span style="color: #007700">&amp; </span><span style="color: #9876AA">EventBufferEvent</span><span style="color: #007700">::</span><span style="color: #9876AA">ERROR</span><span style="color: #007700">) {<br />            echo </span><span style="color: #DD0000">"Error from bufferevent\n"</span><span style="color: #007700">;<br />        }<br /><br />        if (</span><span style="color: #9876AA">$events </span><span style="color: #007700">&amp; (</span><span style="color: #9876AA">EventBufferEvent</span><span style="color: #007700">::</span><span style="color: #9876AA">EOF </span><span style="color: #007700">| </span><span style="color: #9876AA">EventBufferEvent</span><span style="color: #007700">::</span><span style="color: #9876AA">ERROR</span><span style="color: #007700">)) {<br />            </span><span style="color: #FF8000">//$bev-&gt;free();<br />            </span><span style="color: #9876AA">$this</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">__destruct</span><span style="color: #007700">();<br />        }<br />    }<br />}<br /><br />class </span><span style="color: #9876AA">MyListener </span><span style="color: #007700">{<br />    public </span><span style="color: #9876AA">$base</span><span style="color: #007700">,<br />        </span><span style="color: #9876AA">$listener</span><span style="color: #007700">,<br />        </span><span style="color: #9876AA">$socket</span><span style="color: #007700">;<br />    private </span><span style="color: #9876AA">$conn </span><span style="color: #007700">= array();<br /><br />    public function </span><span style="color: #9876AA">__destruct</span><span style="color: #007700">() {<br />        foreach (</span><span style="color: #9876AA">$this</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">conn </span><span style="color: #007700">as &amp;</span><span style="color: #9876AA">$c</span><span style="color: #007700">) </span><span style="color: #9876AA">$c </span><span style="color: #007700">= </span><span style="color: #9876AA">NULL</span><span style="color: #007700">;<br />    }<br /><br />    public function </span><span style="color: #9876AA">__construct</span><span style="color: #007700">(</span><span style="color: #9876AA">$port</span><span style="color: #007700">) {<br />        </span><span style="color: #9876AA">$this</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">base </span><span style="color: #007700">= new </span><span style="color: #9876AA">EventBase</span><span style="color: #007700">();<br />        if (!</span><span style="color: #9876AA">$this</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">base</span><span style="color: #007700">) {<br />            echo </span><span style="color: #DD0000">"Couldn't open event base"</span><span style="color: #007700">;<br />            exit(</span><span style="color: #9876AA">1</span><span style="color: #007700">);<br />        }<br /><br />        </span><span style="color: #FF8000">// Variant #1<br />        //<br />        $this-&gt;socket = socket_create(AF_INET, SOCK_STREAM, SOL_TCP);<br />        if (!socket_bind($this-&gt;socket, '0.0.0.0', $port)) {<br />            echo "Unable to bind socket\n";<br />            exit(1);<br />        }<br />        $this-&gt;listener = new EventListener($this-&gt;base,<br />            array($this, "acceptConnCallback"), $this-&gt;base,<br />            EventListener::OPT_CLOSE_ON_FREE | EventListener::OPT_REUSEABLE,<br />            -1, $this-&gt;socket);<br />         <br /><br />        // Variant #2<br />         </span><span style="color: #9876AA">$this</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">listener </span><span style="color: #007700">= new </span><span style="color: #9876AA">EventListener</span><span style="color: #007700">(</span><span style="color: #9876AA">$this</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">base</span><span style="color: #007700">,<br />             array(</span><span style="color: #9876AA">$this</span><span style="color: #007700">, </span><span style="color: #DD0000">"acceptConnCallback"</span><span style="color: #007700">), </span><span style="color: #9876AA">$this</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">base</span><span style="color: #007700">,<br />             </span><span style="color: #9876AA">EventListener</span><span style="color: #007700">::</span><span style="color: #9876AA">OPT_CLOSE_ON_FREE </span><span style="color: #007700">| </span><span style="color: #9876AA">EventListener</span><span style="color: #007700">::</span><span style="color: #9876AA">OPT_REUSEABLE</span><span style="color: #007700">, -</span><span style="color: #9876AA">1</span><span style="color: #007700">,<br />             </span><span style="color: #DD0000">"0.0.0.0:</span><span style="color: #9876AA">$port</span><span style="color: #DD0000">"</span><span style="color: #007700">);<br /><br />        if (!</span><span style="color: #9876AA">$this</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">listener</span><span style="color: #007700">) {<br />            echo </span><span style="color: #DD0000">"Couldn't create listener"</span><span style="color: #007700">;<br />            exit(</span><span style="color: #9876AA">1</span><span style="color: #007700">);<br />        }<br /><br />        </span><span style="color: #9876AA">$this</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">listener</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">setErrorCallback</span><span style="color: #007700">(array(</span><span style="color: #9876AA">$this</span><span style="color: #007700">, </span><span style="color: #DD0000">"accept_error_cb"</span><span style="color: #007700">));<br />    }<br /><br />    public function </span><span style="color: #9876AA">dispatch</span><span style="color: #007700">() {<br />        </span><span style="color: #9876AA">$this</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">base</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">dispatch</span><span style="color: #007700">();<br />    }<br /><br />    </span><span style="color: #FF8000">// This callback is invoked when there is data to read on $bev<br />    </span><span style="color: #007700">public function </span><span style="color: #9876AA">acceptConnCallback</span><span style="color: #007700">(</span><span style="color: #9876AA">$listener</span><span style="color: #007700">, </span><span style="color: #9876AA">$fd</span><span style="color: #007700">, </span><span style="color: #9876AA">$address</span><span style="color: #007700">, </span><span style="color: #9876AA">$ctx</span><span style="color: #007700">) {<br />        </span><span style="color: #FF8000">// We got a new connection! Set up a bufferevent for it. <br />        </span><span style="color: #9876AA">$base </span><span style="color: #007700">= </span><span style="color: #9876AA">$this</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">base</span><span style="color: #007700">;<br />        </span><span style="color: #9876AA">$this</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">conn</span><span style="color: #007700">[] = new </span><span style="color: #9876AA">MyListenerConnection</span><span style="color: #007700">(</span><span style="color: #9876AA">$base</span><span style="color: #007700">, </span><span style="color: #9876AA">$fd</span><span style="color: #007700">);<br />    }<br /><br />    public function </span><span style="color: #9876AA">accept_error_cb</span><span style="color: #007700">(</span><span style="color: #9876AA">$listener</span><span style="color: #007700">, </span><span style="color: #9876AA">$ctx</span><span style="color: #007700">) {<br />        </span><span style="color: #9876AA">$base </span><span style="color: #007700">= </span><span style="color: #9876AA">$this</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">base</span><span style="color: #007700">;<br /><br />        </span><span style="color: #9876AA">fprintf</span><span style="color: #007700">(</span><span style="color: #9876AA">STDERR</span><span style="color: #007700">, </span><span style="color: #DD0000">"Got an error %d (%s) on the listener. "<br />            </span><span style="color: #007700">.</span><span style="color: #DD0000">"Shutting down.\n"</span><span style="color: #007700">,<br />            </span><span style="color: #9876AA">EventUtil</span><span style="color: #007700">::</span><span style="color: #9876AA">getLastSocketErrno</span><span style="color: #007700">(),<br />            </span><span style="color: #9876AA">EventUtil</span><span style="color: #007700">::</span><span style="color: #9876AA">getLastSocketError</span><span style="color: #007700">());<br /><br />        </span><span style="color: #9876AA">$base</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">exit</span><span style="color: #007700">(</span><span style="color: #9876AA">NULL</span><span style="color: #007700">);<br />    }<br />}<br /><br /></span><span style="color: #9876AA">$port </span><span style="color: #007700">= </span><span style="color: #9876AA">9808</span><span style="color: #007700">;<br /><br />if (</span><span style="color: #9876AA">$argc </span><span style="color: #007700">&gt; </span><span style="color: #9876AA">1</span><span style="color: #007700">) {<br />    </span><span style="color: #9876AA">$port </span><span style="color: #007700">= (int) </span><span style="color: #9876AA">$argv</span><span style="color: #007700">[</span><span style="color: #9876AA">1</span><span style="color: #007700">];<br />}<br />if (</span><span style="color: #9876AA">$port </span><span style="color: #007700">&lt;= </span><span style="color: #9876AA">0 </span><span style="color: #007700">|| </span><span style="color: #9876AA">$port </span><span style="color: #007700">&gt; </span><span style="color: #9876AA">65535</span><span style="color: #007700">) {<br />    exit(</span><span style="color: #DD0000">"Invalid port"</span><span style="color: #007700">);<br />}<br /><br /></span><span style="color: #9876AA">$l </span><span style="color: #007700">= new </span><span style="color: #9876AA">MyListener</span><span style="color: #007700">(</span><span style="color: #9876AA">$port</span><span style="color: #007700">);<br /></span><span style="color: #9876AA">$l</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">dispatch</span><span style="color: #007700">();<br /></span><span style="color: #9876AA">?&gt;</span></span></span></div>  </div> </div> <div class="example" id="">  <p><strong>示例 #4 SSL echo server</strong></p>  <div class="example-contents"><div class="phpcode" style="border-color:gray;background:#232525"><span><span style="color: #000000"><span style="color: #9876AA">&lt;?php<br /></span><span style="color: #FF8000">//<br /> * SSL echo server<br /> *<br /> * To test:<br /> * 1) Run:<br /> * $ php examples/ssl-echo-server/server.php 9998<br /> *<br /> * 2) in another terminal window run:<br /> * $ socat - SSL:127.0.0.1:9998,verify=1,cafile=examples/ssl-echo-server/cert.pem<br /> <br /><br /></span><span style="color: #007700">class </span><span style="color: #9876AA">MySslEchoServer </span><span style="color: #007700">{<br />    public </span><span style="color: #9876AA">$port</span><span style="color: #007700">,<br />        </span><span style="color: #9876AA">$base</span><span style="color: #007700">,<br />        </span><span style="color: #9876AA">$bev</span><span style="color: #007700">,<br />        </span><span style="color: #9876AA">$listener</span><span style="color: #007700">,<br />        </span><span style="color: #9876AA">$ctx</span><span style="color: #007700">;<br /><br />    function </span><span style="color: #9876AA">__construct </span><span style="color: #007700">(</span><span style="color: #9876AA">$port</span><span style="color: #007700">, </span><span style="color: #9876AA">$host </span><span style="color: #007700">= </span><span style="color: #DD0000">"127.0.0.1"</span><span style="color: #007700">) {<br />        </span><span style="color: #9876AA">$this</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">port </span><span style="color: #007700">= </span><span style="color: #9876AA">$port</span><span style="color: #007700">;<br />        </span><span style="color: #9876AA">$this</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">ctx </span><span style="color: #007700">= </span><span style="color: #9876AA">$this</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">init_ssl</span><span style="color: #007700">();<br />        if (!</span><span style="color: #9876AA">$this</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">ctx</span><span style="color: #007700">) {<br />            exit(</span><span style="color: #DD0000">"Failed creating SSL context\n"</span><span style="color: #007700">);<br />        }<br /><br />        </span><span style="color: #9876AA">$this</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">base </span><span style="color: #007700">= new </span><span style="color: #9876AA">EventBase</span><span style="color: #007700">();<br />        if (!</span><span style="color: #9876AA">$this</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">base</span><span style="color: #007700">) {<br />            exit(</span><span style="color: #DD0000">"Couldn't open event base\n"</span><span style="color: #007700">);<br />        }<br /><br />        </span><span style="color: #9876AA">$this</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">listener </span><span style="color: #007700">= new </span><span style="color: #9876AA">EventListener</span><span style="color: #007700">(</span><span style="color: #9876AA">$this</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">base</span><span style="color: #007700">,<br />            array(</span><span style="color: #9876AA">$this</span><span style="color: #007700">, </span><span style="color: #DD0000">"ssl_accept_cb"</span><span style="color: #007700">), </span><span style="color: #9876AA">$this</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">ctx</span><span style="color: #007700">,<br />            </span><span style="color: #9876AA">EventListener</span><span style="color: #007700">::</span><span style="color: #9876AA">OPT_CLOSE_ON_FREE </span><span style="color: #007700">| </span><span style="color: #9876AA">EventListener</span><span style="color: #007700">::</span><span style="color: #9876AA">OPT_REUSEABLE</span><span style="color: #007700">,<br />            -</span><span style="color: #9876AA">1</span><span style="color: #007700">, </span><span style="color: #DD0000">"</span><span style="color: #9876AA">$host</span><span style="color: #DD0000">:</span><span style="color: #9876AA">$port</span><span style="color: #DD0000">"</span><span style="color: #007700">);<br />        if (!</span><span style="color: #9876AA">$this</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">listener</span><span style="color: #007700">) {<br />            exit(</span><span style="color: #DD0000">"Couldn't create listener\n"</span><span style="color: #007700">);<br />        }<br /><br />        </span><span style="color: #9876AA">$this</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">listener</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">setErrorCallback</span><span style="color: #007700">(array(</span><span style="color: #9876AA">$this</span><span style="color: #007700">, </span><span style="color: #DD0000">"accept_error_cb"</span><span style="color: #007700">));<br />    }<br />    function </span><span style="color: #9876AA">dispatch</span><span style="color: #007700">() {<br />        </span><span style="color: #9876AA">$this</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">base</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">dispatch</span><span style="color: #007700">();<br />    }<br /><br />    </span><span style="color: #FF8000">// This callback is invoked when there is data to read on $bev.<br />    </span><span style="color: #007700">function </span><span style="color: #9876AA">ssl_read_cb</span><span style="color: #007700">(</span><span style="color: #9876AA">$bev</span><span style="color: #007700">, </span><span style="color: #9876AA">$ctx</span><span style="color: #007700">) {<br />        </span><span style="color: #9876AA">$in </span><span style="color: #007700">= </span><span style="color: #9876AA">$bev</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">input</span><span style="color: #007700">; </span><span style="color: #FF8000">//$bev-&gt;getInput();<br /><br />        </span><span style="color: #9876AA">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">"Received %zu bytes\n"</span><span style="color: #007700">, </span><span style="color: #9876AA">$in</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">length</span><span style="color: #007700">);<br />        </span><span style="color: #9876AA">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">"----- data ----\n"</span><span style="color: #007700">);<br />        </span><span style="color: #9876AA">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">"%ld:\t%s\n"</span><span style="color: #007700">, (int) </span><span style="color: #9876AA">$in</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">length</span><span style="color: #007700">, </span><span style="color: #9876AA">$in</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">pullup</span><span style="color: #007700">(-</span><span style="color: #9876AA">1</span><span style="color: #007700">));<br /><br />        </span><span style="color: #9876AA">$bev</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">writeBuffer</span><span style="color: #007700">(</span><span style="color: #9876AA">$in</span><span style="color: #007700">);<br />    }<br /><br />    </span><span style="color: #FF8000">// This callback is invoked when some even occurs on the event listener,<br />    // e.g. connection closed, or an error occurred<br />    </span><span style="color: #007700">function </span><span style="color: #9876AA">ssl_event_cb</span><span style="color: #007700">(</span><span style="color: #9876AA">$bev</span><span style="color: #007700">, </span><span style="color: #9876AA">$events</span><span style="color: #007700">, </span><span style="color: #9876AA">$ctx</span><span style="color: #007700">) {<br />        if (</span><span style="color: #9876AA">$events </span><span style="color: #007700">&amp; </span><span style="color: #9876AA">EventBufferEvent</span><span style="color: #007700">::</span><span style="color: #9876AA">ERROR</span><span style="color: #007700">) {<br />            </span><span style="color: #FF8000">// Fetch errors from the SSL error stack<br />            </span><span style="color: #007700">while (</span><span style="color: #9876AA">$err </span><span style="color: #007700">= </span><span style="color: #9876AA">$bev</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">sslError</span><span style="color: #007700">()) {<br />                </span><span style="color: #9876AA">fprintf</span><span style="color: #007700">(</span><span style="color: #9876AA">STDERR</span><span style="color: #007700">, </span><span style="color: #DD0000">"Bufferevent error %s.\n"</span><span style="color: #007700">, </span><span style="color: #9876AA">$err</span><span style="color: #007700">);<br />            }<br />        }<br /><br />        if (</span><span style="color: #9876AA">$events </span><span style="color: #007700">&amp; (</span><span style="color: #9876AA">EventBufferEvent</span><span style="color: #007700">::</span><span style="color: #9876AA">EOF </span><span style="color: #007700">| </span><span style="color: #9876AA">EventBufferEvent</span><span style="color: #007700">::</span><span style="color: #9876AA">ERROR</span><span style="color: #007700">)) {<br />            </span><span style="color: #9876AA">$bev</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">free</span><span style="color: #007700">();<br />        }<br />    }<br /><br />    </span><span style="color: #FF8000">// This callback is invoked when a client accepts new connection<br />    </span><span style="color: #007700">function </span><span style="color: #9876AA">ssl_accept_cb</span><span style="color: #007700">(</span><span style="color: #9876AA">$listener</span><span style="color: #007700">, </span><span style="color: #9876AA">$fd</span><span style="color: #007700">, </span><span style="color: #9876AA">$address</span><span style="color: #007700">, </span><span style="color: #9876AA">$ctx</span><span style="color: #007700">) {<br />        </span><span style="color: #FF8000">// We got a new connection! Set up a bufferevent for it.<br />        </span><span style="color: #9876AA">$this</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">bev </span><span style="color: #007700">= </span><span style="color: #9876AA">EventBufferEvent</span><span style="color: #007700">::</span><span style="color: #9876AA">sslSocket</span><span style="color: #007700">(</span><span style="color: #9876AA">$this</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">base</span><span style="color: #007700">, </span><span style="color: #9876AA">$fd</span><span style="color: #007700">, </span><span style="color: #9876AA">$this</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">ctx</span><span style="color: #007700">,<br />            </span><span style="color: #9876AA">EventBufferEvent</span><span style="color: #007700">::</span><span style="color: #9876AA">SSL_ACCEPTING</span><span style="color: #007700">, </span><span style="color: #9876AA">EventBufferEvent</span><span style="color: #007700">::</span><span style="color: #9876AA">OPT_CLOSE_ON_FREE</span><span style="color: #007700">);<br /><br />        if (!</span><span style="color: #9876AA">$this</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">bev</span><span style="color: #007700">) {<br />            echo </span><span style="color: #DD0000">"Failed creating ssl buffer\n"</span><span style="color: #007700">;<br />            </span><span style="color: #9876AA">$this</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">base</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">exit</span><span style="color: #007700">(</span><span style="color: #9876AA">NULL</span><span style="color: #007700">);<br />            exit(</span><span style="color: #9876AA">1</span><span style="color: #007700">);<br />        }<br /><br />        </span><span style="color: #9876AA">$this</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">bev</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">enable</span><span style="color: #007700">(</span><span style="color: #9876AA">Event</span><span style="color: #007700">::</span><span style="color: #9876AA">READ</span><span style="color: #007700">);<br />        </span><span style="color: #9876AA">$this</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">bev</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">setCallbacks</span><span style="color: #007700">(array(</span><span style="color: #9876AA">$this</span><span style="color: #007700">, </span><span style="color: #DD0000">"ssl_read_cb"</span><span style="color: #007700">), </span><span style="color: #9876AA">NULL</span><span style="color: #007700">,<br />            array(</span><span style="color: #9876AA">$this</span><span style="color: #007700">, </span><span style="color: #DD0000">"ssl_event_cb"</span><span style="color: #007700">), </span><span style="color: #9876AA">NULL</span><span style="color: #007700">);<br />    }<br /><br />    </span><span style="color: #FF8000">// This callback is invoked when we failed to setup new connection for a client<br />    </span><span style="color: #007700">function </span><span style="color: #9876AA">accept_error_cb</span><span style="color: #007700">(</span><span style="color: #9876AA">$listener</span><span style="color: #007700">, </span><span style="color: #9876AA">$ctx</span><span style="color: #007700">) {<br />        </span><span style="color: #9876AA">fprintf</span><span style="color: #007700">(</span><span style="color: #9876AA">STDERR</span><span style="color: #007700">, </span><span style="color: #DD0000">"Got an error %d (%s) on the listener. "<br />            </span><span style="color: #007700">.</span><span style="color: #DD0000">"Shutting down.\n"</span><span style="color: #007700">,<br />            </span><span style="color: #9876AA">EventUtil</span><span style="color: #007700">::</span><span style="color: #9876AA">getLastSocketErrno</span><span style="color: #007700">(),<br />            </span><span style="color: #9876AA">EventUtil</span><span style="color: #007700">::</span><span style="color: #9876AA">getLastSocketError</span><span style="color: #007700">());<br /><br />        </span><span style="color: #9876AA">$this</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">base</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">exit</span><span style="color: #007700">(</span><span style="color: #9876AA">NULL</span><span style="color: #007700">);<br />    }<br /><br />    </span><span style="color: #FF8000">// Initialize SSL structures, create an EventSslContext<br />    // Optionally create self-signed certificates<br />    </span><span style="color: #007700">function </span><span style="color: #9876AA">init_ssl</span><span style="color: #007700">() {<br />        </span><span style="color: #FF8000">// We *must* have entropy. Otherwise there's no point to crypto.<br />        </span><span style="color: #007700">if (!</span><span style="color: #9876AA">EventUtil</span><span style="color: #007700">::</span><span style="color: #9876AA">sslRandPoll</span><span style="color: #007700">()) {<br />            exit(</span><span style="color: #DD0000">"EventUtil::sslRandPoll failed\n"</span><span style="color: #007700">);<br />        }<br /><br />        </span><span style="color: #9876AA">$local_cert </span><span style="color: #007700">= </span><span style="color: #9876AA">__DIR__</span><span style="color: #007700">.</span><span style="color: #DD0000">"/cert.pem"</span><span style="color: #007700">;<br />        </span><span style="color: #9876AA">$local_pk   </span><span style="color: #007700">= </span><span style="color: #9876AA">__DIR__</span><span style="color: #007700">.</span><span style="color: #DD0000">"/privkey.pem"</span><span style="color: #007700">;<br /><br />        if (!</span><span style="color: #9876AA">file_exists</span><span style="color: #007700">(</span><span style="color: #9876AA">$local_cert</span><span style="color: #007700">) || !</span><span style="color: #9876AA">file_exists</span><span style="color: #007700">(</span><span style="color: #9876AA">$local_pk</span><span style="color: #007700">)) {<br />            echo </span><span style="color: #DD0000">"Couldn't read </span><span style="color: #9876AA">$local_cert</span><span style="color: #DD0000"> or </span><span style="color: #9876AA">$local_pk</span><span style="color: #DD0000"> file.  To generate a key\n"</span><span style="color: #007700">,<br />                </span><span style="color: #DD0000">"and self-signed certificate, run:\n"</span><span style="color: #007700">,<br />                </span><span style="color: #DD0000">"  openssl genrsa -out </span><span style="color: #9876AA">$local_pk</span><span style="color: #DD0000"> 2048\n"</span><span style="color: #007700">,<br />                </span><span style="color: #DD0000">"  openssl req -new -key </span><span style="color: #9876AA">$local_pk</span><span style="color: #DD0000"> -out cert.req\n"</span><span style="color: #007700">,<br />                </span><span style="color: #DD0000">"  openssl x509 -req -days 365 -in cert.req -signkey </span><span style="color: #9876AA">$local_pk</span><span style="color: #DD0000"> -out </span><span style="color: #9876AA">$local_cert</span><span style="color: #DD0000">\n"</span><span style="color: #007700">;<br /><br />            return </span><span style="color: #9876AA">FALSE</span><span style="color: #007700">;<br />        }<br /><br />        </span><span style="color: #9876AA">$ctx </span><span style="color: #007700">= new </span><span style="color: #9876AA">EventSslContext</span><span style="color: #007700">(</span><span style="color: #9876AA">EventSslContext</span><span style="color: #007700">::</span><span style="color: #9876AA">SSLv3_SERVER_METHOD</span><span style="color: #007700">, array (<br />             </span><span style="color: #9876AA">EventSslContext</span><span style="color: #007700">::</span><span style="color: #9876AA">OPT_LOCAL_CERT  </span><span style="color: #007700">=&gt; </span><span style="color: #9876AA">$local_cert</span><span style="color: #007700">,<br />             </span><span style="color: #9876AA">EventSslContext</span><span style="color: #007700">::</span><span style="color: #9876AA">OPT_LOCAL_PK    </span><span style="color: #007700">=&gt; </span><span style="color: #9876AA">$local_pk</span><span style="color: #007700">,<br />             </span><span style="color: #FF8000">//EventSslContext::OPT_PASSPHRASE  =&gt; "echo server",<br />             </span><span style="color: #9876AA">EventSslContext</span><span style="color: #007700">::</span><span style="color: #9876AA">OPT_VERIFY_PEER </span><span style="color: #007700">=&gt; </span><span style="color: #9876AA">true</span><span style="color: #007700">,<br />             </span><span style="color: #9876AA">EventSslContext</span><span style="color: #007700">::</span><span style="color: #9876AA">OPT_ALLOW_SELF_SIGNED </span><span style="color: #007700">=&gt; </span><span style="color: #9876AA">false</span><span style="color: #007700">,<br />        ));<br /><br />        return </span><span style="color: #9876AA">$ctx</span><span style="color: #007700">;<br />    }<br />}<br /><br /></span><span style="color: #FF8000">// Allow to override the port<br /></span><span style="color: #9876AA">$port </span><span style="color: #007700">= </span><span style="color: #9876AA">9999</span><span style="color: #007700">;<br />if (</span><span style="color: #9876AA">$argc </span><span style="color: #007700">&gt; </span><span style="color: #9876AA">1</span><span style="color: #007700">) {<br />    </span><span style="color: #9876AA">$port </span><span style="color: #007700">= (int) </span><span style="color: #9876AA">$argv</span><span style="color: #007700">[</span><span style="color: #9876AA">1</span><span style="color: #007700">];<br />}<br />if (</span><span style="color: #9876AA">$port </span><span style="color: #007700">&lt;= </span><span style="color: #9876AA">0 </span><span style="color: #007700">|| </span><span style="color: #9876AA">$port </span><span style="color: #007700">&gt; </span><span style="color: #9876AA">65535</span><span style="color: #007700">) {<br />    exit(</span><span style="color: #DD0000">"Invalid port\n"</span><span style="color: #007700">);<br />}<br /><br /><br /></span><span style="color: #9876AA">$l </span><span style="color: #007700">= new </span><span style="color: #9876AA">MySslEchoServer</span><span style="color: #007700">(</span><span style="color: #9876AA">$port</span><span style="color: #007700">);<br /></span><span style="color: #9876AA">$l</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">dispatch</span><span style="color: #007700">();<br /></span><span style="color: #9876AA">?&gt;</span></span></span></div>  </div> </div> <div class="example" id="">  <p><strong>示例 #5 Signal handler</strong></p>  <div class="example-contents"><div class="phpcode" style="border-color:gray;background:#232525"><span><span style="color: #000000"><span style="color: #9876AA">&lt;?php<br /></span><span style="color: #FF8000">//<br />Launch it in a terminal window:<br /><br />$ php examples/signal.php<br /><br />In another terminal window find out the pid and send SIGTERM, e.g.:<br /><br />$ ps aux | grep examp<br />ruslan    3976  0.2  0.0 139896 11256 pts/1    S+   10:25   0:00 php examples/signal.php<br />ruslan    3978  0.0  0.0   9572   864 pts/2    S+   10:26   0:00 grep --color=auto examp<br />$ kill -TERM 3976<br /><br />At the first terminal window you should catch the following:<br /><br />Caught signal 15<br /><br /></span><span style="color: #007700">class </span><span style="color: #9876AA">MyEventSignal </span><span style="color: #007700">{<br />    private </span><span style="color: #9876AA">$base</span><span style="color: #007700">;<br /><br />    function </span><span style="color: #9876AA">__construct</span><span style="color: #007700">(</span><span style="color: #9876AA">$base</span><span style="color: #007700">) {<br />        </span><span style="color: #9876AA">$this</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">base </span><span style="color: #007700">= </span><span style="color: #9876AA">$base</span><span style="color: #007700">;<br />    }<br /><br />    function </span><span style="color: #9876AA">eventSighandler</span><span style="color: #007700">(</span><span style="color: #9876AA">$no</span><span style="color: #007700">, </span><span style="color: #9876AA">$c</span><span style="color: #007700">) {<br />        echo </span><span style="color: #DD0000">"Caught signal </span><span style="color: #9876AA">$no</span><span style="color: #DD0000">\n"</span><span style="color: #007700">;<br />        </span><span style="color: #9876AA">event_base_loopexit</span><span style="color: #007700">(</span><span style="color: #9876AA">$c</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">base</span><span style="color: #007700">);<br />    }<br />}<br /><br /></span><span style="color: #9876AA">$base </span><span style="color: #007700">= </span><span style="color: #9876AA">event_base_new</span><span style="color: #007700">();<br /></span><span style="color: #9876AA">$c    </span><span style="color: #007700">= new </span><span style="color: #9876AA">MyEventSignal</span><span style="color: #007700">(</span><span style="color: #9876AA">$base</span><span style="color: #007700">);<br /></span><span style="color: #9876AA">$no   </span><span style="color: #007700">= </span><span style="color: #9876AA">SIGTERM</span><span style="color: #007700">;<br /></span><span style="color: #9876AA">$ev   </span><span style="color: #007700">= </span><span style="color: #9876AA">evsignal_new</span><span style="color: #007700">(</span><span style="color: #9876AA">$base</span><span style="color: #007700">, </span><span style="color: #9876AA">$no</span><span style="color: #007700">, array(</span><span style="color: #9876AA">$c</span><span style="color: #007700">,</span><span style="color: #DD0000">'eventSighandler'</span><span style="color: #007700">), </span><span style="color: #9876AA">$c</span><span style="color: #007700">);<br /><br /></span><span style="color: #9876AA">evsignal_add</span><span style="color: #007700">(</span><span style="color: #9876AA">$ev</span><span style="color: #007700">);<br /><br /></span><span style="color: #9876AA">event_base_loop</span><span style="color: #007700">(</span><span style="color: #9876AA">$base</span><span style="color: #007700">);<br /></span><span style="color: #9876AA">?&gt;</span></span></span></div>  </div> </div> <div class="example" id="">  <p><strong>示例 #6 Use libevent&#039;s loop to process requests of `eio&#039; extension</strong></p>  <div class="example-contents"><div class="phpcode" style="border-color:gray;background:#232525"><span><span style="color: #000000"><span style="color: #9876AA">&lt;?php<br /></span><span style="color: #FF8000">// Callback for eio_nop()<br /></span><span style="color: #007700">function </span><span style="color: #9876AA">my_nop_cb</span><span style="color: #007700">(</span><span style="color: #9876AA">$d</span><span style="color: #007700">, </span><span style="color: #9876AA">$r</span><span style="color: #007700">) {<br />    echo </span><span style="color: #DD0000">"step 6\n"</span><span style="color: #007700">;<br />}<br /><br /></span><span style="color: #9876AA">$dir </span><span style="color: #007700">= </span><span style="color: #DD0000">"/tmp/abc-eio-temp"</span><span style="color: #007700">;<br />if (</span><span style="color: #9876AA">file_exists</span><span style="color: #007700">(</span><span style="color: #9876AA">$dir</span><span style="color: #007700">)) {<br />    </span><span style="color: #9876AA">rmdir</span><span style="color: #007700">(</span><span style="color: #9876AA">$dir</span><span style="color: #007700">);<br />}<br /><br />echo </span><span style="color: #DD0000">"step 1\n"</span><span style="color: #007700">;<br /><br /></span><span style="color: #9876AA">$base </span><span style="color: #007700">= new </span><span style="color: #9876AA">EventBase</span><span style="color: #007700">();<br /><br />echo </span><span style="color: #DD0000">"step 2\n"</span><span style="color: #007700">;<br /><br /></span><span style="color: #9876AA">eio_init</span><span style="color: #007700">();<br /><br /></span><span style="color: #9876AA">eio_mkdir</span><span style="color: #007700">(</span><span style="color: #9876AA">$dir</span><span style="color: #007700">, </span><span style="color: #9876AA">0750</span><span style="color: #007700">, </span><span style="color: #9876AA">EIO_PRI_DEFAULT</span><span style="color: #007700">, </span><span style="color: #DD0000">"my_nop_cb"</span><span style="color: #007700">);<br /><br /></span><span style="color: #9876AA">$event </span><span style="color: #007700">= new </span><span style="color: #9876AA">Event</span><span style="color: #007700">(</span><span style="color: #9876AA">$base</span><span style="color: #007700">, </span><span style="color: #9876AA">eio_get_event_stream</span><span style="color: #007700">(),<br />    </span><span style="color: #9876AA">Event</span><span style="color: #007700">::</span><span style="color: #9876AA">READ </span><span style="color: #007700">| </span><span style="color: #9876AA">Event</span><span style="color: #007700">::</span><span style="color: #9876AA">PERSIST</span><span style="color: #007700">, function (</span><span style="color: #9876AA">$fd</span><span style="color: #007700">, </span><span style="color: #9876AA">$events</span><span style="color: #007700">, </span><span style="color: #9876AA">$base</span><span style="color: #007700">) {<br />    echo </span><span style="color: #DD0000">"step 5\n"</span><span style="color: #007700">;<br /><br />    while (</span><span style="color: #9876AA">eio_nreqs</span><span style="color: #007700">()) {<br />        </span><span style="color: #9876AA">eio_poll</span><span style="color: #007700">();<br />    }<br /><br />    </span><span style="color: #9876AA">$base</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">stop</span><span style="color: #007700">();<br />}, </span><span style="color: #9876AA">$base</span><span style="color: #007700">);<br /><br />echo </span><span style="color: #DD0000">"step 3\n"</span><span style="color: #007700">;<br /><br /></span><span style="color: #9876AA">$event</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">add</span><span style="color: #007700">();<br /><br />echo </span><span style="color: #DD0000">"step 4\n"</span><span style="color: #007700">;<br /><br /></span><span style="color: #9876AA">$base</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">dispatch</span><span style="color: #007700">();<br /><br />echo </span><span style="color: #DD0000">"Done\n"</span><span style="color: #007700">;<br /></span><span style="color: #9876AA">?&gt;</span></span></span></div>  </div> </div> <div class="example" id="">  <p><strong>示例 #7 Miscellaneous</strong></p>  <div class="example-contents"><div class="phpcode" style="border-color:gray;background:#232525"><span><span style="color: #000000"><span style="color: #9876AA">&lt;?php<br /></span><span style="color: #FF8000">// {{{ Config &amp; supported stuff <br /></span><span style="color: #007700">echo </span><span style="color: #DD0000">"Supported methods:\n"</span><span style="color: #007700">;<br />foreach (</span><span style="color: #9876AA">Event</span><span style="color: #007700">::</span><span style="color: #9876AA">getSupportedMethods</span><span style="color: #007700">() as </span><span style="color: #9876AA">$m</span><span style="color: #007700">) {<br />    echo </span><span style="color: #9876AA">$m</span><span style="color: #007700">, </span><span style="color: #9876AA">PHP_EOL</span><span style="color: #007700">;<br />}<br /><br /></span><span style="color: #FF8000">// Avoiding "select" method<br /></span><span style="color: #9876AA">$cfg </span><span style="color: #007700">= new </span><span style="color: #9876AA">EventConfig</span><span style="color: #007700">();<br />if (</span><span style="color: #9876AA">$cfg</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">avoidMethod</span><span style="color: #007700">(</span><span style="color: #DD0000">"select"</span><span style="color: #007700">)) {<br />    echo </span><span style="color: #DD0000">"'select' method avoided\n"</span><span style="color: #007700">;<br />}<br /><br /></span><span style="color: #FF8000">// Create event_base associated with the config<br /></span><span style="color: #9876AA">$base </span><span style="color: #007700">= new </span><span style="color: #9876AA">EventBase</span><span style="color: #007700">(</span><span style="color: #9876AA">$cfg</span><span style="color: #007700">);<br />echo </span><span style="color: #DD0000">"Event method used: "</span><span style="color: #007700">, </span><span style="color: #9876AA">$base</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">getMethod</span><span style="color: #007700">(), </span><span style="color: #9876AA">PHP_EOL</span><span style="color: #007700">;<br /><br />echo </span><span style="color: #DD0000">"Features:\n"</span><span style="color: #007700">;<br /></span><span style="color: #9876AA">$features </span><span style="color: #007700">= </span><span style="color: #9876AA">$base</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">getFeatures</span><span style="color: #007700">();<br />(</span><span style="color: #9876AA">$features </span><span style="color: #007700">&amp; </span><span style="color: #9876AA">EventConfig</span><span style="color: #007700">::</span><span style="color: #9876AA">FEATURE_ET</span><span style="color: #007700">) and print </span><span style="color: #DD0000">"ET - edge-triggered IO\n"</span><span style="color: #007700">;<br />(</span><span style="color: #9876AA">$features </span><span style="color: #007700">&amp; </span><span style="color: #9876AA">EventConfig</span><span style="color: #007700">::</span><span style="color: #9876AA">FEATURE_O1</span><span style="color: #007700">) and print </span><span style="color: #DD0000">"O1 - O(1) operation for adding/deleting events\n"</span><span style="color: #007700">;<br />(</span><span style="color: #9876AA">$features </span><span style="color: #007700">&amp; </span><span style="color: #9876AA">EventConfig</span><span style="color: #007700">::</span><span style="color: #9876AA">FEATURE_FDS</span><span style="color: #007700">) and print </span><span style="color: #DD0000">"FDS - arbitrary file descriptor types, and not just sockets\n"</span><span style="color: #007700">;<br /><br /></span><span style="color: #FF8000">// Require FDS feature<br /></span><span style="color: #007700">if (</span><span style="color: #9876AA">$cfg</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">requireFeatures</span><span style="color: #007700">(</span><span style="color: #9876AA">EventConfig</span><span style="color: #007700">::</span><span style="color: #9876AA">FEATURE_FDS</span><span style="color: #007700">)) {<br />    echo </span><span style="color: #DD0000">"FDS feature is now required\n"</span><span style="color: #007700">;<br /><br />    </span><span style="color: #9876AA">$base </span><span style="color: #007700">= new </span><span style="color: #9876AA">EventBase</span><span style="color: #007700">(</span><span style="color: #9876AA">$cfg</span><span style="color: #007700">);<br />    (</span><span style="color: #9876AA">$base</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">getFeatures</span><span style="color: #007700">() &amp; </span><span style="color: #9876AA">EventConfig</span><span style="color: #007700">::</span><span style="color: #9876AA">FEATURE_FDS</span><span style="color: #007700">)<br />        and print </span><span style="color: #DD0000">"FDS - arbitrary file descriptor types, and not just sockets\n"</span><span style="color: #007700">;<br />}<br /></span><span style="color: #FF8000">// }}} <br /><br />// {{{ Base <br /></span><span style="color: #9876AA">$base </span><span style="color: #007700">= new </span><span style="color: #9876AA">EventBase</span><span style="color: #007700">();<br /></span><span style="color: #9876AA">$event </span><span style="color: #007700">= new </span><span style="color: #9876AA">Event</span><span style="color: #007700">(</span><span style="color: #9876AA">$base</span><span style="color: #007700">, </span><span style="color: #9876AA">STDIN</span><span style="color: #007700">, </span><span style="color: #9876AA">Event</span><span style="color: #007700">::</span><span style="color: #9876AA">READ </span><span style="color: #007700">| </span><span style="color: #9876AA">Event</span><span style="color: #007700">::</span><span style="color: #9876AA">PERSIST</span><span style="color: #007700">, function (</span><span style="color: #9876AA">$fd</span><span style="color: #007700">, </span><span style="color: #9876AA">$events</span><span style="color: #007700">, </span><span style="color: #9876AA">$arg</span><span style="color: #007700">) {<br />    static </span><span style="color: #9876AA">$max_iterations </span><span style="color: #007700">= </span><span style="color: #9876AA">0</span><span style="color: #007700">;<br /><br />    if (++</span><span style="color: #9876AA">$max_iterations </span><span style="color: #007700">&gt;= </span><span style="color: #9876AA">5</span><span style="color: #007700">) {<br />        </span><span style="color: #FF8000">// exit after 5 iterations with timeout of 2.33 seconds <br />        </span><span style="color: #007700">echo </span><span style="color: #DD0000">"Stopping...\n"</span><span style="color: #007700">;<br />        </span><span style="color: #9876AA">$arg</span><span style="color: #007700">[</span><span style="color: #9876AA">0</span><span style="color: #007700">]-&gt;</span><span style="color: #9876AA">exit</span><span style="color: #007700">(</span><span style="color: #9876AA">2.33</span><span style="color: #007700">);<br />    }<br /><br />    echo </span><span style="color: #9876AA">fgets</span><span style="color: #007700">(</span><span style="color: #9876AA">$fd</span><span style="color: #007700">);<br />}, array (&amp;</span><span style="color: #9876AA">$base</span><span style="color: #007700">));<br /><br /></span><span style="color: #9876AA">$event</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">add</span><span style="color: #007700">();<br /></span><span style="color: #9876AA">$base</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">loop</span><span style="color: #007700">();<br /></span><span style="color: #FF8000">// Base }}} <br /></span><span style="color: #9876AA">?&gt;</span></span></span></div>  </div> </div> <div class="example" id="">  <p><strong>示例 #8 Simple HTTP server</strong></p>  <div class="example-contents"><div class="phpcode" style="border-color:gray;background:#232525"><span><span style="color: #000000"><span style="color: #9876AA">&lt;?php<br /></span><span style="color: #FF8000">//<br /> * Simple HTTP server.<br /> *<br /> * To test it:<br /> * 1) Run it on a port of your choice, e.g.:<br /> * $ php examples/http.php 8010<br /> * 2) In another terminal connect to some address on this port<br /> * and make GET or POST request(others are turned off here), e.g.:<br /> * $ nc -t 127.0.0.1 8010<br /> * POST /about HTTP/1.0<br /> * Content-Type: text/plain<br /> * Content-Length: 4<br /> * Connection: close<br /> * (press Enter)<br /> *<br /> * It will output<br /> * a=12<br /> * HTTP/1.0 200 OK<br /> * Content-Type: text/html; charset=ISO-8859-1<br /> * Connection: close<br /> *<br /> * $ nc -t 127.0.0.1 8010<br /> * GET /dump HTTP/1.0<br /> * Content-Type: text/plain<br /> * Content-Encoding: UTF-8<br /> * Connection: close<br /> * (press Enter)<br /> *<br /> * It will output:<br /> * HTTP/1.0 200 OK<br /> * Content-Type: text/html; charset=ISO-8859-1<br /> * Connection: close<br /> * (press Enter)<br /> *<br /> * $ nc -t 127.0.0.1 8010<br /> * GET /unknown HTTP/1.0<br /> * Connection: close<br /> *<br /> * It will output:<br /> * HTTP/1.0 200 OK<br /> * Content-Type: text/html; charset=ISO-8859-1<br /> * Connection: close<br /> *<br /> * 3) See what the server outputs on the previous terminal window.<br /> <br /><br /></span><span style="color: #007700">function </span><span style="color: #9876AA">_http_dump</span><span style="color: #007700">(</span><span style="color: #9876AA">$req</span><span style="color: #007700">, </span><span style="color: #9876AA">$data</span><span style="color: #007700">) {<br />    static </span><span style="color: #9876AA">$counter      </span><span style="color: #007700">= </span><span style="color: #9876AA">0</span><span style="color: #007700">;<br />    static </span><span style="color: #9876AA">$max_requests </span><span style="color: #007700">= </span><span style="color: #9876AA">2</span><span style="color: #007700">;<br /><br />    if (++</span><span style="color: #9876AA">$counter </span><span style="color: #007700">&gt;= </span><span style="color: #9876AA">$max_requests</span><span style="color: #007700">)  {<br />        echo </span><span style="color: #DD0000">"Counter reached max requests </span><span style="color: #9876AA">$max_requests</span><span style="color: #DD0000">. Exiting\n"</span><span style="color: #007700">;<br />        exit();<br />    }<br /><br />    echo </span><span style="color: #9876AA">__METHOD__</span><span style="color: #007700">, </span><span style="color: #DD0000">" called\n"</span><span style="color: #007700">;<br />    echo </span><span style="color: #DD0000">"request:"</span><span style="color: #007700">; </span><span style="color: #9876AA">var_dump</span><span style="color: #007700">(</span><span style="color: #9876AA">$req</span><span style="color: #007700">);<br />    echo </span><span style="color: #DD0000">"data:"</span><span style="color: #007700">; </span><span style="color: #9876AA">var_dump</span><span style="color: #007700">(</span><span style="color: #9876AA">$data</span><span style="color: #007700">);<br /><br />    echo </span><span style="color: #DD0000">"\n===== DUMP =====\n"</span><span style="color: #007700">;<br />    echo </span><span style="color: #DD0000">"Command:"</span><span style="color: #007700">, </span><span style="color: #9876AA">$req</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">getCommand</span><span style="color: #007700">(), </span><span style="color: #9876AA">PHP_EOL</span><span style="color: #007700">;<br />    echo </span><span style="color: #DD0000">"URI:"</span><span style="color: #007700">, </span><span style="color: #9876AA">$req</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">getUri</span><span style="color: #007700">(), </span><span style="color: #9876AA">PHP_EOL</span><span style="color: #007700">;<br />    echo </span><span style="color: #DD0000">"Input headers:"</span><span style="color: #007700">; </span><span style="color: #9876AA">var_dump</span><span style="color: #007700">(</span><span style="color: #9876AA">$req</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">getInputHeaders</span><span style="color: #007700">());<br />    echo </span><span style="color: #DD0000">"Output headers:"</span><span style="color: #007700">; </span><span style="color: #9876AA">var_dump</span><span style="color: #007700">(</span><span style="color: #9876AA">$req</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">getOutputHeaders</span><span style="color: #007700">());<br /><br />    echo </span><span style="color: #DD0000">"\n &gt;&gt; Sending reply ..."</span><span style="color: #007700">;<br />    </span><span style="color: #9876AA">$req</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">sendReply</span><span style="color: #007700">(</span><span style="color: #9876AA">200</span><span style="color: #007700">, </span><span style="color: #DD0000">"OK"</span><span style="color: #007700">);<br />    echo </span><span style="color: #DD0000">"OK\n"</span><span style="color: #007700">;<br /><br />    echo </span><span style="color: #DD0000">"\n &gt;&gt; Reading input buffer ...\n"</span><span style="color: #007700">;<br />    </span><span style="color: #9876AA">$buf </span><span style="color: #007700">= </span><span style="color: #9876AA">$req</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">getInputBuffer</span><span style="color: #007700">();<br />    while (</span><span style="color: #9876AA">$s </span><span style="color: #007700">= </span><span style="color: #9876AA">$buf</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">readLine</span><span style="color: #007700">(</span><span style="color: #9876AA">EventBuffer</span><span style="color: #007700">::</span><span style="color: #9876AA">EOL_ANY</span><span style="color: #007700">)) {<br />        echo </span><span style="color: #9876AA">$s</span><span style="color: #007700">, </span><span style="color: #9876AA">PHP_EOL</span><span style="color: #007700">;<br />    }<br />    echo </span><span style="color: #DD0000">"No more data in the buffer\n"</span><span style="color: #007700">;<br />}<br /><br />function </span><span style="color: #9876AA">_http_about</span><span style="color: #007700">(</span><span style="color: #9876AA">$req</span><span style="color: #007700">) {<br />    echo </span><span style="color: #9876AA">__METHOD__</span><span style="color: #007700">, </span><span style="color: #9876AA">PHP_EOL</span><span style="color: #007700">;<br />    echo </span><span style="color: #DD0000">"URI: "</span><span style="color: #007700">, </span><span style="color: #9876AA">$req</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">getUri</span><span style="color: #007700">(), </span><span style="color: #9876AA">PHP_EOL</span><span style="color: #007700">;<br />    echo </span><span style="color: #DD0000">"\n &gt;&gt; Sending reply ..."</span><span style="color: #007700">;<br />    </span><span style="color: #9876AA">$req</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">sendReply</span><span style="color: #007700">(</span><span style="color: #9876AA">200</span><span style="color: #007700">, </span><span style="color: #DD0000">"OK"</span><span style="color: #007700">);<br />    echo </span><span style="color: #DD0000">"OK\n"</span><span style="color: #007700">;<br />}<br /><br />function </span><span style="color: #9876AA">_http_default</span><span style="color: #007700">(</span><span style="color: #9876AA">$req</span><span style="color: #007700">, </span><span style="color: #9876AA">$data</span><span style="color: #007700">) {<br />    echo </span><span style="color: #9876AA">__METHOD__</span><span style="color: #007700">, </span><span style="color: #9876AA">PHP_EOL</span><span style="color: #007700">;<br />    echo </span><span style="color: #DD0000">"URI: "</span><span style="color: #007700">, </span><span style="color: #9876AA">$req</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">getUri</span><span style="color: #007700">(), </span><span style="color: #9876AA">PHP_EOL</span><span style="color: #007700">;<br />    echo </span><span style="color: #DD0000">"\n &gt;&gt; Sending reply ..."</span><span style="color: #007700">;<br />    </span><span style="color: #9876AA">$req</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">sendReply</span><span style="color: #007700">(</span><span style="color: #9876AA">200</span><span style="color: #007700">, </span><span style="color: #DD0000">"OK"</span><span style="color: #007700">);<br />    echo </span><span style="color: #DD0000">"OK\n"</span><span style="color: #007700">;<br />}<br /><br /></span><span style="color: #9876AA">$port </span><span style="color: #007700">= </span><span style="color: #9876AA">8010</span><span style="color: #007700">;<br />if (</span><span style="color: #9876AA">$argc </span><span style="color: #007700">&gt; </span><span style="color: #9876AA">1</span><span style="color: #007700">) {<br />    </span><span style="color: #9876AA">$port </span><span style="color: #007700">= (int) </span><span style="color: #9876AA">$argv</span><span style="color: #007700">[</span><span style="color: #9876AA">1</span><span style="color: #007700">];<br />}<br />if (</span><span style="color: #9876AA">$port </span><span style="color: #007700">&lt;= </span><span style="color: #9876AA">0 </span><span style="color: #007700">|| </span><span style="color: #9876AA">$port </span><span style="color: #007700">&gt; </span><span style="color: #9876AA">65535</span><span style="color: #007700">) {<br />    exit(</span><span style="color: #DD0000">"Invalid port"</span><span style="color: #007700">);<br />}<br /><br /></span><span style="color: #9876AA">$base </span><span style="color: #007700">= new </span><span style="color: #9876AA">EventBase</span><span style="color: #007700">();<br /></span><span style="color: #9876AA">$http </span><span style="color: #007700">= new </span><span style="color: #9876AA">EventHttp</span><span style="color: #007700">(</span><span style="color: #9876AA">$base</span><span style="color: #007700">);<br /></span><span style="color: #9876AA">$http</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">setAllowedMethods</span><span style="color: #007700">(</span><span style="color: #9876AA">EventHttpRequest</span><span style="color: #007700">::</span><span style="color: #9876AA">CMD_GET </span><span style="color: #007700">| </span><span style="color: #9876AA">EventHttpRequest</span><span style="color: #007700">::</span><span style="color: #9876AA">CMD_POST</span><span style="color: #007700">);<br /><br /></span><span style="color: #9876AA">$http</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">setCallback</span><span style="color: #007700">(</span><span style="color: #DD0000">"/dump"</span><span style="color: #007700">, </span><span style="color: #DD0000">"_http_dump"</span><span style="color: #007700">, array(</span><span style="color: #9876AA">4</span><span style="color: #007700">, </span><span style="color: #9876AA">8</span><span style="color: #007700">));<br /></span><span style="color: #9876AA">$http</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">setCallback</span><span style="color: #007700">(</span><span style="color: #DD0000">"/about"</span><span style="color: #007700">, </span><span style="color: #DD0000">"_http_about"</span><span style="color: #007700">);<br /></span><span style="color: #9876AA">$http</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">setDefaultCallback</span><span style="color: #007700">(</span><span style="color: #DD0000">"_http_default"</span><span style="color: #007700">, </span><span style="color: #DD0000">"custom data value"</span><span style="color: #007700">);<br /><br /></span><span style="color: #9876AA">$http</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">bind</span><span style="color: #007700">(</span><span style="color: #DD0000">"0.0.0.0"</span><span style="color: #007700">, </span><span style="color: #9876AA">8010</span><span style="color: #007700">);<br /></span><span style="color: #9876AA">$base</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">loop</span><span style="color: #007700">();<br /></span><span style="color: #9876AA">?&gt;</span></span></span></div>  </div>   <div class="example-contents"><p>以上示例的输出类似于：</p></div>   <div class="example-contents screen" style="color:AFB1B3;background:black;padding-left:5px;"><div class="cdata"><span>a=12<br>HTTP/1.0 200 OK<br>Content-Type: text/html; charset=ISO-8859-1<br>Connection: close<br><br>HTTP/1.0 200 OK<br>Content-Type: text/html; charset=ISO-8859-1<br>Connection: close<br>(press Enter)<br><br>HTTP/1.0 200 OK<br>Content-Type: text/html; charset=ISO-8859-1<br>Connection: close<br></span></div>  </div> </div> <div class="example" id="">  <p><strong>示例 #9 Simple HTTPS server</strong></p>  <div class="example-contents"><div class="phpcode" style="border-color:gray;background:#232525"><span><span style="color: #000000"><span style="color: #9876AA">&lt;?php<br /></span><span style="color: #FF8000">//<br /> * Simple HTTPS server.<br /> *<br /> * 1) Run the server: `php examples/https.php 9999`<br /> * 2) Test it: `php examples/ssl-connection.php 9999`<br /> <br /><br /></span><span style="color: #007700">function </span><span style="color: #9876AA">_http_dump</span><span style="color: #007700">(</span><span style="color: #9876AA">$req</span><span style="color: #007700">, </span><span style="color: #9876AA">$data</span><span style="color: #007700">) {<br />    static </span><span style="color: #9876AA">$counter      </span><span style="color: #007700">= </span><span style="color: #9876AA">0</span><span style="color: #007700">;<br />    static </span><span style="color: #9876AA">$max_requests </span><span style="color: #007700">= </span><span style="color: #9876AA">200</span><span style="color: #007700">;<br /><br />    if (++</span><span style="color: #9876AA">$counter </span><span style="color: #007700">&gt;= </span><span style="color: #9876AA">$max_requests</span><span style="color: #007700">)  {<br />        echo </span><span style="color: #DD0000">"Counter reached max requests </span><span style="color: #9876AA">$max_requests</span><span style="color: #DD0000">. Exiting\n"</span><span style="color: #007700">;<br />        exit();<br />    }<br /><br />    echo </span><span style="color: #9876AA">__METHOD__</span><span style="color: #007700">, </span><span style="color: #DD0000">" called\n"</span><span style="color: #007700">;<br />    echo </span><span style="color: #DD0000">"request:"</span><span style="color: #007700">; </span><span style="color: #9876AA">var_dump</span><span style="color: #007700">(</span><span style="color: #9876AA">$req</span><span style="color: #007700">);<br />    echo </span><span style="color: #DD0000">"data:"</span><span style="color: #007700">; </span><span style="color: #9876AA">var_dump</span><span style="color: #007700">(</span><span style="color: #9876AA">$data</span><span style="color: #007700">);<br /><br />    echo </span><span style="color: #DD0000">"\n===== DUMP =====\n"</span><span style="color: #007700">;<br />    echo </span><span style="color: #DD0000">"Command:"</span><span style="color: #007700">, </span><span style="color: #9876AA">$req</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">getCommand</span><span style="color: #007700">(), </span><span style="color: #9876AA">PHP_EOL</span><span style="color: #007700">;<br />    echo </span><span style="color: #DD0000">"URI:"</span><span style="color: #007700">, </span><span style="color: #9876AA">$req</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">getUri</span><span style="color: #007700">(), </span><span style="color: #9876AA">PHP_EOL</span><span style="color: #007700">;<br />    echo </span><span style="color: #DD0000">"Input headers:"</span><span style="color: #007700">; </span><span style="color: #9876AA">var_dump</span><span style="color: #007700">(</span><span style="color: #9876AA">$req</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">getInputHeaders</span><span style="color: #007700">());<br />    echo </span><span style="color: #DD0000">"Output headers:"</span><span style="color: #007700">; </span><span style="color: #9876AA">var_dump</span><span style="color: #007700">(</span><span style="color: #9876AA">$req</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">getOutputHeaders</span><span style="color: #007700">());<br /><br />    echo </span><span style="color: #DD0000">"\n &gt;&gt; Sending reply ..."</span><span style="color: #007700">;<br />    </span><span style="color: #9876AA">$req</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">sendReply</span><span style="color: #007700">(</span><span style="color: #9876AA">200</span><span style="color: #007700">, </span><span style="color: #DD0000">"OK"</span><span style="color: #007700">);<br />    echo </span><span style="color: #DD0000">"OK\n"</span><span style="color: #007700">;<br /><br />    </span><span style="color: #9876AA">$buf </span><span style="color: #007700">= </span><span style="color: #9876AA">$req</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">getInputBuffer</span><span style="color: #007700">();<br />    echo </span><span style="color: #DD0000">"\n &gt;&gt; Reading input buffer ("</span><span style="color: #007700">, </span><span style="color: #9876AA">$buf</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">length</span><span style="color: #007700">, </span><span style="color: #DD0000">") ...\n"</span><span style="color: #007700">;<br />    while (</span><span style="color: #9876AA">$s </span><span style="color: #007700">= </span><span style="color: #9876AA">$buf</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">read</span><span style="color: #007700">(</span><span style="color: #9876AA">1024</span><span style="color: #007700">)) {<br />        echo </span><span style="color: #9876AA">$s</span><span style="color: #007700">;<br />    }<br />    echo </span><span style="color: #DD0000">"\nNo more data in the buffer\n"</span><span style="color: #007700">;<br />}<br /><br />function </span><span style="color: #9876AA">_http_about</span><span style="color: #007700">(</span><span style="color: #9876AA">$req</span><span style="color: #007700">) {<br />    echo </span><span style="color: #9876AA">__METHOD__</span><span style="color: #007700">, </span><span style="color: #9876AA">PHP_EOL</span><span style="color: #007700">;<br />    echo </span><span style="color: #DD0000">"URI: "</span><span style="color: #007700">, </span><span style="color: #9876AA">$req</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">getUri</span><span style="color: #007700">(), </span><span style="color: #9876AA">PHP_EOL</span><span style="color: #007700">;<br />    echo </span><span style="color: #DD0000">"\n &gt;&gt; Sending reply ..."</span><span style="color: #007700">;<br />    </span><span style="color: #9876AA">$req</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">sendReply</span><span style="color: #007700">(</span><span style="color: #9876AA">200</span><span style="color: #007700">, </span><span style="color: #DD0000">"OK"</span><span style="color: #007700">);<br />    echo </span><span style="color: #DD0000">"OK\n"</span><span style="color: #007700">;<br />}<br /><br />function </span><span style="color: #9876AA">_http_default</span><span style="color: #007700">(</span><span style="color: #9876AA">$req</span><span style="color: #007700">, </span><span style="color: #9876AA">$data</span><span style="color: #007700">) {<br />    echo </span><span style="color: #9876AA">__METHOD__</span><span style="color: #007700">, </span><span style="color: #9876AA">PHP_EOL</span><span style="color: #007700">;<br />    echo </span><span style="color: #DD0000">"URI: "</span><span style="color: #007700">, </span><span style="color: #9876AA">$req</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">getUri</span><span style="color: #007700">(), </span><span style="color: #9876AA">PHP_EOL</span><span style="color: #007700">;<br />    echo </span><span style="color: #DD0000">"\n &gt;&gt; Sending reply ..."</span><span style="color: #007700">;<br />    </span><span style="color: #9876AA">$req</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">sendReply</span><span style="color: #007700">(</span><span style="color: #9876AA">200</span><span style="color: #007700">, </span><span style="color: #DD0000">"OK"</span><span style="color: #007700">);<br />    echo </span><span style="color: #DD0000">"OK\n"</span><span style="color: #007700">;<br />}<br /><br />function </span><span style="color: #9876AA">_http_400</span><span style="color: #007700">(</span><span style="color: #9876AA">$req</span><span style="color: #007700">) {<br />    </span><span style="color: #9876AA">$req</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">sendError</span><span style="color: #007700">(</span><span style="color: #9876AA">400</span><span style="color: #007700">);<br />}<br /><br />function </span><span style="color: #9876AA">_init_ssl</span><span style="color: #007700">() {<br />    </span><span style="color: #9876AA">$local_cert </span><span style="color: #007700">= </span><span style="color: #9876AA">__DIR__</span><span style="color: #007700">.</span><span style="color: #DD0000">"/ssl-echo-server/cert.pem"</span><span style="color: #007700">;<br />    </span><span style="color: #9876AA">$local_pk   </span><span style="color: #007700">= </span><span style="color: #9876AA">__DIR__</span><span style="color: #007700">.</span><span style="color: #DD0000">"/ssl-echo-server/privkey.pem"</span><span style="color: #007700">;<br /><br />    </span><span style="color: #9876AA">$ctx </span><span style="color: #007700">= new </span><span style="color: #9876AA">EventSslContext</span><span style="color: #007700">(</span><span style="color: #9876AA">EventSslContext</span><span style="color: #007700">::</span><span style="color: #9876AA">SSLv3_SERVER_METHOD</span><span style="color: #007700">, array (<br />        </span><span style="color: #9876AA">EventSslContext</span><span style="color: #007700">::</span><span style="color: #9876AA">OPT_LOCAL_CERT  </span><span style="color: #007700">=&gt; </span><span style="color: #9876AA">$local_cert</span><span style="color: #007700">,<br />        </span><span style="color: #9876AA">EventSslContext</span><span style="color: #007700">::</span><span style="color: #9876AA">OPT_LOCAL_PK    </span><span style="color: #007700">=&gt; </span><span style="color: #9876AA">$local_pk</span><span style="color: #007700">,<br />        </span><span style="color: #FF8000">//EventSslContext::OPT_PASSPHRASE  =&gt; "test",<br />        </span><span style="color: #9876AA">EventSslContext</span><span style="color: #007700">::</span><span style="color: #9876AA">OPT_ALLOW_SELF_SIGNED </span><span style="color: #007700">=&gt; </span><span style="color: #9876AA">true</span><span style="color: #007700">,<br />    ));<br /><br />    return </span><span style="color: #9876AA">$ctx</span><span style="color: #007700">;<br />}<br /><br /></span><span style="color: #9876AA">$port </span><span style="color: #007700">= </span><span style="color: #9876AA">9999</span><span style="color: #007700">;<br />if (</span><span style="color: #9876AA">$argc </span><span style="color: #007700">&gt; </span><span style="color: #9876AA">1</span><span style="color: #007700">) {<br />    </span><span style="color: #9876AA">$port </span><span style="color: #007700">= (int) </span><span style="color: #9876AA">$argv</span><span style="color: #007700">[</span><span style="color: #9876AA">1</span><span style="color: #007700">];<br />}<br />if (</span><span style="color: #9876AA">$port </span><span style="color: #007700">&lt;= </span><span style="color: #9876AA">0 </span><span style="color: #007700">|| </span><span style="color: #9876AA">$port </span><span style="color: #007700">&gt; </span><span style="color: #9876AA">65535</span><span style="color: #007700">) {<br />    exit(</span><span style="color: #DD0000">"Invalid port"</span><span style="color: #007700">);<br />}<br /></span><span style="color: #9876AA">$ip </span><span style="color: #007700">= </span><span style="color: #DD0000">'0.0.0.0'</span><span style="color: #007700">;<br /><br /></span><span style="color: #9876AA">$base </span><span style="color: #007700">= new </span><span style="color: #9876AA">EventBase</span><span style="color: #007700">();<br /></span><span style="color: #9876AA">$ctx  </span><span style="color: #007700">= </span><span style="color: #9876AA">_init_ssl</span><span style="color: #007700">();<br /></span><span style="color: #9876AA">$http </span><span style="color: #007700">= new </span><span style="color: #9876AA">EventHttp</span><span style="color: #007700">(</span><span style="color: #9876AA">$base</span><span style="color: #007700">, </span><span style="color: #9876AA">$ctx</span><span style="color: #007700">);<br /></span><span style="color: #9876AA">$http</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">setAllowedMethods</span><span style="color: #007700">(</span><span style="color: #9876AA">EventHttpRequest</span><span style="color: #007700">::</span><span style="color: #9876AA">CMD_GET </span><span style="color: #007700">| </span><span style="color: #9876AA">EventHttpRequest</span><span style="color: #007700">::</span><span style="color: #9876AA">CMD_POST</span><span style="color: #007700">);<br /><br /></span><span style="color: #9876AA">$http</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">setCallback</span><span style="color: #007700">(</span><span style="color: #DD0000">"/dump"</span><span style="color: #007700">, </span><span style="color: #DD0000">"_http_dump"</span><span style="color: #007700">, array(</span><span style="color: #9876AA">4</span><span style="color: #007700">, </span><span style="color: #9876AA">8</span><span style="color: #007700">));<br /></span><span style="color: #9876AA">$http</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">setCallback</span><span style="color: #007700">(</span><span style="color: #DD0000">"/about"</span><span style="color: #007700">, </span><span style="color: #DD0000">"_http_about"</span><span style="color: #007700">);<br /></span><span style="color: #9876AA">$http</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">setCallback</span><span style="color: #007700">(</span><span style="color: #DD0000">"/err400"</span><span style="color: #007700">, </span><span style="color: #DD0000">"_http_400"</span><span style="color: #007700">);<br /></span><span style="color: #9876AA">$http</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">setDefaultCallback</span><span style="color: #007700">(</span><span style="color: #DD0000">"_http_default"</span><span style="color: #007700">, </span><span style="color: #DD0000">"custom data value"</span><span style="color: #007700">);<br /><br /></span><span style="color: #9876AA">$http</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">bind</span><span style="color: #007700">(</span><span style="color: #9876AA">$ip</span><span style="color: #007700">, </span><span style="color: #9876AA">$port</span><span style="color: #007700">);<br /></span><span style="color: #9876AA">$base</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">dispatch</span><span style="color: #007700">();</span></span></span></div>  </div> </div> <div class="example" id="">  <p><strong>示例 #10 OpenSSL connection</strong></p>  <div class="example-contents"><div class="phpcode" style="border-color:gray;background:#232525"><span><span style="color: #000000"><span style="color: #9876AA">&lt;?php<br /></span><span style="color: #FF8000">//<br /> * Sample OpenSSL client.<br /> *<br /> * Usage:<br /> * 1) Launch a server, e.g.:<br /> * $ php examples/https.php 9999<br /> *<br /> * 2) Launch the client in another terminal:<br /> * $ php examples/ssl-connection.php 9999<br /> <br /><br /></span><span style="color: #007700">function </span><span style="color: #9876AA">_request_handler</span><span style="color: #007700">(</span><span style="color: #9876AA">$req</span><span style="color: #007700">, </span><span style="color: #9876AA">$base</span><span style="color: #007700">) {<br />    echo </span><span style="color: #9876AA">__FUNCTION__</span><span style="color: #007700">, </span><span style="color: #9876AA">PHP_EOL</span><span style="color: #007700">;<br /><br />    if (</span><span style="color: #9876AA">is_null</span><span style="color: #007700">(</span><span style="color: #9876AA">$req</span><span style="color: #007700">)) {<br />        echo </span><span style="color: #DD0000">"Timed out\n"</span><span style="color: #007700">;<br />    } else {<br />        </span><span style="color: #9876AA">$response_code </span><span style="color: #007700">= </span><span style="color: #9876AA">$req</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">getResponseCode</span><span style="color: #007700">();<br /><br />        if (</span><span style="color: #9876AA">$response_code </span><span style="color: #007700">== </span><span style="color: #9876AA">0</span><span style="color: #007700">) {<br />            echo </span><span style="color: #DD0000">"Connection refused\n"</span><span style="color: #007700">;<br />        } elseif (</span><span style="color: #9876AA">$response_code </span><span style="color: #007700">!= </span><span style="color: #9876AA">200</span><span style="color: #007700">) {<br />            echo </span><span style="color: #DD0000">"Unexpected response: </span><span style="color: #9876AA">$response_code</span><span style="color: #DD0000">\n"</span><span style="color: #007700">;<br />        } else {<br />            echo </span><span style="color: #DD0000">"Success: </span><span style="color: #9876AA">$response_code</span><span style="color: #DD0000">\n"</span><span style="color: #007700">;<br />            </span><span style="color: #9876AA">$buf </span><span style="color: #007700">= </span><span style="color: #9876AA">$req</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">getInputBuffer</span><span style="color: #007700">();<br />            echo </span><span style="color: #DD0000">"Body:\n"</span><span style="color: #007700">;<br />            while (</span><span style="color: #9876AA">$s </span><span style="color: #007700">= </span><span style="color: #9876AA">$buf</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">readLine</span><span style="color: #007700">(</span><span style="color: #9876AA">EventBuffer</span><span style="color: #007700">::</span><span style="color: #9876AA">EOL_ANY</span><span style="color: #007700">)) {<br />                echo </span><span style="color: #9876AA">$s</span><span style="color: #007700">, </span><span style="color: #9876AA">PHP_EOL</span><span style="color: #007700">;<br />            }<br />        }<br />    }<br /><br />    </span><span style="color: #9876AA">$base</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">exit</span><span style="color: #007700">(</span><span style="color: #9876AA">NULL</span><span style="color: #007700">);<br />}<br /><br />function </span><span style="color: #9876AA">_init_ssl</span><span style="color: #007700">() {<br />    </span><span style="color: #9876AA">$ctx </span><span style="color: #007700">= new </span><span style="color: #9876AA">EventSslContext</span><span style="color: #007700">(</span><span style="color: #9876AA">EventSslContext</span><span style="color: #007700">::</span><span style="color: #9876AA">SSLv3_CLIENT_METHOD</span><span style="color: #007700">, array ());<br /><br />    return </span><span style="color: #9876AA">$ctx</span><span style="color: #007700">;<br />}<br /><br /><br /></span><span style="color: #FF8000">// Allow to override the port<br /></span><span style="color: #9876AA">$port </span><span style="color: #007700">= </span><span style="color: #9876AA">9999</span><span style="color: #007700">;<br />if (</span><span style="color: #9876AA">$argc </span><span style="color: #007700">&gt; </span><span style="color: #9876AA">1</span><span style="color: #007700">) {<br />    </span><span style="color: #9876AA">$port </span><span style="color: #007700">= (int) </span><span style="color: #9876AA">$argv</span><span style="color: #007700">[</span><span style="color: #9876AA">1</span><span style="color: #007700">];<br />}<br />if (</span><span style="color: #9876AA">$port </span><span style="color: #007700">&lt;= </span><span style="color: #9876AA">0 </span><span style="color: #007700">|| </span><span style="color: #9876AA">$port </span><span style="color: #007700">&gt; </span><span style="color: #9876AA">65535</span><span style="color: #007700">) {<br />    exit(</span><span style="color: #DD0000">"Invalid port\n"</span><span style="color: #007700">);<br />}<br /></span><span style="color: #9876AA">$host </span><span style="color: #007700">= </span><span style="color: #DD0000">'127.0.0.1'</span><span style="color: #007700">;<br /><br /></span><span style="color: #9876AA">$ctx </span><span style="color: #007700">= </span><span style="color: #9876AA">_init_ssl</span><span style="color: #007700">();<br />if (!</span><span style="color: #9876AA">$ctx</span><span style="color: #007700">) {<br />    </span><span style="color: #9876AA">trigger_error</span><span style="color: #007700">(</span><span style="color: #DD0000">"Failed creating SSL context"</span><span style="color: #007700">, </span><span style="color: #9876AA">E_USER_ERROR</span><span style="color: #007700">);<br />}<br /><br /></span><span style="color: #9876AA">$base </span><span style="color: #007700">= new </span><span style="color: #9876AA">EventBase</span><span style="color: #007700">();<br />if (!</span><span style="color: #9876AA">$base</span><span style="color: #007700">) {<br />    </span><span style="color: #9876AA">trigger_error</span><span style="color: #007700">(</span><span style="color: #DD0000">"Failed to initialize event base"</span><span style="color: #007700">, </span><span style="color: #9876AA">E_USER_ERROR</span><span style="color: #007700">);<br />}<br /><br /></span><span style="color: #9876AA">$conn </span><span style="color: #007700">= new </span><span style="color: #9876AA">EventHttpConnection</span><span style="color: #007700">(</span><span style="color: #9876AA">$base</span><span style="color: #007700">, </span><span style="color: #9876AA">NULL</span><span style="color: #007700">, </span><span style="color: #9876AA">$host</span><span style="color: #007700">, </span><span style="color: #9876AA">$port</span><span style="color: #007700">, </span><span style="color: #9876AA">$ctx</span><span style="color: #007700">);<br /></span><span style="color: #9876AA">$conn</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">setTimeout</span><span style="color: #007700">(</span><span style="color: #9876AA">50</span><span style="color: #007700">);<br /><br /></span><span style="color: #9876AA">$req </span><span style="color: #007700">= new </span><span style="color: #9876AA">EventHttpRequest</span><span style="color: #007700">(</span><span style="color: #DD0000">"_request_handler"</span><span style="color: #007700">, </span><span style="color: #9876AA">$base</span><span style="color: #007700">);<br /></span><span style="color: #9876AA">$req</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">addHeader</span><span style="color: #007700">(</span><span style="color: #DD0000">"Host"</span><span style="color: #007700">, </span><span style="color: #9876AA">$host</span><span style="color: #007700">, </span><span style="color: #9876AA">EventHttpRequest</span><span style="color: #007700">::</span><span style="color: #9876AA">OUTPUT_HEADER</span><span style="color: #007700">);<br /></span><span style="color: #9876AA">$buf </span><span style="color: #007700">= </span><span style="color: #9876AA">$req</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">getOutputBuffer</span><span style="color: #007700">();<br /></span><span style="color: #9876AA">$buf</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">add</span><span style="color: #007700">(</span><span style="color: #DD0000">"&lt;html&gt;HTML TEST&lt;/html&gt;"</span><span style="color: #007700">);<br /></span><span style="color: #FF8000">//$req-&gt;addHeader("Content-Length", $buf-&gt;length, EventHttpRequest::OUTPUT_HEADER);<br />//$req-&gt;addHeader("Connection", "close", EventHttpRequest::OUTPUT_HEADER);<br /></span><span style="color: #9876AA">$conn</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">makeRequest</span><span style="color: #007700">(</span><span style="color: #9876AA">$req</span><span style="color: #007700">, </span><span style="color: #9876AA">EventHttpRequest</span><span style="color: #007700">::</span><span style="color: #9876AA">CMD_POST</span><span style="color: #007700">, </span><span style="color: #DD0000">"/dump"</span><span style="color: #007700">);<br /><br /></span><span style="color: #9876AA">$base</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">dispatch</span><span style="color: #007700">();<br />echo </span><span style="color: #DD0000">"END\n"</span><span style="color: #007700">;<br /></span><span style="color: #9876AA">?&gt;</span></span></span></div>  </div> </div> <div class="example" id="">  <p><strong>示例 #11    <span class="function">{@link EventHttpConnection::makeRequest()}</span> example</strong></p>  <div class="example-contents"><div class="phpcode" style="border-color:gray;background:#232525"><span><span style="color: #000000"><span style="color: #9876AA">&lt;?php<br /></span><span style="color: #007700">function </span><span style="color: #9876AA">_request_handler</span><span style="color: #007700">(</span><span style="color: #9876AA">$req</span><span style="color: #007700">, </span><span style="color: #9876AA">$base</span><span style="color: #007700">) {<br />    echo </span><span style="color: #9876AA">__FUNCTION__</span><span style="color: #007700">, </span><span style="color: #9876AA">PHP_EOL</span><span style="color: #007700">;<br /><br />    if (</span><span style="color: #9876AA">is_null</span><span style="color: #007700">(</span><span style="color: #9876AA">$req</span><span style="color: #007700">)) {<br />        echo </span><span style="color: #DD0000">"Timed out\n"</span><span style="color: #007700">;<br />    } else {<br />        </span><span style="color: #9876AA">$response_code </span><span style="color: #007700">= </span><span style="color: #9876AA">$req</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">getResponseCode</span><span style="color: #007700">();<br /><br />        if (</span><span style="color: #9876AA">$response_code </span><span style="color: #007700">== </span><span style="color: #9876AA">0</span><span style="color: #007700">) {<br />            echo </span><span style="color: #DD0000">"Connection refused\n"</span><span style="color: #007700">;<br />        } elseif (</span><span style="color: #9876AA">$response_code </span><span style="color: #007700">!= </span><span style="color: #9876AA">200</span><span style="color: #007700">) {<br />            echo </span><span style="color: #DD0000">"Unexpected response: </span><span style="color: #9876AA">$response_code</span><span style="color: #DD0000">\n"</span><span style="color: #007700">;<br />        } else {<br />            echo </span><span style="color: #DD0000">"Success: </span><span style="color: #9876AA">$response_code</span><span style="color: #DD0000">\n"</span><span style="color: #007700">;<br />            </span><span style="color: #9876AA">$buf </span><span style="color: #007700">= </span><span style="color: #9876AA">$req</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">getInputBuffer</span><span style="color: #007700">();<br />            echo </span><span style="color: #DD0000">"Body:\n"</span><span style="color: #007700">;<br />            while (</span><span style="color: #9876AA">$s </span><span style="color: #007700">= </span><span style="color: #9876AA">$buf</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">readLine</span><span style="color: #007700">(</span><span style="color: #9876AA">EventBuffer</span><span style="color: #007700">::</span><span style="color: #9876AA">EOL_ANY</span><span style="color: #007700">)) {<br />                echo </span><span style="color: #9876AA">$s</span><span style="color: #007700">, </span><span style="color: #9876AA">PHP_EOL</span><span style="color: #007700">;<br />            }<br />        }<br />    }<br /><br />    </span><span style="color: #9876AA">$base</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">exit</span><span style="color: #007700">(</span><span style="color: #9876AA">NULL</span><span style="color: #007700">);<br />}<br /><br /></span><span style="color: #9876AA">$address </span><span style="color: #007700">= </span><span style="color: #DD0000">"127.0.0.1"</span><span style="color: #007700">;<br /></span><span style="color: #9876AA">$port </span><span style="color: #007700">= </span><span style="color: #9876AA">80</span><span style="color: #007700">;<br /><br /></span><span style="color: #9876AA">$base </span><span style="color: #007700">= new </span><span style="color: #9876AA">EventBase</span><span style="color: #007700">();<br /></span><span style="color: #9876AA">$conn </span><span style="color: #007700">= new </span><span style="color: #9876AA">EventHttpConnection</span><span style="color: #007700">(</span><span style="color: #9876AA">$base</span><span style="color: #007700">, </span><span style="color: #9876AA">NULL</span><span style="color: #007700">, </span><span style="color: #9876AA">$address</span><span style="color: #007700">, </span><span style="color: #9876AA">$port</span><span style="color: #007700">);<br /></span><span style="color: #9876AA">$conn</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">setTimeout</span><span style="color: #007700">(</span><span style="color: #9876AA">5</span><span style="color: #007700">);<br /></span><span style="color: #9876AA">$req </span><span style="color: #007700">= new </span><span style="color: #9876AA">EventHttpRequest</span><span style="color: #007700">(</span><span style="color: #DD0000">"_request_handler"</span><span style="color: #007700">, </span><span style="color: #9876AA">$base</span><span style="color: #007700">);<br /><br /></span><span style="color: #9876AA">$req</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">addHeader</span><span style="color: #007700">(</span><span style="color: #DD0000">"Host"</span><span style="color: #007700">, </span><span style="color: #9876AA">$address</span><span style="color: #007700">, </span><span style="color: #9876AA">EventHttpRequest</span><span style="color: #007700">::</span><span style="color: #9876AA">OUTPUT_HEADER</span><span style="color: #007700">);<br /></span><span style="color: #9876AA">$req</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">addHeader</span><span style="color: #007700">(</span><span style="color: #DD0000">"Content-Length"</span><span style="color: #007700">, </span><span style="color: #DD0000">"0"</span><span style="color: #007700">, </span><span style="color: #9876AA">EventHttpRequest</span><span style="color: #007700">::</span><span style="color: #9876AA">OUTPUT_HEADER</span><span style="color: #007700">);<br /></span><span style="color: #9876AA">$conn</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">makeRequest</span><span style="color: #007700">(</span><span style="color: #9876AA">$req</span><span style="color: #007700">, </span><span style="color: #9876AA">EventHttpRequest</span><span style="color: #007700">::</span><span style="color: #9876AA">CMD_GET</span><span style="color: #007700">, </span><span style="color: #DD0000">"/index.cphp"</span><span style="color: #007700">);<br /><br /></span><span style="color: #9876AA">$base</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">loop</span><span style="color: #007700">();<br /></span><span style="color: #9876AA">?&gt;</span></span></span></div>  </div>   <div class="example-contents"><p>以上示例的输出类似于：</p></div>   <div class="example-contents screen" style="color:AFB1B3;background:black;padding-left:5px;"><div class="cdata"><span>_request_handler<br>Success: 200<br>Body:<br>PHP, date:<br>2013-03-13T20:27:52+05:00<br></span></div>  </div> </div> <div class="example" id="">  <p><strong>示例 #12    Connection listener based on a UNIX domain socket</strong></p>  <div class="example-contents"><div class="phpcode" style="border-color:gray;background:#232525"><span><span style="color: #000000"><span style="color: #9876AA">&lt;?php<br /></span><span style="color: #FF8000">//<br /> * Simple echo server based on libevent's connection listener.<br /> *<br /> * Usage:<br /> * 1) In one terminal window run:<br /> *<br /> * $ php unix-domain-listener.php [path-to-socket]<br /> *<br /> * 2) In another terminal window open up connection<br /> * to the socket, e.g.:<br /> *<br /> * $ socat - GOPEN:/tmp/1.sock<br /> *<br /> * 3) Start typing. The server should repeat the input.<br /> <br /><br /></span><span style="color: #007700">class </span><span style="color: #9876AA">MyListenerConnection </span><span style="color: #007700">{<br />    private </span><span style="color: #9876AA">$bev</span><span style="color: #007700">, </span><span style="color: #9876AA">$base</span><span style="color: #007700">;<br /><br />    public function </span><span style="color: #9876AA">__destruct</span><span style="color: #007700">() {<br />        if (</span><span style="color: #9876AA">$this</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">bev</span><span style="color: #007700">) {<br />            </span><span style="color: #9876AA">$this</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">bev</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">free</span><span style="color: #007700">();<br />        }<br />    }<br /><br />    public function </span><span style="color: #9876AA">__construct</span><span style="color: #007700">(</span><span style="color: #9876AA">$base</span><span style="color: #007700">, </span><span style="color: #9876AA">$fd</span><span style="color: #007700">) {<br />        </span><span style="color: #9876AA">$this</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">base </span><span style="color: #007700">= </span><span style="color: #9876AA">$base</span><span style="color: #007700">;<br /><br />        </span><span style="color: #9876AA">$this</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">bev </span><span style="color: #007700">= new </span><span style="color: #9876AA">EventBufferEvent</span><span style="color: #007700">(</span><span style="color: #9876AA">$base</span><span style="color: #007700">, </span><span style="color: #9876AA">$fd</span><span style="color: #007700">, </span><span style="color: #9876AA">EventBufferEvent</span><span style="color: #007700">::</span><span style="color: #9876AA">OPT_CLOSE_ON_FREE</span><span style="color: #007700">);<br /><br />        </span><span style="color: #9876AA">$this</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">bev</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">setCallbacks</span><span style="color: #007700">(array(</span><span style="color: #9876AA">$this</span><span style="color: #007700">, </span><span style="color: #DD0000">"echoReadCallback"</span><span style="color: #007700">), </span><span style="color: #9876AA">NULL</span><span style="color: #007700">,<br />            array(</span><span style="color: #9876AA">$this</span><span style="color: #007700">, </span><span style="color: #DD0000">"echoEventCallback"</span><span style="color: #007700">), </span><span style="color: #9876AA">NULL</span><span style="color: #007700">);<br /><br />        if (!</span><span style="color: #9876AA">$this</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">bev</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">enable</span><span style="color: #007700">(</span><span style="color: #9876AA">Event</span><span style="color: #007700">::</span><span style="color: #9876AA">READ</span><span style="color: #007700">)) {<br />            echo </span><span style="color: #DD0000">"Failed to enable READ\n"</span><span style="color: #007700">;<br />            return;<br />        }<br />    }<br /><br />    public function </span><span style="color: #9876AA">echoReadCallback</span><span style="color: #007700">(</span><span style="color: #9876AA">$bev</span><span style="color: #007700">, </span><span style="color: #9876AA">$ctx</span><span style="color: #007700">) {<br />        </span><span style="color: #FF8000">// Copy all the data from the input buffer to the output buffer<br />        </span><span style="color: #9876AA">$bev</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">output</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">addBuffer</span><span style="color: #007700">(</span><span style="color: #9876AA">$bev</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">input</span><span style="color: #007700">);<br />    }<br /><br />    public function </span><span style="color: #9876AA">echoEventCallback</span><span style="color: #007700">(</span><span style="color: #9876AA">$bev</span><span style="color: #007700">, </span><span style="color: #9876AA">$events</span><span style="color: #007700">, </span><span style="color: #9876AA">$ctx</span><span style="color: #007700">) {<br />        if (</span><span style="color: #9876AA">$events </span><span style="color: #007700">&amp; </span><span style="color: #9876AA">EventBufferEvent</span><span style="color: #007700">::</span><span style="color: #9876AA">ERROR</span><span style="color: #007700">) {<br />            echo </span><span style="color: #DD0000">"Error from bufferevent\n"</span><span style="color: #007700">;<br />        }<br /><br />        if (</span><span style="color: #9876AA">$events </span><span style="color: #007700">&amp; (</span><span style="color: #9876AA">EventBufferEvent</span><span style="color: #007700">::</span><span style="color: #9876AA">EOF </span><span style="color: #007700">| </span><span style="color: #9876AA">EventBufferEvent</span><span style="color: #007700">::</span><span style="color: #9876AA">ERROR</span><span style="color: #007700">)) {<br />            </span><span style="color: #9876AA">$bev</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">free</span><span style="color: #007700">();<br />            </span><span style="color: #9876AA">$bev </span><span style="color: #007700">= </span><span style="color: #9876AA">NULL</span><span style="color: #007700">;<br />        }<br />    }<br />}<br /><br />class </span><span style="color: #9876AA">MyListener </span><span style="color: #007700">{<br />    public </span><span style="color: #9876AA">$base</span><span style="color: #007700">,<br />        </span><span style="color: #9876AA">$listener</span><span style="color: #007700">,<br />        </span><span style="color: #9876AA">$socket</span><span style="color: #007700">;<br />    private </span><span style="color: #9876AA">$conn </span><span style="color: #007700">= array();<br /><br />    public function </span><span style="color: #9876AA">__destruct</span><span style="color: #007700">() {<br />        foreach (</span><span style="color: #9876AA">$this</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">conn </span><span style="color: #007700">as &amp;</span><span style="color: #9876AA">$c</span><span style="color: #007700">) </span><span style="color: #9876AA">$c </span><span style="color: #007700">= </span><span style="color: #9876AA">NULL</span><span style="color: #007700">;<br />    }<br /><br />    public function </span><span style="color: #9876AA">__construct</span><span style="color: #007700">(</span><span style="color: #9876AA">$sock_path</span><span style="color: #007700">) {<br />        </span><span style="color: #9876AA">$this</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">base </span><span style="color: #007700">= new </span><span style="color: #9876AA">EventBase</span><span style="color: #007700">();<br />        if (!</span><span style="color: #9876AA">$this</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">base</span><span style="color: #007700">) {<br />            echo </span><span style="color: #DD0000">"Couldn't open event base"</span><span style="color: #007700">;<br />            exit(</span><span style="color: #9876AA">1</span><span style="color: #007700">);<br />        }<br /><br />        if (</span><span style="color: #9876AA">file_exists</span><span style="color: #007700">(</span><span style="color: #9876AA">$sock_path</span><span style="color: #007700">)) {<br />            </span><span style="color: #9876AA">unlink</span><span style="color: #007700">(</span><span style="color: #9876AA">$sock_path</span><span style="color: #007700">);<br />        }<br /><br />         </span><span style="color: #9876AA">$this</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">listener </span><span style="color: #007700">= new </span><span style="color: #9876AA">EventListener</span><span style="color: #007700">(</span><span style="color: #9876AA">$this</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">base</span><span style="color: #007700">,<br />             array(</span><span style="color: #9876AA">$this</span><span style="color: #007700">, </span><span style="color: #DD0000">"acceptConnCallback"</span><span style="color: #007700">), </span><span style="color: #9876AA">$this</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">base</span><span style="color: #007700">,<br />             </span><span style="color: #9876AA">EventListener</span><span style="color: #007700">::</span><span style="color: #9876AA">OPT_CLOSE_ON_FREE </span><span style="color: #007700">| </span><span style="color: #9876AA">EventListener</span><span style="color: #007700">::</span><span style="color: #9876AA">OPT_REUSEABLE</span><span style="color: #007700">, -</span><span style="color: #9876AA">1</span><span style="color: #007700">,<br />             </span><span style="color: #DD0000">"unix:</span><span style="color: #9876AA">$sock_path</span><span style="color: #DD0000">"</span><span style="color: #007700">);<br /><br />        if (!</span><span style="color: #9876AA">$this</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">listener</span><span style="color: #007700">) {<br />            </span><span style="color: #9876AA">trigger_error</span><span style="color: #007700">(</span><span style="color: #DD0000">"Couldn't create listener"</span><span style="color: #007700">, </span><span style="color: #9876AA">E_USER_ERROR</span><span style="color: #007700">);<br />        }<br /><br />        </span><span style="color: #9876AA">$this</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">listener</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">setErrorCallback</span><span style="color: #007700">(array(</span><span style="color: #9876AA">$this</span><span style="color: #007700">, </span><span style="color: #DD0000">"accept_error_cb"</span><span style="color: #007700">));<br />    }<br /><br />    public function </span><span style="color: #9876AA">dispatch</span><span style="color: #007700">() {<br />        </span><span style="color: #9876AA">$this</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">base</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">dispatch</span><span style="color: #007700">();<br />    }<br /><br />    </span><span style="color: #FF8000">// This callback is invoked when there is data to read on $bev<br />    </span><span style="color: #007700">public function </span><span style="color: #9876AA">acceptConnCallback</span><span style="color: #007700">(</span><span style="color: #9876AA">$listener</span><span style="color: #007700">, </span><span style="color: #9876AA">$fd</span><span style="color: #007700">, </span><span style="color: #9876AA">$address</span><span style="color: #007700">, </span><span style="color: #9876AA">$ctx</span><span style="color: #007700">) {<br />        </span><span style="color: #FF8000">// We got a new connection! Set up a bufferevent for it. <br />        </span><span style="color: #9876AA">$base </span><span style="color: #007700">= </span><span style="color: #9876AA">$this</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">base</span><span style="color: #007700">;<br />        </span><span style="color: #9876AA">$this</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">conn</span><span style="color: #007700">[] = new </span><span style="color: #9876AA">MyListenerConnection</span><span style="color: #007700">(</span><span style="color: #9876AA">$base</span><span style="color: #007700">, </span><span style="color: #9876AA">$fd</span><span style="color: #007700">);<br />    }<br /><br />    public function </span><span style="color: #9876AA">accept_error_cb</span><span style="color: #007700">(</span><span style="color: #9876AA">$listener</span><span style="color: #007700">, </span><span style="color: #9876AA">$ctx</span><span style="color: #007700">) {<br />        </span><span style="color: #9876AA">$base </span><span style="color: #007700">= </span><span style="color: #9876AA">$this</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">base</span><span style="color: #007700">;<br /><br />        </span><span style="color: #9876AA">fprintf</span><span style="color: #007700">(</span><span style="color: #9876AA">STDERR</span><span style="color: #007700">, </span><span style="color: #DD0000">"Got an error %d (%s) on the listener. "<br />            </span><span style="color: #007700">.</span><span style="color: #DD0000">"Shutting down.\n"</span><span style="color: #007700">,<br />            </span><span style="color: #9876AA">EventUtil</span><span style="color: #007700">::</span><span style="color: #9876AA">getLastSocketErrno</span><span style="color: #007700">(),<br />            </span><span style="color: #9876AA">EventUtil</span><span style="color: #007700">::</span><span style="color: #9876AA">getLastSocketError</span><span style="color: #007700">());<br /><br />        </span><span style="color: #9876AA">$base</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">exit</span><span style="color: #007700">(</span><span style="color: #9876AA">NULL</span><span style="color: #007700">);<br />    }<br />}<br /><br />if (</span><span style="color: #9876AA">$argc </span><span style="color: #007700">&lt;= </span><span style="color: #9876AA">1</span><span style="color: #007700">) {<br />    exit(</span><span style="color: #DD0000">"Socket path is not provided\n"</span><span style="color: #007700">);<br />}<br /></span><span style="color: #9876AA">$sock_path </span><span style="color: #007700">= </span><span style="color: #9876AA">$argv</span><span style="color: #007700">[</span><span style="color: #9876AA">1</span><span style="color: #007700">];<br /><br /></span><span style="color: #9876AA">$l </span><span style="color: #007700">= new </span><span style="color: #9876AA">MyListener</span><span style="color: #007700">(</span><span style="color: #9876AA">$sock_path</span><span style="color: #007700">);<br /></span><span style="color: #9876AA">$l</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">dispatch</span><span style="color: #007700">();<br /></span><span style="color: #9876AA">?&gt;</span></span></span></div>  </div> </div> <div class="example" id="">  <p><strong>示例 #13 Simple SMTP server</strong></p>  <div class="example-contents"><div class="phpcode" style="border-color:gray;background:#232525"><span><span style="color: #000000"><span style="color: #9876AA">&lt;?php<br /> </span><span style="color: #FF8000">//<br /> * Author: Andrew Rose &lt;hello at andrewrose dot co dot uk&gt;<br /> *<br /> * Usage:<br /> * 1) Prepare cert.pem certificate and privkey.pem private key files.<br /> * 2) Launch the server script<br /> * 3) Open TLS connection, e.g.:<br /> *      $ openssl s_client -connect localhost:25 -starttls smtp -crlf<br /> * 4) Start testing the commands listed in `cmd` method below.<br /> <br /><br /></span><span style="color: #007700">class </span><span style="color: #9876AA">Handler </span><span style="color: #007700">{<br />    public </span><span style="color: #9876AA">$domainName </span><span style="color: #007700">= </span><span style="color: #9876AA">FALSE</span><span style="color: #007700">;<br />    public </span><span style="color: #9876AA">$connections </span><span style="color: #007700">= [];<br />    public </span><span style="color: #9876AA">$buffers </span><span style="color: #007700">= [];<br />    public </span><span style="color: #9876AA">$maxRead </span><span style="color: #007700">= </span><span style="color: #9876AA">256000</span><span style="color: #007700">;<br /><br />    public function </span><span style="color: #9876AA">__construct</span><span style="color: #007700">() {<br />        </span><span style="color: #9876AA">$this</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">ctx </span><span style="color: #007700">= new </span><span style="color: #9876AA">EventSslContext</span><span style="color: #007700">(</span><span style="color: #9876AA">EventSslContext</span><span style="color: #007700">::</span><span style="color: #9876AA">SSLv3_SERVER_METHOD</span><span style="color: #007700">, [<br />            </span><span style="color: #9876AA">EventSslContext</span><span style="color: #007700">::</span><span style="color: #9876AA">OPT_LOCAL_CERT  </span><span style="color: #007700">=&gt; </span><span style="color: #DD0000">'cert.pem'</span><span style="color: #007700">,<br />            </span><span style="color: #9876AA">EventSslContext</span><span style="color: #007700">::</span><span style="color: #9876AA">OPT_LOCAL_PK    </span><span style="color: #007700">=&gt; </span><span style="color: #DD0000">'privkey.pem'</span><span style="color: #007700">,<br />            </span><span style="color: #FF8000">//EventSslContext::OPT_PASSPHRASE  =&gt; '',<br />            </span><span style="color: #9876AA">EventSslContext</span><span style="color: #007700">::</span><span style="color: #9876AA">OPT_VERIFY_PEER </span><span style="color: #007700">=&gt; </span><span style="color: #9876AA">false</span><span style="color: #007700">, </span><span style="color: #FF8000">// change to true with authentic cert<br />            </span><span style="color: #9876AA">EventSslContext</span><span style="color: #007700">::</span><span style="color: #9876AA">OPT_ALLOW_SELF_SIGNED </span><span style="color: #007700">=&gt; </span><span style="color: #9876AA">true </span><span style="color: #FF8000">// change to false with authentic cert<br />        </span><span style="color: #007700">]);<br /><br />        </span><span style="color: #9876AA">$this</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">base </span><span style="color: #007700">= new </span><span style="color: #9876AA">EventBase</span><span style="color: #007700">();<br />        if (!</span><span style="color: #9876AA">$this</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">base</span><span style="color: #007700">) {<br />            exit(</span><span style="color: #DD0000">"Couldn't open event base\n"</span><span style="color: #007700">);<br />        }<br /><br />        if (!</span><span style="color: #9876AA">$this</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">listener </span><span style="color: #007700">= new </span><span style="color: #9876AA">EventListener</span><span style="color: #007700">(</span><span style="color: #9876AA">$this</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">base</span><span style="color: #007700">,<br />            [</span><span style="color: #9876AA">$this</span><span style="color: #007700">, </span><span style="color: #DD0000">'ev_accept'</span><span style="color: #007700">],<br />            </span><span style="color: #9876AA">$this</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">ctx</span><span style="color: #007700">,<br />            </span><span style="color: #9876AA">EventListener</span><span style="color: #007700">::</span><span style="color: #9876AA">OPT_CLOSE_ON_FREE </span><span style="color: #007700">| </span><span style="color: #9876AA">EventListener</span><span style="color: #007700">::</span><span style="color: #9876AA">OPT_REUSEABLE</span><span style="color: #007700">,<br />            -</span><span style="color: #9876AA">1</span><span style="color: #007700">,<br />            </span><span style="color: #DD0000">'0.0.0.0:25'</span><span style="color: #007700">))<br />        {<br />            exit(</span><span style="color: #DD0000">"Couldn't create listener\n"</span><span style="color: #007700">);<br />        }<br /><br />        </span><span style="color: #9876AA">$this</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">listener</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">setErrorCallback</span><span style="color: #007700">([</span><span style="color: #9876AA">$this</span><span style="color: #007700">, </span><span style="color: #DD0000">'ev_error'</span><span style="color: #007700">]);<br />        </span><span style="color: #9876AA">$this</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">base</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">dispatch</span><span style="color: #007700">();<br />    }<br /><br />    public function </span><span style="color: #9876AA">ev_accept</span><span style="color: #007700">(</span><span style="color: #9876AA">$listener</span><span style="color: #007700">, </span><span style="color: #9876AA">$fd</span><span style="color: #007700">, </span><span style="color: #9876AA">$address</span><span style="color: #007700">, </span><span style="color: #9876AA">$ctx</span><span style="color: #007700">) {<br />        static </span><span style="color: #9876AA">$id </span><span style="color: #007700">= </span><span style="color: #9876AA">0</span><span style="color: #007700">;<br />        </span><span style="color: #9876AA">$id </span><span style="color: #007700">+= </span><span style="color: #9876AA">1</span><span style="color: #007700">;<br /><br />        </span><span style="color: #9876AA">$this</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">connections</span><span style="color: #007700">[</span><span style="color: #9876AA">$id</span><span style="color: #007700">][</span><span style="color: #DD0000">'clientData'</span><span style="color: #007700">] = </span><span style="color: #DD0000">''</span><span style="color: #007700">;<br />        </span><span style="color: #9876AA">$this</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">connections</span><span style="color: #007700">[</span><span style="color: #9876AA">$id</span><span style="color: #007700">][</span><span style="color: #DD0000">'cnx'</span><span style="color: #007700">] = new </span><span style="color: #9876AA">EventBufferEvent</span><span style="color: #007700">(</span><span style="color: #9876AA">$this</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">base</span><span style="color: #007700">, </span><span style="color: #9876AA">$fd</span><span style="color: #007700">,<br />            </span><span style="color: #9876AA">EventBufferEvent</span><span style="color: #007700">::</span><span style="color: #9876AA">OPT_CLOSE_ON_FREE</span><span style="color: #007700">);<br /><br />        if (!</span><span style="color: #9876AA">$this</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">connections</span><span style="color: #007700">[</span><span style="color: #9876AA">$id</span><span style="color: #007700">][</span><span style="color: #DD0000">'cnx'</span><span style="color: #007700">]) {<br />            echo </span><span style="color: #DD0000">"Failed creating buffer\n"</span><span style="color: #007700">;<br />            </span><span style="color: #9876AA">$this</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">base</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">exit</span><span style="color: #007700">(</span><span style="color: #9876AA">NULL</span><span style="color: #007700">);<br />            exit(</span><span style="color: #9876AA">1</span><span style="color: #007700">);<br />        }<br /><br />        </span><span style="color: #9876AA">$this</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">connections</span><span style="color: #007700">[</span><span style="color: #9876AA">$id</span><span style="color: #007700">][</span><span style="color: #DD0000">'cnx'</span><span style="color: #007700">]-&gt;</span><span style="color: #9876AA">setCallbacks</span><span style="color: #007700">([</span><span style="color: #9876AA">$this</span><span style="color: #007700">, </span><span style="color: #DD0000">"ev_read"</span><span style="color: #007700">], </span><span style="color: #9876AA">NULL</span><span style="color: #007700">,<br />            [</span><span style="color: #9876AA">$this</span><span style="color: #007700">, </span><span style="color: #DD0000">'ev_error'</span><span style="color: #007700">], </span><span style="color: #9876AA">$id</span><span style="color: #007700">);<br />        </span><span style="color: #9876AA">$this</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">connections</span><span style="color: #007700">[</span><span style="color: #9876AA">$id</span><span style="color: #007700">][</span><span style="color: #DD0000">'cnx'</span><span style="color: #007700">]-&gt;</span><span style="color: #9876AA">enable</span><span style="color: #007700">(</span><span style="color: #9876AA">Event</span><span style="color: #007700">::</span><span style="color: #9876AA">READ </span><span style="color: #007700">| </span><span style="color: #9876AA">Event</span><span style="color: #007700">::</span><span style="color: #9876AA">WRITE</span><span style="color: #007700">);<br /><br />        </span><span style="color: #9876AA">$this</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">ev_write</span><span style="color: #007700">(</span><span style="color: #9876AA">$id</span><span style="color: #007700">, </span><span style="color: #DD0000">'220 '</span><span style="color: #007700">.</span><span style="color: #9876AA">$this</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">domainName</span><span style="color: #007700">.</span><span style="color: #DD0000">" wazzzap?\r\n"</span><span style="color: #007700">);<br />    }<br /><br />    function </span><span style="color: #9876AA">ev_error</span><span style="color: #007700">(</span><span style="color: #9876AA">$listener</span><span style="color: #007700">, </span><span style="color: #9876AA">$ctx</span><span style="color: #007700">) {<br />        </span><span style="color: #9876AA">$errno </span><span style="color: #007700">= </span><span style="color: #9876AA">EventUtil</span><span style="color: #007700">::</span><span style="color: #9876AA">getLastSocketErrno</span><span style="color: #007700">();<br /><br />        </span><span style="color: #9876AA">fprintf</span><span style="color: #007700">(</span><span style="color: #9876AA">STDERR</span><span style="color: #007700">, </span><span style="color: #DD0000">"Got an error %d (%s) on the listener. Shutting down.\n"</span><span style="color: #007700">,<br />            </span><span style="color: #9876AA">$errno</span><span style="color: #007700">, </span><span style="color: #9876AA">EventUtil</span><span style="color: #007700">::</span><span style="color: #9876AA">getLastSocketError</span><span style="color: #007700">());<br /><br />        if (</span><span style="color: #9876AA">$errno </span><span style="color: #007700">!= </span><span style="color: #9876AA">0</span><span style="color: #007700">) {<br />            </span><span style="color: #9876AA">$this</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">base</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">exit</span><span style="color: #007700">(</span><span style="color: #9876AA">NULL</span><span style="color: #007700">);<br />            exit();<br />        }<br />    }<br /><br />    public function </span><span style="color: #9876AA">ev_close</span><span style="color: #007700">(</span><span style="color: #9876AA">$id</span><span style="color: #007700">) {<br />        </span><span style="color: #9876AA">$this</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">connections</span><span style="color: #007700">[</span><span style="color: #9876AA">$id</span><span style="color: #007700">][</span><span style="color: #DD0000">'cnx'</span><span style="color: #007700">]-&gt;</span><span style="color: #9876AA">disable</span><span style="color: #007700">(</span><span style="color: #9876AA">Event</span><span style="color: #007700">::</span><span style="color: #9876AA">READ </span><span style="color: #007700">| </span><span style="color: #9876AA">Event</span><span style="color: #007700">::</span><span style="color: #9876AA">WRITE</span><span style="color: #007700">);<br />        unset(</span><span style="color: #9876AA">$this</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">connections</span><span style="color: #007700">[</span><span style="color: #9876AA">$id</span><span style="color: #007700">]);<br />    }<br /><br />    protected function </span><span style="color: #9876AA">ev_write</span><span style="color: #007700">(</span><span style="color: #9876AA">$id</span><span style="color: #007700">, </span><span style="color: #9876AA">$string</span><span style="color: #007700">) {<br />        echo </span><span style="color: #DD0000">'S('</span><span style="color: #007700">.</span><span style="color: #9876AA">$id</span><span style="color: #007700">.</span><span style="color: #DD0000">'): '</span><span style="color: #007700">.</span><span style="color: #9876AA">$string</span><span style="color: #007700">;<br />        </span><span style="color: #9876AA">$this</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">connections</span><span style="color: #007700">[</span><span style="color: #9876AA">$id</span><span style="color: #007700">][</span><span style="color: #DD0000">'cnx'</span><span style="color: #007700">]-&gt;</span><span style="color: #9876AA">write</span><span style="color: #007700">(</span><span style="color: #9876AA">$string</span><span style="color: #007700">);<br />    }<br /><br />    public function </span><span style="color: #9876AA">ev_read</span><span style="color: #007700">(</span><span style="color: #9876AA">$buffer</span><span style="color: #007700">, </span><span style="color: #9876AA">$id</span><span style="color: #007700">) {<br />        while(</span><span style="color: #9876AA">$buffer</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">input</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">length </span><span style="color: #007700">&gt; </span><span style="color: #9876AA">0</span><span style="color: #007700">) {<br />            </span><span style="color: #9876AA">$this</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">connections</span><span style="color: #007700">[</span><span style="color: #9876AA">$id</span><span style="color: #007700">][</span><span style="color: #DD0000">'clientData'</span><span style="color: #007700">] .= </span><span style="color: #9876AA">$buffer</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">input</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">read</span><span style="color: #007700">(</span><span style="color: #9876AA">$this</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">maxRead</span><span style="color: #007700">);<br />            </span><span style="color: #9876AA">$clientDataLen </span><span style="color: #007700">= </span><span style="color: #9876AA">strlen</span><span style="color: #007700">(</span><span style="color: #9876AA">$this</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">connections</span><span style="color: #007700">[</span><span style="color: #9876AA">$id</span><span style="color: #007700">][</span><span style="color: #DD0000">'clientData'</span><span style="color: #007700">]);<br /><br />            if(</span><span style="color: #9876AA">$this</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">connections</span><span style="color: #007700">[</span><span style="color: #9876AA">$id</span><span style="color: #007700">][</span><span style="color: #DD0000">'clientData'</span><span style="color: #007700">][</span><span style="color: #9876AA">$clientDataLen</span><span style="color: #007700">-</span><span style="color: #9876AA">1</span><span style="color: #007700">] == </span><span style="color: #DD0000">"\n"<br />                </span><span style="color: #007700">&amp;&amp; </span><span style="color: #9876AA">$this</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">connections</span><span style="color: #007700">[</span><span style="color: #9876AA">$id</span><span style="color: #007700">][</span><span style="color: #DD0000">'clientData'</span><span style="color: #007700">][</span><span style="color: #9876AA">$clientDataLen</span><span style="color: #007700">-</span><span style="color: #9876AA">2</span><span style="color: #007700">] == </span><span style="color: #DD0000">"\r"</span><span style="color: #007700">)<br />            {<br />                </span><span style="color: #FF8000">// remove the trailing \r\n<br />                </span><span style="color: #9876AA">$line </span><span style="color: #007700">= </span><span style="color: #9876AA">substr</span><span style="color: #007700">(</span><span style="color: #9876AA">$this</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">connections</span><span style="color: #007700">[</span><span style="color: #9876AA">$id</span><span style="color: #007700">][</span><span style="color: #DD0000">'clientData'</span><span style="color: #007700">], </span><span style="color: #9876AA">0</span><span style="color: #007700">,<br />                    </span><span style="color: #9876AA">strlen</span><span style="color: #007700">(</span><span style="color: #9876AA">$this</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">connections</span><span style="color: #007700">[</span><span style="color: #9876AA">$id</span><span style="color: #007700">][</span><span style="color: #DD0000">'clientData'</span><span style="color: #007700">]) - </span><span style="color: #9876AA">2</span><span style="color: #007700">);<br /><br />                </span><span style="color: #9876AA">$this</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">connections</span><span style="color: #007700">[</span><span style="color: #9876AA">$id</span><span style="color: #007700">][</span><span style="color: #DD0000">'clientData'</span><span style="color: #007700">] = </span><span style="color: #DD0000">''</span><span style="color: #007700">;<br />                </span><span style="color: #9876AA">$this</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">cmd</span><span style="color: #007700">(</span><span style="color: #9876AA">$buffer</span><span style="color: #007700">, </span><span style="color: #9876AA">$id</span><span style="color: #007700">, </span><span style="color: #9876AA">$line</span><span style="color: #007700">);<br />            }<br />        }<br />    }<br /><br />    protected function </span><span style="color: #9876AA">cmd</span><span style="color: #007700">(</span><span style="color: #9876AA">$buffer</span><span style="color: #007700">, </span><span style="color: #9876AA">$id</span><span style="color: #007700">, </span><span style="color: #9876AA">$line</span><span style="color: #007700">) {<br />        switch (</span><span style="color: #9876AA">$line</span><span style="color: #007700">) {<br />            case </span><span style="color: #9876AA">strncmp</span><span style="color: #007700">(</span><span style="color: #DD0000">'EHLO '</span><span style="color: #007700">, </span><span style="color: #9876AA">$line</span><span style="color: #007700">, </span><span style="color: #9876AA">4</span><span style="color: #007700">):<br />                </span><span style="color: #9876AA">$this</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">ev_write</span><span style="color: #007700">(</span><span style="color: #9876AA">$id</span><span style="color: #007700">, </span><span style="color: #DD0000">"250-STARTTLS\r\n"</span><span style="color: #007700">);<br />                </span><span style="color: #9876AA">$this</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">ev_write</span><span style="color: #007700">(</span><span style="color: #9876AA">$id</span><span style="color: #007700">, </span><span style="color: #DD0000">"250 OK ehlo\r\n"</span><span style="color: #007700">);<br />                break;<br /><br />            case </span><span style="color: #9876AA">strncmp</span><span style="color: #007700">(</span><span style="color: #DD0000">'HELO '</span><span style="color: #007700">, </span><span style="color: #9876AA">$line</span><span style="color: #007700">, </span><span style="color: #9876AA">4</span><span style="color: #007700">):<br />                </span><span style="color: #9876AA">$this</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">ev_write</span><span style="color: #007700">(</span><span style="color: #9876AA">$id</span><span style="color: #007700">, </span><span style="color: #DD0000">"250-STARTTLS\r\n"</span><span style="color: #007700">);<br />                </span><span style="color: #9876AA">$this</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">ev_write</span><span style="color: #007700">(</span><span style="color: #9876AA">$id</span><span style="color: #007700">, </span><span style="color: #DD0000">"250 OK helo\r\n"</span><span style="color: #007700">);<br />                break;<br /><br />            case </span><span style="color: #9876AA">strncmp</span><span style="color: #007700">(</span><span style="color: #DD0000">'QUIT'</span><span style="color: #007700">, </span><span style="color: #9876AA">$line</span><span style="color: #007700">, </span><span style="color: #9876AA">3</span><span style="color: #007700">):<br />                </span><span style="color: #9876AA">$this</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">ev_write</span><span style="color: #007700">(</span><span style="color: #9876AA">$id</span><span style="color: #007700">, </span><span style="color: #DD0000">"250 OK quit\r\n"</span><span style="color: #007700">);<br />                </span><span style="color: #9876AA">$this</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">ev_close</span><span style="color: #007700">(</span><span style="color: #9876AA">$id</span><span style="color: #007700">);<br />                break;<br /><br />            case </span><span style="color: #9876AA">strncmp</span><span style="color: #007700">(</span><span style="color: #DD0000">'STARTTLS'</span><span style="color: #007700">, </span><span style="color: #9876AA">$line</span><span style="color: #007700">, </span><span style="color: #9876AA">3</span><span style="color: #007700">):<br />                </span><span style="color: #9876AA">$this</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">ev_write</span><span style="color: #007700">(</span><span style="color: #9876AA">$id</span><span style="color: #007700">, </span><span style="color: #DD0000">"220 Ready to start TLS\r\n"</span><span style="color: #007700">);<br />                </span><span style="color: #9876AA">$this</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">connections</span><span style="color: #007700">[</span><span style="color: #9876AA">$id</span><span style="color: #007700">][</span><span style="color: #DD0000">'cnx'</span><span style="color: #007700">] = </span><span style="color: #9876AA">EventBufferEvent</span><span style="color: #007700">::</span><span style="color: #9876AA">sslFilter</span><span style="color: #007700">(</span><span style="color: #9876AA">$this</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">base</span><span style="color: #007700">,<br />                    </span><span style="color: #9876AA">$this</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">connections</span><span style="color: #007700">[</span><span style="color: #9876AA">$id</span><span style="color: #007700">][</span><span style="color: #DD0000">'cnx'</span><span style="color: #007700">], </span><span style="color: #9876AA">$this</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">ctx</span><span style="color: #007700">,<br />                    </span><span style="color: #9876AA">EventBufferEvent</span><span style="color: #007700">::</span><span style="color: #9876AA">SSL_ACCEPTING</span><span style="color: #007700">,<br />                    </span><span style="color: #9876AA">EventBufferEvent</span><span style="color: #007700">::</span><span style="color: #9876AA">OPT_CLOSE_ON_FREE</span><span style="color: #007700">);<br />                </span><span style="color: #9876AA">$this</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">connections</span><span style="color: #007700">[</span><span style="color: #9876AA">$id</span><span style="color: #007700">][</span><span style="color: #DD0000">'cnx'</span><span style="color: #007700">]-&gt;</span><span style="color: #9876AA">setCallbacks</span><span style="color: #007700">([</span><span style="color: #9876AA">$this</span><span style="color: #007700">, </span><span style="color: #DD0000">"ev_read"</span><span style="color: #007700">], </span><span style="color: #9876AA">NULL</span><span style="color: #007700">, [</span><span style="color: #9876AA">$this</span><span style="color: #007700">, </span><span style="color: #DD0000">'ev_error'</span><span style="color: #007700">], </span><span style="color: #9876AA">$id</span><span style="color: #007700">);<br />                </span><span style="color: #9876AA">$this</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">connections</span><span style="color: #007700">[</span><span style="color: #9876AA">$id</span><span style="color: #007700">][</span><span style="color: #DD0000">'cnx'</span><span style="color: #007700">]-&gt;</span><span style="color: #9876AA">enable</span><span style="color: #007700">(</span><span style="color: #9876AA">Event</span><span style="color: #007700">::</span><span style="color: #9876AA">READ </span><span style="color: #007700">| </span><span style="color: #9876AA">Event</span><span style="color: #007700">::</span><span style="color: #9876AA">WRITE</span><span style="color: #007700">);<br />                break;<br /><br />            default:<br />                echo </span><span style="color: #DD0000">'unknown command: '</span><span style="color: #007700">.</span><span style="color: #9876AA">$line</span><span style="color: #007700">.</span><span style="color: #DD0000">"\n"</span><span style="color: #007700">;<br />                break;<br />        }<br />    }<br />}<br /><br />new </span><span style="color: #9876AA">Handler</span><span style="color: #007700">();</span></span></span></div>  </div> </div></div>