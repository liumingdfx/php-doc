<div id="ev.periodic-modes" class="chapter"> <h1>Periodic watcher operation modes</h1> <p class="para">  <span class="classname"><a href="https://www.php.net/manual/zh/class.evperiodic.php" class="classname">EvPeriodic</a></span>  watcher works in different modes depending on the  <span class="parameter" style="color:#3A95FF">offset</span>  ,  <span class="parameter" style="color:#3A95FF">interval</span>  and  <span class="parameter" style="color:#3A95FF">reschedule_cb</span>  parameters. </p> <ol type="1">  <li class="listitem">   <p class="para">    <em>Absolute timer</em>    . In this mode    <span class="parameter" style="color:#3A95FF">interval</span>    =    <strong><span>0</span></strong>    ,    <span class="parameter" style="color:#3A95FF">reschedule_cb</span>    = <strong><span>null</span></strong>. This time simply fires at the wallclock time    <span class="parameter" style="color:#3A95FF">offset</span>    and doesn&#039;t repeat. It will not adjust when a time jump occurs, that is,    if it is to be run at    <em>January   1st 2014</em>    then it will run when the system time reaches or surpasses this time.   </p>  </li>  <li class="listitem">   <p class="para">    <em>Repeating interval timer</em>    . In this mode    <span class="parameter" style="color:#3A95FF">interval</span>    &gt;    <strong><span>0</span></strong>    ,    <span class="parameter" style="color:#3A95FF">reschedule_cb</span>    = <strong><span>null</span></strong>; the watcher will always be scheduled to timeout at the next    <span class="parameter" style="color:#3A95FF">offset</span>    +    <strong><span>N</span></strong>    *    <span class="parameter" style="color:#3A95FF">interval</span>    time(for some integer    <strong><span>N</span></strong>    ) and then repeat, regardless of any time jumps.   </p>   <p class="para">    This can be used to create timers that do not drift with respect to system    time:    <div class="example-contents"><div class="phpcode" style="border-color:gray;background:#232525"><span><span style="color: #000000"><span style="color: #9876AA">&lt;?php<br />$hourly </span><span style="color: #007700">= </span><span style="color: #9876AA">EvPeriodic</span><span style="color: #007700">(</span><span style="color: #9876AA">0</span><span style="color: #007700">, </span><span style="color: #9876AA">3600</span><span style="color: #007700">, </span><span style="color: #9876AA">NULL</span><span style="color: #007700">, function () {<br />  echo </span><span style="color: #DD0000">"once per hour\n"</span><span style="color: #007700">;<br />});<br /></span><span style="color: #9876AA">?&gt;</span></span></span></div>    </div>    That doesn&#039;t mean there will always be    <strong><span>3600</span></strong>    seconds in between triggers, but only that the callback will be called    when the system time shows a full hour(    <em>UTC</em>    ).   </p>   <p class="para">    <span class="classname"><a href="https://www.php.net/manual/zh/class.evperiodic.php" class="classname">EvPeriodic</a></span>    will try to run the callback in this mode at the next possible time where    <var class="varname">time</var>    =    <span class="parameter" style="color:#3A95FF">offset</span>    (    <span>mod</span>    <span class="parameter" style="color:#3A95FF">interval</span>    ), regardless of any time jumps.   </p>  </li>  <li class="listitem">   <p class="para">    <em>Manual reschedule mode</em>    . In this mode    <span class="parameter" style="color:#3A95FF">reschedule_cb</span>    is a    <span class="type" style="color:#EAB766"><a href="https://www.php.net/manual/zh/language.types.callable.php" class="type callable" style="color:#EAB766">callable</a></span>    .   </p>   <p class="para">    <span class="parameter" style="color:#3A95FF">interval</span>    and    <span class="parameter" style="color:#3A95FF">offset</span>    are both being ignored. Instead, each time the periodic watcher gets    scheduled, the reschedule callback (    <span class="parameter" style="color:#3A95FF">reschedule_cb</span>    ) will be called with the watcher as first, and the current time as second    argument.   </p>   <p class="para">    This callback    <em>must not</em>    stop or destroy this or any other periodic watchers, ever, and    <em>must not</em>    call any event loop functions or methods. To stop it return    <strong><span>1e30</span></strong>    and stop it afterwards. An    <span class="classname"><a href="https://www.php.net/manual/zh/class.evprepare.php" class="classname">EvPrepare</a></span>    watcher may be used for this task.   </p>   <p class="para">    It must return the next time to trigger, based on the passed time value    (that is, the lowest time value larger than or equal to the second    argument). It will usually be called just before the callback will be    triggered, but might be called at other times, too.   </p>   <div class="example" id="">    <p><strong>示例 #1 Using reschedule callback</strong></p>    <div class="example-contents"><div class="phpcode" style="border-color:gray;background:#232525"><span><span style="color: #000000"><span style="color: #9876AA">&lt;?php<br /></span><span style="color: #FF8000">// Tick each 10.5 seconds<br /><br /></span><span style="color: #007700">function </span><span style="color: #9876AA">reschedule_cb </span><span style="color: #007700">(</span><span style="color: #9876AA">$watcher</span><span style="color: #007700">, </span><span style="color: #9876AA">$now</span><span style="color: #007700">) {<br />   return </span><span style="color: #9876AA">$now </span><span style="color: #007700">+ (</span><span style="color: #9876AA">10.5</span><span style="color: #007700">. - </span><span style="color: #9876AA">fmod</span><span style="color: #007700">(</span><span style="color: #9876AA">$now</span><span style="color: #007700">, </span><span style="color: #9876AA">10.5</span><span style="color: #007700">));<br />}<br /><br /></span><span style="color: #9876AA">$w </span><span style="color: #007700">= new </span><span style="color: #9876AA">EvPeriodic</span><span style="color: #007700">(</span><span style="color: #9876AA">0.</span><span style="color: #007700">, </span><span style="color: #9876AA">0.</span><span style="color: #007700">, </span><span style="color: #DD0000">"reschedule_cb"</span><span style="color: #007700">, function (</span><span style="color: #9876AA">$w</span><span style="color: #007700">, </span><span style="color: #9876AA">$revents</span><span style="color: #007700">) {<br />   echo </span><span style="color: #9876AA">time</span><span style="color: #007700">(), </span><span style="color: #9876AA">PHP_EOL</span><span style="color: #007700">;<br />});<br /><br /></span><span style="color: #9876AA">Ev</span><span style="color: #007700">::</span><span style="color: #9876AA">run</span><span style="color: #007700">();<br /></span><span style="color: #9876AA">?&gt;</span></span></span></div>    </div>   </div>  </li> </ol></div>