<div id="class.sessionhandler" class="reference"> <h1 class="title">The SessionHandler class</h1>  <div class="partintro"><p class="verinfo">(PHP 5 &gt;= 5.4.0, PHP 7, PHP 8)</p>  <div class="section" id="sessionhandler.intro">   <h2 class="title">简介</h2>   <p class="para">    <span class="classname"><strong class="classname">SessionHandler</strong></span> is a special class that can be used    to expose the current internal PHP session save handler by inheritance.    There are seven methods which wrap the seven internal session save handler    callbacks (<span class="parameter" style="color:#3A95FF">open</span>, <span class="parameter" style="color:#3A95FF">close</span>,    <span class="parameter" style="color:#3A95FF">read</span>, <span class="parameter" style="color:#3A95FF">write</span>,    <span class="parameter" style="color:#3A95FF">destroy</span>, <span class="parameter" style="color:#3A95FF">gc</span> and    <span class="parameter" style="color:#3A95FF">create_sid</span>).  By default, this class will wrap    whatever internal save handler is set as defined by the    <a href="https://www.php.net/manual/zh/session.configuration.php#ini.session.save-handler" class="link">session.save_handler</a>    configuration directive which is usually <span class="parameter" style="color:#3A95FF">files</span> by    default.  Other internal session save handlers are provided by PHP    extensions such as SQLite (as <span class="parameter" style="color:#3A95FF">sqlite</span>), Memcache (as    <span class="parameter" style="color:#3A95FF">memcache</span>), and Memcached (as    <span class="parameter" style="color:#3A95FF">memcached</span>).   </p>   <p class="para">    When a plain instance of <span class="classname"><strong class="classname">SessionHandler</strong></span> is set as the save handler using    <span class="function">{@link session_set_save_handler()}</span> it will wrap the current save handlers.    A class extending from <span class="classname"><strong class="classname">SessionHandler</strong></span> allows you to override    the methods or intercept or filter them by calls the parent class methods which ultimately wrap    the internal PHP session handlers.   </p>   <p class="para">    This allows you, for example, to intercept the <span class="parameter" style="color:#3A95FF">read</span> and <span class="parameter" style="color:#3A95FF">write</span>    methods to encrypt/decrypt the session data and then pass the result to and from the parent class.    Alternatively one might chose to entirely override a method like the garbage collection callback    <span class="parameter" style="color:#3A95FF">gc</span>.   </p>   <p class="para">    Because the <span class="classname"><strong class="classname">SessionHandler</strong></span> wraps the current internal save handler    methods, the above example of encryption can be applied to any internal save handler without    having to know the internals of the handlers.   </p>   <p class="para">    To use this class, first set the save handler you wish to expose using    <a href="https://www.php.net/manual/zh/session.configuration.php#ini.session.save-handler" class="link">session.save_handler</a> and then pass an instance of    <span class="classname"><strong class="classname">SessionHandler</strong></span> or one extending it to <span class="function">{@link session_set_save_handler()}</span>.   </p>   <p class="para">    Please note that the callback methods of this class are designed to be called internally by    PHP and are not meant to be called from user-space code.  The return values are equally processed internally    by PHP.  For more information on the session workflow, please refer to <span class="function">{@link session_set_save_handler()}</span>.   </p>  </div>  <div class="section" id="sessionhandler.synopsis">   <h2 class="title">类摘要</h2>   <div class="classsynopsis"><div class="classsynopsisinfo">         <span class="modifier">class</span> <strong class="classname"><strong class="classname">SessionHandler</strong></strong>             <span class="modifier">implements</span>      <a href="https://www.php.net/manual/zh/class.sessionhandlerinterface.php" class="interfacename">SessionHandlerInterface</a>,     <a href="https://www.php.net/manual/zh/class.sessionidinterface.php" class="interfacename">SessionIdInterface</a> {</div>    <div class="classsynopsisinfo classsynopsisinfo_comment">// 方法 </div>    <div class="methodsynopsis dc-description">   <span class="modifier">public</span> <span class="methodname" style="color:#CC7832"><a href="https://www.php.net/manual/zh/sessionhandler.close.php" class="methodname" style="color:#CC7832">close</a></span>(): <span class="type" style="color:#EAB766">bool</span></div><div class="methodsynopsis dc-description"><span class="modifier">public</span> <span class="methodname" style="color:#CC7832"><a href="https://www.php.net/manual/zh/sessionhandler.create-sid.php" class="methodname" style="color:#CC7832">create_sid</a></span>(): <span class="type" style="color:#EAB766">string</span></div><div class="methodsynopsis dc-description"><span class="modifier">public</span> <span class="methodname" style="color:#CC7832"><a href="https://www.php.net/manual/zh/sessionhandler.destroy.php" class="methodname" style="color:#CC7832">destroy</a></span>(<span class="methodparam"><span class="type" style="color:#EAB766">string</span> <span class="parameter" style="color:#3A95FF">$id</span></span>): <span class="type" style="color:#EAB766">bool</span></div><div class="methodsynopsis dc-description"><span class="modifier">public</span> <span class="methodname" style="color:#CC7832"><a href="https://www.php.net/manual/zh/sessionhandler.gc.php" class="methodname" style="color:#CC7832">gc</a></span>(<span class="methodparam"><span class="type" style="color:#EAB766">int</span> <span class="parameter" style="color:#3A95FF">$max_lifetime</span></span>): <span class="type" style="color:#EAB766"><span class="type" style="color:#EAB766">int</span>|<span class="type" style="color:#EAB766"><span class="type false" style="color:#EAB766">false</span></span></span></div><div class="methodsynopsis dc-description"><span class="modifier">public</span> <span class="methodname" style="color:#CC7832"><a href="https://www.php.net/manual/zh/sessionhandler.open.php" class="methodname" style="color:#CC7832">open</a></span>(<span class="methodparam"><span class="type" style="color:#EAB766">string</span> <span class="parameter" style="color:#3A95FF">$path</span></span>, <span class="methodparam"><span class="type" style="color:#EAB766">string</span> <span class="parameter" style="color:#3A95FF">$name</span></span>): <span class="type" style="color:#EAB766">bool</span></div><div class="methodsynopsis dc-description"><span class="modifier">public</span> <span class="methodname" style="color:#CC7832"><a href="https://www.php.net/manual/zh/sessionhandler.read.php" class="methodname" style="color:#CC7832">read</a></span>(<span class="methodparam"><span class="type" style="color:#EAB766">string</span> <span class="parameter" style="color:#3A95FF">$id</span></span>): <span class="type" style="color:#EAB766"><span class="type" style="color:#EAB766">string</span>|<span class="type" style="color:#EAB766"><span class="type false" style="color:#EAB766">false</span></span></span></div><div class="methodsynopsis dc-description"><span class="modifier">public</span> <span class="methodname" style="color:#CC7832"><a href="https://www.php.net/manual/zh/sessionhandler.write.php" class="methodname" style="color:#CC7832">write</a></span>(<span class="methodparam"><span class="type" style="color:#EAB766">string</span> <span class="parameter" style="color:#3A95FF">$id</span></span>, <span class="methodparam"><span class="type" style="color:#EAB766">string</span> <span class="parameter" style="color:#3A95FF">$data</span></span>): <span class="type" style="color:#EAB766">bool</span></div>   }</div>  </div>  <div class="section" id="session.notes">   <div class="warning"><strong class="warning">警告</strong>    <p class="para">     This class is designed to expose the current internal PHP session save handler, if you want to     write your own custom save handlers, please implement the <span class="classname"><a href="https://www.php.net/manual/zh/class.sessionhandlerinterface.php" class="classname">SessionHandlerInterface</a></span>     interface instead of extending from <span class="classname"><strong class="classname">SessionHandler</strong></span>.    </p>   </div>  </div>  <div class="section" id="sessionhandler.examples">   <div class="example" id="">    <p><strong>示例 #1      Using <span class="classname"><strong class="classname">SessionHandler</strong></span> to add encryption to internal PHP save handlers.    </strong></p>    <div class="example-contents"><div class="phpcode" style="border-color:gray;background:#232525"><span><span style="color: #000000"><span style="color: #9876AA">&lt;?php<br /><br /> </span><span style="color: #FF8000">//*<br />  * decrypt AES 256<br />  *<br />  * @param data $edata<br />  * @param string $password<br />  * @return decrypted data<br />  <br /></span><span style="color: #007700">function </span><span style="color: #9876AA">decrypt</span><span style="color: #007700">(</span><span style="color: #9876AA">$edata</span><span style="color: #007700">, </span><span style="color: #9876AA">$password</span><span style="color: #007700">) {<br />    </span><span style="color: #9876AA">$data </span><span style="color: #007700">= </span><span style="color: #9876AA">base64_decode</span><span style="color: #007700">(</span><span style="color: #9876AA">$edata</span><span style="color: #007700">);<br />    </span><span style="color: #9876AA">$salt </span><span style="color: #007700">= </span><span style="color: #9876AA">substr</span><span style="color: #007700">(</span><span style="color: #9876AA">$data</span><span style="color: #007700">, </span><span style="color: #9876AA">0</span><span style="color: #007700">, </span><span style="color: #9876AA">16</span><span style="color: #007700">);<br />    </span><span style="color: #9876AA">$ct </span><span style="color: #007700">= </span><span style="color: #9876AA">substr</span><span style="color: #007700">(</span><span style="color: #9876AA">$data</span><span style="color: #007700">, </span><span style="color: #9876AA">16</span><span style="color: #007700">);<br /><br />    </span><span style="color: #9876AA">$rounds </span><span style="color: #007700">= </span><span style="color: #9876AA">3</span><span style="color: #007700">; </span><span style="color: #FF8000">// depends on key length<br />    </span><span style="color: #9876AA">$data00 </span><span style="color: #007700">= </span><span style="color: #9876AA">$password</span><span style="color: #007700">.</span><span style="color: #9876AA">$salt</span><span style="color: #007700">;<br />    </span><span style="color: #9876AA">$hash </span><span style="color: #007700">= array();<br />    </span><span style="color: #9876AA">$hash</span><span style="color: #007700">[</span><span style="color: #9876AA">0</span><span style="color: #007700">] = </span><span style="color: #9876AA">hash</span><span style="color: #007700">(</span><span style="color: #DD0000">'sha256'</span><span style="color: #007700">, </span><span style="color: #9876AA">$data00</span><span style="color: #007700">, </span><span style="color: #9876AA">true</span><span style="color: #007700">);<br />    </span><span style="color: #9876AA">$result </span><span style="color: #007700">= </span><span style="color: #9876AA">$hash</span><span style="color: #007700">[</span><span style="color: #9876AA">0</span><span style="color: #007700">];<br />    for (</span><span style="color: #9876AA">$i </span><span style="color: #007700">= </span><span style="color: #9876AA">1</span><span style="color: #007700">; </span><span style="color: #9876AA">$i </span><span style="color: #007700">&lt; </span><span style="color: #9876AA">$rounds</span><span style="color: #007700">; </span><span style="color: #9876AA">$i</span><span style="color: #007700">++) {<br />        </span><span style="color: #9876AA">$hash</span><span style="color: #007700">[</span><span style="color: #9876AA">$i</span><span style="color: #007700">] = </span><span style="color: #9876AA">hash</span><span style="color: #007700">(</span><span style="color: #DD0000">'sha256'</span><span style="color: #007700">, </span><span style="color: #9876AA">$hash</span><span style="color: #007700">[</span><span style="color: #9876AA">$i </span><span style="color: #007700">- </span><span style="color: #9876AA">1</span><span style="color: #007700">].</span><span style="color: #9876AA">$data00</span><span style="color: #007700">, </span><span style="color: #9876AA">true</span><span style="color: #007700">);<br />        </span><span style="color: #9876AA">$result </span><span style="color: #007700">.= </span><span style="color: #9876AA">$hash</span><span style="color: #007700">[</span><span style="color: #9876AA">$i</span><span style="color: #007700">];<br />    }<br />    </span><span style="color: #9876AA">$key </span><span style="color: #007700">= </span><span style="color: #9876AA">substr</span><span style="color: #007700">(</span><span style="color: #9876AA">$result</span><span style="color: #007700">, </span><span style="color: #9876AA">0</span><span style="color: #007700">, </span><span style="color: #9876AA">32</span><span style="color: #007700">);<br />    </span><span style="color: #9876AA">$iv  </span><span style="color: #007700">= </span><span style="color: #9876AA">substr</span><span style="color: #007700">(</span><span style="color: #9876AA">$result</span><span style="color: #007700">, </span><span style="color: #9876AA">32</span><span style="color: #007700">,</span><span style="color: #9876AA">16</span><span style="color: #007700">);<br /><br />    return </span><span style="color: #9876AA">openssl_decrypt</span><span style="color: #007700">(</span><span style="color: #9876AA">$ct</span><span style="color: #007700">, </span><span style="color: #DD0000">'AES-256-CBC'</span><span style="color: #007700">, </span><span style="color: #9876AA">$key</span><span style="color: #007700">, </span><span style="color: #9876AA">true</span><span style="color: #007700">, </span><span style="color: #9876AA">$iv</span><span style="color: #007700">);<br />  }<br /><br /></span><span style="color: #FF8000">//*<br /> * crypt AES 256<br /> *<br /> * @param data $data<br /> * @param string $password<br /> * @return base64 encrypted data<br /> <br /></span><span style="color: #007700">function </span><span style="color: #9876AA">encrypt</span><span style="color: #007700">(</span><span style="color: #9876AA">$data</span><span style="color: #007700">, </span><span style="color: #9876AA">$password</span><span style="color: #007700">) {<br />    </span><span style="color: #FF8000">// Generate a cryptographically secure random salt using random_bytes()<br />    </span><span style="color: #9876AA">$salt </span><span style="color: #007700">= </span><span style="color: #9876AA">random_bytes</span><span style="color: #007700">(</span><span style="color: #9876AA">16</span><span style="color: #007700">);<br /><br />    </span><span style="color: #9876AA">$salted </span><span style="color: #007700">= </span><span style="color: #DD0000">''</span><span style="color: #007700">;<br />    </span><span style="color: #9876AA">$dx </span><span style="color: #007700">= </span><span style="color: #DD0000">''</span><span style="color: #007700">;<br />    </span><span style="color: #FF8000">// Salt the key(32) and iv(16) = 48<br />    </span><span style="color: #007700">while (</span><span style="color: #9876AA">strlen</span><span style="color: #007700">(</span><span style="color: #9876AA">$salted</span><span style="color: #007700">) &lt; </span><span style="color: #9876AA">48</span><span style="color: #007700">) {<br />      </span><span style="color: #9876AA">$dx </span><span style="color: #007700">= </span><span style="color: #9876AA">hash</span><span style="color: #007700">(</span><span style="color: #DD0000">'sha256'</span><span style="color: #007700">, </span><span style="color: #9876AA">$dx</span><span style="color: #007700">.</span><span style="color: #9876AA">$password</span><span style="color: #007700">.</span><span style="color: #9876AA">$salt</span><span style="color: #007700">, </span><span style="color: #9876AA">true</span><span style="color: #007700">);<br />      </span><span style="color: #9876AA">$salted </span><span style="color: #007700">.= </span><span style="color: #9876AA">$dx</span><span style="color: #007700">;<br />    }<br /><br />    </span><span style="color: #9876AA">$key </span><span style="color: #007700">= </span><span style="color: #9876AA">substr</span><span style="color: #007700">(</span><span style="color: #9876AA">$salted</span><span style="color: #007700">, </span><span style="color: #9876AA">0</span><span style="color: #007700">, </span><span style="color: #9876AA">32</span><span style="color: #007700">);<br />    </span><span style="color: #9876AA">$iv  </span><span style="color: #007700">= </span><span style="color: #9876AA">substr</span><span style="color: #007700">(</span><span style="color: #9876AA">$salted</span><span style="color: #007700">, </span><span style="color: #9876AA">32</span><span style="color: #007700">,</span><span style="color: #9876AA">16</span><span style="color: #007700">);<br /><br />    </span><span style="color: #9876AA">$encrypted_data </span><span style="color: #007700">= </span><span style="color: #9876AA">openssl_encrypt</span><span style="color: #007700">(</span><span style="color: #9876AA">$data</span><span style="color: #007700">, </span><span style="color: #DD0000">'AES-256-CBC'</span><span style="color: #007700">, </span><span style="color: #9876AA">$key</span><span style="color: #007700">, </span><span style="color: #9876AA">true</span><span style="color: #007700">, </span><span style="color: #9876AA">$iv</span><span style="color: #007700">);<br />    return </span><span style="color: #9876AA">base64_encode</span><span style="color: #007700">(</span><span style="color: #9876AA">$salt </span><span style="color: #007700">. </span><span style="color: #9876AA">$encrypted_data</span><span style="color: #007700">);<br />}<br /><br />class </span><span style="color: #9876AA">EncryptedSessionHandler </span><span style="color: #007700">extends </span><span style="color: #9876AA">SessionHandler<br /></span><span style="color: #007700">{<br />    private </span><span style="color: #9876AA">$key</span><span style="color: #007700">;<br /><br />    public function </span><span style="color: #9876AA">__construct</span><span style="color: #007700">(</span><span style="color: #9876AA">$key</span><span style="color: #007700">)<br />    {<br />        </span><span style="color: #9876AA">$this</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">key </span><span style="color: #007700">= </span><span style="color: #9876AA">$key</span><span style="color: #007700">;<br />    }<br /><br />    public function </span><span style="color: #9876AA">read</span><span style="color: #007700">(</span><span style="color: #9876AA">$id</span><span style="color: #007700">)<br />    {<br />        </span><span style="color: #9876AA">$data </span><span style="color: #007700">= </span><span style="color: #9876AA">parent</span><span style="color: #007700">::</span><span style="color: #9876AA">read</span><span style="color: #007700">(</span><span style="color: #9876AA">$id</span><span style="color: #007700">);<br /><br />        if (!</span><span style="color: #9876AA">$data</span><span style="color: #007700">) {<br />            return </span><span style="color: #DD0000">""</span><span style="color: #007700">;<br />        } else {<br />            return </span><span style="color: #9876AA">decrypt</span><span style="color: #007700">(</span><span style="color: #9876AA">$data</span><span style="color: #007700">, </span><span style="color: #9876AA">$this</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">key</span><span style="color: #007700">);<br />        }<br />    }<br /><br />    public function </span><span style="color: #9876AA">write</span><span style="color: #007700">(</span><span style="color: #9876AA">$id</span><span style="color: #007700">, </span><span style="color: #9876AA">$data</span><span style="color: #007700">)<br />    {<br />        </span><span style="color: #9876AA">$data </span><span style="color: #007700">= </span><span style="color: #9876AA">encrypt</span><span style="color: #007700">(</span><span style="color: #9876AA">$data</span><span style="color: #007700">, </span><span style="color: #9876AA">$this</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">key</span><span style="color: #007700">);<br /><br />        return </span><span style="color: #9876AA">parent</span><span style="color: #007700">::</span><span style="color: #9876AA">write</span><span style="color: #007700">(</span><span style="color: #9876AA">$id</span><span style="color: #007700">, </span><span style="color: #9876AA">$data</span><span style="color: #007700">);<br />    }<br />}<br /><br /></span><span style="color: #FF8000">// we'll intercept the native 'files' handler, but will equally work<br />// with other internal native handlers like 'sqlite', 'memcache' or 'memcached'<br />// which are provided by PHP extensions.<br /></span><span style="color: #9876AA">ini_set</span><span style="color: #007700">(</span><span style="color: #DD0000">'session.save_handler'</span><span style="color: #007700">, </span><span style="color: #DD0000">'files'</span><span style="color: #007700">);<br /><br /></span><span style="color: #9876AA">$key </span><span style="color: #007700">= </span><span style="color: #DD0000">'secret_string'</span><span style="color: #007700">;<br /></span><span style="color: #9876AA">$handler </span><span style="color: #007700">= new </span><span style="color: #9876AA">EncryptedSessionHandler</span><span style="color: #007700">(</span><span style="color: #9876AA">$key</span><span style="color: #007700">);<br /></span><span style="color: #9876AA">session_set_save_handler</span><span style="color: #007700">(</span><span style="color: #9876AA">$handler</span><span style="color: #007700">, </span><span style="color: #9876AA">true</span><span style="color: #007700">);<br /></span><span style="color: #9876AA">session_start</span><span style="color: #007700">();<br /><br /></span><span style="color: #FF8000">// proceed to set and retrieve values by key from $_SESSION</span></span></span></div>    </div>   </div>   <blockquote class="note" style="border:1px gray solid"><p><strong class="note" style="border:1px gray solid">注意</strong>:     <p class="para">     Since this class&#039; methods are designed to be called internally by PHP as part of the normal session workflow,     child class calls to parent methods (i.e. the actual internal native handlers) will return <strong><span>false</span></strong> unless     the session has actually been started (either automatically, or by explicit <span class="function">{@link session_start()}</span>).     This is important to consider when writing unit tests where the class methods might be invoked manually.    </p>   </p></blockquote>  </div> </div> <h2>目录</h2><ul class="chunklist chunklist_reference"><li>{@link SessionHandler::close} — Close the session</li><li>{@link SessionHandler::create_sid} — Return a new session ID</li><li>{@link SessionHandler::destroy} — Destroy a session</li><li>{@link SessionHandler::gc} — Cleanup old sessions</li><li>{@link SessionHandler::open} — Initialize session</li><li>{@link SessionHandler::read} — Read session data</li><li>{@link SessionHandler::write} — Write session data</li></ul></div>