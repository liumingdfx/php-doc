<div id="function.proc-open" class="refentry">   <div class="refnamediv">    <h1 class="refname">proc_open</h1>    <p class="verinfo">(PHP 4 &gt;= 4.3.0, PHP 5, PHP 7, PHP 8)</p><p class="refpurpose"><span class="refname">proc_open</span> &mdash; <span class="dc-title">     执行一个命令，并且打开用来输入/输出的文件指针。    </span></p>   </div>   <br></br><div style="BORDER-TOP: gray 1px dashed; OVERFLOW: hidden; HEIGHT: 1px"></div><div class="refsect1 description" id="refsect1-function.proc-open-description">    <h3 class="title">说明</h3>     <div class="methodsynopsis dc-description">   <span class="methodname" style="color:#CC7832"><strong>proc_open</strong></span>(<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="methodparam"><span class="type" style="color:#EAB766"><span class="type" style="color:#EAB766">array</span>|<span class="type" style="color:#EAB766">string</span></span> <span class="parameter" style="color:#3A95FF">$command</span></span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="methodparam"><span class="type" style="color:#EAB766">array</span> <span class="parameter" style="color:#3A95FF">$descriptor_spec</span></span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="methodparam"><span class="type" style="color:#EAB766">array</span> <span class="parameter" style="color:#3A95FF">&$pipes</span></span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="methodparam"><span class="type" style="color:#EAB766">?</span><span class="type" style="color:#EAB766"><span class="type" style="color:#EAB766">string</span><span class="type" style="color:#EAB766"></span></span> <span class="parameter" style="color:#3A95FF">$cwd</span><span class="initializer"> = <strong><span>null</span></strong></span></span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="methodparam"><span class="type" style="color:#EAB766">?</span><span class="type" style="color:#EAB766"><span class="type" style="color:#EAB766">array</span><span class="type" style="color:#EAB766"></span></span> <span class="parameter" style="color:#3A95FF">$env_vars</span><span class="initializer"> = <strong><span>null</span></strong></span></span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="methodparam"><span class="type" style="color:#EAB766">?</span><span class="type" style="color:#EAB766"><span class="type" style="color:#EAB766">array</span><span class="type" style="color:#EAB766"></span></span> <span class="parameter" style="color:#3A95FF">$options</span><span class="initializer"> = <strong><span>null</span></strong></span></span><br>): <span class="type" style="color:#EAB766"><span class="type" style="color:#EAB766">resource</span>|<span class="type" style="color:#EAB766"><span class="type false" style="color:#EAB766">false</span></span></span></div>    <p class="para rdfs-comment">     类似 <span class="function">{@link popen()}</span> 函数，     但是 <span class="function"><strong style="color:#CC7832">proc_open()</strong></span> 提供了更加强大的控制程序执行的能力。    </p>   </div> <br></br><div style="BORDER-TOP: gray 1px dashed; OVERFLOW: hidden; HEIGHT: 1px"></div><div class="refsect1 parameters" id="refsect1-function.proc-open-parameters">  <h3 class="title">参数</h3>  <span>   <dl>         <dt><span class="parameter" style="color:#3A95FF">command</span></dt>     <dd>      <p class="para">       以 <span class="type" style="color:#EAB766">string</span> 形式执行的命令行。特殊字符必须经过转义，并且使用正确的引号。      </p>      <blockquote class="note" style="border:1px gray solid"><p><strong class="note" style="border:1px gray solid">注意</strong>:        <span class="simpara">        在 <em>Windows</em> 上, 除非在 <span class="parameter" style="color:#3A95FF">options</span> 中        把 <span>bypass_shell</span> 设置为  <strong><span>true</span></strong>        ，否则 <span class="parameter" style="color:#3A95FF">command</span> 会被传递给 <strong class="command">cmd.exe</strong> （实际上是 <span>%ComSpec%</span>）        其中的 <span>/c</span> 标志是 <em>未加引号的</em> 字符串 （也就是和 <span class="function"><strong style="color:#CC7832">proc_open()</strong></span> 一样）。        这可能会导致 <strong class="command">cmd.exe</strong> 删除 <span class="parameter" style="color:#3A95FF">command</span> 中的引号 （详见 <strong class="command">cmd.exe</strong> 文档），        从而导致意外的，甚至是潜在的危险行为，因为        <strong class="command">cmd.exe</strong> 错误消息可能包含 （部分） 传递的 <span class="parameter" style="color:#3A95FF">command</span> （见下面的例子）。       </span>      </p></blockquote>      <p class="para">       从 PHP 7.4.0 开始，<span class="parameter" style="color:#3A95FF">command</span> 参数可以使用 <span class="type" style="color:#EAB766">array</span> 类型传递。       在这种情况下，进程将直接打开（不通过 shell ）。       而 PHP 会处理任何必要的参数转义。      </p>      <blockquote class="note" style="border:1px gray solid"><p><strong class="note" style="border:1px gray solid">注意</strong>:        <p class="para">        在 Windows 上， <span class="type" style="color:#EAB766">array</span> 元素的参数转义假定        执行命令的命令行解析与 VC 运行时进行的命令行参数解析兼容。       </p>      </p></blockquote>     </dd>             <dt><span class="parameter" style="color:#3A95FF">descriptor_spec</span></dt>     <dd>      <p class="para">        一个索引数组。        数组的键表示描述符，数组元素值表示 PHP 如何将这些描述符传送至子进程。        0 表示标准输入（stdin），1 表示标准输出（stdout），2 表示标准错误（stderr）。      </p>      <p class="para">       数组中的元素可以是：       <ul class="simplelist">        <li class="member">            包含了要传送至进程的管道的描述信息的数组。第一个元素为描述符类型，第二个元素是针对该描述符的选项。有效的类型有：<span>pipe</span>（第二个元素可以是：<span>r</span>         向进程传送该管道的读取端，<span>w</span> 向进程传送该管道的写入端），以及         <span>file</span>（第二个元素为文件名）。注意除了 <span>w</span>         之外的任何内容都视为 <span>r</span>。        </li>        <li class="member">          流资源表示真实文件描述符（例如：已打开的文件，套接字，<strong><span>STDIN</span></strong>）。        </li>       </ul>      </p>      <p class="para">        文件描述符的值不限于 0，1 和 2，你可以使用任何有效的文件描述符        并将其传送至子进程。        这使得你的脚本可以和其他脚本交互操作。        例如，可以通过指定文件描述符将密码以更加安全的方式        传送至诸如 PGP，GPG 和 openssl 程序，        同时也可以很方便的获取这些程序的状态信息。      </p>     </dd>             <dt><span class="parameter" style="color:#3A95FF">pipes</span></dt>     <dd>      <p class="para">        将被置为索引数组，        其中的元素是被执行程序创建的管道对应到 PHP 这一端的文件指针。      </p>     </dd>             <dt><span class="parameter" style="color:#3A95FF">cwd</span></dt>     <dd>      <p class="para">        要执行命令的初始工作目录。        必须是 <strong>绝对</strong> 路径，        设置此参数为 <strong><span>null</span></strong>         表示使用默认值（当前 PHP 进程的工作目录）。      </p>     </dd>             <dt><span class="parameter" style="color:#3A95FF">env_vars</span></dt>     <dd>      <p class="para">        要执行的命令所使用的环境变量。        设置此参数为 <strong><span>null</span></strong> 表示使用和当前 PHP 进程相同的环境变量。      </p>     </dd>             <dt><span class="parameter" style="color:#3A95FF">options</span></dt>     <dd>      <p class="para">        你还可以指定一些附加选项。        目前支持的选项包括：       <ul class="simplelist">        <li class="member">         <span>suppress_errors</span> （仅用于 Windows 平台）：         设置为 <strong><span>true</span></strong> 表示抑制本函数产生的错误。        </li>        <li class="member">         <span>bypass_shell</span> （仅用于 Windows 平台）：         设置为 <strong><span>true</span></strong> 表示绕过 <span>cmd.exe</span> shell。        </li>        <li class="member">         <span>blocking_pipes</span> （仅用于 Windows 平台）：         设置为 <strong><span>true</span></strong> 表示强制堵塞管道。        </li>        <li class="member">         <span>create_process_group</span> （仅用于 Windows 平台）：         设置为 <strong><span>true</span></strong> 表示允许子进程处理 <span>CTRL</span> 事件。        </li>        <li class="member">         <span>create_new_console</span> （仅用于 Windows 平台）：         表示新进程有一个新的控制台，用于代替父进程的控制台。        </li>       </ul>      </p>     </dd>       </dl>  </span> </div> <br></br><div style="BORDER-TOP: gray 1px dashed; OVERFLOW: hidden; HEIGHT: 1px"></div><div class="refsect1 returnvalues" id="refsect1-function.proc-open-returnvalues">  <h3 class="title">返回值</h3>  <p class="para">    返回表示进程的资源类型，    当使用完毕之后，请调用 <span class="function">{@link proc_close()}</span> 函数来关闭此资源。    如果失败，返回 <strong><span>false</span></strong>。  </p> </div> <br></br><div style="BORDER-TOP: gray 1px dashed; OVERFLOW: hidden; HEIGHT: 1px"></div><div class="refsect1 changelog" id="refsect1-function.proc-open-changelog">  <h3 class="title">更新日志</h3>  <span>   <table class="doctable informaltable">         <thead>      <tr>       <th>版本</th>       <th>说明</th>      </tr>     </thead>     <tbody class="tbody">      <tr>       <td>7.4.4</td>       <td>        为 <span class="parameter" style="color:#3A95FF">options</span> 参数增加 <span>create_new_console</span> 选项。       </td>      </tr>      <tr>       <td>7.4.0</td>       <td>        <span class="function"><strong style="color:#CC7832">proc_open()</strong></span> 的 <span class="parameter" style="color:#3A95FF">command</span> 参数现在也允许数组类型。       </td>      </tr>      <tr>       <td>7.4.0</td>       <td>        为 <span class="parameter" style="color:#3A95FF">options</span> 参数增加 <span>create_process_group</span> 选项。       </td>      </tr>     </tbody>       </table>  </span> </div> <br></br><div style="BORDER-TOP: gray 1px dashed; OVERFLOW: hidden; HEIGHT: 1px"></div><div class="refsect1 examples" id="refsect1-function.proc-open-examples">  <h3 class="title">示例</h3>  <span>   <div class="example" id="">    <p><strong>示例 #1 <span class="function"><strong style="color:#CC7832">proc_open()</strong></span> 示例</strong></p>    <div class="example-contents"><div class="phpcode" style="border-color:gray;background:#232525"><span><span style="color: #000000"><span style="color: #9876AA">&lt;?php<br />$descriptorspec </span><span style="color: #007700">= array(<br />   </span><span style="color: #9876AA">0 </span><span style="color: #007700">=&gt; array(</span><span style="color: #DD0000">"pipe"</span><span style="color: #007700">, </span><span style="color: #DD0000">"r"</span><span style="color: #007700">),  </span><span style="color: #FF8000">// 标准输入，子进程从此管道中读取数据<br />   </span><span style="color: #9876AA">1 </span><span style="color: #007700">=&gt; array(</span><span style="color: #DD0000">"pipe"</span><span style="color: #007700">, </span><span style="color: #DD0000">"w"</span><span style="color: #007700">),  </span><span style="color: #FF8000">// 标准输出，子进程向此管道中写入数据<br />   </span><span style="color: #9876AA">2 </span><span style="color: #007700">=&gt; array(</span><span style="color: #DD0000">"file"</span><span style="color: #007700">, </span><span style="color: #DD0000">"/tmp/error-output.txt"</span><span style="color: #007700">, </span><span style="color: #DD0000">"a"</span><span style="color: #007700">) </span><span style="color: #FF8000">// 标准错误，写入到一个文件<br /></span><span style="color: #007700">);<br /><br /></span><span style="color: #9876AA">$cwd </span><span style="color: #007700">= </span><span style="color: #DD0000">'/tmp'</span><span style="color: #007700">;<br /></span><span style="color: #9876AA">$env </span><span style="color: #007700">= array(</span><span style="color: #DD0000">'some_option' </span><span style="color: #007700">=&gt; </span><span style="color: #DD0000">'aeiou'</span><span style="color: #007700">);<br /><br /></span><span style="color: #9876AA">$process </span><span style="color: #007700">= </span><span style="color: #9876AA">proc_open</span><span style="color: #007700">(</span><span style="color: #DD0000">'php'</span><span style="color: #007700">, </span><span style="color: #9876AA">$descriptorspec</span><span style="color: #007700">, </span><span style="color: #9876AA">$pipes</span><span style="color: #007700">, </span><span style="color: #9876AA">$cwd</span><span style="color: #007700">, </span><span style="color: #9876AA">$env</span><span style="color: #007700">);<br /><br />if (</span><span style="color: #9876AA">is_resource</span><span style="color: #007700">(</span><span style="color: #9876AA">$process</span><span style="color: #007700">)) {<br />    </span><span style="color: #FF8000">// $pipes 现在看起来是这样的：<br />    // 0 =&gt; 可以向子进程标准输入写入的句柄<br />    // 1 =&gt; 可以从子进程标准输出读取的句柄<br />    // 错误输出将被追加到文件 /tmp/error-output.txt<br /><br />    </span><span style="color: #9876AA">fwrite</span><span style="color: #007700">(</span><span style="color: #9876AA">$pipes</span><span style="color: #007700">[</span><span style="color: #9876AA">0</span><span style="color: #007700">], </span><span style="color: #DD0000">'&lt;?php print_r($_ENV); ?&gt;'</span><span style="color: #007700">);<br />    </span><span style="color: #9876AA">fclose</span><span style="color: #007700">(</span><span style="color: #9876AA">$pipes</span><span style="color: #007700">[</span><span style="color: #9876AA">0</span><span style="color: #007700">]);<br /><br />    echo </span><span style="color: #9876AA">stream_get_contents</span><span style="color: #007700">(</span><span style="color: #9876AA">$pipes</span><span style="color: #007700">[</span><span style="color: #9876AA">1</span><span style="color: #007700">]);<br />    </span><span style="color: #9876AA">fclose</span><span style="color: #007700">(</span><span style="color: #9876AA">$pipes</span><span style="color: #007700">[</span><span style="color: #9876AA">1</span><span style="color: #007700">]);<br />    <br /><br />    </span><span style="color: #FF8000">// 切记：在调用 proc_close 之前关闭所有的管道以避免死锁。<br />    </span><span style="color: #9876AA">$return_value </span><span style="color: #007700">= </span><span style="color: #9876AA">proc_close</span><span style="color: #007700">(</span><span style="color: #9876AA">$process</span><span style="color: #007700">);<br /><br />    echo </span><span style="color: #DD0000">"command returned </span><span style="color: #9876AA">$return_value</span><span style="color: #DD0000">\n"</span><span style="color: #007700">;<br />}<br /></span><span style="color: #9876AA">?&gt;</span></span></span></div>    </div>    <div class="example-contents"><p>以上示例的输出类似于：</p></div>    <div class="example-contents screen" style="color:AFB1B3;background:black;padding-left:5px;"><div class="cdata"><span>Array<br>(<br>    [some_option] =&gt; aeiou<br>    [PWD] =&gt; /tmp<br>    [SHLVL] =&gt; 1<br>    [_] =&gt; /usr/local/bin/php<br>)<br>command returned 0<br></span></div>    </div>   </div>  </span>  <p class="para">   <div class="example" id="">    <p><strong>示例 #2 <span class="function"><strong style="color:#CC7832">proc_open()</strong></span> 在 Windows 上的怪异行为</strong></p>    <div class="example-contents"><p>     虽然人们可能期望下面的程序能够搜索文件     <var class="filename">filename.txt</var> 进行文本搜索，     并打印结果，但它的行为相当不同。    </p></div>    <div class="example-contents">     <div class="phpcode" style="border-color:gray;background:#232525"><span><span style="color: #000000"><span style="color: #9876AA">&lt;?php<br />$descriptorspec </span><span style="color: #007700">= [</span><span style="color: #9876AA">STDIN</span><span style="color: #007700">, </span><span style="color: #9876AA">STDOUT</span><span style="color: #007700">, </span><span style="color: #9876AA">STDOUT</span><span style="color: #007700">];<br /></span><span style="color: #9876AA">$cmd </span><span style="color: #007700">= </span><span style="color: #DD0000">'"findstr" "search" "filename.txt"'</span><span style="color: #007700">;<br /></span><span style="color: #9876AA">$proc </span><span style="color: #007700">= </span><span style="color: #9876AA">proc_open</span><span style="color: #007700">(</span><span style="color: #9876AA">$cmd</span><span style="color: #007700">, </span><span style="color: #9876AA">$descriptorspec</span><span style="color: #007700">, </span><span style="color: #9876AA">$pipes</span><span style="color: #007700">);<br /></span><span style="color: #9876AA">proc_close</span><span style="color: #007700">(</span><span style="color: #9876AA">$proc</span><span style="color: #007700">);<br /></span><span style="color: #9876AA">?&gt;</span></span></span></div>    </div>    <div class="example-contents"><p>以上示例会输出：</p></div>    <div class="example-contents screen" style="color:AFB1B3;background:black;padding-left:5px;">     <div class="cdata"><span>&#039;findstr&quot; &quot;search&quot; &quot;filename.txt&#039; is not recognized as an internal or external command,<br>operable program or batch file.<br></span></div>    </div>    <div class="example-contents"><p>     要解决该行为，通常只需将 <span class="parameter" style="color:#3A95FF">command</span> 加上引号：    </p></div>    <div class="example-contents">     <div class="phpcode" style="border-color:gray;background:#232525"><span><span style="color: #000000">$cmd = '""findstr" "search" "filename.txt""';</span></span></div>    </div>   </div>  </p> </div> <br></br><div style="BORDER-TOP: gray 1px dashed; OVERFLOW: hidden; HEIGHT: 1px"></div><div class="refsect1 notes" id="refsect1-function.proc-open-notes">  <h3 class="title">注释</h3>  <blockquote class="note" style="border:1px gray solid"><p><strong class="note" style="border:1px gray solid">注意</strong>:    <p class="para">    Windows 兼容性：超过 2 的描述符也可以作为可继承的句柄传送到子进程。    但是，由于 Windows 的架构并不将文件描述符和底层句柄进行关联，    所以，子进程无法访问这样的句柄。    标准输入，标准输出和标注错误会按照预期工作。   </p>  </p></blockquote>  <blockquote class="note" style="border:1px gray solid"><p><strong class="note" style="border:1px gray solid">注意</strong>:    <p class="para">    如果你只需要单向的进程管道，    使用 <span class="function">{@link popen()}</span> 函数会更加简单。   </p>  </p></blockquote> </div>  <br></br><div style="BORDER-TOP: gray 1px dashed; OVERFLOW: hidden; HEIGHT: 1px"></div><div class="refsect1 seealso" id="refsect1-function.proc-open-seealso">  <h3 class="title">参见</h3>  <span>   <ul class="simplelist">    <li class="member"><span class="function">{@link popen()} - 打开进程文件指针</span></li>    <li class="member"><span class="function">{@link exec()} - 执行一个外部程序</span></li>    <li class="member"><span class="function">{@link system()} - 执行外部程序，并且显示输出</span></li>    <li class="member"><span class="function">{@link passthru()} - 执行外部程序并且显示原始输出</span></li>    <li class="member"><span class="function">{@link stream_select()} - Runs the equivalent of the select() system call on the given   arrays of streams with a timeout specified by seconds and microseconds</span></li>    <li class="member">The <a href="https://www.php.net/manual/zh/language.operators.execution.php" class="link">执行运算符</a></li>   </ul>  </span> </div></div>