<div id="pdo.lobs" class="chapter"> <h1>大对象 (LOB)</h1> <p class="para">   应用程序在某一时刻，可能需要在数据库中存储“大”数据。“大”通常意味着“大约 4kb 或以上”，尽管某些数据库在数据达到“大”之前可以轻松地处理多达   32kb 的数据。大对象本质上可能是文本或二进制。在 <span class="methodname" style="color:#CC7832">{@link PDOStatement::bindParam()}</span> 或    <span class="methodname" style="color:#CC7832">{@link PDOStatement::bindColumn()}</span>) 调用中使用 <strong><span>PDO::PARAM_LOB</span></strong>   类型码可以让 PDO 使用大数据类型。<strong><span>PDO::PARAM_LOB</span></strong> 告诉 PDO 作为流来映射数据，以便能使用   <a href="https://www.php.net/manual/zh/ref.stream.php" class="link">PHP Streams API</a> 来操作。 </p> <p class="para">  <div class="example" id="example-3104">   <p><strong>示例 #1 从数据库中显示一张图片</strong></p>   <div class="example-contents"><p>    下面例子绑定一个 LOB 到 $lob 变量，然后用  <span class="function">{@link fpassthru()}</span> 将其发送到浏览器。因为 LOB 代表一个流，所以类似 <span class="function">{@link fgets()}</span>、<span class="function">{@link fread()}</span> 以及 <span class="function">{@link stream_get_contents()}</span> 这样的函数都可以用在它上面。   </p></div>   <div class="example-contents"><div class="phpcode" style="border-color:gray;background:#232525"><span><span style="color: #000000"><span style="color: #9876AA">&lt;?php<br />$db </span><span style="color: #007700">= new </span><span style="color: #9876AA">PDO</span><span style="color: #007700">(</span><span style="color: #DD0000">'odbc:SAMPLE'</span><span style="color: #007700">, </span><span style="color: #DD0000">'db2inst1'</span><span style="color: #007700">, </span><span style="color: #DD0000">'ibmdb2'</span><span style="color: #007700">);<br /></span><span style="color: #9876AA">$stmt </span><span style="color: #007700">= </span><span style="color: #9876AA">$db</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">prepare</span><span style="color: #007700">(</span><span style="color: #DD0000">"select contenttype, imagedata from images where id=?"</span><span style="color: #007700">);<br /></span><span style="color: #9876AA">$stmt</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">execute</span><span style="color: #007700">(array(</span><span style="color: #9876AA">$_GET</span><span style="color: #007700">[</span><span style="color: #DD0000">'id'</span><span style="color: #007700">]));<br /></span><span style="color: #9876AA">$stmt</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">bindColumn</span><span style="color: #007700">(</span><span style="color: #9876AA">1</span><span style="color: #007700">, </span><span style="color: #9876AA">$type</span><span style="color: #007700">, </span><span style="color: #9876AA">PDO</span><span style="color: #007700">::</span><span style="color: #9876AA">PARAM_STR</span><span style="color: #007700">, </span><span style="color: #9876AA">256</span><span style="color: #007700">);<br /></span><span style="color: #9876AA">$stmt</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">bindColumn</span><span style="color: #007700">(</span><span style="color: #9876AA">2</span><span style="color: #007700">, </span><span style="color: #9876AA">$lob</span><span style="color: #007700">, </span><span style="color: #9876AA">PDO</span><span style="color: #007700">::</span><span style="color: #9876AA">PARAM_LOB</span><span style="color: #007700">);<br /></span><span style="color: #9876AA">$stmt</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">fetch</span><span style="color: #007700">(</span><span style="color: #9876AA">PDO</span><span style="color: #007700">::</span><span style="color: #9876AA">FETCH_BOUND</span><span style="color: #007700">);<br /><br /></span><span style="color: #9876AA">header</span><span style="color: #007700">(</span><span style="color: #DD0000">"Content-Type: </span><span style="color: #9876AA">$type</span><span style="color: #DD0000">"</span><span style="color: #007700">);<br /></span><span style="color: #9876AA">fpassthru</span><span style="color: #007700">(</span><span style="color: #9876AA">$lob</span><span style="color: #007700">);<br /></span><span style="color: #9876AA">?&gt;</span></span></span></div>   </div>  </div> </p> <p class="para">  <div class="example" id="example-3107">   <p><strong>示例 #2 插入一张图片到数据库</strong></p>   <div class="example-contents"><p>   下面例子打开一个文件并将文件句柄传给 PDO 来做为一个 LOB 插入。PDO尽可能地让数据库以最有效的方式获取文件内容。   </p></div>   <div class="example-contents"><div class="phpcode" style="border-color:gray;background:#232525"><span><span style="color: #000000"><span style="color: #9876AA">&lt;?php<br />$db </span><span style="color: #007700">= new </span><span style="color: #9876AA">PDO</span><span style="color: #007700">(</span><span style="color: #DD0000">'odbc:SAMPLE'</span><span style="color: #007700">, </span><span style="color: #DD0000">'db2inst1'</span><span style="color: #007700">, </span><span style="color: #DD0000">'ibmdb2'</span><span style="color: #007700">);<br /></span><span style="color: #9876AA">$stmt </span><span style="color: #007700">= </span><span style="color: #9876AA">$db</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">prepare</span><span style="color: #007700">(</span><span style="color: #DD0000">"insert into images (id, contenttype, imagedata) values (?, ?, ?)"</span><span style="color: #007700">);<br /></span><span style="color: #9876AA">$id </span><span style="color: #007700">= </span><span style="color: #9876AA">get_new_id</span><span style="color: #007700">(); </span><span style="color: #FF8000">// 调用某个函数来分配一个新 ID<br /><br />// 假设处理一个文件上传<br />// 可以在 PHP 文档中找到更多的信息<br /><br /></span><span style="color: #9876AA">$fp </span><span style="color: #007700">= </span><span style="color: #9876AA">fopen</span><span style="color: #007700">(</span><span style="color: #9876AA">$_FILES</span><span style="color: #007700">[</span><span style="color: #DD0000">'file'</span><span style="color: #007700">][</span><span style="color: #DD0000">'tmp_name'</span><span style="color: #007700">], </span><span style="color: #DD0000">'rb'</span><span style="color: #007700">);<br /><br /></span><span style="color: #9876AA">$stmt</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">bindParam</span><span style="color: #007700">(</span><span style="color: #9876AA">1</span><span style="color: #007700">, </span><span style="color: #9876AA">$id</span><span style="color: #007700">);<br /></span><span style="color: #9876AA">$stmt</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">bindParam</span><span style="color: #007700">(</span><span style="color: #9876AA">2</span><span style="color: #007700">, </span><span style="color: #9876AA">$_FILES</span><span style="color: #007700">[</span><span style="color: #DD0000">'file'</span><span style="color: #007700">][</span><span style="color: #DD0000">'type'</span><span style="color: #007700">]);<br /></span><span style="color: #9876AA">$stmt</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">bindParam</span><span style="color: #007700">(</span><span style="color: #9876AA">3</span><span style="color: #007700">, </span><span style="color: #9876AA">$fp</span><span style="color: #007700">, </span><span style="color: #9876AA">PDO</span><span style="color: #007700">::</span><span style="color: #9876AA">PARAM_LOB</span><span style="color: #007700">);<br /><br /></span><span style="color: #9876AA">$db</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">beginTransaction</span><span style="color: #007700">();<br /></span><span style="color: #9876AA">$stmt</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">execute</span><span style="color: #007700">();<br /></span><span style="color: #9876AA">$db</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">commit</span><span style="color: #007700">();<br /></span><span style="color: #9876AA">?&gt;</span></span></span></div>   </div>  </div> </p> <p class="para">  <div class="example" id="example-3110">   <p><strong>示例 #3  插入一张图片到数据库：Oracle</strong></p>   <div class="example-contents"><p>   对于从文件插入一个 lob，Oracle略有不同。必须在事务之后进行插入，否则当执行查询时导致新近插入 LOB 将以0长度被隐式提交：   </p></div>   <div class="example-contents"><div class="phpcode" style="border-color:gray;background:#232525"><span><span style="color: #000000"><span style="color: #9876AA">&lt;?php<br />$db </span><span style="color: #007700">= new </span><span style="color: #9876AA">PDO</span><span style="color: #007700">(</span><span style="color: #DD0000">'oci:'</span><span style="color: #007700">, </span><span style="color: #DD0000">'scott'</span><span style="color: #007700">, </span><span style="color: #DD0000">'tiger'</span><span style="color: #007700">);<br /></span><span style="color: #9876AA">$stmt </span><span style="color: #007700">= </span><span style="color: #9876AA">$db</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">prepare</span><span style="color: #007700">(</span><span style="color: #DD0000">"insert into images (id, contenttype, imagedata) " </span><span style="color: #007700">.<br /></span><span style="color: #DD0000">"VALUES (?, ?, EMPTY_BLOB()) RETURNING imagedata INTO ?"</span><span style="color: #007700">);<br /></span><span style="color: #9876AA">$id </span><span style="color: #007700">= </span><span style="color: #9876AA">get_new_id</span><span style="color: #007700">(); </span><span style="color: #FF8000">// 调用某个函数来分配一个新 ID<br /><br />// 假设处理一个文件上传<br />// 可以在 PHP 文档中找到更多的信息<br /><br /></span><span style="color: #9876AA">$fp </span><span style="color: #007700">= </span><span style="color: #9876AA">fopen</span><span style="color: #007700">(</span><span style="color: #9876AA">$_FILES</span><span style="color: #007700">[</span><span style="color: #DD0000">'file'</span><span style="color: #007700">][</span><span style="color: #DD0000">'tmp_name'</span><span style="color: #007700">], </span><span style="color: #DD0000">'rb'</span><span style="color: #007700">);<br /><br /></span><span style="color: #9876AA">$stmt</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">bindParam</span><span style="color: #007700">(</span><span style="color: #9876AA">1</span><span style="color: #007700">, </span><span style="color: #9876AA">$id</span><span style="color: #007700">);<br /></span><span style="color: #9876AA">$stmt</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">bindParam</span><span style="color: #007700">(</span><span style="color: #9876AA">2</span><span style="color: #007700">, </span><span style="color: #9876AA">$_FILES</span><span style="color: #007700">[</span><span style="color: #DD0000">'file'</span><span style="color: #007700">][</span><span style="color: #DD0000">'type'</span><span style="color: #007700">]);<br /></span><span style="color: #9876AA">$stmt</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">bindParam</span><span style="color: #007700">(</span><span style="color: #9876AA">3</span><span style="color: #007700">, </span><span style="color: #9876AA">$fp</span><span style="color: #007700">, </span><span style="color: #9876AA">PDO</span><span style="color: #007700">::</span><span style="color: #9876AA">PARAM_LOB</span><span style="color: #007700">);<br /><br /></span><span style="color: #9876AA">$db</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">beginTransaction</span><span style="color: #007700">();<br /></span><span style="color: #9876AA">$stmt</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">execute</span><span style="color: #007700">();<br /></span><span style="color: #9876AA">$db</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">commit</span><span style="color: #007700">();<br /></span><span style="color: #9876AA">?&gt;</span></span></span></div>   </div>  </div> </p></div>