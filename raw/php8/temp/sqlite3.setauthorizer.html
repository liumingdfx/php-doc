<div id="sqlite3.setauthorizer" class="refentry"> <div class="refnamediv">  <h1 class="refname">SQLite3::setAuthorizer</h1>  <p class="verinfo">(PHP 8)</p><p class="refpurpose"><span class="refname">SQLite3::setAuthorizer</span> &mdash; <span class="dc-title">Configures a callback to be used as an authorizer to limit what a statement can do</span></p> </div> <br></br><div style="BORDER-TOP: gray 1px dashed; OVERFLOW: hidden; HEIGHT: 1px"></div><div class="refsect1 description" id="refsect1-sqlite3.setauthorizer-description">  <h3 class="title">说明</h3>  <div class="methodsynopsis dc-description">   <span class="modifier">public</span> <span class="methodname" style="color:#CC7832"><strong>SQLite3::setAuthorizer</strong></span>(<span class="methodparam"><span class="type" style="color:#EAB766">?</span><span class="type" style="color:#EAB766"><span class="type" style="color:#EAB766"><a href="https://www.php.net/manual/zh/language.types.callable.php" class="type callable" style="color:#EAB766">callable</a></span><span class="type" style="color:#EAB766"></span></span> <span class="parameter" style="color:#3A95FF">$callback</span></span>): <span class="type" style="color:#EAB766">bool</span></div>  <p class="para rdfs-comment">   Sets a callback that will be called by SQLite every time an action is performed   (reading, deleting, updating, etc.). This is used when preparing a SQL statement from   an untrusted source to ensure that the SQL statements do not try to access data they   are not allowed to see, or that they do not try to execute malicious statements that   damage the database. For example, an application may allow a user to enter arbitrary   SQL queries for evaluation by a database. But the application does not want the user to   be able to make arbitrary changes to the database. An authorizer could then be put in   place while the user-entered SQL is being prepared that disallows everything except   SELECT statements.  </p>  <p class="para">   The authorizer callback may be called multiple times for each statement prepared by   SQLite. A <span>SELECT</span> or <span>UPDATE</span> query will call the   authorizer for every column that would be read or updated.  </p>  <p class="para">   The authorizer is called with up to five parameters. The first parameter is always   given, and is an <span class="type" style="color:#EAB766">int</span> (action code) matching a constant from   <span>SQLite3</span>. The other parameters are only passed for some actions. The   following table describes the second and third parameters according to the action:   <table class="doctable table">    <caption><strong>List of action codes and parameters</strong></caption>         <thead>      <tr>       <th>Action</th>       <th>Second parameter</th>       <th>Third parameter</th>      </tr>     </thead>     <tbody class="tbody">      <tr><td><strong><span>SQLite3::CREATE_INDEX</span></strong></td><td>Index Name</td><td>Table Name</td></tr>      <tr><td><strong><span>SQLite3::CREATE_TABLE</span></strong></td><td>Table Name</td><td><strong><span>null</span></strong></td></tr>      <tr><td><strong><span>SQLite3::CREATE_TEMP_INDEX</span></strong></td><td>Index Name</td><td>Table Name</td></tr>      <tr><td><strong><span>SQLite3::CREATE_TEMP_TABLE</span></strong></td><td>Table Name</td><td><strong><span>null</span></strong></td></tr>      <tr><td><strong><span>SQLite3::CREATE_TEMP_TRIGGER</span></strong></td><td>Trigger Name</td><td>Table Name</td></tr>      <tr><td><strong><span>SQLite3::CREATE_TEMP_VIEW</span></strong></td><td>View Name</td><td><strong><span>null</span></strong></td></tr>      <tr><td><strong><span>SQLite3::CREATE_TRIGGER</span></strong></td><td>Trigger Name</td><td>Table Name</td></tr>      <tr><td><strong><span>SQLite3::CREATE_VIEW</span></strong></td><td>View Name</td><td><strong><span>null</span></strong></td></tr>      <tr><td><strong><span>SQLite3::DELETE</span></strong></td><td>Table Name</td><td><strong><span>null</span></strong></td></tr>      <tr><td><strong><span>SQLite3::DROP_INDEX</span></strong></td><td>Index Name</td><td>Table Name</td></tr>      <tr><td><strong><span>SQLite3::DROP_TABLE</span></strong></td><td>Table Name</td><td><strong><span>null</span></strong></td></tr>      <tr><td><strong><span>SQLite3::DROP_TEMP_INDEX</span></strong></td><td>Index Name</td><td>Table Name</td></tr>      <tr><td><strong><span>SQLite3::DROP_TEMP_TABLE</span></strong></td><td>Table Name</td><td><strong><span>null</span></strong></td></tr>      <tr><td><strong><span>SQLite3::DROP_TEMP_TRIGGER</span></strong></td><td>Trigger Name</td><td>Table Name</td></tr>      <tr><td><strong><span>SQLite3::DROP_TEMP_VIEW</span></strong></td><td>View Name</td><td><strong><span>null</span></strong></td></tr>      <tr><td><strong><span>SQLite3::DROP_TRIGGER</span></strong></td><td>Trigger Name</td><td>Table Name</td></tr>      <tr><td><strong><span>SQLite3::DROP_VIEW</span></strong></td><td>View Name</td><td><strong><span>null</span></strong></td></tr>      <tr><td><strong><span>SQLite3::INSERT</span></strong></td><td>Table Name</td><td><strong><span>null</span></strong></td></tr>      <tr><td><strong><span>SQLite3::PRAGMA</span></strong></td><td>Pragma Name</td><td>First argument passed to the pragma, or <strong><span>null</span></strong></td></tr>      <tr><td><strong><span>SQLite3::READ</span></strong></td><td>Table Name</td><td>Column Name</td></tr>      <tr><td><strong><span>SQLite3::SELECT</span></strong></td><td><strong><span>null</span></strong></td><td><strong><span>null</span></strong></td></tr>      <tr><td><strong><span>SQLite3::TRANSACTION</span></strong></td><td>Operation</td><td><strong><span>null</span></strong></td></tr>      <tr><td><strong><span>SQLite3::UPDATE</span></strong></td><td>Table Name</td><td>Column Name</td></tr>      <tr><td><strong><span>SQLite3::ATTACH</span></strong></td><td>Filename</td><td><strong><span>null</span></strong></td></tr>      <tr><td><strong><span>SQLite3::DETACH</span></strong></td><td>Database Name</td><td><strong><span>null</span></strong></td></tr>      <tr><td><strong><span>SQLite3::ALTER_TABLE</span></strong></td><td>Database Name</td><td>Table Name</td></tr>      <tr><td><strong><span>SQLite3::REINDEX</span></strong></td><td>Index Name</td><td><strong><span>null</span></strong></td></tr>      <tr><td><strong><span>SQLite3::ANALYZE</span></strong></td><td>Table Name</td><td><strong><span>null</span></strong></td></tr>      <tr><td><strong><span>SQLite3::CREATE_VTABLE</span></strong></td><td>Table Name</td><td>Module Name</td></tr>      <tr><td><strong><span>SQLite3::DROP_VTABLE</span></strong></td><td>Table Name</td><td>Module Name</td></tr>      <tr><td><strong><span>SQLite3::FUNCTION</span></strong></td><td><strong><span>null</span></strong></td><td>Function Name</td></tr>      <tr><td><strong><span>SQLite3::SAVEPOINT</span></strong></td><td>Operation</td><td>Savepoint Name</td></tr>      <tr><td><strong><span>SQLite3::RECURSIVE</span></strong></td><td><strong><span>null</span></strong></td><td><strong><span>null</span></strong></td></tr>     </tbody>       </table>  </p>  <p class="para">   The 4th parameter will be the name of the database (<span>&quot;main&quot;</span>,   <span>&quot;temp&quot;</span>, etc.) if applicable.  </p>  <p class="para">   The 5th parameter to the authorizer callback is the name of the inner-most trigger or   view that is responsible for the access attempt or <strong><span>null</span></strong> if this access attempt is   directly from top-level SQL code.  </p>  <p class="para">   When the callback returns <strong><span>SQLite3::OK</span></strong>, that means the operation   requested is accepted. When the callback returns <strong><span>SQLite3::DENY</span></strong>,   the call that triggered the authorizer will fail with an error message explaining that   access is denied.  </p>  <p class="para">   If the action code is <strong><span>SQLite3::READ</span></strong> and the callback returns   <strong><span>SQLite3::IGNORE</span></strong> then the prepared statement is   constructed to substitute a <strong><span>null</span></strong> value in place of the table column that would have   been read if <strong><span>SQLite3::OK</span></strong> had been returned. The   <strong><span>SQLite3::IGNORE</span></strong> return can be used to deny an untrusted user   access to individual columns of a table.  </p>  <p class="para">   When a table is referenced by a <span>SELECT</span> but no column values are   extracted from that table (for example in a query like <span>&quot;SELECT count(*) FROM   table&quot;</span>) then the <strong><span>SQLite3::READ</span></strong> authorizer callback is   invoked once for that table with a column name that is an empty string.  </p>  <p class="para">   If the action code is <strong><span>SQLite3::DELETE</span></strong> and the callback returns   <strong><span>SQLite3::IGNORE</span></strong> then the DELETE operation proceeds but the   truncate optimization is disabled and all rows are deleted individually.  </p>  <p class="para">   Only a single authorizer can be in place on a database connection at a time. Each call   to <span class="methodname" style="color:#CC7832"><strong>SQLite3::setAuthorizer()</strong></span> overrides the previous call. Disable the   authorizer by installing a <strong><span>null</span></strong> callback. The authorizer is disabled by default.  </p>  <p class="para">   The authorizer callback must not do anything that will modify the database connection   that invoked the authorizer callback.  </p>  <p class="para">   Note that the authorizer is only called when a statement is prepared, not when it&#039;s   executed.  </p>  <p class="para">   More details can be found in the   <a href="http://sqlite.org/c3ref/set_authorizer.html" class="link external">&raquo;&nbsp;SQLite3 documentation</a>.  </p> </div> <br></br><div style="BORDER-TOP: gray 1px dashed; OVERFLOW: hidden; HEIGHT: 1px"></div><div class="refsect1 parameters" id="refsect1-sqlite3.setauthorizer-parameters">  <h3 class="title">参数</h3>  <dl>       <dt><span class="parameter" style="color:#3A95FF">callback</span></dt>    <dd>     <span>      The <span class="type" style="color:#EAB766"><a href="https://www.php.net/manual/zh/language.types.callable.php" class="type callable" style="color:#EAB766">callable</a></span> to be called.     </span>     <p class="para">      If <strong><span>null</span></strong> is passed instead, this will disable the current authorizer callback.     </p>    </dd>     </dl> </div> <br></br><div style="BORDER-TOP: gray 1px dashed; OVERFLOW: hidden; HEIGHT: 1px"></div><div class="refsect1 returnvalues" id="refsect1-sqlite3.setauthorizer-returnvalues">  <h3 class="title">返回值</h3>  <p class="para">   成功时返回 <strong><span>true</span></strong>， 或者在失败时返回 <strong><span>false</span></strong>。  </p> </div> <br></br><div style="BORDER-TOP: gray 1px dashed; OVERFLOW: hidden; HEIGHT: 1px"></div><div class="refsect1 errors" id="refsect1-sqlite3.setauthorizer-errors">  <h3 class="title">错误／异常</h3>  <p class="para">   This method doesn&#039;t throw any error, but if an authorizer is enabled and returns an   invalid value, the statement preparation will throw an error (or exception, depending   on the use of the <span class="methodname" style="color:#CC7832">{@link SQLite3::enableExceptions()}</span> method).  </p> </div> <br></br><div style="BORDER-TOP: gray 1px dashed; OVERFLOW: hidden; HEIGHT: 1px"></div><div class="refsect1 examples" id="refsect1-sqlite3.setauthorizer-examples">  <h3 class="title">示例</h3>  <div class="example" id="">   <p><strong>示例 #1 <span class="methodname" style="color:#CC7832"><strong>SQLite3::setAuthorizer()</strong></span> example</strong></p>   <div class="example-contents"><p>     This only allows access to reading, and only some columns of the     <span>users</span> table will be returned. Other columns will be replaced with     <strong><span>null</span></strong>.   </p></div>   <div class="example-contents"><div class="phpcode" style="border-color:gray;background:#232525"><span><span style="color: #000000"><span style="color: #9876AA">&lt;?php<br />$db </span><span style="color: #007700">= new </span><span style="color: #9876AA">SQLite3</span><span style="color: #007700">(</span><span style="color: #DD0000">'data.sqlite'</span><span style="color: #007700">);<br /></span><span style="color: #9876AA">$db</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">exec</span><span style="color: #007700">(</span><span style="color: #DD0000">'CREATE TABLE users (id, name, password);'</span><span style="color: #007700">);<br /></span><span style="color: #9876AA">$db</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">exec</span><span style="color: #007700">(</span><span style="color: #DD0000">'INSERT INTO users VALUES (1, \'Pauline\', \'Snails4eva\');'</span><span style="color: #007700">);<br /><br /></span><span style="color: #9876AA">$allowed_columns </span><span style="color: #007700">= [</span><span style="color: #DD0000">'id'</span><span style="color: #007700">, </span><span style="color: #DD0000">'name'</span><span style="color: #007700">];<br /><br /></span><span style="color: #9876AA">$db</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">setAuthorizer</span><span style="color: #007700">(function (</span><span style="color: #9876AA">int $action</span><span style="color: #007700">, ...</span><span style="color: #9876AA">$args</span><span style="color: #007700">) use (</span><span style="color: #9876AA">$allowed_columns</span><span style="color: #007700">) {<br />    if (</span><span style="color: #9876AA">$action </span><span style="color: #007700">=== </span><span style="color: #9876AA">SQLite3</span><span style="color: #007700">::</span><span style="color: #9876AA">READ</span><span style="color: #007700">) {<br />        list(</span><span style="color: #9876AA">$table</span><span style="color: #007700">, </span><span style="color: #9876AA">$column</span><span style="color: #007700">) = </span><span style="color: #9876AA">$args</span><span style="color: #007700">;<br /><br />        if (</span><span style="color: #9876AA">$table </span><span style="color: #007700">=== </span><span style="color: #DD0000">'users' </span><span style="color: #007700">&amp;&amp; </span><span style="color: #9876AA">in_array</span><span style="color: #007700">(</span><span style="color: #9876AA">$column</span><span style="color: #007700">, </span><span style="color: #9876AA">$allowed_columns</span><span style="color: #007700">) {<br />            return </span><span style="color: #9876AA">SQLite3</span><span style="color: #007700">::</span><span style="color: #9876AA">OK</span><span style="color: #007700">;<br />        }<br /><br />        return </span><span style="color: #9876AA">SQLite3</span><span style="color: #007700">::</span><span style="color: #9876AA">IGNORE</span><span style="color: #007700">;<br />    }<br /><br />    return </span><span style="color: #9876AA">SQLite3</span><span style="color: #007700">::</span><span style="color: #9876AA">DENY</span><span style="color: #007700">;<br />});<br /><br /></span><span style="color: #9876AA">print_r</span><span style="color: #007700">(</span><span style="color: #9876AA">$db</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">querySingle</span><span style="color: #007700">(</span><span style="color: #DD0000">'SELECT * FROM users WHERE id = 1;'</span><span style="color: #007700">));</span></span></span></div>   </div>   <div class="example-contents"><p>以上示例会输出：</p></div>   <div class="example-contents screen" style="color:AFB1B3;background:black;padding-left:5px;"><div class="cdata"><span>Array<br>(<br>    [id] =&gt; 1<br>    [name] =&gt; Pauline<br>    [password] =&gt;<br>)<br></span></div>   </div>  </div> </div></div>