<div id="eventbufferevent.connect" class="refentry"> <div class="refnamediv">  <h1 class="refname">EventBufferEvent::connect</h1>  <p class="verinfo">(PECL event &gt;= 1.2.6-beta)</p><p class="refpurpose"><span class="refname">EventBufferEvent::connect</span> &mdash; <span class="dc-title">Connect buffer event&#039;s file descriptor to given address or  UNIX socket</span></p> </div> <br></br><div style="BORDER-TOP: gray 1px dashed; OVERFLOW: hidden; HEIGHT: 1px"></div><div class="refsect1 description" id="refsect1-eventbufferevent.connect-description">  <h3 class="title">说明</h3>  <div class="methodsynopsis dc-description">   <span class="modifier">public</span>   <span class="methodname" style="color:#CC7832"><strong>EventBufferEvent::connect</strong></span>(<span class="methodparam">    <span class="type" style="color:#EAB766">string</span>     <span class="parameter" style="color:#3A95FF">$addr</span>   </span>): <span class="type" style="color:#EAB766">bool</span></div>  <p class="para rdfs-comment">   Connect buffer event&#039;s file descriptor to given address(optionally   with port), or a UNIX domain socket.  </p>  <p class="para">   If socket is not assigned to the buffer event, this function allocates a   new socket and makes it non-blocking internally.  </p>  <p class="para">   To resolve DNS names(asyncronously), use   <span class="methodname" style="color:#CC7832">{@link EventBufferEvent::connectHost()}</span>   method.  </p> </div> <br></br><div style="BORDER-TOP: gray 1px dashed; OVERFLOW: hidden; HEIGHT: 1px"></div><div class="refsect1 parameters" id="refsect1-eventbufferevent.connect-parameters">  <h3 class="title">参数</h3>  <dl>       <dt>     <span class="parameter" style="color:#3A95FF">addr</span>    </dt>    <dd>     <span>      Should contain an IP address with optional port number, or a path to      UNIX domain socket. Recognized formats are:<div class="example-contents screen" style="color:AFB1B3;background:black;padding-left:5px;"><div class="parameterscode"><span>[IPv6Address]:port<br>[IPv6Address]<br>IPv6Address<br>IPv4Address:port<br>IPv4Address<br>unix:path</span></div>      </div>      Note,      <span>&#039;unix:&#039;</span>      prefix is currently not case sensitive.     </span>    </dd>     </dl> </div> <br></br><div style="BORDER-TOP: gray 1px dashed; OVERFLOW: hidden; HEIGHT: 1px"></div><div class="refsect1 returnvalues" id="refsect1-eventbufferevent.connect-returnvalues">  <h3 class="title">返回值</h3>  <p class="para">   成功时返回 <strong><span>true</span></strong>， 或者在失败时返回 <strong><span>false</span></strong>。  </p> </div> <br></br><div style="BORDER-TOP: gray 1px dashed; OVERFLOW: hidden; HEIGHT: 1px"></div><div class="refsect1 examples" id="refsect1-eventbufferevent.connect-examples">  <h3 class="title">示例</h3>  <div class="example" id="">   <p><strong>示例 #1     <span class="function"><strong style="color:#CC7832">EventBufferEvent::connect()</strong></span> example</strong></p>   <div class="example-contents"><div class="phpcode" style="border-color:gray;background:#232525"><span><span style="color: #000000"><span style="color: #9876AA">&lt;?php<br /></span><span style="color: #FF8000">//<br /> * 1. Connect to 127.0.0.1 at port 80<br /> * by means of EventBufferEvent::connect().<br /> *<br /> * 2. Request /index.cphp via HTTP/1.0<br /> * using the output buffer.<br /> *<br /> * 3. Asyncronously read the response and print it to stdout.<br /> <br /><br />// Read callback <br /></span><span style="color: #007700">function </span><span style="color: #9876AA">readcb</span><span style="color: #007700">(</span><span style="color: #9876AA">$bev</span><span style="color: #007700">, </span><span style="color: #9876AA">$base</span><span style="color: #007700">) {<br />    </span><span style="color: #9876AA">$input </span><span style="color: #007700">= </span><span style="color: #9876AA">$bev</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">getInput</span><span style="color: #007700">();<br /><br />    while ((</span><span style="color: #9876AA">$n </span><span style="color: #007700">= </span><span style="color: #9876AA">$input</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">remove</span><span style="color: #007700">(</span><span style="color: #9876AA">$buf</span><span style="color: #007700">, </span><span style="color: #9876AA">1024</span><span style="color: #007700">)) &gt; </span><span style="color: #9876AA">0</span><span style="color: #007700">) {<br />        echo </span><span style="color: #9876AA">$buf</span><span style="color: #007700">;<br />    }<br />}<br /><br /></span><span style="color: #FF8000">// Event callback <br /></span><span style="color: #007700">function </span><span style="color: #9876AA">eventcb</span><span style="color: #007700">(</span><span style="color: #9876AA">$bev</span><span style="color: #007700">, </span><span style="color: #9876AA">$events</span><span style="color: #007700">, </span><span style="color: #9876AA">$base</span><span style="color: #007700">) {<br />    if (</span><span style="color: #9876AA">$events </span><span style="color: #007700">&amp; </span><span style="color: #9876AA">EventBufferEvent</span><span style="color: #007700">::</span><span style="color: #9876AA">CONNECTED</span><span style="color: #007700">) {<br />        echo </span><span style="color: #DD0000">"Connected.\n"</span><span style="color: #007700">;<br />    } elseif (</span><span style="color: #9876AA">$events </span><span style="color: #007700">&amp; (</span><span style="color: #9876AA">EventBufferEvent</span><span style="color: #007700">::</span><span style="color: #9876AA">ERROR </span><span style="color: #007700">| </span><span style="color: #9876AA">EventBufferEvent</span><span style="color: #007700">::</span><span style="color: #9876AA">EOF</span><span style="color: #007700">)) {<br />        if (</span><span style="color: #9876AA">$events </span><span style="color: #007700">&amp; </span><span style="color: #9876AA">EventBufferEvent</span><span style="color: #007700">::</span><span style="color: #9876AA">ERROR</span><span style="color: #007700">) {<br />            echo </span><span style="color: #DD0000">"DNS error: "</span><span style="color: #007700">, </span><span style="color: #9876AA">$bev</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">getDnsErrorString</span><span style="color: #007700">(), </span><span style="color: #9876AA">PHP_EOL</span><span style="color: #007700">;<br />        }<br /><br />        echo </span><span style="color: #DD0000">"Closing\n"</span><span style="color: #007700">;<br />        </span><span style="color: #9876AA">$base</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">exit</span><span style="color: #007700">();<br />        exit(</span><span style="color: #DD0000">"Done\n"</span><span style="color: #007700">);<br />    }<br />}<br /><br /></span><span style="color: #9876AA">$base </span><span style="color: #007700">= new </span><span style="color: #9876AA">EventBase</span><span style="color: #007700">();<br /><br />echo </span><span style="color: #DD0000">"step 1\n"</span><span style="color: #007700">;<br /></span><span style="color: #9876AA">$bev </span><span style="color: #007700">= new </span><span style="color: #9876AA">EventBufferEvent</span><span style="color: #007700">(</span><span style="color: #9876AA">$base</span><span style="color: #007700">, </span><span style="color: #FF8000">// use internal socket  </span><span style="color: #9876AA">NULL</span><span style="color: #007700">,<br />    </span><span style="color: #9876AA">EventBufferEvent</span><span style="color: #007700">::</span><span style="color: #9876AA">OPT_CLOSE_ON_FREE </span><span style="color: #007700">| </span><span style="color: #9876AA">EventBufferEvent</span><span style="color: #007700">::</span><span style="color: #9876AA">OPT_DEFER_CALLBACKS</span><span style="color: #007700">);<br />if (!</span><span style="color: #9876AA">$bev</span><span style="color: #007700">) {<br />    exit(</span><span style="color: #DD0000">"Failed creating bufferevent socket\n"</span><span style="color: #007700">);<br />}<br /><br />echo </span><span style="color: #DD0000">"step 2\n"</span><span style="color: #007700">;<br /></span><span style="color: #9876AA">$bev</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">setCallbacks</span><span style="color: #007700">(</span><span style="color: #DD0000">"readcb"</span><span style="color: #007700">, </span><span style="color: #FF8000">// writecb  </span><span style="color: #9876AA">NULL</span><span style="color: #007700">, </span><span style="color: #DD0000">"eventcb"</span><span style="color: #007700">, </span><span style="color: #9876AA">$base</span><span style="color: #007700">);<br /></span><span style="color: #9876AA">$bev</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">enable</span><span style="color: #007700">(</span><span style="color: #9876AA">Event</span><span style="color: #007700">::</span><span style="color: #9876AA">READ </span><span style="color: #007700">| </span><span style="color: #9876AA">Event</span><span style="color: #007700">::</span><span style="color: #9876AA">WRITE</span><span style="color: #007700">);<br /><br />echo </span><span style="color: #DD0000">"step 3\n"</span><span style="color: #007700">;<br /></span><span style="color: #FF8000">// Send request <br /></span><span style="color: #9876AA">$output </span><span style="color: #007700">= </span><span style="color: #9876AA">$bev</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">getOutput</span><span style="color: #007700">();<br />if (!</span><span style="color: #9876AA">$output</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">add</span><span style="color: #007700">(<br />    </span><span style="color: #DD0000">"GET /index.cphp HTTP/1.0\r\n"</span><span style="color: #007700">.<br />    </span><span style="color: #DD0000">"Connection: Close\r\n\r\n"<br /></span><span style="color: #007700">)) {<br />    exit(</span><span style="color: #DD0000">"Failed adding request to output buffer\n"</span><span style="color: #007700">);<br />}<br /><br /></span><span style="color: #FF8000">// Connect to the host syncronously.<br /> * We know the IP, and don't need to resolve DNS. <br /></span><span style="color: #007700">if (!</span><span style="color: #9876AA">$bev</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">connect</span><span style="color: #007700">(</span><span style="color: #DD0000">"127.0.0.1:80"</span><span style="color: #007700">)) {<br />    exit(</span><span style="color: #DD0000">"Can't connect to host\n"</span><span style="color: #007700">);<br />}<br /><br /></span><span style="color: #FF8000">// Dispatch pending events <br /></span><span style="color: #9876AA">$base</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">dispatch</span><span style="color: #007700">();</span></span></span></div>   </div>   <div class="example-contents"><p>以上示例的输出类似于：</p></div>   <div class="example-contents screen" style="color:AFB1B3;background:black;padding-left:5px;"><div class="cdata"><span>step 1<br>step 2<br>step 3<br>Connected.<br>HTTP/1.1 200 OK<br>Server: nginx/1.2.6<br>Date: Sat, 09 Mar 2013 10:06:58 GMT<br>Content-Type: text/html; charset=utf-8<br>Connection: close<br>X-Powered-By: PHP/5.4.11--pl2-gentoo<br><br>sdfsdfsf<br>Closing<br>Done<br></span></div>   </div>  </div>  <div class="example" id="">   <p><strong>示例 #2 Connect to UNIX domain socket which presumably is served by a server, read response from   the server and output it to the console</strong></p>   <div class="example-contents"><div class="phpcode" style="border-color:gray;background:#232525"><span><span style="color: #000000"><span style="color: #9876AA">&lt;?php<br /></span><span style="color: #007700">class </span><span style="color: #9876AA">MyUnixSocketClient </span><span style="color: #007700">{<br />    private </span><span style="color: #9876AA">$base</span><span style="color: #007700">, </span><span style="color: #9876AA">$bev</span><span style="color: #007700">;<br /><br />    function </span><span style="color: #9876AA">__construct</span><span style="color: #007700">(</span><span style="color: #9876AA">$base</span><span style="color: #007700">, </span><span style="color: #9876AA">$sock_path</span><span style="color: #007700">) {<br />        </span><span style="color: #9876AA">$this</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">base </span><span style="color: #007700">= </span><span style="color: #9876AA">$base</span><span style="color: #007700">;<br />        </span><span style="color: #9876AA">$this</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">bev </span><span style="color: #007700">= new </span><span style="color: #9876AA">EventBufferEvent</span><span style="color: #007700">(</span><span style="color: #9876AA">$base</span><span style="color: #007700">, </span><span style="color: #9876AA">NULL</span><span style="color: #007700">, </span><span style="color: #9876AA">EventBufferEvent</span><span style="color: #007700">::</span><span style="color: #9876AA">OPT_CLOSE_ON_FREE</span><span style="color: #007700">,<br />            array (</span><span style="color: #9876AA">$this</span><span style="color: #007700">, </span><span style="color: #DD0000">"read_cb"</span><span style="color: #007700">), </span><span style="color: #9876AA">NULL</span><span style="color: #007700">, array (</span><span style="color: #9876AA">$this</span><span style="color: #007700">, </span><span style="color: #DD0000">"event_cb"</span><span style="color: #007700">));<br /><br />        if (!</span><span style="color: #9876AA">$this</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">bev</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">connect</span><span style="color: #007700">(</span><span style="color: #DD0000">"unix:</span><span style="color: #9876AA">$sock_path</span><span style="color: #DD0000">"</span><span style="color: #007700">)) {<br />            </span><span style="color: #9876AA">trigger_error</span><span style="color: #007700">(</span><span style="color: #DD0000">"Failed to connect to socket `</span><span style="color: #9876AA">$sock_path</span><span style="color: #DD0000">'"</span><span style="color: #007700">, </span><span style="color: #9876AA">E_USER_ERROR</span><span style="color: #007700">);<br />        }<br /><br />        </span><span style="color: #9876AA">$this</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">bev</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">enable</span><span style="color: #007700">(</span><span style="color: #9876AA">Event</span><span style="color: #007700">::</span><span style="color: #9876AA">READ</span><span style="color: #007700">);<br />    }<br /><br />    function </span><span style="color: #9876AA">__destruct</span><span style="color: #007700">() {<br />        if (</span><span style="color: #9876AA">$this</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">bev</span><span style="color: #007700">) {<br />            </span><span style="color: #9876AA">$this</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">bev</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">free</span><span style="color: #007700">();<br />            </span><span style="color: #9876AA">$this</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">bev </span><span style="color: #007700">= </span><span style="color: #9876AA">NULL</span><span style="color: #007700">;<br />        }<br />    }<br /><br />    function </span><span style="color: #9876AA">dispatch</span><span style="color: #007700">() {<br />        </span><span style="color: #9876AA">$this</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">base</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">dispatch</span><span style="color: #007700">();<br />    }<br /><br />    function </span><span style="color: #9876AA">read_cb</span><span style="color: #007700">(</span><span style="color: #9876AA">$bev</span><span style="color: #007700">, </span><span style="color: #9876AA">$unused</span><span style="color: #007700">) {<br />        </span><span style="color: #9876AA">$in </span><span style="color: #007700">= </span><span style="color: #9876AA">$bev</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">input</span><span style="color: #007700">;<br /><br />        </span><span style="color: #9876AA">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">"Received %ld bytes\n"</span><span style="color: #007700">, </span><span style="color: #9876AA">$in</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">length</span><span style="color: #007700">);<br />        </span><span style="color: #9876AA">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">"----- data ----\n"</span><span style="color: #007700">);<br />        </span><span style="color: #9876AA">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">"%ld:\t%s\n"</span><span style="color: #007700">, (int) </span><span style="color: #9876AA">$in</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">length</span><span style="color: #007700">, </span><span style="color: #9876AA">$in</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">pullup</span><span style="color: #007700">(-</span><span style="color: #9876AA">1</span><span style="color: #007700">));<br /><br />        </span><span style="color: #9876AA">$this</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">bev</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">free</span><span style="color: #007700">();<br />        </span><span style="color: #9876AA">$this</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">bev </span><span style="color: #007700">= </span><span style="color: #9876AA">NULL</span><span style="color: #007700">;<br />        </span><span style="color: #9876AA">$this</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">base</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">exit</span><span style="color: #007700">(</span><span style="color: #9876AA">NULL</span><span style="color: #007700">);<br />    }<br /><br />    function </span><span style="color: #9876AA">event_cb</span><span style="color: #007700">(</span><span style="color: #9876AA">$bev</span><span style="color: #007700">, </span><span style="color: #9876AA">$events</span><span style="color: #007700">, </span><span style="color: #9876AA">$unused</span><span style="color: #007700">) {<br />        if (</span><span style="color: #9876AA">$events </span><span style="color: #007700">&amp; </span><span style="color: #9876AA">EventBufferEvent</span><span style="color: #007700">::</span><span style="color: #9876AA">ERROR</span><span style="color: #007700">) {<br />            echo </span><span style="color: #DD0000">"Error from bufferevent\n"</span><span style="color: #007700">;<br />        }<br /><br />        if (</span><span style="color: #9876AA">$events </span><span style="color: #007700">&amp; (</span><span style="color: #9876AA">EventBufferEvent</span><span style="color: #007700">::</span><span style="color: #9876AA">EOF </span><span style="color: #007700">| </span><span style="color: #9876AA">EventBufferEvent</span><span style="color: #007700">::</span><span style="color: #9876AA">ERROR</span><span style="color: #007700">)) {<br />            </span><span style="color: #9876AA">$bev</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">free</span><span style="color: #007700">();<br />            </span><span style="color: #9876AA">$bev </span><span style="color: #007700">= </span><span style="color: #9876AA">NULL</span><span style="color: #007700">;<br />        } elseif (</span><span style="color: #9876AA">$events </span><span style="color: #007700">&amp; </span><span style="color: #9876AA">EventBufferEvent</span><span style="color: #007700">::</span><span style="color: #9876AA">CONNECTED</span><span style="color: #007700">) {<br />            </span><span style="color: #9876AA">$bev</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">output</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">add</span><span style="color: #007700">(</span><span style="color: #DD0000">"test\n"</span><span style="color: #007700">);<br />        }<br />    }<br />}<br /><br />if (</span><span style="color: #9876AA">$argc </span><span style="color: #007700">&lt;= </span><span style="color: #9876AA">1</span><span style="color: #007700">) {<br />    exit(</span><span style="color: #DD0000">"Socket path is not provided\n"</span><span style="color: #007700">);<br />}<br /></span><span style="color: #9876AA">$sock_path </span><span style="color: #007700">= </span><span style="color: #9876AA">$argv</span><span style="color: #007700">[</span><span style="color: #9876AA">1</span><span style="color: #007700">];<br /><br /></span><span style="color: #9876AA">$base </span><span style="color: #007700">= new </span><span style="color: #9876AA">EventBase</span><span style="color: #007700">();<br /></span><span style="color: #9876AA">$cl </span><span style="color: #007700">= new </span><span style="color: #9876AA">MyUnixSocketClient</span><span style="color: #007700">(</span><span style="color: #9876AA">$base</span><span style="color: #007700">, </span><span style="color: #9876AA">$sock_path</span><span style="color: #007700">);<br /></span><span style="color: #9876AA">$cl</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">dispatch</span><span style="color: #007700">();<br /></span><span style="color: #9876AA">?&gt;</span></span></span></div>   </div>   <div class="example-contents"><p>以上示例的输出类似于：</p></div>   <div class="example-contents screen" style="color:AFB1B3;background:black;padding-left:5px;"><div class="cdata"><span>Received 5 bytes<br>----- data ----<br>5:  test<br></span></div>   </div>  </div> </div> <br></br><div style="BORDER-TOP: gray 1px dashed; OVERFLOW: hidden; HEIGHT: 1px"></div><div class="refsect1 seealso" id="refsect1-eventbufferevent.connect-seealso">  <h3 class="title">参见</h3>  <ul class="simplelist">   <li class="member">    <span class="methodname" style="color:#CC7832">{@link EventBufferEvent::connectHost()} - Connects to a hostname with optionally asyncronous DNS resolving</span>   </li>  </ul> </div></div>