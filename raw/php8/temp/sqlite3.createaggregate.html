<div id="sqlite3.createaggregate" class="refentry"> <div class="refnamediv">  <h1 class="refname">SQLite3::createAggregate</h1>  <p class="verinfo">(PHP 5 &gt;= 5.3.0, PHP 7, PHP 8)</p><p class="refpurpose"><span class="refname">SQLite3::createAggregate</span> &mdash; <span class="dc-title">Registers a PHP function for use as an SQL aggregate function</span></p> </div> <br></br><div style="BORDER-TOP: gray 1px dashed; OVERFLOW: hidden; HEIGHT: 1px"></div><div class="refsect1 description" id="refsect1-sqlite3.createaggregate-description">  <h3 class="title">说明</h3>  <div class="methodsynopsis dc-description">   <span class="modifier">public</span> <span class="methodname" style="color:#CC7832"><strong>SQLite3::createAggregate</strong></span>(<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="methodparam"><span class="type" style="color:#EAB766">string</span> <span class="parameter" style="color:#3A95FF">$name</span></span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="methodparam"><span class="type" style="color:#EAB766"><a href="https://www.php.net/manual/zh/language.types.callable.php" class="type callable" style="color:#EAB766">callable</a></span> <span class="parameter" style="color:#3A95FF">$stepCallback</span></span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="methodparam"><span class="type" style="color:#EAB766"><a href="https://www.php.net/manual/zh/language.types.callable.php" class="type callable" style="color:#EAB766">callable</a></span> <span class="parameter" style="color:#3A95FF">$finalCallback</span></span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="methodparam"><span class="type" style="color:#EAB766">int</span> <span class="parameter" style="color:#3A95FF">$argCount</span><span class="initializer"> = -1</span></span><br>): <span class="type" style="color:#EAB766">bool</span></div>  <p class="para rdfs-comment">   Registers a PHP function or user-defined function for use as an SQL   aggregate function for use within SQL statements.  </p> </div> <br></br><div style="BORDER-TOP: gray 1px dashed; OVERFLOW: hidden; HEIGHT: 1px"></div><div class="refsect1 parameters" id="refsect1-sqlite3.createaggregate-parameters">  <h3 class="title">参数</h3>  <span>   <dl>         <dt><span class="parameter" style="color:#3A95FF">name</span></dt>     <dd>      <p class="para">       Name of the SQL aggregate to be created or redefined.      </p>     </dd>             <dt><span class="parameter" style="color:#3A95FF">stepCallback</span></dt>     <dd>      <p class="para">       Callback function called for each row of the result set. Your PHP       function should accumulate the result and store it in the aggregation       context.      </p>      <p class="para">       This function need to be defined as:       <div class="methodsynopsis dc-description">        <span class="methodname" style="color:#CC7832"><span class="replaceable">step</span></span>(<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="methodparam"><span class="type" style="color:#EAB766"><a href="https://www.php.net/manual/zh/language.types.declarations.php#language.types.declarations.mixed" class="type mixed" style="color:#EAB766">mixed</a></span> <span class="parameter" style="color:#3A95FF">$context</span></span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="methodparam"><span class="type" style="color:#EAB766">int</span> <span class="parameter" style="color:#3A95FF">$rownumber</span></span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="methodparam"><span class="type" style="color:#EAB766"><a href="https://www.php.net/manual/zh/language.types.declarations.php#language.types.declarations.mixed" class="type mixed" style="color:#EAB766">mixed</a></span> <span class="parameter" style="color:#3A95FF">$value</span></span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="methodparam"><span class="type" style="color:#EAB766"><a href="https://www.php.net/manual/zh/language.types.declarations.php#language.types.declarations.mixed" class="type mixed" style="color:#EAB766">mixed</a></span> <span class="parameter" style="color:#3A95FF">...$values</span></span><br>): <span class="type" style="color:#EAB766"><a href="https://www.php.net/manual/zh/language.types.declarations.php#language.types.declarations.mixed" class="type mixed" style="color:#EAB766">mixed</a></span></div>       <dl>                 <dt><span class="parameter" style="color:#3A95FF">context</span></dt>         <dd>          <p class="para">           <strong><span>null</span></strong> for the first row; on subsequent rows it will have the value           that was previously returned from the step function; you should use           this to maintain the aggregate state.          </p>         </dd>                         <dt><span class="parameter" style="color:#3A95FF">rownumber</span></dt>         <dd>          <p class="para">           The current row number.          </p>         </dd>                         <dt><span class="parameter" style="color:#3A95FF">value</span></dt>         <dd>          <p class="para">           The first argument passed to the aggregate.          </p>         </dd>                         <dt><span class="parameter" style="color:#3A95FF">values</span></dt>         <dd>          <p class="para">           Further arguments passed to the aggregate.          </p>         </dd>               </dl>       The return value of this function will be used as the       <span class="parameter" style="color:#3A95FF">context</span> argument in the next call of the step or       finalize functions.      </p>      </dd>             <dt><span class="parameter" style="color:#3A95FF">finalCallback</span></dt>     <dd>      <p class="para">       Callback function to aggregate the &quot;stepped&quot; data from each row.        Once all the rows have been processed, this function will be called       and it should then take the data from the aggregation context and       return the result. This callback function should return a type understood       by SQLite (i.e. <a href="https://www.php.net/manual/zh/language.types.intro.php" class="link">scalar type</a>).      </p>      <p class="para">       This function need to be defined as:       <div class="methodsynopsis dc-description">        <span class="methodname" style="color:#CC7832"><span class="replaceable">fini</span></span>(<span class="methodparam"><span class="type" style="color:#EAB766"><a href="https://www.php.net/manual/zh/language.types.declarations.php#language.types.declarations.mixed" class="type mixed" style="color:#EAB766">mixed</a></span> <span class="parameter" style="color:#3A95FF">$context</span></span>, <span class="methodparam"><span class="type" style="color:#EAB766">int</span> <span class="parameter" style="color:#3A95FF">$rownumber</span></span>): <span class="type" style="color:#EAB766"><a href="https://www.php.net/manual/zh/language.types.declarations.php#language.types.declarations.mixed" class="type mixed" style="color:#EAB766">mixed</a></span></div>       <dl>                 <dt><span class="parameter" style="color:#3A95FF">context</span></dt>         <dd>          <p class="para">           Holds the return value from the very last call to the step function.          </p>         </dd>                         <dt><span class="parameter" style="color:#3A95FF">rownumber</span></dt>         <dd>          <p class="para">           Always <span>0</span>.          </p>         </dd>               </dl>       The return value of this function will be used as the return value for       the aggregate.      </p>     </dd>             <dt><span class="parameter" style="color:#3A95FF">argCount</span></dt>     <dd>      <p class="para">       The number of arguments that the SQL aggregate takes. If       this parameter is negative, then the SQL aggregate may take       any number of arguments.      </p>     </dd>       </dl>  </span> </div> <br></br><div style="BORDER-TOP: gray 1px dashed; OVERFLOW: hidden; HEIGHT: 1px"></div><div class="refsect1 returnvalues" id="refsect1-sqlite3.createaggregate-returnvalues">  <h3 class="title">返回值</h3>  <p class="para">   Returns <strong><span>true</span></strong> upon successful creation of the aggregate,  或者在失败时返回 <strong><span>false</span></strong>.  </p> </div> <br></br><div style="BORDER-TOP: gray 1px dashed; OVERFLOW: hidden; HEIGHT: 1px"></div><div class="refsect1 examples" id="refsect1-sqlite3.createaggregate-examples">  <h3 class="title">示例</h3>  <span>   <div class="example" id="">    <p><strong>示例 #1 max_length aggregation function example</strong></p>    <div class="example-contents"><div class="phpcode" style="border-color:gray;background:#232525"><span><span style="color: #000000"><span style="color: #9876AA">&lt;?php<br />$data </span><span style="color: #007700">= array(<br />   </span><span style="color: #DD0000">'one'</span><span style="color: #007700">,<br />   </span><span style="color: #DD0000">'two'</span><span style="color: #007700">,<br />   </span><span style="color: #DD0000">'three'</span><span style="color: #007700">,<br />   </span><span style="color: #DD0000">'four'</span><span style="color: #007700">,<br />   </span><span style="color: #DD0000">'five'</span><span style="color: #007700">,<br />   </span><span style="color: #DD0000">'six'</span><span style="color: #007700">,<br />   </span><span style="color: #DD0000">'seven'</span><span style="color: #007700">,<br />   </span><span style="color: #DD0000">'eight'</span><span style="color: #007700">,<br />   </span><span style="color: #DD0000">'nine'</span><span style="color: #007700">,<br />   </span><span style="color: #DD0000">'ten'</span><span style="color: #007700">,<br />   );<br /></span><span style="color: #9876AA">$db </span><span style="color: #007700">= new </span><span style="color: #9876AA">SQLite3</span><span style="color: #007700">(</span><span style="color: #DD0000">':memory:'</span><span style="color: #007700">);<br /></span><span style="color: #9876AA">$db</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">exec</span><span style="color: #007700">(</span><span style="color: #DD0000">"CREATE TABLE strings(a)"</span><span style="color: #007700">);<br /></span><span style="color: #9876AA">$insert </span><span style="color: #007700">= </span><span style="color: #9876AA">$db</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">prepare</span><span style="color: #007700">(</span><span style="color: #DD0000">'INSERT INTO strings VALUES (?)'</span><span style="color: #007700">);<br />foreach (</span><span style="color: #9876AA">$data </span><span style="color: #007700">as </span><span style="color: #9876AA">$str</span><span style="color: #007700">) {<br />    </span><span style="color: #9876AA">$insert</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">bindValue</span><span style="color: #007700">(</span><span style="color: #9876AA">1</span><span style="color: #007700">, </span><span style="color: #9876AA">$str</span><span style="color: #007700">);<br />    </span><span style="color: #9876AA">$insert</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">execute</span><span style="color: #007700">();<br />}<br /></span><span style="color: #9876AA">$insert </span><span style="color: #007700">= </span><span style="color: #9876AA">null</span><span style="color: #007700">;<br /><br />function </span><span style="color: #9876AA">max_len_step</span><span style="color: #007700">(</span><span style="color: #9876AA">$context</span><span style="color: #007700">, </span><span style="color: #9876AA">$rownumber</span><span style="color: #007700">, </span><span style="color: #9876AA">$string</span><span style="color: #007700">)<br />{<br />    if (</span><span style="color: #9876AA">strlen</span><span style="color: #007700">(</span><span style="color: #9876AA">$string</span><span style="color: #007700">) &gt; </span><span style="color: #9876AA">$context</span><span style="color: #007700">) {<br />        </span><span style="color: #9876AA">$context </span><span style="color: #007700">= </span><span style="color: #9876AA">strlen</span><span style="color: #007700">(</span><span style="color: #9876AA">$string</span><span style="color: #007700">);<br />    }<br />    return </span><span style="color: #9876AA">$context</span><span style="color: #007700">;<br />}<br /><br />function </span><span style="color: #9876AA">max_len_finalize</span><span style="color: #007700">(</span><span style="color: #9876AA">$context</span><span style="color: #007700">, </span><span style="color: #9876AA">$rownumber</span><span style="color: #007700">)<br />{<br />    return </span><span style="color: #9876AA">$context </span><span style="color: #007700">=== </span><span style="color: #9876AA">null </span><span style="color: #007700">? </span><span style="color: #9876AA">0 </span><span style="color: #007700">: </span><span style="color: #9876AA">$context</span><span style="color: #007700">;<br />}<br /><br /></span><span style="color: #9876AA">$db</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">createAggregate</span><span style="color: #007700">(</span><span style="color: #DD0000">'max_len'</span><span style="color: #007700">, </span><span style="color: #DD0000">'max_len_step'</span><span style="color: #007700">, </span><span style="color: #DD0000">'max_len_finalize'</span><span style="color: #007700">);<br /><br /></span><span style="color: #9876AA">var_dump</span><span style="color: #007700">(</span><span style="color: #9876AA">$db</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">querySingle</span><span style="color: #007700">(</span><span style="color: #DD0000">'SELECT max_len(a) from strings'</span><span style="color: #007700">));<br /></span><span style="color: #9876AA">?&gt;</span></span></span></div>    </div>    <div class="example-contents"><p>以上示例会输出：</p></div>    <div class="example-contents screen" style="color:AFB1B3;background:black;padding-left:5px;"><div class="cdata"><span>int(5)<br></span></div>    </div>   </div>  </span>  <p class="para">   In this example, we are creating an aggregating function that will   calculate the length of the longest string in one of the columns of the   table.  For each row, the <span>max_len_step</span> function is   called and passed a <span>$context</span> parameter.  The context   parameter is just like any other PHP variable and be set to hold an array   or even an object value.  In this example, we are simply using it to hold   the maximum length we have seen so far; if the   <span>$string</span> has a length longer than the current   maximum, we update the context to hold this new maximum length.  </p>  <p class="para">   After all of the rows have been processed, SQLite calls the   <span>max_len_finalize</span> function to determine the aggregate   result.  Here, we could perform some kind of calculation based on the   data found in the <span>$context</span>.  In our simple example   though, we have been calculating the result as the query progressed, so we   simply need to return the context value.  </p>  <div class="tip"><strong class="tip">小技巧</strong>   <p class="para">    It is NOT recommended for you to store a copy of the values in the context    and then process them at the end, as you would cause SQLite to use a lot of    memory to process the query - just think of how much memory you would need    if a million rows were stored in memory, each containing a string 32 bytes    in length.   </p>  </div>  <div class="tip"><strong class="tip">小技巧</strong>   <p class="para">    You can use <span class="methodname" style="color:#CC7832"><strong>SQLite3::createAggregate()</strong></span> to override SQLite    native SQL functions.   </p>  </div> </div></div>