<div id="pdo.sqlitecreateaggregate" class="refentry"> <div class="refnamediv">  <h1 class="refname">PDO::sqliteCreateAggregate</h1>  <p class="verinfo">(PHP 5 &gt;= 5.1.0, PHP 7, PHP 8, PECL pdo_sqlite &gt;= 1.0.0)</p><p class="refpurpose"><span class="refname">PDO::sqliteCreateAggregate</span> &mdash; <span class="dc-title">   Registers an aggregating User Defined Function for use in SQL statements  </span></p> </div> <br></br><div style="BORDER-TOP: gray 1px dashed; OVERFLOW: hidden; HEIGHT: 1px"></div><div class="refsect1 description" id="refsect1-pdo.sqlitecreateaggregate-description">  <h3 class="title">说明</h3>  <div class="methodsynopsis dc-description">   <span class="modifier">public</span> <span class="methodname" style="color:#CC7832"><strong>PDO::sqliteCreateAggregate</strong></span>(<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="methodparam"><span class="type" style="color:#EAB766">string</span> <span class="parameter" style="color:#3A95FF">$function_name</span></span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="methodparam"><span class="type" style="color:#EAB766"><a href="https://www.php.net/manual/zh/language.types.callable.php" class="type callable" style="color:#EAB766">callable</a></span> <span class="parameter" style="color:#3A95FF">$step_func</span></span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="methodparam"><span class="type" style="color:#EAB766"><a href="https://www.php.net/manual/zh/language.types.callable.php" class="type callable" style="color:#EAB766">callable</a></span> <span class="parameter" style="color:#3A95FF">$finalize_func</span></span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="methodparam"><span class="type" style="color:#EAB766">int</span> <span class="parameter" style="color:#3A95FF">$num_args</span><span class="initializer"> = ?</span></span><br>): <span class="type" style="color:#EAB766">bool</span></div>  <div class="warning"><strong class="warning">警告</strong><p class="simpara">此函数是<em>实验性</em>的。此函数的表象，包括名称及其相关文档都可能在未来的PHP 发布版本中未通知就被修改。使用本函数风险自担。</p></div>  <p class="para">   This method is similar to {@link PDO::sqliteCreateFunction} except that it registers functions that can be used to calculate a   result aggregated across all the rows of a query.  </p>  <p class="para">   The key difference between this method and {@link PDO::sqliteCreateFunction} is that two functions are   required to manage the aggregate.   </p> </div> <br></br><div style="BORDER-TOP: gray 1px dashed; OVERFLOW: hidden; HEIGHT: 1px"></div><div class="refsect1 parameters" id="refsect1-pdo.sqlitecreateaggregate-parameters">  <h3 class="title">参数</h3>  <span>   <dl>         <dt><span class="parameter" style="color:#3A95FF">function_name</span></dt>     <dd>      <p class="para">       The name of the function used in SQL statements.      </p>     </dd>             <dt><span class="parameter" style="color:#3A95FF">step_func</span></dt>     <dd>      <p class="para">       Callback function called for each row of the result set. Your PHP       function should accumulate the result and store it in the aggregation       context.      </p>      <p class="para">       This function need to be defined as:       <div class="methodsynopsis dc-description">        <span class="methodname" style="color:#CC7832"><span class="replaceable">step</span></span>(<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="methodparam"><span class="type" style="color:#EAB766"><a href="https://www.php.net/manual/zh/language.types.declarations.php#language.types.declarations.mixed" class="type mixed" style="color:#EAB766">mixed</a></span> <span class="parameter" style="color:#3A95FF">$context</span></span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="methodparam"><span class="type" style="color:#EAB766">int</span> <span class="parameter" style="color:#3A95FF">$rownumber</span></span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="methodparam"><span class="type" style="color:#EAB766"><a href="https://www.php.net/manual/zh/language.types.declarations.php#language.types.declarations.mixed" class="type mixed" style="color:#EAB766">mixed</a></span> <span class="parameter" style="color:#3A95FF">$value</span></span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="methodparam"><span class="type" style="color:#EAB766"><a href="https://www.php.net/manual/zh/language.types.declarations.php#language.types.declarations.mixed" class="type mixed" style="color:#EAB766">mixed</a></span> <span class="parameter" style="color:#3A95FF">...$values</span></span><br>): <span class="type" style="color:#EAB766"><a href="https://www.php.net/manual/zh/language.types.declarations.php#language.types.declarations.mixed" class="type mixed" style="color:#EAB766">mixed</a></span></div>       <dl>                 <dt><span class="parameter" style="color:#3A95FF">context</span></dt>         <dd>          <p class="para">           <strong><span>null</span></strong> for the first row; on subsequent rows it will have the value           that was previously returned from the step function; you should use           this to maintain the aggregate state.          </p>         </dd>                         <dt><span class="parameter" style="color:#3A95FF">rownumber</span></dt>         <dd>          <p class="para">           The current row number.          </p>         </dd>                         <dt><span class="parameter" style="color:#3A95FF">value</span></dt>         <dd>          <p class="para">           The first argument passed to the aggregate.          </p>         </dd>                         <dt><span class="parameter" style="color:#3A95FF">values</span></dt>         <dd>          <p class="para">           Further arguments passed to the aggregate.          </p>         </dd>               </dl>       The return value of this function will be used as the       <span class="parameter" style="color:#3A95FF">context</span> argument in the next call of the step or       finalize functions.      </p>     </dd>             <dt><span class="parameter" style="color:#3A95FF">finalize_func</span></dt>     <dd>      <p class="para">       Callback function to aggregate the &quot;stepped&quot; data from each row.        Once all the rows have been processed, this function will be called       and it should then take the data from the aggregation context and       return the result. This callback function should return a type understood       by SQLite (i.e. <a href="https://www.php.net/manual/zh/language.types.intro.php" class="link">scalar type</a>).      </p>      <p class="para">       This function need to be defined as:       <div class="methodsynopsis dc-description">        <span class="methodname" style="color:#CC7832"><span class="replaceable">fini</span></span>(<span class="methodparam"><span class="type" style="color:#EAB766"><a href="https://www.php.net/manual/zh/language.types.declarations.php#language.types.declarations.mixed" class="type mixed" style="color:#EAB766">mixed</a></span> <span class="parameter" style="color:#3A95FF">$context</span></span>, <span class="methodparam"><span class="type" style="color:#EAB766">int</span> <span class="parameter" style="color:#3A95FF">$rowcount</span></span>): <span class="type" style="color:#EAB766"><a href="https://www.php.net/manual/zh/language.types.declarations.php#language.types.declarations.mixed" class="type mixed" style="color:#EAB766">mixed</a></span></div>       <dl>                 <dt><span class="parameter" style="color:#3A95FF">context</span></dt>         <dd>          <p class="para">           Holds the return value from the very last call to the step function.          </p>         </dd>                         <dt><span class="parameter" style="color:#3A95FF">rowcount</span></dt>         <dd>          <p class="para">           Holds the number of rows over which the aggregate was performed.          </p>         </dd>               </dl>       The return value of this function will be used as the return value for       the aggregate.      </p>     </dd>             <dt><span class="parameter" style="color:#3A95FF">num_args</span></dt>     <dd>      <p class="para">       Hint to the SQLite parser if the callback function accepts a       predetermined number of arguments.      </p>     </dd>       </dl>  </span> </div> <br></br><div style="BORDER-TOP: gray 1px dashed; OVERFLOW: hidden; HEIGHT: 1px"></div><div class="refsect1 returnvalues" id="refsect1-pdo.sqlitecreateaggregate-returnvalues">  <h3 class="title">返回值</h3>  <p class="para">   成功时返回 <strong><span>true</span></strong>， 或者在失败时返回 <strong><span>false</span></strong>。  </p> </div> <br></br><div style="BORDER-TOP: gray 1px dashed; OVERFLOW: hidden; HEIGHT: 1px"></div><div class="refsect1 examples" id="refsect1-pdo.sqlitecreateaggregate-examples">  <h3 class="title">示例</h3>  <span>   <div class="example" id="example-3344">    <p><strong>示例 #1 max_length aggregation function example</strong></p>    <div class="example-contents"><div class="phpcode" style="border-color:gray;background:#232525"><span><span style="color: #000000"><span style="color: #9876AA">&lt;?php<br />$data </span><span style="color: #007700">= array(<br />   </span><span style="color: #DD0000">'one'</span><span style="color: #007700">,<br />   </span><span style="color: #DD0000">'two'</span><span style="color: #007700">,<br />   </span><span style="color: #DD0000">'three'</span><span style="color: #007700">,<br />   </span><span style="color: #DD0000">'four'</span><span style="color: #007700">,<br />   </span><span style="color: #DD0000">'five'</span><span style="color: #007700">,<br />   </span><span style="color: #DD0000">'six'</span><span style="color: #007700">,<br />   </span><span style="color: #DD0000">'seven'</span><span style="color: #007700">,<br />   </span><span style="color: #DD0000">'eight'</span><span style="color: #007700">,<br />   </span><span style="color: #DD0000">'nine'</span><span style="color: #007700">,<br />   </span><span style="color: #DD0000">'ten'</span><span style="color: #007700">,<br />   );<br /></span><span style="color: #9876AA">$db </span><span style="color: #007700">= new </span><span style="color: #9876AA">PDO</span><span style="color: #007700">(</span><span style="color: #DD0000">'sqlite::memory:'</span><span style="color: #007700">);<br /></span><span style="color: #9876AA">$db</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">exec</span><span style="color: #007700">(</span><span style="color: #DD0000">"CREATE TABLE strings(a)"</span><span style="color: #007700">);<br /></span><span style="color: #9876AA">$insert </span><span style="color: #007700">= </span><span style="color: #9876AA">$db</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">prepare</span><span style="color: #007700">(</span><span style="color: #DD0000">'INSERT INTO strings VALUES (?)'</span><span style="color: #007700">);<br />foreach (</span><span style="color: #9876AA">$data </span><span style="color: #007700">as </span><span style="color: #9876AA">$str</span><span style="color: #007700">) {<br />    </span><span style="color: #9876AA">$insert</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">execute</span><span style="color: #007700">(array(</span><span style="color: #9876AA">$str</span><span style="color: #007700">));<br />}<br /></span><span style="color: #9876AA">$insert </span><span style="color: #007700">= </span><span style="color: #9876AA">null</span><span style="color: #007700">;<br /><br />function </span><span style="color: #9876AA">max_len_step</span><span style="color: #007700">(</span><span style="color: #9876AA">$context</span><span style="color: #007700">, </span><span style="color: #9876AA">$rownumber</span><span style="color: #007700">, </span><span style="color: #9876AA">$string</span><span style="color: #007700">) <br />{<br />    if (</span><span style="color: #9876AA">strlen</span><span style="color: #007700">(</span><span style="color: #9876AA">$string</span><span style="color: #007700">) &gt; </span><span style="color: #9876AA">$context</span><span style="color: #007700">) {<br />        </span><span style="color: #9876AA">$context </span><span style="color: #007700">= </span><span style="color: #9876AA">strlen</span><span style="color: #007700">(</span><span style="color: #9876AA">$string</span><span style="color: #007700">);<br />    }<br />    return </span><span style="color: #9876AA">$context</span><span style="color: #007700">;<br />}<br /><br />function </span><span style="color: #9876AA">max_len_finalize</span><span style="color: #007700">(</span><span style="color: #9876AA">$context</span><span style="color: #007700">, </span><span style="color: #9876AA">$rowcount</span><span style="color: #007700">) <br />{<br />    return </span><span style="color: #9876AA">$context </span><span style="color: #007700">=== </span><span style="color: #9876AA">null </span><span style="color: #007700">? </span><span style="color: #9876AA">0 </span><span style="color: #007700">: </span><span style="color: #9876AA">$context</span><span style="color: #007700">;<br />}<br /><br /></span><span style="color: #9876AA">$db</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">sqliteCreateAggregate</span><span style="color: #007700">(</span><span style="color: #DD0000">'max_len'</span><span style="color: #007700">, </span><span style="color: #DD0000">'max_len_step'</span><span style="color: #007700">, </span><span style="color: #DD0000">'max_len_finalize'</span><span style="color: #007700">);<br /><br /></span><span style="color: #9876AA">var_dump</span><span style="color: #007700">(</span><span style="color: #9876AA">$db</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">query</span><span style="color: #007700">(</span><span style="color: #DD0000">'SELECT max_len(a) from strings'</span><span style="color: #007700">)-&gt;</span><span style="color: #9876AA">fetchAll</span><span style="color: #007700">());<br /><br /></span><span style="color: #9876AA">?&gt;</span></span></span></div>    </div>   </div>  </span>  <p class="para">   In this example, we are creating an aggregating function that will   calculate the length of the longest string in one of the columns of the   table.  For each row, the <span>max_len_step</span> function is   called and passed a <span>$context</span> parameter.  The context   parameter is just like any other PHP variable and be set to hold an array   or even an object value.  In this example, we are simply using it to hold   the maximum length we have seen so far; if the   <span>$string</span> has a length longer than the current   maximum, we update the context to hold this new maximum length.  </p>  <p class="para">   After all of the rows have been processed, SQLite calls the   <span>max_len_finalize</span> function to determine the aggregate   result.  Here, we could perform some kind of calculation based on the   data found in the <span>$context</span>.  In our simple example   though, we have been calculating the result as the query progressed, so we   simply need to return the context value.  </p>  <div class="tip"><strong class="tip">小技巧</strong>   <p class="para">    It is NOT recommended for you to store a copy of the values in the context    and then process them at the end, as you would cause SQLite to use a lot of    memory to process the query - just think of how much memory you would need    if a million rows were stored in memory, each containing a string 32 bytes    in length.   </p>  </div>  <div class="tip"><strong class="tip">小技巧</strong>   <p class="para">    You can use {@link PDO::sqliteCreateFunction} and    {@link PDO::sqliteCreateAggregate} to override SQLite    native SQL functions.   </p>  </div> </div> <br></br><div style="BORDER-TOP: gray 1px dashed; OVERFLOW: hidden; HEIGHT: 1px"></div><div class="refsect1 seealso" id="refsect1-pdo.sqlitecreateaggregate-seealso">  <h3 class="title">参见</h3>  <span>   <ul class="simplelist">    <li class="member">{@link PDO::sqliteCreateFunction}</li>    <li class="member"><span class="function"><strong style="color:#CC7832">sqlite_create_function()</strong></span></li>    <li class="member"><span class="function"><strong style="color:#CC7832">sqlite_create_aggregate()</strong></span></li>   </ul>  </span> </div></div>