<div id="ffi.examples-callback" class="section">  <h2 class="title">PHP 回调</h2>  <p class="para">   可以将 PHP 闭包分配给函数指针类型的原生变量，或将其作为函数参数传递。   <div class="example" id="example-1592">    <div class="example-contents"><div class="phpcode" style="border-color:gray;background:#232525"><span><span style="color: #000000"><span style="color: #9876AA">&lt;?php<br />$zend </span><span style="color: #007700">= </span><span style="color: #9876AA">FFI</span><span style="color: #007700">::</span><span style="color: #9876AA">cdef</span><span style="color: #007700">(</span><span style="color: #DD0000">"<br />    typedef int (*zend_write_func_t)(const char *str, size_t str_length);<br />    extern zend_write_func_t zend_write;<br />"</span><span style="color: #007700">);<br /> <br />echo </span><span style="color: #DD0000">"Hello World 1!\n"</span><span style="color: #007700">;<br /> <br /></span><span style="color: #9876AA">$orig_zend_write </span><span style="color: #007700">= clone </span><span style="color: #9876AA">$zend</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">zend_write</span><span style="color: #007700">;<br /></span><span style="color: #9876AA">$zend</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">zend_write </span><span style="color: #007700">= function(</span><span style="color: #9876AA">$str</span><span style="color: #007700">, </span><span style="color: #9876AA">$len</span><span style="color: #007700">) {<br />    global </span><span style="color: #9876AA">$orig_zend_write</span><span style="color: #007700">;<br />    </span><span style="color: #9876AA">$orig_zend_write</span><span style="color: #007700">(</span><span style="color: #DD0000">"{\n\t"</span><span style="color: #007700">, </span><span style="color: #9876AA">3</span><span style="color: #007700">);<br />    </span><span style="color: #9876AA">$ret </span><span style="color: #007700">= </span><span style="color: #9876AA">$orig_zend_write</span><span style="color: #007700">(</span><span style="color: #9876AA">$str</span><span style="color: #007700">, </span><span style="color: #9876AA">$len</span><span style="color: #007700">);<br />    </span><span style="color: #9876AA">$orig_zend_write</span><span style="color: #007700">(</span><span style="color: #DD0000">"}\n"</span><span style="color: #007700">, </span><span style="color: #9876AA">2</span><span style="color: #007700">);<br />    return </span><span style="color: #9876AA">$ret</span><span style="color: #007700">;<br />};<br />echo </span><span style="color: #DD0000">"Hello World 2!\n"</span><span style="color: #007700">;<br /></span><span style="color: #9876AA">$zend</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">zend_write </span><span style="color: #007700">= </span><span style="color: #9876AA">$orig_zend_write</span><span style="color: #007700">;<br />echo </span><span style="color: #DD0000">"Hello World 3!\n"</span><span style="color: #007700">;<br /></span><span style="color: #9876AA">?&gt;</span></span></span></div>    </div>    <div class="example-contents"><p>以上示例会输出：</p></div>    <div class="example-contents screen" style="color:AFB1B3;background:black;padding-left:5px;"><div class="cdata"><span>Hello World 1!<br>{<br>        Hello World 2!<br>}<br>Hello World 3!<br></span></div>    </div>   </div>   虽然这样可以运行，但并非所有的 libffi 平台都支持这个功能，而且效率不高，并且在请求结束时会泄漏资源。   <div class="tip"><strong class="tip">小技巧</strong>    <p class="simpara">     因此，建议尽量减少使用 PHP 回调函数。    </p>   </div>  </p> </div>