<div id="class.mongodb-driver-bulkwrite" class="reference"> <h1 class="title">The MongoDB\Driver\BulkWrite class</h1>  <div class="partintro"><p class="verinfo">(mongodb &gt;=1.0.0)</p>  <div class="section" id="mongodb-driver-bulkwrite.intro">   <h2 class="title">简介</h2>   <p class="para">    The <span class="classname"><strong class="classname">MongoDB\Driver\BulkWrite</strong></span> collects one or more    write operations that should be sent to the server. After adding any    number of insert, update, and delete operations, the collection may be    executed via    <span class="methodname" style="color:#CC7832">{@link MongoDB\Driver\Manager::executeBulkWrite()}</span>.   </p>   <p class="para">    Write operations may either be ordered (default) or unordered. Ordered write    operations are sent to the server, in the order provided, for serial    execution. If a write fails, any remaining operations will be aborted.    Unordered operations are sent to the server in an arbitrary order    where they may be executed in parallel. Any errors that occur are reported    after all operations have been attempted.   </p>  </div>  <div class="section" id="mongodb-driver-bulkwrite.synopsis">   <h2 class="title">类摘要</h2>   <div class="classsynopsis">    <span class="ooclass"><strong class="classname"></strong></span>    <div class="classsynopsisinfo">     <span class="modifier">final</span>     <span class="ooclass">      <span class="modifier">class</span> <strong class="classname">MongoDB\Driver\BulkWrite</strong>     </span>          <span class="oointerface"><span class="modifier">implements</span>        <a href="https://www.php.net/manual/zh/class.countable.php" class="interfacename">Countable</a></span> {</div>        <div class="classsynopsisinfo classsynopsisinfo_comment">// 方法 </div>    <div class="methodsynopsis dc-description">   <span class="modifier">public</span> <span class="methodname" style="color:#CC7832"><a href="https://www.php.net/manual/zh/mongodb-driver-bulkwrite.construct.php" class="methodname" style="color:#CC7832">__construct</a></span>(<span class="methodparam"><span class="type" style="color:#EAB766">?</span><span class="type" style="color:#EAB766"><span class="type" style="color:#EAB766">array</span><span class="type" style="color:#EAB766"></span></span> <span class="parameter" style="color:#3A95FF">$options</span><span class="initializer"> = <strong><span>null</span></strong></span></span>)</div><div class="methodsynopsis dc-description"><span class="modifier">public</span> <span class="methodname" style="color:#CC7832"><a href="https://www.php.net/manual/zh/mongodb-driver-bulkwrite.count.php" class="methodname" style="color:#CC7832">count</a></span>(): <span class="type" style="color:#EAB766">int</span></div><div class="methodsynopsis dc-description"><span class="modifier">public</span> <span class="methodname" style="color:#CC7832"><a href="https://www.php.net/manual/zh/mongodb-driver-bulkwrite.delete.php" class="methodname" style="color:#CC7832">delete</a></span>(<span class="methodparam"><span class="type" style="color:#EAB766"><span class="type" style="color:#EAB766">array</span>|<span class="type" style="color:#EAB766">object</span></span> <span class="parameter" style="color:#3A95FF">$filter</span></span>, <span class="methodparam"><span class="type" style="color:#EAB766">?</span><span class="type" style="color:#EAB766"><span class="type" style="color:#EAB766">array</span><span class="type" style="color:#EAB766"></span></span> <span class="parameter" style="color:#3A95FF">$deleteOptions</span><span class="initializer"> = <strong><span>null</span></strong></span></span>): <span class="type" style="color:#EAB766"><span class="type void" style="color:#EAB766">void</span></span></div><div class="methodsynopsis dc-description"><span class="modifier">public</span> <span class="methodname" style="color:#CC7832"><a href="https://www.php.net/manual/zh/mongodb-driver-bulkwrite.insert.php" class="methodname" style="color:#CC7832">insert</a></span>(<span class="methodparam"><span class="type" style="color:#EAB766"><span class="type" style="color:#EAB766">array</span>|<span class="type" style="color:#EAB766">object</span></span> <span class="parameter" style="color:#3A95FF">$document</span></span>): <span class="type" style="color:#EAB766"><a href="https://www.php.net/manual/zh/language.types.declarations.php#language.types.declarations.mixed" class="type mixed" style="color:#EAB766">mixed</a></span></div><div class="methodsynopsis dc-description"><span class="modifier">public</span> <span class="methodname" style="color:#CC7832"><a href="https://www.php.net/manual/zh/mongodb-driver-bulkwrite.update.php" class="methodname" style="color:#CC7832">update</a></span>(<span class="methodparam"><span class="type" style="color:#EAB766"><span class="type" style="color:#EAB766">array</span>|<span class="type" style="color:#EAB766">object</span></span> <span class="parameter" style="color:#3A95FF">$filter</span></span>, <span class="methodparam"><span class="type" style="color:#EAB766"><span class="type" style="color:#EAB766">array</span>|<span class="type" style="color:#EAB766">object</span></span> <span class="parameter" style="color:#3A95FF">$newObj</span></span>, <span class="methodparam"><span class="type" style="color:#EAB766">?</span><span class="type" style="color:#EAB766"><span class="type" style="color:#EAB766">array</span><span class="type" style="color:#EAB766"></span></span> <span class="parameter" style="color:#3A95FF">$updateOptions</span><span class="initializer"> = <strong><span>null</span></strong></span></span>): <span class="type" style="color:#EAB766"><span class="type void" style="color:#EAB766">void</span></span></div>   }</div>  </div>  <div class="section" id="mongodb-driver-bulkwrite.examples">   <h2 class="title">示例</h2>   <div class="example" id="example-3941">    <p><strong>示例 #1 Mixed write operations are grouped by type</strong></p>    <div class="example-contents"><p>     Mixed write operations (i.e. inserts, updates, and deletes) will be     assembled into typed write commands to be sent sequentially to the server.    </p></div>    <div class="example-contents"><div class="phpcode" style="border-color:gray;background:#232525"><span><span style="color: #000000"><span style="color: #9876AA">&lt;?php<br /><br />$bulk </span><span style="color: #007700">= new </span><span style="color: #9876AA">MongoDB\Driver\BulkWrite</span><span style="color: #007700">([</span><span style="color: #DD0000">'ordered' </span><span style="color: #007700">=&gt; </span><span style="color: #9876AA">true</span><span style="color: #007700">]);<br /></span><span style="color: #9876AA">$bulk</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">insert</span><span style="color: #007700">([</span><span style="color: #DD0000">'_id' </span><span style="color: #007700">=&gt; </span><span style="color: #9876AA">1</span><span style="color: #007700">, </span><span style="color: #DD0000">'x' </span><span style="color: #007700">=&gt; </span><span style="color: #9876AA">1</span><span style="color: #007700">]);<br /></span><span style="color: #9876AA">$bulk</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">insert</span><span style="color: #007700">([</span><span style="color: #DD0000">'_id' </span><span style="color: #007700">=&gt; </span><span style="color: #9876AA">2</span><span style="color: #007700">, </span><span style="color: #DD0000">'x' </span><span style="color: #007700">=&gt; </span><span style="color: #9876AA">2</span><span style="color: #007700">]);<br /></span><span style="color: #9876AA">$bulk</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">update</span><span style="color: #007700">([</span><span style="color: #DD0000">'x' </span><span style="color: #007700">=&gt; </span><span style="color: #9876AA">2</span><span style="color: #007700">], [</span><span style="color: #DD0000">'$set' </span><span style="color: #007700">=&gt; [</span><span style="color: #DD0000">'x' </span><span style="color: #007700">=&gt; </span><span style="color: #9876AA">1</span><span style="color: #007700">]]);<br /></span><span style="color: #9876AA">$bulk</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">insert</span><span style="color: #007700">([</span><span style="color: #DD0000">'_id' </span><span style="color: #007700">=&gt; </span><span style="color: #9876AA">3</span><span style="color: #007700">, </span><span style="color: #DD0000">'x' </span><span style="color: #007700">=&gt; </span><span style="color: #9876AA">3</span><span style="color: #007700">]);<br /></span><span style="color: #9876AA">$bulk</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">delete</span><span style="color: #007700">([</span><span style="color: #DD0000">'x' </span><span style="color: #007700">=&gt; </span><span style="color: #9876AA">1</span><span style="color: #007700">]);<br /><br /></span><span style="color: #9876AA">?&gt;</span></span></span></div>    </div>    <div class="example-contents"><p>     Will result in four write commands (i.e. roundtrips) being executed. Since     the operations are ordered, the third insertion cannot be sent until the     preceding update is executed.    </p></div>   </div>   <div class="example" id="example-3944">    <p><strong>示例 #2 Ordered write operations causing an error</strong></p>    <div class="example-contents"><div class="phpcode" style="border-color:gray;background:#232525"><span><span style="color: #000000"><span style="color: #9876AA">&lt;?php<br /><br />$bulk </span><span style="color: #007700">= new </span><span style="color: #9876AA">MongoDB\Driver\BulkWrite</span><span style="color: #007700">([</span><span style="color: #DD0000">'ordered' </span><span style="color: #007700">=&gt; </span><span style="color: #9876AA">true</span><span style="color: #007700">]);<br /></span><span style="color: #9876AA">$bulk</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">delete</span><span style="color: #007700">([]);<br /></span><span style="color: #9876AA">$bulk</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">insert</span><span style="color: #007700">([</span><span style="color: #DD0000">'_id' </span><span style="color: #007700">=&gt; </span><span style="color: #9876AA">1</span><span style="color: #007700">]);<br /></span><span style="color: #9876AA">$bulk</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">insert</span><span style="color: #007700">([</span><span style="color: #DD0000">'_id' </span><span style="color: #007700">=&gt; </span><span style="color: #9876AA">2</span><span style="color: #007700">]);<br /></span><span style="color: #9876AA">$bulk</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">insert</span><span style="color: #007700">([</span><span style="color: #DD0000">'_id' </span><span style="color: #007700">=&gt; </span><span style="color: #9876AA">3</span><span style="color: #007700">, </span><span style="color: #DD0000">'hello' </span><span style="color: #007700">=&gt; </span><span style="color: #DD0000">'world'</span><span style="color: #007700">]);<br /></span><span style="color: #9876AA">$bulk</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">update</span><span style="color: #007700">([</span><span style="color: #DD0000">'_id' </span><span style="color: #007700">=&gt; </span><span style="color: #9876AA">3</span><span style="color: #007700">], [</span><span style="color: #DD0000">'$set' </span><span style="color: #007700">=&gt; [</span><span style="color: #DD0000">'hello' </span><span style="color: #007700">=&gt; </span><span style="color: #DD0000">'earth'</span><span style="color: #007700">]]);<br /></span><span style="color: #9876AA">$bulk</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">insert</span><span style="color: #007700">([</span><span style="color: #DD0000">'_id' </span><span style="color: #007700">=&gt; </span><span style="color: #9876AA">4</span><span style="color: #007700">, </span><span style="color: #DD0000">'hello' </span><span style="color: #007700">=&gt; </span><span style="color: #DD0000">'pluto'</span><span style="color: #007700">]);<br /></span><span style="color: #9876AA">$bulk</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">update</span><span style="color: #007700">([</span><span style="color: #DD0000">'_id' </span><span style="color: #007700">=&gt; </span><span style="color: #9876AA">4</span><span style="color: #007700">], [</span><span style="color: #DD0000">'$set' </span><span style="color: #007700">=&gt; [</span><span style="color: #DD0000">'hello' </span><span style="color: #007700">=&gt; </span><span style="color: #DD0000">'moon'</span><span style="color: #007700">]]);<br /></span><span style="color: #9876AA">$bulk</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">insert</span><span style="color: #007700">([</span><span style="color: #DD0000">'_id' </span><span style="color: #007700">=&gt; </span><span style="color: #9876AA">3</span><span style="color: #007700">]);<br /></span><span style="color: #9876AA">$bulk</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">insert</span><span style="color: #007700">([</span><span style="color: #DD0000">'_id' </span><span style="color: #007700">=&gt; </span><span style="color: #9876AA">4</span><span style="color: #007700">]);<br /></span><span style="color: #9876AA">$bulk</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">insert</span><span style="color: #007700">([</span><span style="color: #DD0000">'_id' </span><span style="color: #007700">=&gt; </span><span style="color: #9876AA">5</span><span style="color: #007700">]);<br /><br /></span><span style="color: #9876AA">$manager </span><span style="color: #007700">= new </span><span style="color: #9876AA">MongoDB\Driver\Manager</span><span style="color: #007700">(</span><span style="color: #DD0000">'mongodb://localhost:27017'</span><span style="color: #007700">);<br /></span><span style="color: #9876AA">$writeConcern </span><span style="color: #007700">= new </span><span style="color: #9876AA">MongoDB\Driver\WriteConcern</span><span style="color: #007700">(</span><span style="color: #9876AA">MongoDB\Driver\WriteConcern</span><span style="color: #007700">::</span><span style="color: #9876AA">MAJORITY</span><span style="color: #007700">, </span><span style="color: #9876AA">1000</span><span style="color: #007700">);<br /><br />try {<br />    </span><span style="color: #9876AA">$result </span><span style="color: #007700">= </span><span style="color: #9876AA">$manager</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">executeBulkWrite</span><span style="color: #007700">(</span><span style="color: #DD0000">'db.collection'</span><span style="color: #007700">, </span><span style="color: #9876AA">$bulk</span><span style="color: #007700">, </span><span style="color: #9876AA">$writeConcern</span><span style="color: #007700">);<br />} catch (</span><span style="color: #9876AA">MongoDB\Driver\Exception\BulkWriteException $e</span><span style="color: #007700">) {<br />    </span><span style="color: #9876AA">$result </span><span style="color: #007700">= </span><span style="color: #9876AA">$e</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">getWriteResult</span><span style="color: #007700">();<br /><br />    </span><span style="color: #FF8000">// Check if the write concern could not be fulfilled<br />    </span><span style="color: #007700">if (</span><span style="color: #9876AA">$writeConcernError </span><span style="color: #007700">= </span><span style="color: #9876AA">$result</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">getWriteConcernError</span><span style="color: #007700">()) {<br />        </span><span style="color: #9876AA">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">"%s (%d): %s\n"</span><span style="color: #007700">,<br />            </span><span style="color: #9876AA">$writeConcernError</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">getMessage</span><span style="color: #007700">(),<br />            </span><span style="color: #9876AA">$writeConcernError</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">getCode</span><span style="color: #007700">(),<br />            </span><span style="color: #9876AA">var_export</span><span style="color: #007700">(</span><span style="color: #9876AA">$writeConcernError</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">getInfo</span><span style="color: #007700">(), </span><span style="color: #9876AA">true</span><span style="color: #007700">)<br />        );<br />    }<br /><br />    </span><span style="color: #FF8000">// Check if any write operations did not complete at all<br />    </span><span style="color: #007700">foreach (</span><span style="color: #9876AA">$result</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">getWriteErrors</span><span style="color: #007700">() as </span><span style="color: #9876AA">$writeError</span><span style="color: #007700">) {<br />        </span><span style="color: #9876AA">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">"Operation#%d: %s (%d)\n"</span><span style="color: #007700">,<br />            </span><span style="color: #9876AA">$writeError</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">getIndex</span><span style="color: #007700">(),<br />            </span><span style="color: #9876AA">$writeError</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">getMessage</span><span style="color: #007700">(),<br />            </span><span style="color: #9876AA">$writeError</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">getCode</span><span style="color: #007700">()<br />        );<br />    }<br />} catch (</span><span style="color: #9876AA">MongoDB\Driver\Exception\Exception $e</span><span style="color: #007700">) {<br />    </span><span style="color: #9876AA">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">"Other error: %s\n"</span><span style="color: #007700">, </span><span style="color: #9876AA">$e</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">getMessage</span><span style="color: #007700">());<br />    exit;<br />}<br /><br /></span><span style="color: #9876AA">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">"Inserted %d document(s)\n"</span><span style="color: #007700">, </span><span style="color: #9876AA">$result</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">getInsertedCount</span><span style="color: #007700">());<br /></span><span style="color: #9876AA">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">"Updated  %d document(s)\n"</span><span style="color: #007700">, </span><span style="color: #9876AA">$result</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">getModifiedCount</span><span style="color: #007700">());<br /><br /></span><span style="color: #9876AA">?&gt;</span></span></span></div>    </div>   </div>   <p class="para">以上示例会输出：</p>   <div class="example-contents screen" style="color:AFB1B3;background:black;padding-left:5px;"><div class="cdata"><span>Operation#7: E11000 duplicate key error index: db.collection.$_id_ dup key: { : 3 } (11000)<br>Inserted 4 document(s)<br>Updated  2 document(s)<br></span></div>   </div>   <p class="para">    If the write concern could not be fullfilled, the example above would output    something like:   </p>   <div class="example-contents screen" style="color:AFB1B3;background:black;padding-left:5px;"><div class="cdata"><span>waiting for replication timed out (64): array (<br>  &#039;wtimeout&#039; =&gt; true,<br>)<br>Operation#7: E11000 duplicate key error index: databaseName.collectionName.$_id_ dup key: { : 3 } (11000)<br>Inserted 4 document(s)<br>Updated  2 document(s)<br></span></div>   </div>   <p class="para">    If we execute the example above, but allow for unordered writes:   </p>   <div class="example-contents"><div class="phpcode" style="border-color:gray;background:#232525"><span><span style="color: #000000"><span style="color: #9876AA">&lt;?php<br /><br />$bulk </span><span style="color: #007700">= new </span><span style="color: #9876AA">MongoDB\Driver\BulkWrite</span><span style="color: #007700">([</span><span style="color: #DD0000">'ordered' </span><span style="color: #007700">=&gt; </span><span style="color: #9876AA">false</span><span style="color: #007700">]);<br /></span><span style="color: #FF8000">// ... <br /><br /></span><span style="color: #9876AA">?&gt;</span></span></span></div>   </div>   <p class="para">以上示例会输出：</p>   <div class="example-contents screen" style="color:AFB1B3;background:black;padding-left:5px;"><div class="cdata"><span>Operation#7: E11000 duplicate key error index: db.collection.$_id_ dup key: { : 3 } (11000)<br>Operation#8: E11000 duplicate key error index: db.collection.$_id_ dup key: { : 4 } (11000)<br>Inserted 5 document(s)<br>Updated  2 document(s)<br></span></div>   </div>  </div>  <div class="section" id="mongodb-driver-bulkwrite.seealso">   <h2 class="title">参见</h2>   <ul class="simplelist">    <li class="member"><span class="methodname" style="color:#CC7832">{@link MongoDB\Driver\Manager::executeBulkWrite()}</span></li>    <li class="member"><span class="classname"><a href="https://www.php.net/manual/zh/class.mongodb-driver-writeresult.php" class="classname">MongoDB\Driver\WriteResult</a></span></li>    <li class="member"><span class="classname"><a href="https://www.php.net/manual/zh/class.mongodb-driver-writeconcern.php" class="classname">MongoDB\Driver\WriteConcern</a></span></li>    <li class="member"><span class="classname"><a href="https://www.php.net/manual/zh/class.mongodb-driver-writeconcernerror.php" class="classname">MongoDB\Driver\WriteConcernError</a></span></li>    <li class="member"><span class="classname"><a href="https://www.php.net/manual/zh/class.mongodb-driver-writeerror.php" class="classname">MongoDB\Driver\WriteError</a></span></li>   </ul>  </div> </div>   <h2>目录</h2><ul class="chunklist chunklist_reference"><li>{@link MongoDB\Driver\BulkWrite::__construct} — Create a new BulkWrite</li><li>{@link MongoDB\Driver\BulkWrite::count} — Count number of write operations in the bulk</li><li>{@link MongoDB\Driver\BulkWrite::delete} — Add a delete operation to the bulk</li><li>{@link MongoDB\Driver\BulkWrite::insert} — Add an insert operation to the bulk</li><li>{@link MongoDB\Driver\BulkWrite::update} — Add an update operation to the bulk</li></ul></div>