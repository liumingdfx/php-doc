<div id="eventhttpconnection.setclosecallback" class="refentry"> <div class="refnamediv">  <h1 class="refname">EventHttpConnection::setCloseCallback</h1>  <p class="verinfo">(PECL event &gt;= 1.8.0)</p><p class="refpurpose"><span class="refname">EventHttpConnection::setCloseCallback</span> &mdash; <span class="dc-title">Set callback for connection close</span></p> </div> <br></br><div style="BORDER-TOP: gray 1px dashed; OVERFLOW: hidden; HEIGHT: 1px"></div><div class="refsect1 description" id="refsect1-eventhttpconnection.setclosecallback-description">  <h3 class="title">说明</h3>  <div class="methodsynopsis dc-description">   <span class="modifier">public</span>   <span class="methodname" style="color:#CC7832"><strong>EventHttpConnection::setCloseCallback</strong></span>(<span class="methodparam">    <span class="type" style="color:#EAB766"><a href="https://www.php.net/manual/zh/language.types.callable.php" class="type callable" style="color:#EAB766">callable</a></span>     <span class="parameter" style="color:#3A95FF">$callback</span>   </span>, <span class="methodparam">    <span class="type" style="color:#EAB766"><a href="https://www.php.net/manual/zh/language.types.declarations.php#language.types.declarations.mixed" class="type mixed" style="color:#EAB766">mixed</a></span>     <span class="parameter" style="color:#3A95FF">$data</span>   <span class="initializer"> = ?</span></span>): <span class="type" style="color:#EAB766"><span class="type void" style="color:#EAB766">void</span></span></div>  <p class="para rdfs-comment">   Sets callback for connection close.  </p> </div> <br></br><div style="BORDER-TOP: gray 1px dashed; OVERFLOW: hidden; HEIGHT: 1px"></div><div class="refsect1 parameters" id="refsect1-eventhttpconnection.setclosecallback-parameters">  <h3 class="title">参数</h3>  <dl>       <dt>     <span class="parameter" style="color:#3A95FF">callback</span>    </dt>    <dd>     <span>      Callback which is called when connection is closed. Should match the      following prototype:     </span>     <div class="methodsynopsis dc-description">      <span class="methodname" style="color:#CC7832"><strong>callback</strong></span>(<span class="methodparam">       <span class="type" style="color:#EAB766"><a href="https://www.php.net/manual/zh/class.eventhttpconnection.php" class="type EventHttpConnection" style="color:#EAB766">EventHttpConnection</a></span>        <span class="parameter" style="color:#3A95FF">$conn</span>       <span class="initializer"> = <strong><span>null</span></strong></span>      </span>, <span class="methodparam">       <span class="type" style="color:#EAB766"><a href="https://www.php.net/manual/zh/language.types.declarations.php#language.types.declarations.mixed" class="type mixed" style="color:#EAB766">mixed</a></span>        <span class="parameter" style="color:#3A95FF">$arg</span>       <span class="initializer"> = <strong><span>null</span></strong></span>      </span>): <span class="type" style="color:#EAB766"><span class="type void" style="color:#EAB766">void</span></span></div>    </dd>     </dl> </div> <br></br><div style="BORDER-TOP: gray 1px dashed; OVERFLOW: hidden; HEIGHT: 1px"></div><div class="refsect1 returnvalues" id="refsect1-eventhttpconnection.setclosecallback-returnvalues">  <h3 class="title">返回值</h3>  <p class="para">   没有返回值。  </p> </div> <br></br><div style="BORDER-TOP: gray 1px dashed; OVERFLOW: hidden; HEIGHT: 1px"></div><div class="refsect1 examples" id="refsect1-eventhttpconnection.setclosecallback-examples">  <h3 class="title">示例</h3>  <div class="example" id="">   <p><strong>示例 #1     <span class="methodname" style="color:#CC7832"><strong>EventHttpConnection::setCloseCallback()</strong></span> example</strong></p>   <div class="example-contents"><div class="phpcode" style="border-color:gray;background:#232525"><span><span style="color: #000000"><span style="color: #9876AA">&lt;?php<br /></span><span style="color: #FF8000">//<br /> * Setting up close-connection callback<br /> *<br /> * The script handles closed connections using HTTP API.<br /> *<br /> * Usage:<br /> * 1) Launch the server:<br /> * $ php examples/http_closecb.php 4242<br /> *<br /> * 2) Launch a client in another terminal. Telnet-like<br /> * session should look like the following:<br /> *<br /> * $ nc -t 127.0.0.1 4242<br /> * GET / HTTP/1.0<br /> * Connection: close<br /> *<br /> * The server will output something similar to the following:<br /> *<br /> * HTTP/1.0 200 OK<br /> * Content-Type: multipart/x-mixed-replace;boundary=boundarydonotcross<br /> * Connection: close<br /> *<br /> * &lt;html&gt;<br /> *<br /> * 3) Terminate the client connection abruptly,<br /> * i.e. kill the process, or just press Ctrl-C.<br /> *<br /> * 4) Check if the server called _close_callback.<br /> * The script should output "_close_callback" string to standard output.<br /> *<br /> * 5) Check if the server's process has no orphaned connections,<br /> * e.g. with `lsof` utility.<br /> <br /><br /></span><span style="color: #007700">function </span><span style="color: #9876AA">_close_callback</span><span style="color: #007700">(</span><span style="color: #9876AA">$conn</span><span style="color: #007700">)<br />{<br />    echo </span><span style="color: #9876AA">__FUNCTION__</span><span style="color: #007700">, </span><span style="color: #9876AA">PHP_EOL</span><span style="color: #007700">;<br />}<br /><br />function </span><span style="color: #9876AA">_http_default</span><span style="color: #007700">(</span><span style="color: #9876AA">$req</span><span style="color: #007700">, </span><span style="color: #9876AA">$dummy</span><span style="color: #007700">)<br />{<br />    </span><span style="color: #9876AA">$conn </span><span style="color: #007700">= </span><span style="color: #9876AA">$req</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">getConnection</span><span style="color: #007700">();<br />    </span><span style="color: #9876AA">$conn</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">setCloseCallback</span><span style="color: #007700">(</span><span style="color: #DD0000">'_close_callback'</span><span style="color: #007700">, </span><span style="color: #9876AA">NULL</span><span style="color: #007700">);<br /><br />    </span><span style="color: #FF8000">//<br />    By enabling Event::READ we protect the server against unclosed conections.<br />    This is a peculiarity of Libevent. The library disables Event::READ events<br />     on this connection, and the server is not notified about terminated<br />    connections.<br /><br />    So each time client terminates connection abruptly, we get an orphaned<br />    connection. For instance, the following is a part of `lsof -p $PID | grep TCP`<br />    command after client has terminated connection:<br /><br />    57-php     15057 ruslan  6u  unix 0xffff8802fb59c780   0t0  125187 socket<br />    58:php     15057 ruslan  7u  IPv4             125189   0t0     TCP *:4242 (LISTEN)<br />    59:php     15057 ruslan  8u  IPv4             124342   0t0     TCP localhost:4242-&gt;localhost:37375 (CLOSE_WAIT)<br /><br />    where $PID is our process ID.<br /><br />    The following block of code fixes such kind of orphaned connections.<br />     <br />    </span><span style="color: #9876AA">$bev </span><span style="color: #007700">= </span><span style="color: #9876AA">$req</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">getBufferEvent</span><span style="color: #007700">();<br />    </span><span style="color: #9876AA">$bev</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">enable</span><span style="color: #007700">(</span><span style="color: #9876AA">Event</span><span style="color: #007700">::</span><span style="color: #9876AA">READ</span><span style="color: #007700">);<br />    </span><span style="color: #FF8000">// We have to free it explicitly. See</span></span></span></div>    <span class="methodname" style="color:#CC7832">{@link EventHttpRequest::getConnection()}</span><div class="phpcode" style="border-color:gray;background:#232525"><span><span style="color: #000000">$bev-&gt;free(); // we have to free it explicitly<br /><br />    $req-&gt;addHeader(<br />        'Content-Type',<br />        'multipart/x-mixed-replace;boundary=boundarydonotcross',<br />        EventHttpRequest::OUTPUT_HEADER<br />    );<br /><br />    $buf = new EventBuffer();<br />    $buf-&gt;add('&lt;html&gt;');<br /><br />    $req-&gt;sendReply(200, "OK");<br />    $req-&gt;sendReplyChunk($buf);<br />}<br /><br />$port = 4242;<br />if ($argc &gt; 1) {<br />    $port = (int) $argv[1];<br />}<br />if ($port &lt;= 0 || $port &gt; 65535) {<br />    exit("Invalid port");<br />}<br /><br />$base = new EventBase();<br />$http = new EventHttp($base);<br /><br />$http-&gt;setDefaultCallback("_http_default", NULL);<br />$http-&gt;bind("0.0.0.0", $port);<br />$base-&gt;loop();<br /><br />?&gt;</span></span></div>   </div>  </div> </div></div>