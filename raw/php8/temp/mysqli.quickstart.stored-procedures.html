<div id="mysqli.quickstart.stored-procedures" class="section">  <h2 class="title">Stored Procedures</h2>  <p class="para">   The MySQL database supports stored procedures. A stored procedure is a   subroutine stored in the database catalog. Applications can call and   execute the stored procedure. The <span>CALL</span>   SQL statement is used to execute a stored procedure.  </p>  <p class="para">   <strong>Parameter</strong>  </p>  <p class="para">   Stored procedures can have <span>IN</span>,   <span>INOUT</span> and <span>OUT</span> parameters,   depending on the MySQL version. The mysqli interface has no special   notion for the different kinds of parameters.  </p>  <p class="para">   <strong>IN parameter</strong>  </p>  <p class="para">   Input parameters are provided with the <span>CALL</span> statement.   Please, make sure values are escaped correctly.  </p>  <p class="para">   <div class="example" id="example-4310">    <p><strong>示例 #1 Calling a stored procedure</strong></p>    <div class="example-contents"><div class="phpcode" style="border-color:gray;background:#232525"><span><span style="color: #000000"><span style="color: #9876AA">&lt;?php<br /><br />mysqli_report</span><span style="color: #007700">(</span><span style="color: #9876AA">MYSQLI_REPORT_ERROR </span><span style="color: #007700">| </span><span style="color: #9876AA">MYSQLI_REPORT_STRICT</span><span style="color: #007700">);<br /></span><span style="color: #9876AA">$mysqli </span><span style="color: #007700">= new </span><span style="color: #9876AA">mysqli</span><span style="color: #007700">(</span><span style="color: #DD0000">"example.com"</span><span style="color: #007700">, </span><span style="color: #DD0000">"user"</span><span style="color: #007700">, </span><span style="color: #DD0000">"password"</span><span style="color: #007700">, </span><span style="color: #DD0000">"database"</span><span style="color: #007700">);<br /><br /></span><span style="color: #9876AA">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">query</span><span style="color: #007700">(</span><span style="color: #DD0000">"DROP TABLE IF EXISTS test"</span><span style="color: #007700">);<br /></span><span style="color: #9876AA">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">query</span><span style="color: #007700">(</span><span style="color: #DD0000">"CREATE TABLE test(id INT)"</span><span style="color: #007700">);<br /><br /></span><span style="color: #9876AA">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">query</span><span style="color: #007700">(</span><span style="color: #DD0000">"DROP PROCEDURE IF EXISTS p"</span><span style="color: #007700">);<br /></span><span style="color: #9876AA">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">query</span><span style="color: #007700">(</span><span style="color: #DD0000">"CREATE PROCEDURE p(IN id_val INT) BEGIN INSERT INTO test(id) VALUES(id_val); END;"</span><span style="color: #007700">);<br /><br /></span><span style="color: #9876AA">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">query</span><span style="color: #007700">(</span><span style="color: #DD0000">"CALL p(1)"</span><span style="color: #007700">);<br /><br /></span><span style="color: #9876AA">$result </span><span style="color: #007700">= </span><span style="color: #9876AA">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">query</span><span style="color: #007700">(</span><span style="color: #DD0000">"SELECT id FROM test"</span><span style="color: #007700">);<br /><br /></span><span style="color: #9876AA">var_dump</span><span style="color: #007700">(</span><span style="color: #9876AA">$result</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">fetch_assoc</span><span style="color: #007700">());</span></span></span></div>    </div>    <div class="example-contents"><p>以上示例会输出：</p></div>    <div class="example-contents screen" style="color:AFB1B3;background:black;padding-left:5px;"><div class="cdata"><span>array(1) {<br>  [&quot;id&quot;]=&gt;<br>  string(1) &quot;1&quot;<br>}<br></span></div>    </div>   </div>  </p>  <p class="para">   <strong>INOUT/OUT parameter</strong>  </p>  <p class="para">   The values of <span>INOUT</span>/<span>OUT</span>   parameters are accessed using session variables.  </p>  <p class="para">   <div class="example" id="example-4313">    <p><strong>示例 #2 Using session variables</strong></p>    <div class="example-contents"><div class="phpcode" style="border-color:gray;background:#232525"><span><span style="color: #000000"><span style="color: #9876AA">&lt;?php<br /><br />mysqli_report</span><span style="color: #007700">(</span><span style="color: #9876AA">MYSQLI_REPORT_ERROR </span><span style="color: #007700">| </span><span style="color: #9876AA">MYSQLI_REPORT_STRICT</span><span style="color: #007700">);<br /></span><span style="color: #9876AA">$mysqli </span><span style="color: #007700">= new </span><span style="color: #9876AA">mysqli</span><span style="color: #007700">(</span><span style="color: #DD0000">"example.com"</span><span style="color: #007700">, </span><span style="color: #DD0000">"user"</span><span style="color: #007700">, </span><span style="color: #DD0000">"password"</span><span style="color: #007700">, </span><span style="color: #DD0000">"database"</span><span style="color: #007700">);<br /><br /></span><span style="color: #9876AA">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">query</span><span style="color: #007700">(</span><span style="color: #DD0000">"DROP PROCEDURE IF EXISTS p"</span><span style="color: #007700">);<br /></span><span style="color: #9876AA">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">query</span><span style="color: #007700">(</span><span style="color: #DD0000">'CREATE PROCEDURE p(OUT msg VARCHAR(50)) BEGIN SELECT "Hi!" INTO msg; END;'</span><span style="color: #007700">);<br /><br /></span><span style="color: #9876AA">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">query</span><span style="color: #007700">(</span><span style="color: #DD0000">"SET @msg = ''"</span><span style="color: #007700">);<br /></span><span style="color: #9876AA">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">query</span><span style="color: #007700">(</span><span style="color: #DD0000">"CALL p(@msg)"</span><span style="color: #007700">);<br /><br /></span><span style="color: #9876AA">$result </span><span style="color: #007700">= </span><span style="color: #9876AA">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">query</span><span style="color: #007700">(</span><span style="color: #DD0000">"SELECT @msg as _p_out"</span><span style="color: #007700">);<br /><br /></span><span style="color: #9876AA">$row </span><span style="color: #007700">= </span><span style="color: #9876AA">$result</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">fetch_assoc</span><span style="color: #007700">();<br />echo </span><span style="color: #9876AA">$row</span><span style="color: #007700">[</span><span style="color: #DD0000">'_p_out'</span><span style="color: #007700">];</span></span></span></div>    </div>    <div class="example-contents"><p>以上示例会输出：</p></div>    <div class="example-contents screen" style="color:AFB1B3;background:black;padding-left:5px;"><div class="cdata"><span>Hi!<br></span></div>    </div>   </div>  </p>  <p class="para">   Application and framework developers may be able to provide a more convenient   API using a mix of session variables and databased catalog inspection.   However, please note the possible performance impact of a custom   solution based on catalog inspection.  </p>  <p class="para">   <strong>Handling result sets</strong>  </p>  <p class="para">   Stored procedures can return result sets. Result sets returned from a   stored procedure cannot be fetched correctly using <span class="methodname" style="color:#CC7832">{@link mysqli::query()}</span>.   The <span class="methodname" style="color:#CC7832">{@link mysqli::query()}</span> function combines statement execution   and fetching the first result set into a buffered result set, if any.   However, there are additional stored procedure result sets hidden   from the user which cause <span class="methodname" style="color:#CC7832">{@link mysqli::query()}</span> to fail   returning the user expected result sets.  </p>  <p class="para">   Result sets returned from a stored procedure are fetched using   <span class="methodname" style="color:#CC7832">{@link mysqli::real_query()}</span> or <span class="methodname" style="color:#CC7832">{@link mysqli::multi_query()}</span>.   Both functions allow fetching any number of result sets returned by a   statement, such as <span>CALL</span>. Failing to fetch all   result sets returned by a stored procedure causes an error.  </p>  <p class="para">   <div class="example" id="example-4316">    <p><strong>示例 #3 Fetching results from stored procedures</strong></p>    <div class="example-contents"><div class="phpcode" style="border-color:gray;background:#232525"><span><span style="color: #000000"><span style="color: #9876AA">&lt;?php<br /><br />mysqli_report</span><span style="color: #007700">(</span><span style="color: #9876AA">MYSQLI_REPORT_ERROR </span><span style="color: #007700">| </span><span style="color: #9876AA">MYSQLI_REPORT_STRICT</span><span style="color: #007700">);<br /></span><span style="color: #9876AA">$mysqli </span><span style="color: #007700">= new </span><span style="color: #9876AA">mysqli</span><span style="color: #007700">(</span><span style="color: #DD0000">"example.com"</span><span style="color: #007700">, </span><span style="color: #DD0000">"user"</span><span style="color: #007700">, </span><span style="color: #DD0000">"password"</span><span style="color: #007700">, </span><span style="color: #DD0000">"database"</span><span style="color: #007700">);<br /><br /></span><span style="color: #9876AA">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">query</span><span style="color: #007700">(</span><span style="color: #DD0000">"DROP TABLE IF EXISTS test"</span><span style="color: #007700">);<br /></span><span style="color: #9876AA">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">query</span><span style="color: #007700">(</span><span style="color: #DD0000">"CREATE TABLE test(id INT)"</span><span style="color: #007700">);<br /></span><span style="color: #9876AA">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">query</span><span style="color: #007700">(</span><span style="color: #DD0000">"INSERT INTO test(id) VALUES (1), (2), (3)"</span><span style="color: #007700">);<br /><br /></span><span style="color: #9876AA">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">query</span><span style="color: #007700">(</span><span style="color: #DD0000">"DROP PROCEDURE IF EXISTS p"</span><span style="color: #007700">);<br /></span><span style="color: #9876AA">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">query</span><span style="color: #007700">(</span><span style="color: #DD0000">'CREATE PROCEDURE p() READS SQL DATA BEGIN SELECT id FROM test; SELECT id + 1 FROM test; END;'</span><span style="color: #007700">);<br /><br /></span><span style="color: #9876AA">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">multi_query</span><span style="color: #007700">(</span><span style="color: #DD0000">"CALL p()"</span><span style="color: #007700">);<br /><br />do {<br />    if (</span><span style="color: #9876AA">$result </span><span style="color: #007700">= </span><span style="color: #9876AA">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">store_result</span><span style="color: #007700">()) {<br />        </span><span style="color: #9876AA">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">"---\n"</span><span style="color: #007700">);<br />        </span><span style="color: #9876AA">var_dump</span><span style="color: #007700">(</span><span style="color: #9876AA">$result</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">fetch_all</span><span style="color: #007700">());<br />        </span><span style="color: #9876AA">$result</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">free</span><span style="color: #007700">();<br />    }<br />} while (</span><span style="color: #9876AA">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">next_result</span><span style="color: #007700">());</span></span></span></div>    </div>    <div class="example-contents"><p>以上示例会输出：</p></div>    <div class="example-contents screen" style="color:AFB1B3;background:black;padding-left:5px;"><div class="cdata"><span>---<br>array(3) {<br>  [0]=&gt;<br>  array(1) {<br>    [0]=&gt;<br>    string(1) &quot;1&quot;<br>  }<br>  [1]=&gt;<br>  array(1) {<br>    [0]=&gt;<br>    string(1) &quot;2&quot;<br>  }<br>  [2]=&gt;<br>  array(1) {<br>    [0]=&gt;<br>    string(1) &quot;3&quot;<br>  }<br>}<br>---<br>array(3) {<br>  [0]=&gt;<br>  array(1) {<br>    [0]=&gt;<br>    string(1) &quot;2&quot;<br>  }<br>  [1]=&gt;<br>  array(1) {<br>    [0]=&gt;<br>    string(1) &quot;3&quot;<br>  }<br>  [2]=&gt;<br>  array(1) {<br>    [0]=&gt;<br>    string(1) &quot;4&quot;<br>  }<br>}<br></span></div>    </div>   </div>  </p>  <p class="para">   <strong>Use of prepared statements</strong>  </p>  <p class="para">   No special handling is required when using the prepared statement   interface for fetching results from the same stored procedure as above.   The prepared statement and non-prepared statement interfaces are similar.   Please note, that not every MYSQL server version may support   preparing the <span>CALL</span> SQL statement.  </p>  <p class="para">   <div class="example" id="example-4319">    <p><strong>示例 #4 Stored Procedures and Prepared Statements</strong></p>    <div class="example-contents"><div class="phpcode" style="border-color:gray;background:#232525"><span><span style="color: #000000"><span style="color: #9876AA">&lt;?php<br /><br />mysqli_report</span><span style="color: #007700">(</span><span style="color: #9876AA">MYSQLI_REPORT_ERROR </span><span style="color: #007700">| </span><span style="color: #9876AA">MYSQLI_REPORT_STRICT</span><span style="color: #007700">);<br /></span><span style="color: #9876AA">$mysqli </span><span style="color: #007700">= new </span><span style="color: #9876AA">mysqli</span><span style="color: #007700">(</span><span style="color: #DD0000">"example.com"</span><span style="color: #007700">, </span><span style="color: #DD0000">"user"</span><span style="color: #007700">, </span><span style="color: #DD0000">"password"</span><span style="color: #007700">, </span><span style="color: #DD0000">"database"</span><span style="color: #007700">);<br /><br /></span><span style="color: #9876AA">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">query</span><span style="color: #007700">(</span><span style="color: #DD0000">"DROP TABLE IF EXISTS test"</span><span style="color: #007700">);<br /></span><span style="color: #9876AA">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">query</span><span style="color: #007700">(</span><span style="color: #DD0000">"CREATE TABLE test(id INT)"</span><span style="color: #007700">);<br /></span><span style="color: #9876AA">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">query</span><span style="color: #007700">(</span><span style="color: #DD0000">"INSERT INTO test(id) VALUES (1), (2), (3)"</span><span style="color: #007700">);<br /><br /></span><span style="color: #9876AA">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">query</span><span style="color: #007700">(</span><span style="color: #DD0000">"DROP PROCEDURE IF EXISTS p"</span><span style="color: #007700">);<br /></span><span style="color: #9876AA">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">query</span><span style="color: #007700">(</span><span style="color: #DD0000">'CREATE PROCEDURE p() READS SQL DATA BEGIN SELECT id FROM test; SELECT id + 1 FROM test; END;'</span><span style="color: #007700">);<br /><br /></span><span style="color: #9876AA">$stmt </span><span style="color: #007700">= </span><span style="color: #9876AA">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">prepare</span><span style="color: #007700">(</span><span style="color: #DD0000">"CALL p()"</span><span style="color: #007700">);<br /><br /></span><span style="color: #9876AA">$stmt</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">execute</span><span style="color: #007700">();<br /><br />do {<br />    if (</span><span style="color: #9876AA">$result </span><span style="color: #007700">= </span><span style="color: #9876AA">$stmt</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">get_result</span><span style="color: #007700">()) {<br />        </span><span style="color: #9876AA">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">"---\n"</span><span style="color: #007700">);<br />        </span><span style="color: #9876AA">var_dump</span><span style="color: #007700">(</span><span style="color: #9876AA">$result</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">fetch_all</span><span style="color: #007700">());<br />        </span><span style="color: #9876AA">$result</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">free</span><span style="color: #007700">();<br />    }<br />} while (</span><span style="color: #9876AA">$stmt</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">next_result</span><span style="color: #007700">());</span></span></span></div>    </div>    <div class="example-contents"><p>以上示例会输出：</p></div>    <div class="example-contents screen" style="color:AFB1B3;background:black;padding-left:5px;"><div class="cdata"><span>---<br>array(3) {<br>  [0]=&gt;<br>  array(1) {<br>    [0]=&gt;<br>    int(1)<br>  }<br>  [1]=&gt;<br>  array(1) {<br>    [0]=&gt;<br>    int(2)<br>  }<br>  [2]=&gt;<br>  array(1) {<br>    [0]=&gt;<br>    int(3)<br>  }<br>}<br>---<br>array(3) {<br>  [0]=&gt;<br>  array(1) {<br>    [0]=&gt;<br>    int(2)<br>  }<br>  [1]=&gt;<br>  array(1) {<br>    [0]=&gt;<br>    int(3)<br>  }<br>  [2]=&gt;<br>  array(1) {<br>    [0]=&gt;<br>    int(4)<br>  }<br>}<br></span></div>    </div>   </div>  </p>  <p class="para">   Of course, use of the bind API for fetching is supported as well.  </p>  <p class="para">   <div class="example" id="example-4322">    <p><strong>示例 #5 Stored Procedures and Prepared Statements using bind API</strong></p>    <div class="example-contents"><div class="phpcode" style="border-color:gray;background:#232525"><span><span style="color: #000000"><span style="color: #9876AA">&lt;?php<br /><br />mysqli_report</span><span style="color: #007700">(</span><span style="color: #9876AA">MYSQLI_REPORT_ERROR </span><span style="color: #007700">| </span><span style="color: #9876AA">MYSQLI_REPORT_STRICT</span><span style="color: #007700">);<br /></span><span style="color: #9876AA">$mysqli </span><span style="color: #007700">= new </span><span style="color: #9876AA">mysqli</span><span style="color: #007700">(</span><span style="color: #DD0000">"example.com"</span><span style="color: #007700">, </span><span style="color: #DD0000">"user"</span><span style="color: #007700">, </span><span style="color: #DD0000">"password"</span><span style="color: #007700">, </span><span style="color: #DD0000">"database"</span><span style="color: #007700">);<br /><br /></span><span style="color: #9876AA">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">query</span><span style="color: #007700">(</span><span style="color: #DD0000">"DROP TABLE IF EXISTS test"</span><span style="color: #007700">);<br /></span><span style="color: #9876AA">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">query</span><span style="color: #007700">(</span><span style="color: #DD0000">"CREATE TABLE test(id INT)"</span><span style="color: #007700">);<br /></span><span style="color: #9876AA">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">query</span><span style="color: #007700">(</span><span style="color: #DD0000">"INSERT INTO test(id) VALUES (1), (2), (3)"</span><span style="color: #007700">);<br /><br /></span><span style="color: #9876AA">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">query</span><span style="color: #007700">(</span><span style="color: #DD0000">"DROP PROCEDURE IF EXISTS p"</span><span style="color: #007700">);<br /></span><span style="color: #9876AA">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">query</span><span style="color: #007700">(</span><span style="color: #DD0000">'CREATE PROCEDURE p() READS SQL DATA BEGIN SELECT id FROM test; SELECT id + 1 FROM test; END;'</span><span style="color: #007700">);<br /><br /></span><span style="color: #9876AA">$stmt </span><span style="color: #007700">= </span><span style="color: #9876AA">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">prepare</span><span style="color: #007700">(</span><span style="color: #DD0000">"CALL p()"</span><span style="color: #007700">);<br /><br /></span><span style="color: #9876AA">$stmt</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">execute</span><span style="color: #007700">();<br /><br />do {<br />    if (</span><span style="color: #9876AA">$stmt</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">store_result</span><span style="color: #007700">()) {<br />        </span><span style="color: #9876AA">$stmt</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">bind_result</span><span style="color: #007700">(</span><span style="color: #9876AA">$id_out</span><span style="color: #007700">);<br />        while (</span><span style="color: #9876AA">$stmt</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">fetch</span><span style="color: #007700">()) {<br />            echo </span><span style="color: #DD0000">"id = </span><span style="color: #9876AA">$id_out</span><span style="color: #DD0000">\n"</span><span style="color: #007700">;<br />        }<br />    }<br />} while (</span><span style="color: #9876AA">$stmt</span><span style="color: #007700">-&gt;</span><span style="color: #9876AA">next_result</span><span style="color: #007700">());</span></span></span></div>    </div>    <div class="example-contents"><p>以上示例会输出：</p></div>    <div class="example-contents screen" style="color:AFB1B3;background:black;padding-left:5px;"><div class="cdata"><span>id = 1<br>id = 2<br>id = 3<br>id = 2<br>id = 3<br>id = 4<br></span></div>    </div>   </div>  </p>  <p class="para">   <strong>See also</strong>  </p>  <p class="para">   <ul class="simplelist">    <li class="member"><span class="methodname" style="color:#CC7832">{@link mysqli::query()}</span></li>    <li class="member"><span class="methodname" style="color:#CC7832">{@link mysqli::multi_query()}</span></li>    <li class="member"><span class="methodname" style="color:#CC7832">{@link mysqli::next_result()}</span></li>    <li class="member"><span class="methodname" style="color:#CC7832">{@link mysqli::more_results()}</span></li>   </ul>  </p> </div>