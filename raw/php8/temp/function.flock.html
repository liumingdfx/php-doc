<div id="function.flock" class="refentry"> <div class="refnamediv">  <h1 class="refname">flock</h1>  <p class="verinfo">(PHP 4, PHP 5, PHP 7, PHP 8)</p><p class="refpurpose"><span class="refname">flock</span> &mdash; <span class="dc-title">可移植的协同文件锁定</span></p> </div> <br></br><div style="BORDER-TOP: gray 1px dashed; OVERFLOW: hidden; HEIGHT: 1px"></div><div class="refsect1 description" id="refsect1-function.flock-description">  <h3 class="title">说明</h3>  <div class="methodsynopsis dc-description">   <span class="methodname" style="color:#CC7832"><strong>flock</strong></span>(<span class="methodparam"><span class="type" style="color:#EAB766">resource</span> <span class="parameter" style="color:#3A95FF">$stream</span></span>, <span class="methodparam"><span class="type" style="color:#EAB766">int</span> <span class="parameter" style="color:#3A95FF">$operation</span></span>, <span class="methodparam"><span class="type" style="color:#EAB766">int</span> <span class="parameter" style="color:#3A95FF">&$would_block</span><span class="initializer"> = <strong><span>null</span></strong></span></span>): <span class="type" style="color:#EAB766">bool</span></div>  <p class="para rdfs-comment">   <span class="function"><strong style="color:#CC7832">flock()</strong></span> 允许执行简单的读取/写入模型,该模型可以在任何平台（包括大部分   Unix 衍生产品，甚至是 Windows）上使用。  </p>  <p class="para">   当调用 <span class="function">{@link fclose()}</span> 或者对 <span class="parameter" style="color:#3A95FF">stream</span> 垃圾收集时，锁会释放。  </p>  <p class="para">   PHP 支持以协同且可移植的方式锁定完整文件（也就是说所有访问程序必须使用相同锁定方式, 否则将无法工作）。默认情况下，该函数将堵塞直到获得锁；这可以通过下面文档中   <strong><span>LOCK_NB</span></strong> 选项来控制。  </p> </div>  <br></br><div style="BORDER-TOP: gray 1px dashed; OVERFLOW: hidden; HEIGHT: 1px"></div><div class="refsect1 parameters" id="refsect1-function.flock-parameters">  <h3 class="title">参数</h3>  <span>   <dl>         <dt><span class="parameter" style="color:#3A95FF">stream</span></dt>     <dd>      <p class="para">文件系统指针，是典型地由<span class="function">{@link fopen()}</span> 创建的 <span class="type" style="color:#EAB766">resource</span>(资源)。</p>     </dd>             <dt><span class="parameter" style="color:#3A95FF">operation</span></dt>     <dd>      <p class="para">       <span class="parameter" style="color:#3A95FF">operation</span> 可以是以下值之一：       <ul class="itemizedlist">        <li class="listitem">         <span class="simpara">         <strong><span>LOCK_SH</span></strong>取得共享锁定（读取的程序）。         </span>        </li>        <li class="listitem">         <span class="simpara">         <strong><span>LOCK_EX</span></strong> 取得独占锁定（写入的程序。         </span>        </li>        <li class="listitem">         <span class="simpara">          <strong><span>LOCK_UN</span></strong> 释放锁定（无论共享或独占）。         </span>        </li>       </ul>      </p>      <p class="para">       It is also possible to add <strong><span>LOCK_NB</span></strong> as a bitmask to one        of the above operations, if <span class="function"><strong style="color:#CC7832">flock()</strong></span> should not       block during the locking attempt.      </p>     </dd>             <dt><span class="parameter" style="color:#3A95FF">would_block</span></dt>     <dd>      <p class="para">       如果锁将堵塞（EWOULDBLOCK       错误码情况下），第三个可选参数会设置为 1。      </p>     </dd>       </dl>  </span> </div>  <br></br><div style="BORDER-TOP: gray 1px dashed; OVERFLOW: hidden; HEIGHT: 1px"></div><div class="refsect1 returnvalues" id="refsect1-function.flock-returnvalues">  <h3 class="title">返回值</h3>  <p class="para">   成功时返回 <strong><span>true</span></strong>， 或者在失败时返回 <strong><span>false</span></strong>。  </p> </div> <br></br><div style="BORDER-TOP: gray 1px dashed; OVERFLOW: hidden; HEIGHT: 1px"></div><div class="refsect1 examples" id="refsect1-function.flock-examples">  <h3 class="title">示例</h3>  <span>   <div class="example" id="">    <p><strong>示例 #1 <span class="function"><strong style="color:#CC7832">flock()</strong></span> 例子</strong></p>    <div class="example-contents"><div class="phpcode" style="border-color:gray;background:#232525"><span><span style="color: #000000"><span style="color: #9876AA">&lt;?php<br /><br />$fp </span><span style="color: #007700">= </span><span style="color: #9876AA">fopen</span><span style="color: #007700">(</span><span style="color: #DD0000">"/tmp/lock.txt"</span><span style="color: #007700">, </span><span style="color: #DD0000">"r+"</span><span style="color: #007700">);<br /><br />if (</span><span style="color: #9876AA">flock</span><span style="color: #007700">(</span><span style="color: #9876AA">$fp</span><span style="color: #007700">, </span><span style="color: #9876AA">LOCK_EX</span><span style="color: #007700">)) {  </span><span style="color: #FF8000">// 进行排它型锁定<br />    </span><span style="color: #9876AA">ftruncate</span><span style="color: #007700">(</span><span style="color: #9876AA">$fp</span><span style="color: #007700">, </span><span style="color: #9876AA">0</span><span style="color: #007700">);      </span><span style="color: #FF8000">// truncate file<br />    </span><span style="color: #9876AA">fwrite</span><span style="color: #007700">(</span><span style="color: #9876AA">$fp</span><span style="color: #007700">, </span><span style="color: #DD0000">"Write something here\n"</span><span style="color: #007700">);<br />    </span><span style="color: #9876AA">fflush</span><span style="color: #007700">(</span><span style="color: #9876AA">$fp</span><span style="color: #007700">);            </span><span style="color: #FF8000">// flush output before releasing the lock<br />    </span><span style="color: #9876AA">flock</span><span style="color: #007700">(</span><span style="color: #9876AA">$fp</span><span style="color: #007700">, </span><span style="color: #9876AA">LOCK_UN</span><span style="color: #007700">);    </span><span style="color: #FF8000">// 释放锁定<br /></span><span style="color: #007700">} else {<br />    echo </span><span style="color: #DD0000">"Couldn't get the lock!"</span><span style="color: #007700">;<br />}<br /><br /></span><span style="color: #9876AA">fclose</span><span style="color: #007700">(</span><span style="color: #9876AA">$fp</span><span style="color: #007700">);<br /><br /></span><span style="color: #9876AA">?&gt;</span></span></span></div>    </div>   </div>  </span>  <p class="para">   <div class="example" id="">    <p><strong>示例 #2 <span class="function"><strong style="color:#CC7832">flock()</strong></span> 使用 <strong><span>LOCK_NB</span></strong> 选项</strong></p>    <div class="example-contents"><div class="phpcode" style="border-color:gray;background:#232525"><span><span style="color: #000000"><span style="color: #9876AA">&lt;?php<br />$fp </span><span style="color: #007700">= </span><span style="color: #9876AA">fopen</span><span style="color: #007700">(</span><span style="color: #DD0000">'/tmp/lock.txt'</span><span style="color: #007700">, </span><span style="color: #DD0000">'r+'</span><span style="color: #007700">);<br /><br /></span><span style="color: #FF8000">// Activate the LOCK_NB option on an LOCK_EX operation <br /></span><span style="color: #007700">if(!</span><span style="color: #9876AA">flock</span><span style="color: #007700">(</span><span style="color: #9876AA">$fp</span><span style="color: #007700">, </span><span style="color: #9876AA">LOCK_EX </span><span style="color: #007700">| </span><span style="color: #9876AA">LOCK_NB</span><span style="color: #007700">)) {<br />    echo </span><span style="color: #DD0000">'Unable to obtain lock'</span><span style="color: #007700">;<br />    exit(-</span><span style="color: #9876AA">1</span><span style="color: #007700">);<br />}<br /><br /></span><span style="color: #FF8000">// ... <br /><br /></span><span style="color: #9876AA">fclose</span><span style="color: #007700">(</span><span style="color: #9876AA">$fp</span><span style="color: #007700">);<br /></span><span style="color: #9876AA">?&gt;</span></span></span></div>    </div>   </div>  </p> </div>  <br></br><div style="BORDER-TOP: gray 1px dashed; OVERFLOW: hidden; HEIGHT: 1px"></div><div class="refsect1 notes" id="refsect1-function.flock-notes">  <h3 class="title">注释</h3>  <blockquote class="note" style="border:1px gray solid"><p><strong class="note" style="border:1px gray solid">注意</strong>:    <p class="para">    在 Windows 上，<span class="function"><strong style="color:#CC7832">flock()</strong></span> 使用的是强制锁而不是协同锁。    Mandatory locking is also supported on Linux and    System V based operating systems via the usual mechanism supported by the    fcntl() system call: that is, if the file in question has the setgid    permission bit set and the group execution bit cleared. On Linux, the file    system will also need to be mounted with the mand option for this to work.   </p>  </p></blockquote>  <blockquote class="note" style="border:1px gray solid"><p><strong class="note" style="border:1px gray solid">注意</strong>:    <p class="para">    由于 <span class="function"><strong style="color:#CC7832">flock()</strong></span>    需要一个文件指针， 因此可能不得不用一个特殊的锁定文件来保护打算通过写模式打开的文件的访问（在    <span class="function">{@link fopen()}</span> 函数中加入 &quot;w&quot; 或 &quot;w+&quot;）。   </p>  </p></blockquote>  <blockquote class="note" style="border:1px gray solid"><p><strong class="note" style="border:1px gray solid">注意</strong>:    <p class="para">    只能用于 <span class="function">{@link fopen()}</span> 返回本地文件的文件指针，或指向实现    <span class="function">{@link streamWrapper::stream_lock()}</span> 方法的用户空间流的文件指针。   </p>  </p></blockquote>  <div class="warning"><strong class="warning">警告</strong>   <p class="para">    在后续代码中为 <span class="parameter" style="color:#3A95FF">stream</span> 分配另一个值将释放锁。   </p>  </div>  <div class="warning"><strong class="warning">警告</strong>   <p class="para">    在部分操作系统中 <span class="function"><strong style="color:#CC7832">flock()</strong></span> 以进程级实现。当用多线程服务器    API 时，可能无法依靠 <span class="function"><strong style="color:#CC7832">flock()</strong></span>    来保护文件，因为运行于同一服务器实例中其它并行线程的 PHP 脚本可以对该文件进行处理！   </p>   <p class="para">    旧的文件系统（如 <span>FAT</span> 及其衍生）不支持    <span class="function"><strong style="color:#CC7832">flock()</strong></span>，也因此在这些环境下总是返回 <strong><span>false</span></strong>。   </p>  </div>  <blockquote class="note" style="border:1px gray solid"><p><strong class="note" style="border:1px gray solid">注意</strong>:    <p class="para">    在 Windows 上，如果锁进程再次打开文件，那么在解锁文件之前，无法通过第二个句柄访问文件。   </p>  </p></blockquote> </div></div>